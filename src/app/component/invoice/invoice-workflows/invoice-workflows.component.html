<div class="row" style="margin-top: 120px;">
  <div class="col-12">
    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
      <h4 class="mb-sm-0">Invoice Workflows</h4>
      <div class="page-title-right">
        <ol class="breadcrumb m-0">
          <li class="breadcrumb-item"><a [routerLink]="['/']">Home</a></li>
          <li class="breadcrumb-item"><a [routerLink]="['/invoices']">Invoices</a></li>
          <li class="breadcrumb-item active">Workflows</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <ul class="nav nav-tabs-custom rounded card-header-tabs border-bottom-0" role="tablist">
          <li class="nav-item">
            <a class="nav-link" [class.active]="activeTab === 'rules'" 
               (click)="switchTab('rules')" role="tab">
              <i class="ri-settings-3-line me-1 align-bottom"></i> Workflow Rules
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" [class.active]="activeTab === 'executions'" 
               (click)="switchTab('executions')" role="tab">
              <i class="ri-history-line me-1 align-bottom"></i> Execution History
            </a>
          </li>
        </ul>
      </div>
      
      <div class="card-body">
        <!-- Loading State -->
        <div *ngIf="isLoading$ | async" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Workflow Rules Tab -->
        <div *ngIf="activeTab === 'rules' && !(isLoading$ | async)" class="tab-pane active">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Workflow Name</th>
                  <th>Trigger</th>
                  <th>Action</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let rule of workflowRules">
                  <td>
                    <h5 class="fs-14 mb-1">{{ rule.name }}</h5>
                    <p class="text-muted mb-0">{{ rule.description }}</p>
                  </td>
                  <td>
                    <span class="badge bg-info-subtle text-info">
                      {{ getTriggerDescription(rule) }}
                    </span>
                  </td>
                  <td>
                    <span class="badge bg-primary-subtle text-primary">
                      {{ getActionDescription(rule) }}
                    </span>
                  </td>
                  <td>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" role="switch" 
                             [checked]="rule.isActive" 
                             (change)="toggleRule(rule)"
                             [id]="'switch-' + rule.id"
                             style="cursor: pointer;">
                      <label class="form-check-label" [for]="'switch-' + rule.id">
                        <span [class.text-success]="rule.isActive" [class.text-muted]="!rule.isActive">
                          {{ rule.isActive ? 'Active' : 'Inactive' }}
                        </span>
                      </label>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-light" title="View Details" 
                            [routerLink]="['/invoices/workflows', rule.id]">
                      <i class="ri-eye-line"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Execution History Tab -->
        <div *ngIf="activeTab === 'executions' && !(isLoading$ | async)" class="tab-pane active">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Workflow</th>
                  <th>Invoice</th>
                  <th>Executed At</th>
                  <th>Status</th>
                  <th>Result</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let execution of executions">
                  <td>{{ execution.workflowRule?.name || 'Unknown' }}</td>
                  <td>
                    <a [routerLink]="['/invoices', execution.invoiceId]">
                      Invoice #{{ execution.invoiceId }}
                    </a>
                  </td>
                  <td>{{ execution.executedAt | date:'medium' }}</td>
                  <td>
                    <span class="badge" 
                          [ngClass]="{
                            'bg-success-subtle text-success': execution.status === 'SUCCESS',
                            'bg-danger-subtle text-danger': execution.status === 'FAILED',
                            'bg-warning-subtle text-warning': execution.status === 'SKIPPED'
                          }">
                      {{ execution.status }}
                    </span>
                  </td>
                  <td>
                    <span class="text-muted">{{ execution.resultMessage || '-' }}</span>
                  </td>
                </tr>
                <tr *ngIf="executions.length === 0">
                  <td colspan="5" class="text-center py-4 text-muted">
                    No execution history available
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Info Card -->
<div class="row">
  <div class="col-lg-12">
    <div class="card border card-border-info">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="ri-information-line align-middle me-1"></i> About Invoice Workflows
        </h6>
      </div>
      <div class="card-body">
        <p class="mb-2">Invoice workflows automate common tasks:</p>
        <ul class="mb-0">
          <li><strong>Auto-send invoices</strong> - Automatically email invoices to clients when created</li>
          <li><strong>Payment reminders</strong> - Send reminders before due dates</li>
          <li><strong>Overdue notices</strong> - Notify clients about overdue invoices</li>
          <li><strong>Late fees</strong> - Automatically apply late fees after specified days</li>
          <li><strong>Status updates</strong> - Automatically change invoice status based on conditions</li>
        </ul>
      </div>
    </div>
  </div>
</div>