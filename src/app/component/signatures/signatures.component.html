<div class="container-fluid" style="margin-top: 100px;">
  <!-- Page Header with Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h4 class="mb-1 fw-semibold">E-Signatures</h4>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="javascript:void(0);" class="text-muted">Home</a></li>
              <li class="breadcrumb-item active">E-Signatures</li>
            </ol>
          </nav>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-soft-primary" (click)="loadStats(); loadTemplates()">
            <i class="ri-refresh-line me-1"></i> Refresh
          </button>
          <button class="btn btn-primary" (click)="switchToSendTab()">
            <i class="ri-send-plane-fill me-1"></i> Send Document
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Statistics Cards -->
  <div class="row g-4 mb-4" *ngIf="stats && activeTab === 'documents'">
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <p class="text-muted text-uppercase fw-medium fs-12 mb-2">Total Requests</p>
              <h3 class="mb-0 counter-value fw-bold">{{ stats.totalRequests }}</h3>
              <p class="text-muted mb-0 mt-2 fs-13">
                <span class="text-success me-1"><i class="ri-arrow-up-line"></i></span>
                All time documents
              </p>
            </div>
            <div class="avatar-md flex-shrink-0">
              <span class="avatar-title bg-primary-subtle text-primary rounded-circle fs-2">
                <i class="ri-file-list-3-line"></i>
              </span>
            </div>
          </div>
          <div class="progress progress-sm mt-3" style="height: 4px;">
            <div class="progress-bar bg-primary" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <p class="text-muted text-uppercase fw-medium fs-12 mb-2">Pending Signatures</p>
              <h3 class="mb-0 counter-value fw-bold text-warning">{{ stats.pendingRequests }}</h3>
              <p class="text-muted mb-0 mt-2 fs-13">
                <span class="text-warning me-1"><i class="ri-time-line"></i></span>
                Awaiting response
              </p>
            </div>
            <div class="avatar-md flex-shrink-0">
              <span class="avatar-title bg-warning-subtle text-warning rounded-circle fs-2">
                <i class="ri-time-line"></i>
              </span>
            </div>
          </div>
          <div class="progress progress-sm mt-3" style="height: 4px;">
            <div class="progress-bar bg-warning" [style.width.%]="stats.totalRequests ? (stats.pendingRequests / stats.totalRequests * 100) : 0"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <p class="text-muted text-uppercase fw-medium fs-12 mb-2">Completed</p>
              <h3 class="mb-0 counter-value fw-bold text-success">{{ stats.completedRequests }}</h3>
              <p class="text-muted mb-0 mt-2 fs-13">
                <span class="text-success me-1"><i class="ri-check-line"></i></span>
                Successfully signed
              </p>
            </div>
            <div class="avatar-md flex-shrink-0">
              <span class="avatar-title bg-success-subtle text-success rounded-circle fs-2">
                <i class="ri-check-double-line"></i>
              </span>
            </div>
          </div>
          <div class="progress progress-sm mt-3" style="height: 4px;">
            <div class="progress-bar bg-success" [style.width.%]="stats.totalRequests ? (stats.completedRequests / stats.totalRequests * 100) : 0"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <p class="text-muted text-uppercase fw-medium fs-12 mb-2">Success Rate</p>
              <h3 class="mb-0 counter-value fw-bold text-info">{{ stats.completionRate }}%</h3>
              <p class="text-muted mb-0 mt-2 fs-13">
                <span class="text-info me-1"><i class="ri-pie-chart-line"></i></span>
                Completion rate
              </p>
            </div>
            <div class="avatar-md flex-shrink-0">
              <span class="avatar-title bg-info-subtle text-info rounded-circle fs-2">
                <i class="ri-pie-chart-line"></i>
              </span>
            </div>
          </div>
          <div class="progress progress-sm mt-3" style="height: 4px;">
            <div class="progress-bar bg-info" [style.width.%]="stats.completionRate"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Card with Tabs -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-bottom">
          <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" (activeIdChange)="onTabChange()" class="nav nav-pills nav-custom-pills gap-2">
            <li [ngbNavItem]="'documents'">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-file-list-3-line fs-16"></i>
                <span>Documents</span>
                <span class="badge bg-primary-subtle text-primary ms-1" *ngIf="stats">{{ stats.totalRequests }}</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Documents Tab Content -->
                <div class="py-4">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                    <div>
                      <h5 class="mb-1 fw-semibold">Signature Requests</h5>
                      <p class="text-muted mb-0 fs-13">Manage and track all your signature requests</p>
                    </div>
                    <button class="btn btn-primary btn-label" (click)="switchToSendTab()">
                      <i class="ri-add-line label-icon"></i> Send New Document
                    </button>
                  </div>
                  <app-signature-list
                    [organizationId]="organizationId"
                    [showActions]="true"
                    (requestSelected)="onRequestSelected($event)"
                    (viewAuditLog)="onViewAuditLog($event)">
                  </app-signature-list>
                </div>
              </ng-template>
            </li>

            <li [ngbNavItem]="'send'">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-send-plane-line fs-16"></i>
                <span>Send Document</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Send Document Tab Content -->
                <div class="py-4">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                    <div>
                      <h5 class="mb-1 fw-semibold">Send Document for Signature</h5>
                      <p class="text-muted mb-0 fs-13">Upload a document, add signers, and place signature fields</p>
                    </div>
                    <button class="btn btn-soft-secondary" (click)="switchToDocumentsTab()">
                      <i class="ri-arrow-left-line me-1"></i> Back to Documents
                    </button>
                  </div>

                  <!-- Step Progress Indicator -->
                  <div class="step-progress mb-4" *ngIf="!sendDocumentUrl">
                    <div class="d-flex justify-content-between position-relative">
                      <div class="step-line"></div>
                      <div class="step-item active">
                        <div class="step-icon">
                          <i class="ri-file-add-line"></i>
                        </div>
                        <span class="step-label">Document Details</span>
                      </div>
                      <div class="step-item" [class.active]="sendDocumentUrl">
                        <div class="step-icon">
                          <i class="ri-drag-drop-line"></i>
                        </div>
                        <span class="step-label">Place Fields</span>
                      </div>
                      <div class="step-item">
                        <div class="step-icon">
                          <i class="ri-send-plane-2-line"></i>
                        </div>
                        <span class="step-label">Send</span>
                      </div>
                    </div>
                  </div>

                  <!-- Step 1: Document & Signer Info Form -->
                  <div class="card border shadow-none" *ngIf="!sendDocumentUrl && !loadingEmbedUrl">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">
                        <i class="ri-file-text-line me-2 text-primary"></i>
                        Document & Signer Details
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="row g-4">
                        <!-- Document Section -->
                        <div class="col-lg-6">
                          <div class="form-section">
                            <h6 class="form-section-title text-muted mb-3">
                              <i class="ri-file-line me-1"></i> Document Information
                            </h6>
                            <div class="mb-3">
                              <label class="form-label fw-medium">Document Title <span class="text-danger">*</span></label>
                              <input type="text" class="form-control form-control-lg" [(ngModel)]="sendDocForm.title"
                                     placeholder="e.g., Retainer Agreement">
                            </div>
                            <div class="mb-0">
                              <label class="form-label fw-medium">Upload Document (PDF) <span class="text-danger">*</span></label>
                              <div class="dropzone-area" [class.has-file]="selectedFile">
                                <input type="file" class="dropzone-input" accept=".pdf" id="docUpload"
                                       (change)="onFileSelected($event)">
                                <label for="docUpload" class="dropzone-label">
                                  <i class="ri-upload-cloud-2-line fs-1 text-primary mb-2"></i>
                                  <p class="mb-1" *ngIf="!selectedFile">
                                    <strong>Click to upload</strong> or drag and drop
                                  </p>
                                  <p class="text-muted fs-13 mb-0" *ngIf="!selectedFile">PDF files only (max 10MB)</p>
                                  <div *ngIf="selectedFile" class="selected-file">
                                    <i class="ri-file-pdf-line text-danger fs-3 me-2"></i>
                                    <div>
                                      <p class="mb-0 fw-medium">{{ selectedFile.name }}</p>
                                      <small class="text-muted">{{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</small>
                                    </div>
                                  </div>
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Signer Section -->
                        <div class="col-lg-6">
                          <div class="form-section">
                            <h6 class="form-section-title text-muted mb-3">
                              <i class="ri-user-line me-1"></i> Signer Information
                            </h6>
                            <div class="mb-3">
                              <label class="form-label fw-medium">Link to Client (optional)</label>
                              <div class="input-group">
                                <span class="input-group-text bg-light"><i class="ri-user-search-line"></i></span>
                                <select class="form-select" [(ngModel)]="sendDocForm.clientId"
                                        (ngModelChange)="onClientChange()">
                                  <option [ngValue]="null">-- Select Client --</option>
                                  <option *ngFor="let client of clients" [ngValue]="client.id">
                                    {{ client.name }}
                                  </option>
                                </select>
                              </div>
                              <small class="text-muted" *ngIf="loadingClients">
                                <i class="ri-loader-4-line spin me-1"></i> Loading clients...
                              </small>
                            </div>

                            <div class="mb-3" *ngIf="sendDocForm.clientId">
                              <label class="form-label fw-medium">Link to Case (optional)</label>
                              <div class="input-group">
                                <span class="input-group-text bg-light"><i class="ri-briefcase-line"></i></span>
                                <select class="form-select" [(ngModel)]="sendDocForm.caseId"
                                        [disabled]="loadingCases">
                                  <option [ngValue]="null">-- Select Case --</option>
                                  <option *ngFor="let case of cases" [ngValue]="case.id">
                                    {{ case.caseNumber }} - {{ case.title }}
                                  </option>
                                </select>
                              </div>
                              <small class="text-muted" *ngIf="loadingCases">
                                <i class="ri-loader-4-line spin me-1"></i> Loading cases...
                              </small>
                              <small class="text-warning" *ngIf="sendDocForm.clientId && !loadingCases && cases.length === 0">
                                <i class="ri-information-line me-1"></i> No cases found for this client
                              </small>
                            </div>

                            <div class="row g-3">
                              <div class="col-12">
                                <label class="form-label fw-medium">Signer Name <span class="text-danger">*</span></label>
                                <div class="input-group">
                                  <span class="input-group-text bg-light"><i class="ri-user-3-line"></i></span>
                                  <input type="text" class="form-control" [(ngModel)]="sendDocForm.signerName"
                                         placeholder="e.g., John Doe">
                                </div>
                              </div>
                              <div class="col-12">
                                <label class="form-label fw-medium">Signer Email <span class="text-danger">*</span></label>
                                <div class="input-group">
                                  <span class="input-group-text bg-light"><i class="ri-mail-line"></i></span>
                                  <input type="email" class="form-control" [(ngModel)]="sendDocForm.signerEmail"
                                         placeholder="e.g., john@example.com">
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Message Section -->
                        <div class="col-12">
                          <label class="form-label fw-medium">
                            <i class="ri-message-3-line me-1 text-muted"></i>
                            Message to Signer (optional)
                          </label>
                          <textarea class="form-control" rows="3" [(ngModel)]="sendDocForm.message"
                                    placeholder="Please review and sign this document at your earliest convenience..."></textarea>
                        </div>
                      </div>

                      <!-- Error State -->
                      <div class="alert alert-danger d-flex align-items-center mt-4" *ngIf="embedError">
                        <i class="ri-error-warning-line fs-4 me-3"></i>
                        <div>{{ embedError }}</div>
                      </div>

                      <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                        <div class="text-muted fs-13">
                          <i class="ri-information-line me-1"></i>
                          After clicking continue, you'll configure signature field placement
                        </div>
                        <button class="btn btn-primary btn-lg" (click)="loadSendDocumentEmbed()"
                                [disabled]="!canProceedToEmbed()">
                          Continue <i class="ri-arrow-right-line ms-2"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Loading State -->
                  <div class="text-center py-5" *ngIf="loadingEmbedUrl">
                    <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                    <h5 class="mt-4">Loading Document Editor</h5>
                    <p class="text-muted">Please wait while we prepare your document...</p>
                  </div>

                  <!-- Step 2: BoldSign Embedded -->
                  <div *ngIf="sendDocumentUrl && !loadingEmbedUrl">
                    <div class="alert alert-primary border-0 d-flex align-items-center mb-4">
                      <i class="ri-drag-drop-line fs-4 me-3"></i>
                      <div class="flex-grow-1">
                        <strong>Step 2:</strong> Drag and drop signature fields onto the document, then click Send.
                      </div>
                      <button class="btn btn-sm btn-light" (click)="resetSendForm()">
                        <i class="ri-arrow-left-line me-1"></i> Start Over
                      </button>
                    </div>
                    <div class="boldsign-iframe-container">
                      <app-boldsign-embed
                        [url]="sendDocumentUrl"
                        mode="send-document"
                        displayMode="iframe"
                        (sent)="onDocumentSent($event)"
                        (cancelled)="onEmbedCancelled()"
                        (errorOccurred)="onEmbedError($event)"
                        (loaded)="onEmbedLoaded()">
                      </app-boldsign-embed>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>

            <li [ngbNavItem]="'templates'">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-file-copy-line fs-16"></i>
                <span>Templates</span>
                <span class="badge bg-secondary-subtle text-secondary ms-1" *ngIf="templates.length">{{ templates.length }}</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Templates Tab Content -->
                <div class="py-4">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                    <div>
                      <h5 class="mb-1 fw-semibold">Signature Templates</h5>
                      <p class="text-muted mb-0 fs-13">Create and manage reusable document templates</p>
                    </div>
                    <button class="btn btn-primary btn-label" (click)="createNewTemplate()">
                      <i class="ri-add-line label-icon"></i> Create Template
                    </button>
                  </div>

                  <!-- Loading State -->
                  <div class="text-center py-5" *ngIf="loadingTemplates">
                    <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                    <h5 class="mt-4">Loading Templates</h5>
                  </div>

                  <!-- Templates Grid -->
                  <div class="row g-4" *ngIf="!loadingTemplates && templates.length > 0">
                    <div class="col-xl-3 col-lg-4 col-md-6" *ngFor="let template of templates">
                      <div class="card template-card h-100 border"
                           [class.border-warning]="!template.boldsignTemplateId"
                           [class.border-primary]="template.boldsignTemplateId">
                        <div class="card-body">
                          <div class="d-flex align-items-start mb-3">
                            <div class="avatar-md flex-shrink-0 me-3">
                              <span class="avatar-title rounded-lg fs-2"
                                    [class.bg-primary-subtle]="template.boldsignTemplateId"
                                    [class.text-primary]="template.boldsignTemplateId"
                                    [class.bg-warning-subtle]="!template.boldsignTemplateId"
                                    [class.text-warning]="!template.boldsignTemplateId">
                                <i [class]="template.boldsignTemplateId ? signatureService.getCategoryIcon(template.category || '') : 'ri-settings-3-line'"></i>
                              </span>
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                              <h6 class="mb-1 text-truncate fw-semibold">{{ template.name }}</h6>
                              <div class="d-flex flex-wrap gap-1">
                                <span class="badge bg-light text-dark fs-11">{{ template.category || 'General' }}</span>
                                <span *ngIf="template.isGlobal" class="badge bg-info-subtle text-info fs-11">Global</span>
                              </div>
                            </div>
                          </div>
                          <p class="text-muted fs-13 mb-3 text-truncate-2" *ngIf="template.description">
                            {{ template.description }}
                          </p>
                          <div *ngIf="!template.boldsignTemplateId" class="alert alert-warning border-0 py-2 px-3 mb-3 fs-12">
                            <i class="ri-alert-line me-1"></i> Setup required in BoldSign
                          </div>
                          <div class="d-flex gap-2">
                            <button *ngIf="template.boldsignTemplateId"
                                    class="btn btn-soft-primary btn-sm flex-grow-1"
                                    (click)="useTemplate(template)">
                              <i class="ri-send-plane-line me-1"></i> Use
                            </button>
                            <button *ngIf="!template.boldsignTemplateId"
                                    class="btn btn-soft-warning btn-sm flex-grow-1"
                                    (click)="setupTemplateInBoldSign(template)">
                              <i class="ri-settings-3-line me-1"></i> Setup
                            </button>
                            <div class="dropdown" (click)="$event.stopPropagation()">
                              <button class="btn btn-soft-secondary btn-sm" data-bs-toggle="dropdown">
                                <i class="ri-more-2-fill"></i>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li *ngIf="template.boldsignTemplateId">
                                  <a class="dropdown-item" (click)="editTemplate(template)">
                                    <i class="ri-edit-line me-2 text-muted"></i> Edit
                                  </a>
                                </li>
                                <li *ngIf="!template.isGlobal">
                                  <a class="dropdown-item text-danger" (click)="deleteTemplate(template)">
                                    <i class="ri-delete-bin-line me-2"></i> Delete
                                  </a>
                                </li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Empty State -->
                  <div class="text-center py-5" *ngIf="!loadingTemplates && templates.length === 0">
                    <div class="empty-state-icon mx-auto mb-4">
                      <i class="ri-file-copy-line"></i>
                    </div>
                    <h4 class="fw-semibold">No Templates Yet</h4>
                    <p class="text-muted mb-4">Create reusable templates for frequently used documents to save time</p>
                    <button class="btn btn-primary btn-lg" (click)="createNewTemplate()">
                      <i class="ri-add-line me-1"></i> Create Your First Template
                    </button>
                  </div>
                </div>
              </ng-template>
            </li>
          </ul>
        </div>
        <div class="card-body pt-0">
          <div [ngbNavOutlet]="nav"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Request Detail Modal -->
<ng-template #detailModal let-modal>
  <div class="modal-header border-0 pb-0">
    <div>
      <h5 class="modal-title fw-semibold">
        <i class="ri-file-text-line me-2 text-primary"></i>Signature Request Details
      </h5>
      <p class="text-muted mb-0 fs-13" *ngIf="selectedRequest">{{ selectedRequest.title }}</p>
    </div>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body" *ngIf="selectedRequest">
    <!-- Status Header -->
    <div class="d-flex align-items-center justify-content-between bg-light rounded-3 p-3 mb-4">
      <app-signature-status-badge [status]="selectedRequest.status" size="lg"></app-signature-status-badge>
      <div class="d-flex gap-2">
        <button class="btn btn-soft-primary btn-sm" (click)="refreshStatus(selectedRequest)">
          <i class="ri-refresh-line me-1"></i> Refresh
        </button>
        <button class="btn btn-soft-warning btn-sm"
                *ngIf="signatureService.canRemind(selectedRequest)"
                (click)="sendReminder(selectedRequest)">
          <i class="ri-notification-3-line me-1"></i> Remind
        </button>
        <button class="btn btn-soft-success btn-sm"
                *ngIf="selectedRequest.status === 'COMPLETED'"
                (click)="downloadDocument(selectedRequest)">
          <i class="ri-download-line me-1"></i> Download
        </button>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="row g-4">
      <div class="col-md-6">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Document</label>
          <p class="mb-0 fw-medium">{{ selectedRequest.fileName || selectedRequest.title }}</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Signer</label>
          <p class="mb-0 fw-medium">{{ selectedRequest.signerName }}</p>
          <small class="text-muted">{{ selectedRequest.signerEmail }}</small>
        </div>
      </div>
      <div class="col-md-4">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Created</label>
          <p class="mb-0">{{ formatDate(selectedRequest.createdAt) }}</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Sent</label>
          <p class="mb-0">{{ formatDate(selectedRequest.sentAt) }}</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Expires</label>
          <p class="mb-0" [class.text-danger]="selectedRequest.daysUntilExpiry !== undefined && selectedRequest.daysUntilExpiry <= 3">
            {{ formatDate(selectedRequest.expiresAt) }}
            <span *ngIf="selectedRequest.daysUntilExpiry !== undefined && selectedRequest.daysUntilExpiry >= 0"
                  class="badge bg-warning-subtle text-warning ms-1">
              {{ selectedRequest.daysUntilExpiry }} days left
            </span>
          </p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-0">
    <button type="button" class="btn btn-light" (click)="modal.dismiss()">Close</button>
    <button type="button" class="btn btn-primary" (click)="onViewAuditLog(selectedRequest!)">
      <i class="ri-history-line me-1"></i> View Audit Log
    </button>
  </div>
</ng-template>

<!-- Audit Log Modal -->
<ng-template #auditModal let-modal>
  <div class="modal-header border-0">
    <h5 class="modal-title fw-semibold">
      <i class="ri-history-line me-2 text-primary"></i>Activity Timeline
    </h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="text-center py-5" *ngIf="loadingAudit">
      <div class="spinner-grow text-primary" role="status"></div>
      <p class="mt-3 text-muted">Loading activity...</p>
    </div>
    <div class="timeline-modern" *ngIf="!loadingAudit && auditLogs.length > 0">
      <div class="timeline-item-modern" *ngFor="let log of auditLogs; let last = last" [class.last]="last">
        <div class="timeline-icon-modern">
          <i [class]="getEventIcon(log.eventType)"></i>
        </div>
        <div class="timeline-content-modern">
          <div class="d-flex justify-content-between align-items-start">
            <h6 class="mb-1 fw-medium">{{ log.eventTypeDisplay || log.eventType }}</h6>
            <small class="text-muted">{{ formatDate(log.createdAt) }}</small>
          </div>
          <p class="mb-0 text-muted fs-13" *ngIf="log.actorName || log.actorEmail">
            by {{ log.actorName || log.actorEmail }}
            <span class="badge bg-light text-dark ms-1">{{ log.actorType }}</span>
          </p>
        </div>
      </div>
    </div>
    <div class="text-center py-5" *ngIf="!loadingAudit && auditLogs.length === 0">
      <div class="empty-state-icon-sm mx-auto mb-3">
        <i class="ri-history-line"></i>
      </div>
      <p class="text-muted mb-0">No activity recorded yet</p>
    </div>
  </div>
  <div class="modal-footer border-0">
    <button type="button" class="btn btn-light" (click)="modal.dismiss()">Close</button>
  </div>
</ng-template>

<!-- Template Creation Modal -->
<ng-template #templateModal let-modal>
  <div class="modal-header border-0">
    <div>
      <h5 class="modal-title fw-semibold">
        <i class="ri-file-copy-line me-2 text-primary"></i>
        {{ editingTemplate ? 'Edit Template' : 'Create New Template' }}
      </h5>
      <p class="text-muted mb-0 fs-13">Configure your reusable signature template</p>
    </div>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <!-- Step 1: Template Info Form -->
    <div *ngIf="showCreateTemplateForm && !editingTemplate && !loadingEmbedUrl">
      <!-- Progress Steps -->
      <div class="template-steps mb-4">
        <div class="d-flex">
          <div class="template-step active">
            <div class="step-number">1</div>
            <span>Template Details</span>
          </div>
          <div class="step-connector"></div>
          <div class="template-step">
            <div class="step-number">2</div>
            <span>Configure Fields</span>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-6">
          <label class="form-label fw-medium">Template Name <span class="text-danger">*</span></label>
          <input type="text" class="form-control form-control-lg" [(ngModel)]="createTemplateForm.name"
                 placeholder="e.g., Retainer Agreement Template">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-medium">Category</label>
          <select class="form-select form-select-lg" [(ngModel)]="createTemplateForm.category">
            <option value="General">General</option>
            <option value="Retainer">Retainer Agreements</option>
            <option value="NDA">Non-Disclosure</option>
            <option value="Settlement">Settlement</option>
            <option value="Consent">Consent Forms</option>
            <option value="POA">Power of Attorney</option>
            <option value="Fee">Fee Agreements</option>
            <option value="Release">Release Forms</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label fw-medium">Description (optional)</label>
          <textarea class="form-control" rows="2" [(ngModel)]="createTemplateForm.description"
                    placeholder="Brief description of when to use this template..."></textarea>
        </div>
        <div class="col-12">
          <label class="form-label fw-medium">Upload Document (PDF) <span class="text-danger">*</span></label>
          <div class="dropzone-area" [class.has-file]="templateFile">
            <input type="file" class="dropzone-input" accept=".pdf" id="templateUpload"
                   (change)="onTemplateFileSelected($event)">
            <label for="templateUpload" class="dropzone-label">
              <i class="ri-upload-cloud-2-line fs-1 text-primary mb-2"></i>
              <p class="mb-1" *ngIf="!templateFile">
                <strong>Click to upload</strong> or drag and drop
              </p>
              <p class="text-muted fs-13 mb-0" *ngIf="!templateFile">PDF files only</p>
              <div *ngIf="templateFile" class="selected-file">
                <i class="ri-file-pdf-line text-danger fs-3 me-2"></i>
                <div>
                  <p class="mb-0 fw-medium">{{ templateFile.name }}</p>
                  <small class="text-muted">{{ (templateFile.size / 1024 / 1024).toFixed(2) }} MB</small>
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="alert alert-danger d-flex align-items-center mt-4" *ngIf="embedError">
        <i class="ri-error-warning-line fs-4 me-3"></i>
        <div>{{ embedError }}</div>
      </div>

      <div class="d-flex justify-content-between mt-4 pt-3 border-top">
        <button class="btn btn-light" (click)="modal.dismiss()">Cancel</button>
        <button class="btn btn-primary" (click)="proceedToTemplateEmbed()"
                [disabled]="!canProceedToTemplateEmbed()">
          Continue to Configure Fields <i class="ri-arrow-right-line ms-2"></i>
        </button>
      </div>

      <div class="mt-4 p-3 bg-soft-info rounded-3">
        <h6 class="mb-2 text-info"><i class="ri-lightbulb-line me-1"></i> Quick Tips</h6>
        <ul class="mb-0 ps-3 text-muted fs-13">
          <li>Upload a base document to start with</li>
          <li>Drag and drop signature fields in the next step</li>
          <li>Save to reuse with any client</li>
        </ul>
      </div>
    </div>

    <!-- Loading State -->
    <div class="text-center py-5" *ngIf="loadingEmbedUrl">
      <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
      <h5 class="mt-4">Loading Template Editor</h5>
      <p class="text-muted">Please wait...</p>
    </div>

    <!-- Step 2: BoldSign Embedded -->
    <div *ngIf="!showCreateTemplateForm && templateEmbedUrl && !loadingEmbedUrl">
      <div class="template-steps mb-4">
        <div class="d-flex">
          <div class="template-step completed">
            <div class="step-number"><i class="ri-check-line"></i></div>
            <span>Template Details</span>
          </div>
          <div class="step-connector active"></div>
          <div class="template-step active">
            <div class="step-number">2</div>
            <span>Configure Fields</span>
          </div>
        </div>
      </div>

      <div class="alert alert-primary border-0 d-flex align-items-center mb-3">
        <i class="ri-drag-drop-line fs-4 me-3"></i>
        <div class="flex-grow-1">Drag and drop signature fields onto your document, then click Create/Save.</div>
        <button class="btn btn-sm btn-light" (click)="showCreateTemplateForm = true; templateEmbedUrl = ''">
          <i class="ri-arrow-left-line me-1"></i> Back
        </button>
      </div>

      <div class="boldsign-iframe-container modal-iframe">
        <app-boldsign-embed
          [url]="templateEmbedUrl"
          [mode]="editingTemplate ? 'edit-template' : 'create-template'"
          displayMode="iframe"
          (completed)="onTemplateCreated($event)"
          (cancelled)="modal.dismiss()"
          (errorOccurred)="onEmbedError($event)">
        </app-boldsign-embed>
      </div>
    </div>

    <!-- Edit Template Mode -->
    <div *ngIf="editingTemplate && templateEmbedUrl && !loadingEmbedUrl">
      <div class="boldsign-iframe-container modal-iframe">
        <app-boldsign-embed
          [url]="templateEmbedUrl"
          mode="edit-template"
          displayMode="iframe"
          (completed)="onTemplateCreated($event)"
          (cancelled)="modal.dismiss()"
          (errorOccurred)="onEmbedError($event)">
        </app-boldsign-embed>
      </div>
    </div>
  </div>
</ng-template>

<!-- Use Template Modal -->
<ng-template #useTemplateModal let-modal>
  <div class="modal-header border-0">
    <div>
      <h5 class="modal-title fw-semibold">
        <i class="ri-send-plane-line me-2 text-primary"></i>Send from Template
      </h5>
      <p class="text-muted mb-0 fs-13">{{ selectedTemplate?.name }}</p>
    </div>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <!-- Step 1: Signer Information -->
    <div *ngIf="showUseTemplateForm && !loadingEmbedUrl">
      <div class="text-center mb-4 pb-3 border-bottom">
        <div class="avatar-lg mx-auto mb-3">
          <span class="avatar-title bg-primary-subtle text-primary rounded-circle fs-1">
            <i [class]="signatureService.getCategoryIcon(selectedTemplate?.category || '')"></i>
          </span>
        </div>
        <h5 class="mb-1">{{ selectedTemplate?.name }}</h5>
        <p class="text-muted mb-0">Enter the signer's information to send this document</p>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-medium">Signer Name <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text bg-light"><i class="ri-user-3-line"></i></span>
            <input type="text" class="form-control" [(ngModel)]="useTemplateForm.signerName"
                   placeholder="e.g., John Doe">
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-medium">Signer Email <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text bg-light"><i class="ri-mail-line"></i></span>
            <input type="email" class="form-control" [(ngModel)]="useTemplateForm.signerEmail"
                   placeholder="e.g., john@example.com">
          </div>
        </div>
      </div>

      <div class="alert alert-danger d-flex align-items-center mt-4" *ngIf="embedError">
        <i class="ri-error-warning-line fs-4 me-3"></i>
        <div>{{ embedError }}</div>
      </div>

      <div class="d-flex justify-content-end mt-4 pt-3 border-top">
        <button class="btn btn-light me-2" (click)="modal.dismiss()">Cancel</button>
        <button class="btn btn-primary" (click)="proceedToUseTemplateEmbed()"
                [disabled]="!canProceedToUseTemplateEmbed()">
          Continue <i class="ri-arrow-right-line ms-2"></i>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="text-center py-5" *ngIf="loadingEmbedUrl">
      <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
      <h5 class="mt-4">Preparing Document</h5>
      <p class="text-muted">Please wait...</p>
    </div>

    <!-- Step 2: BoldSign Embedded -->
    <div *ngIf="useTemplateUrl && !loadingEmbedUrl && !showUseTemplateForm">
      <div class="alert alert-primary border-0 d-flex align-items-center mb-3">
        <i class="ri-information-line fs-4 me-3"></i>
        <div class="flex-grow-1">Review the document and click <strong>Send</strong> when ready.</div>
        <button class="btn btn-sm btn-light" (click)="showUseTemplateForm = true; useTemplateUrl = ''">
          <i class="ri-arrow-left-line me-1"></i> Back
        </button>
      </div>
      <div class="boldsign-iframe-container modal-iframe">
        <app-boldsign-embed
          [url]="useTemplateUrl"
          mode="send-from-template"
          displayMode="iframe"
          (sent)="onDocumentSentFromTemplate($event)"
          (cancelled)="modal.dismiss()"
          (errorOccurred)="onEmbedError($event)">
        </app-boldsign-embed>
      </div>
    </div>
  </div>
</ng-template>
