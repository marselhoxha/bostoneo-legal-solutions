<div class="container-fluid" style="margin-top: 100px;">
  <!-- Page Header - Dashboard Greeting Style -->
  <div class="row">
    <div class="col-12">
      <div class="page-header-wrapper">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
          <div>
            <div class="text-muted fs-11 fw-semibold letter-spacing text-uppercase mb-1">Document Management</div>
            <h4 class="mb-0">E-Signatures</h4>
          </div>
          <div class="d-flex align-items-center gap-3">
            <!-- Global Search -->
            <div class="search-box d-none d-md-block">
              <input type="text" class="form-control search-input"
                     [(ngModel)]="globalSearch"
                     (keyup.enter)="onGlobalSearch()"
                     placeholder="Search documents...">
              <i class="ri-search-line search-icon"></i>
            </div>
            <!-- Quick Actions -->
            <div class="btn-group">
              <button class="btn btn-primary" (click)="switchToSendTab()">
                <i class="ri-add-line me-1"></i> New Document
              </button>
              <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split"
                      data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" (click)="switchToSendTab()">
                    <i class="ri-file-upload-line me-2 text-primary"></i> Upload & Send
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" (click)="activeTab = 'templates'">
                    <i class="ri-file-copy-line me-2 text-info"></i> Use Template
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" (click)="createNewTemplate()">
                    <i class="ri-add-circle-line me-2 text-success"></i> Create Template
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Stats Cards - Minimal Design -->
  <div class="stats-row" *ngIf="activeTab === 'documents'">
    <!-- Waiting for me -->
    <div class="stat-item cursor-pointer"
         [class.active]="selectedDashboardFilter === 'WaitingForMe'"
         (click)="filterByDashboard('WaitingForMe')">
      <div class="stat-header">
        <span class="stat-label">WAITING FOR ME</span>
        <span class="stat-indicator stat-indicator-purple">
          <i class="ri-arrow-right-up-line"></i>
        </span>
      </div>
      <div class="stat-body">
        <i class="ri-edit-line stat-icon text-purple"></i>
        <span class="stat-value">{{ dashboard?.waitingForMe || 0 }}</span>
      </div>
    </div>

    <!-- Waiting for others -->
    <div class="stat-item cursor-pointer"
         [class.active]="selectedDashboardFilter === 'WaitingForOthers'"
         (click)="filterByDashboard('WaitingForOthers')">
      <div class="stat-header">
        <span class="stat-label">WAITING FOR OTHERS</span>
        <span class="stat-indicator stat-indicator-info">
          <i class="ri-time-line"></i>
        </span>
      </div>
      <div class="stat-body">
        <i class="ri-send-plane-line stat-icon text-info"></i>
        <span class="stat-value">{{ dashboard?.waitingForOthers || 0 }}</span>
      </div>
    </div>

    <!-- Needs Attention -->
    <div class="stat-item cursor-pointer"
         [class.active]="selectedDashboardFilter === 'NeedsAttention'"
         [class.has-alert]="dashboard?.needsAttention > 0"
         (click)="filterByDashboard('NeedsAttention')">
      <div class="stat-header">
        <span class="stat-label">NEEDS ATTENTION</span>
        <span class="stat-indicator stat-indicator-warning">
          <i class="ri-error-warning-line"></i>
        </span>
      </div>
      <div class="stat-body">
        <i class="ri-alert-line stat-icon text-warning"></i>
        <span class="stat-value">{{ dashboard?.needsAttention || 0 }}</span>
      </div>
    </div>

    <!-- Completed -->
    <div class="stat-item cursor-pointer"
         [class.active]="selectedDashboardFilter === 'Completed'"
         (click)="filterByDashboard('Completed')">
      <div class="stat-header">
        <span class="stat-label">COMPLETED</span>
        <span class="stat-indicator stat-indicator-success">
          <i class="ri-check-line"></i>
        </span>
      </div>
      <div class="stat-body">
        <i class="ri-checkbox-circle-line stat-icon text-success"></i>
        <span class="stat-value">{{ dashboard?.completed || 0 }}</span>
      </div>
    </div>
  </div>

  <!-- Loading Dashboard -->
  <div class="row g-3 mb-4" *ngIf="loadingDashboard && activeTab === 'documents'">
    <div class="col-12">
      <div class="d-flex justify-content-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Card with Tabs -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-bottom">
          <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" (activeIdChange)="onTabChange()" class="nav nav-pills nav-custom-pills gap-2">
            <li [ngbNavItem]="'documents'">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-file-list-3-line fs-16"></i>
                <span>Documents</span>
                <span class="badge bg-primary-subtle text-primary ms-1" *ngIf="stats">{{ stats.totalRequests }}</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Documents Tab Content -->
                <div class="py-4">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                    <div>
                      <h5 class="mb-1 fw-semibold">Signature Requests</h5>
                      <p class="text-muted mb-0 fs-13">Manage and track all your signature requests</p>
                    </div>
                    
                  </div>
                  <app-signature-list
                    [organizationId]="organizationId"
                    [showActions]="false"
                    [dataSource]="'boldsign'"
                    (documentSelected)="onBoldsignDocumentSelected($event)"
                    (requestSelected)="onRequestSelected($event)"
                    (viewAuditLog)="onViewAuditLog($event)">
                  </app-signature-list>
                </div>
              </ng-template>
            </li>

            <li [ngbNavItem]="'send'">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-send-plane-line fs-16"></i>
                <span>Send Document</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Send Document Tab Content -->
                <div class="py-4">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                    <div>
                      <h5 class="mb-1 fw-semibold">Send Document for Signature</h5>
                      <p class="text-muted mb-0 fs-13">Upload a document, add signers, and place signature fields</p>
                    </div>
                    <button class="btn btn-soft-secondary" (click)="switchToDocumentsTab()">
                      <i class="ri-arrow-left-line me-1"></i> Back to Documents
                    </button>
                  </div>

                  <!-- Step Progress Indicator -->
                  <div class="step-progress mb-4" *ngIf="!sendDocumentUrl">
                    <div class="d-flex justify-content-between position-relative">
                      <div class="step-line"></div>
                      <div class="step-item active">
                        <div class="step-icon">
                          <i class="ri-file-add-line"></i>
                        </div>
                        <span class="step-label">Document Details</span>
                      </div>
                      <div class="step-item" [class.active]="sendDocumentUrl">
                        <div class="step-icon">
                          <i class="ri-drag-drop-line"></i>
                        </div>
                        <span class="step-label">Place Fields</span>
                      </div>
                      <div class="step-item">
                        <div class="step-icon">
                          <i class="ri-send-plane-2-line"></i>
                        </div>
                        <span class="step-label">Send</span>
                      </div>
                    </div>
                  </div>

                  <!-- Step 1: Document & Signer Info Form -->
                  <div class="card border shadow-none" *ngIf="!sendDocumentUrl && !loadingEmbedUrl">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">
                        <i class="ri-file-text-line me-2 text-primary"></i>
                        Document & Signer Details
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="row g-4">
                        <!-- Document Section -->
                        <div class="col-lg-6">
                          <div class="form-section">
                            <h6 class="form-section-title text-muted mb-3">
                              <i class="ri-file-line me-1"></i> Document Information
                            </h6>
                            <div class="mb-3">
                              <label class="form-label fw-medium">Document Title <span class="text-danger">*</span></label>
                              <input type="text" class="form-control form-control-lg" [(ngModel)]="sendDocForm.title"
                                     placeholder="e.g., Retainer Agreement">
                            </div>
                            <div class="mb-0">
                              <label class="form-label fw-medium">Upload Document (PDF) <span class="text-danger">*</span></label>
                              <div class="dropzone-area" [class.has-file]="selectedFile">
                                <input type="file" class="dropzone-input" accept=".pdf" id="docUpload"
                                       (change)="onFileSelected($event)">
                                <label for="docUpload" class="dropzone-label">
                                  <i class="ri-upload-cloud-2-line fs-1 text-primary mb-2"></i>
                                  <p class="mb-1" *ngIf="!selectedFile">
                                    <strong>Click to upload</strong> or drag and drop
                                  </p>
                                  <p class="text-muted fs-13 mb-0" *ngIf="!selectedFile">PDF files only (max 10MB)</p>
                                  <div *ngIf="selectedFile" class="selected-file">
                                    <i class="ri-file-pdf-line text-danger fs-3 me-2"></i>
                                    <div>
                                      <p class="mb-0 fw-medium">{{ selectedFile.name }}</p>
                                      <small class="text-muted">{{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</small>
                                    </div>
                                  </div>
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Signer Section -->
                        <div class="col-lg-6">
                          <div class="form-section">
                            <h6 class="form-section-title text-muted mb-3">
                              <i class="ri-user-line me-1"></i> Signer Information
                            </h6>
                            <div class="mb-3">
                              <label class="form-label fw-medium">Link to Client (optional)</label>
                              <div class="input-group">
                                <span class="input-group-text bg-light"><i class="ri-user-search-line"></i></span>
                                <select class="form-select" [(ngModel)]="sendDocForm.clientId"
                                        (ngModelChange)="onClientChange()">
                                  <option [ngValue]="null">-- Select Client --</option>
                                  <option *ngFor="let client of clients" [ngValue]="client.id">
                                    {{ client.name }}
                                  </option>
                                </select>
                              </div>
                              <small class="text-muted" *ngIf="loadingClients">
                                <i class="ri-loader-4-line spin me-1"></i> Loading clients...
                              </small>
                            </div>

                            <div class="mb-3" *ngIf="sendDocForm.clientId">
                              <label class="form-label fw-medium">Link to Case (optional)</label>
                              <div class="input-group">
                                <span class="input-group-text bg-light"><i class="ri-briefcase-line"></i></span>
                                <select class="form-select" [(ngModel)]="sendDocForm.caseId"
                                        [disabled]="loadingCases">
                                  <option [ngValue]="null">-- Select Case --</option>
                                  <option *ngFor="let case of cases" [ngValue]="case.id">
                                    {{ case.caseNumber }} - {{ case.title }}
                                  </option>
                                </select>
                              </div>
                              <small class="text-muted" *ngIf="loadingCases">
                                <i class="ri-loader-4-line spin me-1"></i> Loading cases...
                              </small>
                              <small class="text-warning" *ngIf="sendDocForm.clientId && !loadingCases && cases.length === 0">
                                <i class="ri-information-line me-1"></i> No cases found for this client
                              </small>
                            </div>

                            <div class="row g-3">
                              <div class="col-12">
                                <label class="form-label fw-medium">Signer Name <span class="text-danger">*</span></label>
                                <div class="input-group">
                                  <span class="input-group-text bg-light"><i class="ri-user-3-line"></i></span>
                                  <input type="text" class="form-control" [(ngModel)]="sendDocForm.signerName"
                                         placeholder="e.g., John Doe">
                                </div>
                              </div>
                              <div class="col-12">
                                <label class="form-label fw-medium">Signer Email <span class="text-danger">*</span></label>
                                <div class="input-group">
                                  <span class="input-group-text bg-light"><i class="ri-mail-line"></i></span>
                                  <input type="email" class="form-control" [(ngModel)]="sendDocForm.signerEmail"
                                         placeholder="e.g., john@example.com">
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Message Section -->
                        <div class="col-12">
                          <label class="form-label fw-medium">
                            <i class="ri-message-3-line me-1 text-muted"></i>
                            Message to Signer (optional)
                          </label>
                          <textarea class="form-control" rows="3" [(ngModel)]="sendDocForm.message"
                                    placeholder="Please review and sign this document at your earliest convenience..."></textarea>
                        </div>
                      </div>

                      <!-- Error State -->
                      <div class="alert alert-danger d-flex align-items-center mt-4" *ngIf="embedError">
                        <i class="ri-error-warning-line fs-4 me-3"></i>
                        <div>{{ embedError }}</div>
                      </div>

                      <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                        <div class="text-muted fs-13">
                          <i class="ri-information-line me-1"></i>
                          After clicking continue, you'll configure signature field placement
                        </div>
                        <button class="btn btn-primary btn-lg" (click)="loadSendDocumentEmbed()"
                                [disabled]="!canProceedToEmbed()">
                          Continue <i class="ri-arrow-right-line ms-2"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Loading State -->
                  <div class="text-center py-5" *ngIf="loadingEmbedUrl">
                    <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                    <h5 class="mt-4">Loading Document Editor</h5>
                    <p class="text-muted">Please wait while we prepare your document...</p>
                  </div>

                  <!-- Step 2: BoldSign Embedded -->
                  <div *ngIf="sendDocumentUrl && !loadingEmbedUrl">
                    <div class="alert alert-primary border-0 d-flex align-items-center mb-4">
                      <i class="ri-drag-drop-line fs-4 me-3"></i>
                      <div class="flex-grow-1">
                        <strong>Step 2:</strong> Drag and drop signature fields onto the document, then click Send.
                      </div>
                      <button class="btn btn-sm btn-light" (click)="resetSendForm()">
                        <i class="ri-arrow-left-line me-1"></i> Start Over
                      </button>
                    </div>
                    <div class="boldsign-iframe-container">
                      <app-boldsign-embed
                        [url]="sendDocumentUrl"
                        mode="send-document"
                        displayMode="iframe"
                        (sent)="onDocumentSent($event)"
                        (cancelled)="onEmbedCancelled()"
                        (errorOccurred)="onEmbedError($event)"
                        (loaded)="onEmbedLoaded()">
                      </app-boldsign-embed>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>

            <li [ngbNavItem]="'templates'">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-file-copy-line fs-16"></i>
                <span>Templates</span>
                <span class="badge bg-secondary-subtle text-secondary ms-1" *ngIf="templates.length">{{ templates.length }}</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Templates Tab Content -->
                <div class="py-4">
                  <!-- Header with Stats -->
                  <div class="row g-3 mb-4">
                    <div class="col-lg-8">
                      <h5 class="mb-1 fw-semibold">Signature Templates</h5>
                      <p class="text-muted mb-0 fs-13">Create and manage reusable document templates for faster document preparation</p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                      <button class="btn btn-primary" (click)="createNewTemplate()">
                        <i class="ri-add-line me-1"></i> Create Template
                      </button>
                    </div>
                  </div>

                  <!-- Template Stats Cards -->
                  <div class="row g-3 mb-4" *ngIf="!loadingTemplates && templates.length > 0">
                    <div class="col-lg-3 col-sm-6">
                      <div class="template-stat-card">
                        <div class="template-stat-icon bg-primary-subtle">
                          <i class="ri-file-copy-line text-primary"></i>
                        </div>
                        <div class="template-stat-content">
                          <h4 class="mb-0 fw-bold">{{ templates.length }}</h4>
                          <span class="text-muted fs-13">Total Templates</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-3 col-sm-6">
                      <div class="template-stat-card">
                        <div class="template-stat-icon bg-success-subtle">
                          <i class="ri-check-double-line text-success"></i>
                        </div>
                        <div class="template-stat-content">
                          <h4 class="mb-0 fw-bold">{{ getReadyTemplatesCount() }}</h4>
                          <span class="text-muted fs-13">Ready to Use</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-3 col-sm-6">
                      <div class="template-stat-card">
                        <div class="template-stat-icon bg-warning-subtle">
                          <i class="ri-settings-3-line text-warning"></i>
                        </div>
                        <div class="template-stat-content">
                          <h4 class="mb-0 fw-bold">{{ getPendingSetupCount() }}</h4>
                          <span class="text-muted fs-13">Needs Setup</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-3 col-sm-6">
                      <div class="template-stat-card">
                        <div class="template-stat-icon bg-info-subtle">
                          <i class="ri-global-line text-info"></i>
                        </div>
                        <div class="template-stat-content">
                          <h4 class="mb-0 fw-bold">{{ getGlobalTemplatesCount() }}</h4>
                          <span class="text-muted fs-13">Global Templates</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Loading State -->
                  <div class="text-center py-5" *ngIf="loadingTemplates">
                    <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                    <h5 class="mt-4">Loading Templates</h5>
                    <p class="text-muted">Fetching your document templates...</p>
                  </div>

                  <!-- Templates Grid -->
                  <div class="row g-4" *ngIf="!loadingTemplates && templates.length > 0">
                    <!-- Create New Template Card -->
                    <div class="col-xl-3 col-lg-4 col-md-6">
                      <div class="template-card-new h-100" (click)="createNewTemplate()">
                        <div class="template-card-new-content">
                          <div class="template-card-new-icon">
                            <i class="ri-add-line"></i>
                          </div>
                          <h6 class="mb-1 fw-semibold">Create New Template</h6>
                          <p class="text-muted fs-13 mb-0">Upload a document and configure signature fields</p>
                        </div>
                      </div>
                    </div>

                    <!-- Template Cards -->
                    <div class="col-xl-3 col-lg-4 col-md-6" *ngFor="let template of templates">
                      <div class="template-card-modern h-100"
                           [class.template-card-pending]="!template.boldsignTemplateId"
                           [class.template-card-ready]="template.boldsignTemplateId">
                        <!-- Status Ribbon -->
                        <div class="template-ribbon" *ngIf="!template.boldsignTemplateId">
                          <span class="badge bg-warning">Setup Required</span>
                        </div>
                        <div class="template-ribbon" *ngIf="template.isGlobal && template.boldsignTemplateId">
                          <span class="badge bg-info">Global</span>
                        </div>

                        <!-- Card Content -->
                        <div class="template-card-body">
                          <!-- Icon & Category -->
                          <div class="template-card-header">
                            <div class="template-icon-wrapper"
                                 [class.bg-primary-subtle]="template.boldsignTemplateId"
                                 [class.bg-warning-subtle]="!template.boldsignTemplateId">
                              <i [class]="template.boldsignTemplateId ? signatureService.getCategoryIcon(template.category || '') : 'ri-settings-3-line'"
                                 [class.text-primary]="template.boldsignTemplateId"
                                 [class.text-warning]="!template.boldsignTemplateId"></i>
                            </div>
                            <div class="template-menu" ngbDropdown container="body" placement="bottom-end" (click)="$event.stopPropagation()">
                              <button class="btn btn-sm btn-icon btn-ghost-secondary" ngbDropdownToggle>
                                <i class="ri-more-2-fill"></i>
                              </button>
                              <div ngbDropdownMenu>
                                <button *ngIf="template.boldsignTemplateId" ngbDropdownItem (click)="useTemplate(template)">
                                  <i class="ri-send-plane-line me-2 text-primary"></i> Send Document
                                </button>
                                <button *ngIf="template.boldsignTemplateId" ngbDropdownItem (click)="editTemplate(template)">
                                  <i class="ri-edit-line me-2 text-muted"></i> Edit Template
                                </button>
                                <button *ngIf="!template.boldsignTemplateId" ngbDropdownItem (click)="setupTemplateInBoldSign(template)">
                                  <i class="ri-settings-3-line me-2 text-warning"></i> Complete Setup
                                </button>
                                <div class="dropdown-divider" *ngIf="!template.isGlobal"></div>
                                <button *ngIf="!template.isGlobal" ngbDropdownItem class="text-danger" (click)="deleteTemplate(template)">
                                  <i class="ri-delete-bin-line me-2"></i> Delete
                                </button>
                              </div>
                            </div>
                          </div>

                          <!-- Template Info -->
                          <div class="template-card-info">
                            <h6 class="template-title text-truncate" [title]="template.name">{{ template.name }}</h6>
                            <span class="template-category">
                              <i class="ri-folder-line me-1"></i>{{ template.category || 'General' }}
                            </span>
                            <p class="template-description" *ngIf="template.description">
                              {{ template.description }}
                            </p>
                            <p class="template-description text-muted" *ngIf="!template.description">
                              No description provided
                            </p>
                          </div>

                          <!-- Action Button -->
                          <div class="template-card-footer">
                            <button *ngIf="template.boldsignTemplateId"
                                    class="btn btn-primary btn-sm w-100"
                                    (click)="useTemplate(template)">
                              <i class="ri-send-plane-line me-1"></i> Use Template
                            </button>
                            <button *ngIf="!template.boldsignTemplateId"
                                    class="btn btn-warning btn-sm w-100"
                                    (click)="setupTemplateInBoldSign(template)">
                              <i class="ri-settings-3-line me-1"></i> Complete Setup
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Empty State -->
                  <div class="empty-state-container" *ngIf="!loadingTemplates && templates.length === 0">
                    <div class="empty-state-illustration">
                      <div class="empty-state-icon-lg">
                        <i class="ri-file-copy-line"></i>
                      </div>
                      <div class="empty-state-circles">
                        <span></span><span></span><span></span>
                      </div>
                    </div>
                    <h4 class="fw-semibold mb-2">No Templates Yet</h4>
                    <p class="text-muted mb-4 mx-auto" style="max-width: 400px;">
                      Templates help you save time by reusing document layouts with pre-configured signature fields
                    </p>
                    <div class="d-flex gap-2 justify-content-center">
                      <button class="btn btn-primary btn-lg" (click)="createNewTemplate()">
                        <i class="ri-add-line me-1"></i> Create Your First Template
                      </button>
                    </div>
                    <div class="empty-state-tips mt-4 pt-4 border-top">
                      <h6 class="text-muted fs-12 text-uppercase letter-spacing mb-3">Popular Template Types</h6>
                      <div class="d-flex flex-wrap justify-content-center gap-2">
                        <span class="badge bg-light text-dark"><i class="ri-file-text-line me-1"></i>Retainer Agreements</span>
                        <span class="badge bg-light text-dark"><i class="ri-shield-check-line me-1"></i>NDAs</span>
                        <span class="badge bg-light text-dark"><i class="ri-hand-coin-line me-1"></i>Fee Agreements</span>
                        <span class="badge bg-light text-dark"><i class="ri-file-shield-line me-1"></i>Consent Forms</span>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>

            <!-- Branding Tab (Admin/Attorney only) -->
            <li [ngbNavItem]="'branding'" *ngIf="canAccessBranding">
              <a ngbNavLink class="d-flex align-items-center gap-2" (click)="onBrandTabActivated()">
                <i class="ri-palette-line fs-16"></i>
                <span>Branding</span>
                <span class="badge bg-success-subtle text-success ms-1" *ngIf="brandSettings.brandId">
                  <i class="ri-check-line"></i>
                </span>
              </a>
              <ng-template ngbNavContent>
                <!-- Branding Tab Content -->
                <div class="py-4">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                    <div>
                      <h5 class="mb-1 fw-semibold">E-Signature Branding</h5>
                      <p class="text-muted mb-0 fs-13">Customize how your documents appear to signers</p>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                      <span class="badge bg-primary-subtle text-primary" *ngIf="brandSettings.brandId">
                        <i class="ri-check-line me-1"></i>Active
                      </span>
                      <span class="badge bg-secondary-subtle text-secondary" *ngIf="!brandSettings.brandId">
                        <i class="ri-information-line me-1"></i>Not Configured
                      </span>
                    </div>
                  </div>

                  <!-- Loading State -->
                  <div class="text-center py-5" *ngIf="brandLoading">
                    <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                    <h5 class="mt-4">Loading Brand Settings</h5>
                    <p class="text-muted">Fetching your branding configuration...</p>
                  </div>

                  <!-- Branding Form + Preview -->
                  <div class="row g-4" *ngIf="!brandLoading">
                    <!-- Left: Settings Form -->
                    <div class="col-lg-6">
                      <div class="card border shadow-none h-100">
                        <div class="card-header bg-light border-bottom">
                          <h6 class="card-title mb-0">
                            <i class="ri-settings-3-line me-2"></i>Brand Settings
                          </h6>
                        </div>
                        <div class="card-body">
                          <!-- Brand Name -->
                          <div class="mb-4">
                            <label class="form-label fw-medium">Brand Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" [(ngModel)]="brandSettings.brandName"
                                   placeholder="Your Law Firm Name" />
                            <small class="text-muted">Appears in signature emails and documents</small>
                          </div>

                          <!-- Logo Upload -->
                          <div class="mb-4">
                            <label class="form-label fw-medium">Logo <span class="text-danger" *ngIf="!brandSettings.brandId">*</span></label>
                            <div class="logo-upload-area p-4 border border-dashed rounded text-center"
                                 (drop)="onLogoDrop($event)"
                                 (dragover)="onLogoDragOver($event)"
                                 [class.has-logo]="logoPreviewUrl"
                                 [class.border-danger]="!brandSettings.brandId && !logoPreviewUrl && !selectedLogoFile">

                              <div *ngIf="!logoPreviewUrl">
                                <i class="ri-image-add-line fs-1 text-muted mb-2 d-block"></i>
                                <p class="text-muted mb-2">Drag & drop your logo here</p>
                                <p class="text-muted fs-12 mb-3">Accepted formats: JPG, JPEG, PNG, SVG</p>
                                <label class="btn btn-soft-primary btn-sm mb-0">
                                  <i class="ri-upload-2-line me-1"></i> Browse
                                  <input type="file" class="d-none" accept=".jpg,.jpeg,.png,.svg,image/jpeg,image/png,image/svg+xml" (change)="onLogoFileSelected($event)" />
                                </label>
                              </div>

                              <div *ngIf="logoPreviewUrl" class="logo-preview">
                                <img [src]="logoPreviewUrl" alt="Logo Preview" class="img-fluid mb-3" style="max-height: 60px;" />
                                <div>
                                  <button class="btn btn-soft-danger btn-sm" (click)="removeLogo()">
                                    <i class="ri-delete-bin-line me-1"></i> Remove
                                  </button>
                                  <label class="btn btn-soft-primary btn-sm ms-2 mb-0">
                                    <i class="ri-refresh-line me-1"></i> Change
                                    <input type="file" class="d-none" accept=".jpg,.jpeg,.png,.svg,image/jpeg,image/png,image/svg+xml" (change)="onLogoFileSelected($event)" />
                                  </label>
                                </div>
                              </div>
                            </div>
                            <small class="text-muted" *ngIf="!brandSettings.brandId">
                              <i class="ri-information-line me-1"></i>Logo is required for brand creation
                            </small>
                          </div>

                          <!-- Email Display Name -->
                          <div class="mb-4">
                            <label class="form-label fw-medium">Email Display Name</label>
                            <input type="text" class="form-control" [(ngModel)]="brandSettings.emailDisplayName"
                                   placeholder="Your Law Firm" />
                            <small class="text-muted">Name shown in "From" field of signature emails</small>
                          </div>

                          <!-- Colors -->
                          <div class="mb-4">
                            <label class="form-label fw-medium mb-3">
                              <i class="ri-paint-brush-line me-1"></i>Brand Colors
                            </label>
                            <div class="row g-3">
                              <div class="col-6">
                                <label class="form-label fs-12 text-muted">Primary Color</label>
                                <div class="input-group input-group-sm">
                                  <input type="color" class="form-control form-control-color"
                                         [(ngModel)]="brandSettings.primaryColor" />
                                  <input type="text" class="form-control" [(ngModel)]="brandSettings.primaryColor"
                                         placeholder="#405189" />
                                </div>
                              </div>
                              <div class="col-6">
                                <label class="form-label fs-12 text-muted">Background Color</label>
                                <div class="input-group input-group-sm">
                                  <input type="color" class="form-control form-control-color"
                                         [(ngModel)]="brandSettings.backgroundColor" />
                                  <input type="text" class="form-control" [(ngModel)]="brandSettings.backgroundColor"
                                         placeholder="#ffffff" />
                                </div>
                              </div>
                              <div class="col-6">
                                <label class="form-label fs-12 text-muted">Button Color</label>
                                <div class="input-group input-group-sm">
                                  <input type="color" class="form-control form-control-color"
                                         [(ngModel)]="brandSettings.buttonColor" />
                                  <input type="text" class="form-control" [(ngModel)]="brandSettings.buttonColor"
                                         placeholder="#405189" />
                                </div>
                              </div>
                              <div class="col-6">
                                <label class="form-label fs-12 text-muted">Button Text Color</label>
                                <div class="input-group input-group-sm">
                                  <input type="color" class="form-control form-control-color"
                                         [(ngModel)]="brandSettings.buttonTextColor" />
                                  <input type="text" class="form-control" [(ngModel)]="brandSettings.buttonTextColor"
                                         placeholder="#ffffff" />
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Save Result -->
                          <div *ngIf="brandSaveResult" class="alert mb-4"
                               [ngClass]="brandSaveResult.success ? 'alert-success' : 'alert-danger'">
                            <div class="d-flex align-items-center">
                              <i [ngClass]="brandSaveResult.success ? 'ri-check-circle-line' : 'ri-error-warning-line'"
                                 class="fs-20 me-2"></i>
                              <span>{{ brandSaveResult.message }}</span>
                            </div>
                          </div>

                          <!-- Actions -->
                          <div class="d-flex gap-2">
                            <button class="btn btn-primary flex-grow-1" (click)="saveBrandSettings()" [disabled]="brandSaving">
                              <i class="ri-save-line me-1"></i>
                              {{ brandSaving ? 'Saving...' : 'Save Brand' }}
                            </button>
                            <button class="btn btn-outline-danger" (click)="deleteBrandSettings()"
                                    [disabled]="brandSaving || !brandSettings.brandId">
                              <i class="ri-delete-bin-line"></i>
                            </button>
                            <button class="btn btn-outline-secondary" (click)="loadBrandSettings()" [disabled]="brandSaving">
                              <i class="ri-refresh-line"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Right: Live Preview -->
                    <div class="col-lg-6">
                      <div class="card border shadow-none h-100">
                        <div class="card-header bg-light border-bottom">
                          <div class="d-flex align-items-center justify-content-between">
                            <h6 class="card-title mb-0">
                              <i class="ri-eye-line me-2"></i>Preview
                            </h6>
                            <div class="btn-group btn-group-sm" role="group">
                              <button type="button" class="btn"
                                      [class.btn-primary]="brandPreviewMode === 'email'"
                                      [class.btn-outline-primary]="brandPreviewMode !== 'email'"
                                      (click)="brandPreviewMode = 'email'">
                                <i class="ri-mail-line me-1"></i>Email
                              </button>
                              <button type="button" class="btn"
                                      [class.btn-primary]="brandPreviewMode === 'signer'"
                                      [class.btn-outline-primary]="brandPreviewMode !== 'signer'"
                                      (click)="brandPreviewMode = 'signer'">
                                <i class="ri-file-edit-line me-1"></i>Signer Page
                              </button>
                            </div>
                          </div>
                        </div>
                        <div class="card-body p-0">
                          <!-- Device Toggle -->
                          <div class="d-flex justify-content-end p-2 bg-light border-bottom">
                            <div class="btn-group btn-group-sm" role="group">
                              <button type="button" class="btn btn-sm"
                                      [class.btn-secondary]="brandPreviewDevice === 'desktop'"
                                      [class.btn-outline-secondary]="brandPreviewDevice !== 'desktop'"
                                      (click)="brandPreviewDevice = 'desktop'">
                                <i class="ri-computer-line"></i>
                              </button>
                              <button type="button" class="btn btn-sm"
                                      [class.btn-secondary]="brandPreviewDevice === 'mobile'"
                                      [class.btn-outline-secondary]="brandPreviewDevice !== 'mobile'"
                                      (click)="brandPreviewDevice = 'mobile'">
                                <i class="ri-smartphone-line"></i>
                              </button>
                            </div>
                          </div>

                          <!-- Preview Content -->
                          <div class="preview-container p-4"
                               [style.background-color]="'#f5f5f5'"
                               [class.mobile-preview]="brandPreviewDevice === 'mobile'">

                            <!-- Email Preview -->
                            <div *ngIf="brandPreviewMode === 'email'" class="email-preview mx-auto"
                                 [class.mobile-width]="brandPreviewDevice === 'mobile'">
                              <div class="bg-white rounded shadow-sm overflow-hidden">
                                <!-- Email Header -->
                                <div class="p-3 border-bottom" [style.background-color]="brandSettings.backgroundColor || '#ffffff'">
                                  <div *ngIf="logoPreviewUrl" class="mb-2">
                                    <img [src]="logoPreviewUrl" alt="Logo" style="max-height: 40px;" />
                                  </div>
                                  <div *ngIf="!logoPreviewUrl && brandSettings.brandName"
                                       class="fw-bold fs-5" [style.color]="brandSettings.primaryColor || '#405189'">
                                    {{ brandSettings.brandName || 'Your Law Firm' }}
                                  </div>
                                </div>
                                <!-- Email Body -->
                                <div class="p-4">
                                  <div class="d-flex gap-2 mb-3 text-muted fs-12">
                                    <span><strong>From:</strong> {{ brandSettings.emailDisplayName || 'Your Law Firm' }}</span>
                                  </div>
                                  <div class="d-flex gap-2 mb-3 text-muted fs-12">
                                    <span><strong>To:</strong> client&#64;example.com</span>
                                  </div>
                                  <hr class="my-3">
                                  <h6 class="fw-semibold mb-3">Document Signature Request</h6>
                                  <p class="text-muted fs-13 mb-4">
                                    You have received a document that requires your signature. Please review and sign at your earliest convenience.
                                  </p>
                                  <button class="btn w-100"
                                          [style.background-color]="brandSettings.buttonColor || '#405189'"
                                          [style.color]="brandSettings.buttonTextColor || '#ffffff'">
                                    <i class="ri-edit-line me-1"></i>Review & Sign Document
                                  </button>
                                </div>
                                <!-- Email Footer -->
                                <div class="p-3 bg-light text-center">
                                  <small class="text-muted">Powered by BoldSign</small>
                                </div>
                              </div>
                            </div>

                            <!-- Signer Page Preview -->
                            <div *ngIf="brandPreviewMode === 'signer'" class="signer-preview mx-auto"
                                 [class.mobile-width]="brandPreviewDevice === 'mobile'">
                              <div class="bg-white rounded shadow-sm overflow-hidden">
                                <!-- Header -->
                                <div class="p-3 border-bottom"
                                     [style.background-color]="brandSettings.primaryColor || '#405189'">
                                  <div class="d-flex align-items-center justify-content-between">
                                    <div *ngIf="logoPreviewUrl">
                                      <img [src]="logoPreviewUrl" alt="Logo" style="max-height: 32px; filter: brightness(0) invert(1);" />
                                    </div>
                                    <div *ngIf="!logoPreviewUrl" class="text-white fw-bold">
                                      {{ brandSettings.brandName || 'Your Law Firm' }}
                                    </div>
                                    <span class="badge bg-white bg-opacity-25 text-white">Signing</span>
                                  </div>
                                </div>
                                <!-- Document Area -->
                                <div class="p-4" [style.background-color]="brandSettings.backgroundColor || '#ffffff'">
                                  <div class="text-center mb-4">
                                    <div class="document-placeholder mb-3">
                                      <i class="ri-file-text-line fs-1 text-muted"></i>
                                    </div>
                                    <p class="text-muted fs-13">Document Preview Area</p>
                                  </div>
                                  <div class="signature-field border border-dashed rounded p-3 mb-4 text-center">
                                    <i class="ri-edit-box-line text-muted me-1"></i>
                                    <span class="text-muted fs-13">Click here to sign</span>
                                  </div>
                                  <div class="d-flex gap-2">
                                    <button class="btn btn-outline-secondary flex-grow-1">
                                      Decline
                                    </button>
                                    <button class="btn flex-grow-1"
                                            [style.background-color]="brandSettings.buttonColor || '#405189'"
                                            [style.color]="brandSettings.buttonTextColor || '#ffffff'">
                                      <i class="ri-check-line me-1"></i>Finish
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>
          </ul>
        </div>
        <div class="card-body pt-0">
          <div [ngbNavOutlet]="nav"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Request Detail Modal -->
<ng-template #detailModal let-modal>
  <div class="modal-header border-0 pb-0">
    <div>
      <h5 class="modal-title fw-semibold">
        <i class="ri-file-text-line me-2 text-primary"></i>Signature Request Details
      </h5>
      <p class="text-muted mb-0 fs-13" *ngIf="selectedRequest">{{ selectedRequest.title }}</p>
    </div>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body" *ngIf="selectedRequest">
    <!-- Status Header -->
    <div class="d-flex align-items-center justify-content-between bg-light rounded-3 p-3 mb-4">
      <app-signature-status-badge [status]="selectedRequest.status" size="lg"></app-signature-status-badge>
      <div class="d-flex gap-2">
        <button class="btn btn-soft-primary btn-sm" (click)="refreshStatus(selectedRequest)">
          <i class="ri-refresh-line me-1"></i> Refresh
        </button>
        <button class="btn btn-soft-warning btn-sm"
                *ngIf="signatureService.canRemind(selectedRequest)"
                (click)="sendReminder(selectedRequest)">
          <i class="ri-notification-3-line me-1"></i> Remind
        </button>
        <button class="btn btn-soft-success btn-sm"
                *ngIf="selectedRequest.status === 'COMPLETED'"
                (click)="downloadDocument(selectedRequest)">
          <i class="ri-download-line me-1"></i> Download
        </button>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="row g-4">
      <div class="col-md-6">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Document</label>
          <p class="mb-0 fw-medium">{{ selectedRequest.fileName || selectedRequest.title }}</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Signer</label>
          <p class="mb-0 fw-medium">{{ selectedRequest.signerName }}</p>
          <small class="text-muted">{{ selectedRequest.signerEmail }}</small>
        </div>
      </div>
      <div class="col-md-4">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Created</label>
          <p class="mb-0">{{ formatDate(selectedRequest.createdAt) }}</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Sent</label>
          <p class="mb-0">{{ formatDate(selectedRequest.sentAt) }}</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="info-item">
          <label class="text-muted fs-12 text-uppercase fw-medium">Expires</label>
          <p class="mb-0" [class.text-danger]="selectedRequest.daysUntilExpiry !== undefined && selectedRequest.daysUntilExpiry <= 3">
            {{ formatDate(selectedRequest.expiresAt) }}
            <span *ngIf="selectedRequest.daysUntilExpiry !== undefined && selectedRequest.daysUntilExpiry >= 0"
                  class="badge bg-warning-subtle text-warning ms-1">
              {{ selectedRequest.daysUntilExpiry }} days left
            </span>
          </p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-0">
    <button type="button" class="btn btn-light" (click)="modal.dismiss()">Close</button>
    <button type="button" class="btn btn-primary" (click)="onViewAuditLog(selectedRequest!)">
      <i class="ri-history-line me-1"></i> View Audit Log
    </button>
  </div>
</ng-template>

<!-- Audit Log Modal -->
<ng-template #auditModal let-modal>
  <div class="modal-header border-0">
    <h5 class="modal-title fw-semibold">
      <i class="ri-history-line me-2 text-primary"></i>Activity Timeline
    </h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="text-center py-5" *ngIf="loadingAudit">
      <div class="spinner-grow text-primary" role="status"></div>
      <p class="mt-3 text-muted">Loading activity...</p>
    </div>
    <div class="timeline-modern" *ngIf="!loadingAudit && auditLogs.length > 0">
      <div class="timeline-item-modern" *ngFor="let log of auditLogs; let last = last" [class.last]="last">
        <div class="timeline-icon-modern">
          <i [class]="getEventIcon(log.eventType)"></i>
        </div>
        <div class="timeline-content-modern">
          <div class="d-flex justify-content-between align-items-start">
            <h6 class="mb-1 fw-medium">{{ log.eventTypeDisplay || log.eventType }}</h6>
            <small class="text-muted">{{ formatDate(log.createdAt) }}</small>
          </div>
          <p class="mb-0 text-muted fs-13" *ngIf="log.actorName || log.actorEmail">
            by {{ log.actorName || log.actorEmail }}
            <span class="badge bg-light text-dark ms-1">{{ log.actorType }}</span>
          </p>
        </div>
      </div>
    </div>
    <div class="text-center py-5" *ngIf="!loadingAudit && auditLogs.length === 0">
      <div class="empty-state-icon-sm mx-auto mb-3">
        <i class="ri-history-line"></i>
      </div>
      <p class="text-muted mb-0">No activity recorded yet</p>
    </div>
  </div>
  <div class="modal-footer border-0">
    <button type="button" class="btn btn-light" (click)="modal.dismiss()">Close</button>
  </div>
</ng-template>

<!-- Template Creation Modal -->
<ng-template #templateModal let-modal>
  <div class="modal-header border-0">
    <div>
      <h5 class="modal-title fw-semibold">
        <i class="ri-file-copy-line me-2 text-primary"></i>
        {{ editingTemplate ? 'Edit Template' : (isSettingUpTemplate ? 'Complete Template Setup' : 'Create New Template') }}
      </h5>
      <p class="text-muted mb-0 fs-13">
        {{ isSettingUpTemplate ? 'Upload a PDF document to complete the template configuration' : 'Configure your reusable signature template' }}
      </p>
    </div>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <!-- Step 1: Template Info Form -->
    <div *ngIf="showCreateTemplateForm && !editingTemplate && !loadingEmbedUrl">
      <!-- Info banner for setup mode -->
      <div class="alert alert-info border-0 d-flex align-items-center mb-4" *ngIf="isSettingUpTemplate">
        <i class="ri-information-line fs-4 me-3"></i>
        <div>
          <strong>Template details pre-filled.</strong> Upload a PDF document to configure signature fields in BoldSign.
        </div>
      </div>

      <!-- Progress Steps -->
      <div class="template-steps mb-4">
        <div class="d-flex">
          <div class="template-step active">
            <div class="step-number">1</div>
            <span>Template Details</span>
          </div>
          <div class="step-connector"></div>
          <div class="template-step">
            <div class="step-number">2</div>
            <span>Configure Fields</span>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-6">
          <label class="form-label fw-medium">Template Name <span class="text-danger">*</span></label>
          <input type="text" class="form-control form-control-lg" [(ngModel)]="createTemplateForm.name"
                 placeholder="e.g., Retainer Agreement Template">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-medium">Category</label>
          <select class="form-select form-select-lg" [(ngModel)]="createTemplateForm.category">
            <option value="General">General</option>
            <option value="Retainer">Retainer Agreements</option>
            <option value="NDA">Non-Disclosure</option>
            <option value="Settlement">Settlement</option>
            <option value="Consent">Consent Forms</option>
            <option value="POA">Power of Attorney</option>
            <option value="Fee">Fee Agreements</option>
            <option value="Release">Release Forms</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label fw-medium">Description (optional)</label>
          <textarea class="form-control" rows="2" [(ngModel)]="createTemplateForm.description"
                    placeholder="Brief description of when to use this template..."></textarea>
        </div>
        <div class="col-12">
          <label class="form-label fw-medium">Upload Document (PDF) <span class="text-danger">*</span></label>
          <div class="dropzone-area" [class.has-file]="templateFile">
            <input type="file" class="dropzone-input" accept=".pdf" id="templateUpload"
                   (change)="onTemplateFileSelected($event)">
            <label for="templateUpload" class="dropzone-label">
              <i class="ri-upload-cloud-2-line fs-1 text-primary mb-2"></i>
              <p class="mb-1" *ngIf="!templateFile">
                <strong>Click to upload</strong> or drag and drop
              </p>
              <p class="text-muted fs-13 mb-0" *ngIf="!templateFile">PDF files only</p>
              <div *ngIf="templateFile" class="selected-file">
                <i class="ri-file-pdf-line text-danger fs-3 me-2"></i>
                <div>
                  <p class="mb-0 fw-medium">{{ templateFile.name }}</p>
                  <small class="text-muted">{{ (templateFile.size / 1024 / 1024).toFixed(2) }} MB</small>
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="alert alert-danger d-flex align-items-center mt-4" *ngIf="embedError">
        <i class="ri-error-warning-line fs-4 me-3"></i>
        <div>{{ embedError }}</div>
      </div>

      <div class="d-flex justify-content-between mt-4 pt-3 border-top">
        <button class="btn btn-light" (click)="modal.dismiss()">Cancel</button>
        <button class="btn btn-primary" (click)="proceedToTemplateEmbed()"
                [disabled]="!canProceedToTemplateEmbed()">
          Continue to Configure Fields <i class="ri-arrow-right-line ms-2"></i>
        </button>
      </div>

      <div class="mt-4 p-3 bg-soft-info rounded-3">
        <h6 class="mb-2 text-info"><i class="ri-lightbulb-line me-1"></i> Quick Tips</h6>
        <ul class="mb-0 ps-3 text-muted fs-13">
          <li>Upload a base document to start with</li>
          <li>Drag and drop signature fields in the next step</li>
          <li>Save to reuse with any client</li>
        </ul>
      </div>
    </div>

    <!-- Loading State -->
    <div class="text-center py-5" *ngIf="loadingEmbedUrl">
      <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
      <h5 class="mt-4">Loading Template Editor</h5>
      <p class="text-muted">Please wait...</p>
    </div>

    <!-- Step 2: BoldSign Embedded -->
    <div *ngIf="!showCreateTemplateForm && templateEmbedUrl && !loadingEmbedUrl">
      <div class="template-steps mb-4">
        <div class="d-flex">
          <div class="template-step completed">
            <div class="step-number"><i class="ri-check-line"></i></div>
            <span>Template Details</span>
          </div>
          <div class="step-connector active"></div>
          <div class="template-step active">
            <div class="step-number">2</div>
            <span>Configure Fields</span>
          </div>
        </div>
      </div>

      <div class="alert alert-primary border-0 d-flex align-items-center mb-3">
        <i class="ri-drag-drop-line fs-4 me-3"></i>
        <div class="flex-grow-1">Drag and drop signature fields onto your document, then click Create/Save.</div>
        <button class="btn btn-sm btn-light" (click)="showCreateTemplateForm = true; templateEmbedUrl = ''">
          <i class="ri-arrow-left-line me-1"></i> Back
        </button>
      </div>

      <div class="boldsign-iframe-container modal-iframe">
        <app-boldsign-embed
          [url]="templateEmbedUrl"
          [mode]="editingTemplate ? 'edit-template' : 'create-template'"
          displayMode="iframe"
          (completed)="onTemplateCreated($event)"
          (cancelled)="modal.dismiss()"
          (errorOccurred)="onEmbedError($event)">
        </app-boldsign-embed>
      </div>
    </div>

    <!-- Edit Template Mode -->
    <div *ngIf="editingTemplate && templateEmbedUrl && !loadingEmbedUrl">
      <div class="boldsign-iframe-container modal-iframe">
        <app-boldsign-embed
          [url]="templateEmbedUrl"
          mode="edit-template"
          displayMode="iframe"
          (completed)="onTemplateCreated($event)"
          (cancelled)="modal.dismiss()"
          (errorOccurred)="onEmbedError($event)">
        </app-boldsign-embed>
      </div>
    </div>
  </div>
</ng-template>

<!-- Use Template Modal -->
<ng-template #useTemplateModal let-modal>
  <div class="modal-header border-0">
    <div>
      <h5 class="modal-title fw-semibold">
        <i class="ri-send-plane-line me-2 text-primary"></i>Send from Template
      </h5>
      <p class="text-muted mb-0 fs-13">{{ selectedTemplate?.name }}</p>
    </div>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <!-- Step 1: Signer Information -->
    <div *ngIf="showUseTemplateForm && !loadingEmbedUrl">
      <div class="text-center mb-4 pb-3 border-bottom">
        <div class="avatar-lg mx-auto mb-3">
          <span class="avatar-title bg-primary-subtle text-primary rounded-circle fs-1">
            <i [class]="signatureService.getCategoryIcon(selectedTemplate?.category || '')"></i>
          </span>
        </div>
        <h5 class="mb-1">{{ selectedTemplate?.name }}</h5>
        <p class="text-muted mb-0">Enter the signer's information to send this document</p>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-medium">Signer Name <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text bg-light"><i class="ri-user-3-line"></i></span>
            <input type="text" class="form-control" [(ngModel)]="useTemplateForm.signerName"
                   placeholder="e.g., John Doe">
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-medium">Signer Email <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text bg-light"><i class="ri-mail-line"></i></span>
            <input type="email" class="form-control" [(ngModel)]="useTemplateForm.signerEmail"
                   placeholder="e.g., john@example.com">
          </div>
        </div>
      </div>

      <div class="alert alert-danger d-flex align-items-center mt-4" *ngIf="embedError">
        <i class="ri-error-warning-line fs-4 me-3"></i>
        <div>{{ embedError }}</div>
      </div>

      <div class="d-flex justify-content-end mt-4 pt-3 border-top">
        <button class="btn btn-light me-2" (click)="modal.dismiss()">Cancel</button>
        <button class="btn btn-primary" (click)="proceedToUseTemplateEmbed()"
                [disabled]="!canProceedToUseTemplateEmbed()">
          Continue <i class="ri-arrow-right-line ms-2"></i>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="text-center py-5" *ngIf="loadingEmbedUrl">
      <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
      <h5 class="mt-4">Preparing Document</h5>
      <p class="text-muted">Please wait...</p>
    </div>

    <!-- Step 2: BoldSign Embedded -->
    <div *ngIf="useTemplateUrl && !loadingEmbedUrl && !showUseTemplateForm">
      <div class="alert alert-primary border-0 d-flex align-items-center mb-3">
        <i class="ri-information-line fs-4 me-3"></i>
        <div class="flex-grow-1">Review the document and click <strong>Send</strong> when ready.</div>
        <button class="btn btn-sm btn-light" (click)="showUseTemplateForm = true; useTemplateUrl = ''">
          <i class="ri-arrow-left-line me-1"></i> Back
        </button>
      </div>
      <div class="boldsign-iframe-container modal-iframe">
        <app-boldsign-embed
          [url]="useTemplateUrl"
          mode="send-from-template"
          displayMode="iframe"
          (sent)="onDocumentSentFromTemplate($event)"
          (cancelled)="modal.dismiss()"
          (errorOccurred)="onEmbedError($event)">
        </app-boldsign-embed>
      </div>
    </div>
  </div>
</ng-template>

<!-- Document Properties Modal - Enhanced Layout -->
<ng-template #documentPropertiesModal let-modal>
  <div class="modal-header bg-light border-bottom">
    <div class="d-flex align-items-center gap-3">
      <div class="modal-icon">
        <i class="ri-file-text-line"></i>
      </div>
      <div>
        <h5 class="modal-title fw-semibold mb-0">
          {{ selectedDocumentProperties?.messageTitle || 'Document Details' }}
        </h5>
        <div class="d-flex align-items-center gap-2 mt-1" *ngIf="selectedDocumentProperties">
          <span class="badge rounded-pill" [ngClass]="getStatusBadgeClass(selectedDocumentProperties.status)">
            {{ selectedDocumentProperties.status }}
          </span>
          <span class="text-muted fs-12" *ngIf="selectedDocumentProperties.statusDescription">
            {{ selectedDocumentProperties.statusDescription }}
          </span>
        </div>
      </div>
    </div>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body p-0" *ngIf="selectedDocumentProperties">
    <!-- Document Info Grid -->
    <div class="doc-info-grid p-4">
      <div class="doc-info-row">
        <div class="doc-info-item">
          <label>Document ID</label>
          <span class="font-monospace text-primary">{{ selectedDocumentProperties.documentId }}</span>
        </div>
        <div class="doc-info-item">
          <label>Sent by</label>
          <span>
            <i class="ri-user-line me-1 text-muted"></i>
            {{ selectedDocumentProperties.senderDetail?.name }}
          </span>
        </div>
      </div>
      <div class="doc-info-row">
        <div class="doc-info-item">
          <label>Sent on</label>
          <span>
            <i class="ri-calendar-line me-1 text-muted"></i>
            {{ selectedDocumentProperties.sentOn || '-' }}
          </span>
        </div>
        <div class="doc-info-item">
          <label>Last activity</label>
          <span>
            <i class="ri-history-line me-1 text-muted"></i>
            {{ selectedDocumentProperties.lastActivityDate || '-' }}
            <small class="text-muted d-block" *ngIf="selectedDocumentProperties.lastActivityDescription">
              {{ selectedDocumentProperties.lastActivityDescription }}
            </small>
          </span>
        </div>
      </div>
      <div class="doc-info-row">
        <div class="doc-info-item">
          <label>Expires on</label>
          <span [class.text-danger]="isExpiringSoon(selectedDocumentProperties.expiryDate)">
            <i class="ri-time-line me-1 text-muted"></i>
            {{ selectedDocumentProperties.expiryDate || '-' }}
          </span>
        </div>
        <div class="doc-info-item">
          <label>File(s)</label>
          <span>
            <i class="ri-file-pdf-line me-1 text-danger"></i>
            <span *ngIf="selectedDocumentProperties.files?.length > 0">
              {{ selectedDocumentProperties.files.join(', ') }}
            </span>
            <span *ngIf="!selectedDocumentProperties.files?.length" class="text-muted">-</span>
          </span>
        </div>
      </div>
      <div class="doc-info-row" *ngIf="selectedDocumentProperties.brandName">
        <div class="doc-info-item full-width">
          <label>Brand profile</label>
          <span>
            <i class="ri-palette-line me-1 text-muted"></i>
            {{ selectedDocumentProperties.brandName }}
          </span>
        </div>
      </div>
    </div>

    <!-- Tabs: Recipient Details | Document History -->
    <ul ngbNav #docPropsNav="ngbNav" [(activeId)]="docPropsActiveTab" class="nav-tabs nav-tabs-custom border-top px-3">
      <li [ngbNavItem]="'recipients'">
        <a ngbNavLink>
          <i class="ri-user-line me-1"></i> Recipients
          <span class="badge bg-primary-subtle text-primary ms-1">{{ selectedDocumentProperties.signerDetails?.length || 0 }}</span>
        </a>
        <ng-template ngbNavContent>
          <div class="p-3">
            <div class="recipient-cards">
              <div class="recipient-card" *ngFor="let signer of selectedDocumentProperties.signerDetails">
                <div class="recipient-avatar">
                  <i class="ri-user-3-line"></i>
                </div>
                <div class="recipient-info">
                  <h6 class="mb-0 fw-medium">{{ signer.signerName }}</h6>
                  <small class="text-primary">{{ signer.signerEmail }}</small>
                </div>
                <div class="recipient-meta">
                  <div class="meta-item">
                    <span class="meta-label">Delivery</span>
                    <span class="meta-value">{{ signer.deliveryMode || 'Email' }}</span>
                  </div>
                  <div class="meta-item">
                    <span class="meta-label">Status</span>
                    <span class="meta-value">
                      <span class="status-dot" [ngClass]="getSignerStatusClass(signer.status)"></span>
                      {{ getSignerStatusDisplay(signer.status) }}
                    </span>
                  </div>
                  <div class="meta-item" *ngIf="signer.lastActivity">
                    <span class="meta-label">Last Activity</span>
                    <span class="meta-value">{{ signer.lastActivity }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="text-center text-muted py-4" *ngIf="!selectedDocumentProperties.signerDetails?.length">
              <i class="ri-user-line fs-2 d-block mb-2"></i>
              No recipients found
            </div>
          </div>
        </ng-template>
      </li>
      <li [ngbNavItem]="'history'">
        <a ngbNavLink>
          <i class="ri-history-line me-1"></i> Activity
          <span class="badge bg-secondary-subtle text-secondary ms-1">{{ selectedDocumentProperties.documentHistory?.length || 0 }}</span>
        </a>
        <ng-template ngbNavContent>
          <div class="p-3">
            <div class="activity-timeline" *ngIf="selectedDocumentProperties.documentHistory?.length > 0">
              <div class="activity-item" *ngFor="let activity of selectedDocumentProperties.documentHistory; let first = first">
                <div class="activity-icon" [ngClass]="getActivityIconClass(activity.action)">
                  <i [class]="getActivityIcon(activity.action)"></i>
                </div>
                <div class="activity-content">
                  <div class="d-flex align-items-center justify-content-between">
                    <span class="fw-medium">{{ activity.action || activity.activityAction }}</span>
                    <small class="text-muted">{{ activity.activityDate }}</small>
                  </div>
                  <p class="mb-0 text-muted fs-13" *ngIf="activity.activityBy">
                    by {{ activity.activityBy }}
                    <span *ngIf="activity.ipAddress && activity.ipAddress !== '-'">
                      from {{ activity.ipAddress }}
                    </span>
                  </p>
                </div>
              </div>
            </div>
            <div class="text-center text-muted py-4" *ngIf="!selectedDocumentProperties.documentHistory?.length">
              <i class="ri-history-line fs-2 d-block mb-2"></i>
              No activity history available
            </div>
          </div>
        </ng-template>
      </li>
    </ul>
    <div [ngbNavOutlet]="docPropsNav"></div>
  </div>

  <!-- Loading State -->
  <div class="modal-body text-center py-5" *ngIf="loadingDocumentProperties">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-3 mb-0">Loading document details...</p>
  </div>

  <div class="modal-footer bg-light border-top">
    <div class="d-flex gap-2 w-100 justify-content-between">
      <button type="button" class="btn btn-light" (click)="modal.dismiss()">Close</button>
      <div class="d-flex gap-2" *ngIf="selectedDocumentProperties">
        <!-- Primary action: Download for completed docs, Send Reminder for pending -->
        <button class="btn btn-primary"
                *ngIf="selectedDocumentProperties.status?.toLowerCase() === 'completed'"
                (click)="downloadDocumentByBoldsignId(selectedDocumentProperties.documentId)">
          <i class="ri-download-line me-1"></i> Download document
        </button>
        <button class="btn btn-warning"
                *ngIf="selectedDocumentProperties.status?.toLowerCase()?.includes('waiting')"
                (click)="sendDocumentReminder(selectedDocumentProperties.documentId)">
          <i class="ri-notification-3-line me-1"></i> Send Reminder
        </button>

        <!-- More actions dropdown -->
        <div ngbDropdown placement="top-end">
          <button class="btn btn-outline-primary" ngbDropdownToggle>
            More actions
          </button>
          <div ngbDropdownMenu>
            <button ngbDropdownItem
                    *ngIf="selectedDocumentProperties.status?.toLowerCase() === 'completed'"
                    (click)="downloadAuditTrail(selectedDocumentProperties.documentId)">
              <i class="ri-file-list-3-line me-2"></i> Download audit trail
            </button>
            <div class="dropdown-divider" *ngIf="selectedDocumentProperties.status?.toLowerCase()?.includes('waiting')"></div>
            <button ngbDropdownItem class="text-danger"
                    *ngIf="selectedDocumentProperties.status?.toLowerCase()?.includes('waiting')"
                    (click)="voidDocument(selectedDocumentProperties.documentId)">
              <i class="ri-close-circle-line me-2"></i> Void document
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Floating Action Button -->
<div class="fab-container" [class.fab-expanded]="fabExpanded">
  <button class="fab-main btn btn-primary" (click)="fabExpanded = !fabExpanded" title="Quick Actions">
    <i class="ri-add-line" [class.rotate-45]="fabExpanded"></i>
  </button>
  <div class="fab-actions" *ngIf="fabExpanded">
    <button class="fab-action btn btn-info" (click)="switchToSendTab(); fabExpanded = false" title="Upload & Send">
      <i class="ri-upload-2-line"></i>
      <span>Send Document</span>
    </button>
    <button class="fab-action btn btn-success" (click)="activeTab = 'templates'; fabExpanded = false" title="Use Template">
      <i class="ri-file-copy-line"></i>
      <span>Use Template</span>
    </button>
    <button class="fab-action btn btn-warning" (click)="createNewTemplate(); fabExpanded = false" title="Create Template">
      <i class="ri-add-circle-line"></i>
      <span>New Template</span>
    </button>
  </div>
  <div class="fab-backdrop" *ngIf="fabExpanded" (click)="fabExpanded = false"></div>
</div>
