<header id="page-topbar" data-scroll-header >
    <div class="layout-width">
        <div class="navbar-header">
            <div class="d-flex">
                <!-- LOGO -->
                <div class="navbar-brand-box horizontal-logo">
                    <a href="javascript:void(0);" class="logo logo-dark">
                        <span class="logo-sm">
                            <img src="assets/images/bostoneo-logo-1.svg" alt="" height="60">
                        </span>
                        <span class="logo-lg">
                            <img src="assets/images/bostoneo-logo-1.svg" alt="" height="60">
                        </span>
                    </a>

                    <a href="javascript:void(0);" class="logo logo-light">
                        <span class="logo-sm">
                            <img src="assets/images/bostoneo-logo-white-1.svg" alt="" height="60">
                        </span>
                        <span class="logo-lg">
                            <img src="assets/images/bostoneo-logo-white-1.svg" alt="" height="60">
                        </span>
                    </a>
                </div>

                <button type="button" class="btn btn-sm px-3 fs-16 header-item vertical-menu-btn topnav-hamburger material-shadow-none" id="topnav-hamburger-icon" (click)="toggleMobileMenu($event)">
                    <span class="hamburger-icon">
                        <span></span>
                        <span></span>
                        <span></span>
                    </span>
                </button>

               
            </div>

            <div class="d-flex align-items-center">

                <!-- Organization Switcher (Sysadmin only) -->
                <app-organization-switcher></app-organization-switcher>

                <div class="dropdown d-md-none topbar-head-dropdown header-item" ngbDropdown>
                    <button type="button" class="btn btn-icon btn-topbar material-shadow-none btn-ghost-secondary rounded-circle" id="page-header-search-dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" ngbDropdownToggle>
                        <i class="bx bx-search fs-22"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0" aria-labelledby="page-header-search-dropdown" ngbDropdownMenu>
                        <form class="p-3">
                            <div class="form-group m-0">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search ..." aria-label="Recipient's username">
                                    <button class="btn btn-primary" type="submit"><i class="mdi mdi-magnify"></i></button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

           
                <!-- Case Management Dropdown (hidden for client users) -->
                <div class="dropdown ms-1 header-item" ngbDropdown #caseDropdown="ngbDropdown" display="dynamic" placement="bottom-end" *ngIf="!isClientUser">
                    <button type="button" class="btn btn-icon btn-topbar material-shadow-none btn-ghost-secondary rounded-circle position-relative"
                            ngbDropdownToggle
                            id="page-header-case-dropdown">
                        <i class='ri-briefcase-4-line fs-22'></i>
                        <span *ngIf="pendingAssignments > 0" class="position-absolute topbar-badge fs-9 translate-middle badge rounded-pill bg-warning">
                            {{ pendingAssignments }}
                            <span class="visually-hidden">pending assignments</span>
                        </span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0 custom-notification-dropdown" ngbDropdownMenu aria-labelledby="page-header-case-dropdown" style="width: 360px;">
                        <div class="p-3 border-top-0 border-start-0 border-end-0 border-dashed border bg-primary bg-pattern">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h6 class="m-0 fw-semibold fs-15 text-white">
                                        <i class="ri-briefcase-4-line me-2"></i>Case Management
                                    </h6>
                                </div>
                                <div class="col-auto">
                                    <a [routerLink]="['/case-management/dashboard']" class="btn btn-sm btn-light"
                                       (click)="caseDropdown.close()">
                                        View Dashboard
                                        <i class="ri-arrow-right-s-line align-middle"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="p-3 border-bottom">
                            <div class="row g-3 text-center">
                                <div class="col-4">
                                    <div class="p-2">
                                        <h5 class="mb-1 text-primary">{{ myCasesCount || 0 }}</h5>
                                        <p class="text-muted mb-0 fs-12">My Cases</p>
                                    </div>
                                </div>
                                <div class="col-4 border-start border-end">
                                    <div class="p-2">
                                        <h5 class="mb-1 text-warning">{{ myTasksCount || 0 }}</h5>
                                        <p class="text-muted mb-0 fs-12">Active Tasks</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2">
                                        <h5 class="mb-1 text-info">{{ teamWorkloadPercentage || 0 }}%</h5>
                                        <p class="text-muted mb-0 fs-12">Team Load</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="p-3 border-bottom">
                            <h6 class="text-muted text-uppercase fs-11 fw-semibold mb-3">Quick Actions</h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <a [routerLink]="['/legal/cases/create']" class="btn btn-soft-primary btn-sm w-100"
                                       (click)="caseDropdown.close()">
                                        <i class="ri-add-line me-1"></i>New Case
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a [routerLink]="['/case-management/tasks/new']" class="btn btn-soft-success btn-sm w-100"
                                       (click)="caseDropdown.close()">
                                        <i class="ri-task-line me-1"></i>New Task
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a [routerLink]="['/case-management/assignments']" class="btn btn-soft-info btn-sm w-100"
                                       (click)="caseDropdown.close()">
                                        <i class="ri-user-settings-line me-1"></i>Assignments
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a [routerLink]="['/case-management/workload']" class="btn btn-soft-warning btn-sm w-100"
                                       (click)="caseDropdown.close()">
                                        <i class="ri-dashboard-line me-1"></i>Workload
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Assignments -->
                        <div class="p-3">
                            <h6 class="text-muted text-uppercase fs-11 fw-semibold mb-3">Recent Assignments</h6>
                            <div class="recent-assignments-list" style="max-height: 200px; overflow-y: auto;">
                                <div *ngIf="recentAssignments && recentAssignments.length > 0; else noAssignments">
                                    <a *ngFor="let assignment of recentAssignments.slice(0, 3)" 
                                       [routerLink]="['/legal/cases', assignment.caseId]"
                                       class="d-flex align-items-center p-2 rounded hover-bg-light text-decoration-none text-body mb-2"
                                       (click)="caseDropdown.close()">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="avatar-xs rounded-circle bg-primary-subtle text-primary">
                                                <i class="ri-briefcase-line"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fs-13">{{ assignment.caseTitle }}</h6>
                                            <p class="mb-0 fs-12 text-muted">
                                                Assigned {{ assignment.assignmentDate | date:'shortDate' }}
                                            </p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <span class="badge bg-primary-subtle text-primary fs-11">
                                                {{ assignment.roleType }}
                                            </span>
                                        </div>
                                    </a>
                                </div>
                                <ng-template #noAssignments>
                                    <div class="text-center py-3">
                                        <div class="avatar-md mx-auto mb-3">
                                            <div class="avatar-title bg-light-subtle text-muted rounded-circle fs-24">
                                                <i class="ri-briefcase-line"></i>
                                            </div>
                                        </div>
                                        <p class="text-muted mb-0">No recent assignments</p>
                                    </div>
                                </ng-template>
                            </div>
                            <div class="mt-3 text-center">
                                <a [routerLink]="['/case-management/assignments']" class="btn btn-soft-primary btn-sm"
                                   (click)="caseDropdown.close()">
                                    View All Assignments <i class="ri-arrow-right-line ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timer Dropdown (hidden for client users) -->
                <div class="dropdown ms-1 header-item" ngbDropdown #timerDropdown="ngbDropdown" display="dynamic" placement="bottom-end" (openChange)="onTimerDropdownToggle($event)" *ngIf="!isClientUser">
                    <button type="button" class="btn btn-icon btn-topbar material-shadow-none btn-ghost-secondary rounded-circle position-relative"
                            ngbDropdownToggle
                            id="page-header-timer-dropdown"
                            aria-haspopup="true"
                            aria-expanded="false"
                            title="Time Tracking">
                        <i class="ri-timer-line fs-22" [ngClass]="{'text-success timer-pulse': hasRunningTimers()}"></i>
                        <span *ngIf="activeTimers.length > 0" class="position-absolute topbar-badge fs-10 translate-middle badge rounded-pill"
                              [ngClass]="hasRunningTimers() ? 'bg-success' : 'bg-warning'">
                            {{ activeTimers.length }}
                            <span class="visually-hidden">active timers</span>
                        </span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-0 custom-notification-dropdown" ngbDropdownMenu aria-labelledby="page-header-timer-dropdown"
                         style="width: 320px; border-radius: 8px; overflow: hidden; box-shadow: var(--vz-box-shadow-lg); border: 1px solid var(--vz-border-color);">

                        <!-- Header -->
                        <div class="bg-success p-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="ri-timer-flash-line text-white fs-18"></i>
                                    <span class="text-white fw-semibold fs-14">Timers</span>
                                    <span *ngIf="activeTimers.length > 0" class="badge bg-white text-success fs-10">{{ activeTimers.length }}</span>
                                </div>
                                <span class="text-white fw-bold fs-12" style="font-family: monospace;" *ngIf="activeTimers.length > 0">{{ getTodayTotalTime() }}</span>
                            </div>
                        </div>

                        <div style="max-height: 360px; overflow-y: auto; background: var(--vz-body-bg);">
                            <!-- Active Timers -->
                            <div *ngIf="!loadingTimers && activeTimers.length > 0" class="p-2">
                                <div *ngFor="let timer of activeTimers" class="mb-2 p-3 rounded-2"
                                     [class.border-success]="timer.isActive"
                                     [class.bg-success-subtle]="timer.isActive"
                                     style="background: var(--vz-card-bg); border: 1px solid var(--vz-border-color);">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <span class="fw-semibold text-truncate fs-12" style="max-width: 180px; color: var(--vz-heading-color);">{{ timer.caseName || 'Untitled' }}</span>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-icon" style="width: 28px; height: 28px;"
                                                    [class.btn-warning]="timer.isActive" [class.btn-success]="!timer.isActive"
                                                    (click)="toggleTimer(timer); $event.stopPropagation()"
                                                    [title]="timer.isActive ? 'Pause' : 'Resume'">
                                                <i [class]="timer.isActive ? 'ri-pause-fill' : 'ri-play-fill'" class="fs-14"></i>
                                            </button>
                                            <button class="btn btn-sm btn-icon btn-soft-danger" style="width: 28px; height: 28px;"
                                                    (click)="stopTimer(timer); $event.stopPropagation()" title="Stop Timer">
                                                <i class="ri-stop-fill fs-14"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fw-bold fs-18" style="font-family: 'SFMono-Regular', Consolas, monospace;"
                                              [class.text-success]="timer.isActive" [class.text-warning]="!timer.isActive">
                                            {{ timer.formattedDuration || '00:00:00' }}
                                        </span>
                                        <span *ngIf="!timer.isActive" class="badge bg-warning-subtle text-warning fs-9">PAUSED</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div *ngIf="!loadingTimers && activeTimers.length === 0" class="text-center py-4">
                                <i class="ri-timer-line fs-28 text-muted d-block mb-2"></i>
                                <span class="text-muted fs-12">No active timers</span>
                            </div>

                            <!-- Loading -->
                            <div *ngIf="loadingTimers" class="text-center py-4">
                                <div class="spinner-border spinner-border-sm text-success"></div>
                            </div>

                            <!-- Quick Start -->
                            <div class="p-3 border-top" *ngIf="!showQuickStartForm">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <span class="text-muted fw-semibold fs-10 text-uppercase">Start Timer</span>
                                    <a href="javascript:void(0)" class="text-primary fs-11" (click)="showQuickStartForm = true; $event.stopPropagation()">All Cases</a>
                                </div>
                                <div *ngFor="let rc of recentCases.slice(0, 3)"
                                     class="d-flex align-items-center gap-2 p-2 rounded mb-1"
                                     style="background: var(--vz-tertiary-bg); cursor: pointer;"
                                     (click)="startTimerForCase(rc); $event.stopPropagation()">
                                    <i class="ri-play-circle-fill text-success fs-16"></i>
                                    <span class="text-truncate fw-medium fs-12">{{ rc.title }}</span>
                                </div>
                                <div *ngIf="recentCases.length === 0" class="text-center">
                                    <button class="btn btn-sm btn-soft-success" (click)="showQuickStartForm = true; $event.stopPropagation()">
                                        <i class="ri-add-line"></i> New Timer
                                    </button>
                                </div>
                            </div>

                            <!-- Search Form (All Cases) -->
                            <div class="p-3 border-top" style="background: var(--vz-tertiary-bg);" *ngIf="showQuickStartForm" (click)="$event.stopPropagation()">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <span class="fw-semibold fs-12">All Cases</span>
                                    <i class="ri-close-line text-muted" style="cursor: pointer;" (click)="showQuickStartForm = false; $event.stopPropagation()"></i>
                                </div>
                                <input type="text" class="form-control form-control-sm mb-2 fs-12" placeholder="Search cases..."
                                       [(ngModel)]="caseSearchQuery" (input)="filterCases()" (click)="$event.stopPropagation()">
                                <div style="max-height: 180px; overflow-y: auto;" *ngIf="filteredCases.length > 0">
                                    <div *ngFor="let c of filteredCases"
                                         class="d-flex align-items-center justify-content-between p-2 mb-1 rounded fs-11"
                                         style="cursor: pointer; background: var(--vz-card-bg); border: 1px solid var(--vz-border-color);"
                                         [class.bg-success-subtle]="quickStartCaseId === c.id"
                                         [class.border-success]="quickStartCaseId === c.id"
                                         (click)="selectCase(c); $event.stopPropagation()">
                                        <span class="text-truncate fw-medium">{{ c.title }}</span>
                                        <i *ngIf="quickStartCaseId === c.id" class="ri-check-line text-success"></i>
                                    </div>
                                </div>
                                <div *ngIf="filteredCases.length === 0 && caseSearchQuery" class="text-center py-2 text-muted fs-11">
                                    No cases found
                                </div>
                                <button class="btn btn-success btn-sm w-100 mt-2 fs-12" [disabled]="!quickStartCaseId || startingTimer"
                                        (click)="startQuickTimer(); $event.stopPropagation()">
                                    <i class="ri-play-fill"></i> Start Timer
                                </button>
                            </div>
                        </div>

                        <!-- Footer -->
                        <a [routerLink]="['/time-tracking']" class="d-flex align-items-center justify-content-center gap-1 text-muted p-2 border-top fs-12"
                           style="text-decoration: none; background: var(--vz-tertiary-bg);" (click)="timerDropdown.close()">
                            All Entries <i class="ri-arrow-right-s-line"></i>
                        </a>
                    </div>
                </div>

              

                <div class="ms-1 header-item d-none d-sm-flex">
                    <button type="button" class="btn btn-icon btn-topbar material-shadow-none btn-ghost-secondary rounded-circle" data-toggle="fullscreen" (click)="fullscreen()">
                        <i class='bx bx-fullscreen fs-22'></i>
                    </button>
                </div>

                <div class="ms-1 header-item d-none d-sm-flex">
                    <button
                      type="button"
                      class="btn btn-icon btn-topbar material-shadow-none btn-ghost-secondary rounded-circle light-dark-mode"
                      (click)="toggleTheme()"
                    >
                      <i class='bx bx-moon fs-22'></i>
                      <i class='bx bx-sun fs-22'></i>
                    </button>
                  </div>

                <!-- Messages Dropdown -->
                <div class="dropdown ms-1 header-item" ngbDropdown #messageDropdown="ngbDropdown" display="dynamic" placement="bottom-end" (openChange)="onMessageDropdownToggle($event)">
                    <button type="button" class="btn btn-icon btn-topbar material-shadow-none btn-ghost-secondary rounded-circle position-relative"
                            ngbDropdownToggle
                            id="page-header-messages-dropdown"
                            aria-haspopup="true"
                            aria-expanded="false"
                            title="Messages">
                        <i class="bx bx-message-square-dots fs-22"></i>
                        <span *ngIf="unreadMessageCount > 0" class="position-absolute topbar-badge fs-10 translate-middle badge rounded-pill bg-danger">
                            {{ unreadMessageCount > 99 ? '99+' : unreadMessageCount }}
                            <span class="visually-hidden">unread messages</span>
                        </span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0 overflow-hidden message-dropdown" ngbDropdownMenu aria-labelledby="page-header-messages-dropdown">
                        <!-- Header -->
                        <div class="dropdown-head bg-primary bg-pattern rounded-top">
                            <div class="p-3">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h6 class="m-0 fs-16 fw-semibold text-white">
                                            <i class="bx bx-message-square-dots me-2"></i>Messages
                                        </h6>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge bg-light-subtle text-dark fs-13" *ngIf="unreadMessageCount > 0">
                                            {{ unreadMessageCount }} unread
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Message List -->
                        <div class="message-list-scroll" style="max-height: 300px; overflow-y: auto;" data-simplebar>
                            <!-- Loading state -->
                            <div *ngIf="loadingMessages" class="text-center p-4">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted mb-0 mt-2">Loading messages...</p>
                            </div>

                            <!-- Empty state -->
                            <div *ngIf="!loadingMessages && getDisplayThreads().length === 0" class="text-center p-4">
                                <div class="avatar-md mx-auto mb-3">
                                    <div class="avatar-title bg-light-subtle text-primary rounded-circle fs-24">
                                        <i class="bx bx-message-x"></i>
                                    </div>
                                </div>
                                <h5 class="mb-1 fs-16">No Messages</h5>
                                <p class="text-muted mb-0">You have no message conversations yet.</p>
                            </div>

                            <!-- Message items -->
                            <div *ngFor="let thread of getDisplayThreads()"
                                 class="text-reset message-item d-block p-3 border-bottom cursor-pointer"
                                 [ngClass]="{'bg-light-subtle': thread.unreadCount > 0}"
                                 (click)="onThreadClick(thread)">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm rounded-circle bg-primary-subtle">
                                            <span class="avatar-title rounded-circle bg-primary-subtle text-primary fs-14 fw-medium">
                                                {{ getInitials(getThreadDisplayName(thread)) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 overflow-hidden">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <h6 class="mb-0 fs-14 text-truncate" [ngClass]="{'fw-semibold': thread.unreadCount > 0}">
                                                {{ getThreadDisplayName(thread) }}
                                            </h6>
                                            <span class="text-muted fs-11 flex-shrink-0 ms-2">
                                                {{ formatMessageTime(thread.lastMessageAt) }}
                                            </span>
                                        </div>
                                        <p class="mb-1 fs-13 text-truncate" [ngClass]="{'text-body fw-medium': thread.unreadCount > 0, 'text-muted': thread.unreadCount === 0}">
                                            {{ thread.subject }}
                                        </p>
                                        <p class="mb-0 fs-12 text-muted text-truncate">
                                            <span class="fw-medium" [class.text-primary]="isLastMessageByMe(thread)">{{ getLastSenderDisplay(thread) }}: </span>{{ thread.lastMessage }}
                                        </p>
                                        <div class="d-flex align-items-center mt-1" *ngIf="thread.unreadCount > 0">
                                            <span class="badge bg-danger rounded-pill fs-10">{{ thread.unreadCount }} new</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="p-2 border-top text-center">
                            <button type="button" class="btn btn-sm btn-soft-primary w-100" (click)="navigateToMessages()">
                                View All Messages <i class="ri-arrow-right-line ms-1"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notification Dropdown -->
                <div class="dropdown ms-1 header-item" ngbDropdown #notificationDropdown="ngbDropdown" display="dynamic" placement="bottom-end" (openChange)="onNotificationDropdownToggle($event)">
                    <button type="button" class="btn btn-icon btn-topbar material-shadow-none btn-ghost-secondary rounded-circle position-relative notification-bell"
                            ngbDropdownToggle
                            id="page-header-notifications-dropdown"
                            [ngClass]="{'has-new-notifications': hasNewNotifications}"
                            aria-haspopup="true"
                            aria-expanded="false"
                            (click)="$event.stopPropagation()">
                        <i class="bx bx-bell fs-22"></i>
                        <span *ngIf="unreadNotificationCount > 0" class="position-absolute topbar-badge fs-10 translate-middle badge rounded-pill bg-danger">
                            {{ unreadNotificationCount || '' }}
                            <span class="visually-hidden">unread notifications</span>
                        </span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0 custom-notification-dropdown overflow-hidden" ngbDropdownMenu aria-labelledby="page-header-notifications-dropdown">
                        <div class="dropdown-head bg-primary bg-pattern rounded-top">
                            <div class="p-3">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h6 class="m-0 fs-16 fw-semibold text-white">
                                            <i class="bx bx-bell-ring me-2"></i>Notifications
                                        </h6>
                                    </div>
                                    <div class="col-auto dropdown-tabs">
                                        <span class="badge bg-light-subtle text-dark fs-13" *ngIf="pushNotifications.length > 0">
                                            {{ pushNotifications.length }} <span class="text-nowrap">{{ hasUnreadNotifications() ? '(' + getUnreadCount() + ' new)' : '' }}</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content position-relative">
                            <div class="tab-pane fade show active py-2 ps-2" id="all-noti-tab" role="tabpanel">
                                <div class="notification-list-scroll" style="max-height: 300px;" data-simplebar>
                                    <!-- Empty state with improved styling -->
                                    <div *ngIf="pushNotifications.length === 0" class="text-center p-4 empty-notification">
                                        <div class="avatar-md mx-auto mb-4">
                                            <div class="avatar-title bg-light-subtle text-primary rounded-circle fs-24">
                                                <i class="bx bx-bell-off"></i>
                                            </div>
                                        </div>
                                        <h5 class="mb-1 font-size-16">No Notifications</h5>
                                        <p class="text-muted mb-0">You have no notifications at the moment.</p>
                                    </div>

                                    <!-- Notification items with improved styling -->
                                    <div *ngFor="let notification of pushNotifications; let i = index" 
                                         class="text-reset notification-item d-block p-2 position-relative" 
                                         [ngClass]="{'bg-light-subtle': !notification.read}"
                                         [style]="{'--index': i}"
                                         (click)="onNotificationClick(notification)">
                                        <div class="d-flex">
                                            <div class="flex-shrink-0 me-3">
                                                <div class="avatar-xs rounded-circle" [ngClass]="getNotificationIconClass(notification)">
                                                    <i [ngClass]="getNotificationIcon(notification)"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 fs-14 notification-title" [ngClass]="!notification.read ? 'fw-semibold' : ''">
                                                    {{ notification.title }}
                                                </h6>
                                                <div class="font-size-13 notification-text">
                                                    <p class="mb-1" [ngClass]="!notification.read ? 'notification-text-unread' : ''">
                                                        {{ notification.body }}
                                                    </p>
                                                </div>
                                                <p class="mb-0 font-size-11 text-muted">
                                                    <i class="mdi mdi-clock-outline"></i>
                                                    <span>{{ notification.timestamp | date:'shortTime' }}</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-2 mt-2 border-top">
                            <div class="row g-2">
                                <div class="col">
                                    <button type="button" (click)="markAllAsRead()" class="btn btn-sm btn-light" *ngIf="hasUnreadNotifications()">
                                        <i class="ri-check-double-line align-bottom"></i> Mark All Read
                                    </button>
                                    <button type="button" (click)="sendTestNotification()" class="btn btn-sm btn-light" *ngIf="!hasUnreadNotifications()">
                                        <i class="ri-notification-3-line align-bottom"></i> Test
                                    </button>
                                    <button type="button" (click)="clearAllNotifications()" class="btn btn-sm btn-light ms-2" *ngIf="pushNotifications.length > 0">
                                        <i class="ri-delete-bin-line align-bottom"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Background Tasks Indicator - AI Workspace Tasks (placed after bell, before profile) -->
                <div class="ms-1 header-item">
                    <app-background-tasks-indicator
                      (viewTask)="onBackgroundTaskView($event)">
                    </app-background-tasks-indicator>
                </div>

                <div *ngIf="user$ | async as user" class="dropdown ms-sm-3 header-item topbar-user" ngbDropdown display="dynamic" placement="bottom-end" container="body">
                    <button type="button" class="btn material-shadow-none" id="page-header-user-dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" ngbDropdownToggle>
                        <span class="d-flex align-items-center">
                            <img class="rounded-circle header-profile-user" [src]="user?.imageUrl | imageUrl" alt="Header Avatar" (error)="$event.target.src = 'assets/images/users/default-avatar.jpg'">
                            <span class="text-start ms-xl-2">
                                <span class="d-none d-xl-inline-block ms-1 fw-medium user-name-text">{{ user.firstName }} {{ user.lastName }}</span>
                                <span class="d-none d-xl-block ms-1 fs-12 user-name-sub-text">{{ user.title }}</span>
                            </span>
                        </span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end user-profile-dropdown" ngbDropdownMenu>
                        <a class="dropdown-item" routerLink="/user"><i class="mdi mdi-account-circle text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Profile</span></a>
                        <a class="dropdown-item" routerLink="/case-management/tasks"><i class="mdi mdi-calendar-check-outline text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Taskboard</span></a>
                        <a class="dropdown-item" routerLink="/faqs"><i class="mdi mdi-lifebuoy text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Help</span></a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="javascript:void(0);" (click)="logOut()"><i class="mdi mdi-logout text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Logout</span></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- removeNotificationModal -->
<ng-template #removenotification let-modal>
    <div class="modal-content border-0">
        <div class="modal-header p-3" [ngClass]="{'bg-primary-subtle': activeNotification?.type === 'default', 
                          'bg-info-subtle': activeNotification?.type === 'case',
                          'bg-warning-subtle': activeNotification?.type === 'deadline',
                          'bg-success-subtle': activeNotification?.type === 'document',
                          'bg-danger-subtle': activeNotification?.type === 'alert',
                          'bg-purple-subtle': activeNotification?.type === 'court'}">
            <div class="d-flex align-items-center">
                <div class="notification-icon me-3 rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;" 
                     [ngClass]="{'bg-primary': activeNotification?.type === 'default', 
                              'bg-info': activeNotification?.type === 'case',
                              'bg-warning': activeNotification?.type === 'deadline',
                              'bg-success': activeNotification?.type === 'document',
                              'bg-danger': activeNotification?.type === 'alert',
                              'bg-purple': activeNotification?.type === 'court'}">
                    <i class="text-white" [ngClass]="getNotificationIcon(activeNotification)"></i>
                </div>
                <div>
                    <h5 class="modal-title fw-semibold mb-0" [ngClass]="{'text-primary': activeNotification?.type === 'default', 
                                 'text-info': activeNotification?.type === 'case',
                                 'text-warning': activeNotification?.type === 'deadline',
                                 'text-success': activeNotification?.type === 'document',
                                 'text-danger': activeNotification?.type === 'alert',
                                 'text-purple': activeNotification?.type === 'court'}">
                        {{ activeNotification?.title || 'Notification Details' }}
                    </h5>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="NotificationModalbtn-close" (click)="modal.dismiss('Cross click')"></button>
        </div>
        <div class="modal-body p-4">
            <div class="notification-details">
                <div class="notification-content mb-4" *ngIf="activeNotification">
                    <!-- Priority badge -->
                    <div class="mb-4" *ngIf="activeNotification.data?.priority === 'high'">
                        <div class="d-flex align-items-center p-2 bg-danger-subtle text-danger rounded">
                            <i class="bx bx-error-circle fs-22 text-danger me-2"></i>
                            <div>
                                <h6 class="fs-15 fw-semibold text-danger mb-0">High Priority Notification</h6>
                                <p class="text-muted mb-0 fs-13">This notification requires immediate attention</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main notification body content -->
                    <div class="p-3 border-start border-4 rounded bg-light-subtle mb-4 position-relative shadow-sm"
                         [ngClass]="{'border-primary': activeNotification?.type === 'default', 
                                     'border-info': activeNotification?.type === 'case',
                                     'border-warning': activeNotification?.type === 'deadline',
                                     'border-success': activeNotification?.type === 'document',
                                     'border-danger': activeNotification?.type === 'alert',
                                     'border-purple': activeNotification?.type === 'court'}">
                        <p class="mb-0 fs-15 lh-base">{{ activeNotification.body }}</p>
                    </div>
                    
                    <!-- Task Assignment Details (if available) -->
                    <div *ngIf="activeNotification.data?.taskDetails" class="mb-4 p-3 rounded bg-success-subtle border border-success shadow-sm">
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar-xs me-3 flex-shrink-0 rounded-circle bg-success text-white">
                                <i class="bx bx-task fs-16"></i>
                            </div>
                            <h6 class="mb-0 fs-15 fw-semibold text-success">Task Assignment Details</h6>
                        </div>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="info-item">
                                    <label class="fs-12 fw-medium text-muted text-uppercase mb-1">Assigned To</label>
                                    <p class="mb-0 fs-14 fw-medium">{{ activeNotification.data.taskDetails.assignedTo }}</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="info-item">
                                    <label class="fs-12 fw-medium text-muted text-uppercase mb-1">Task Count</label>
                                    <p class="mb-0 fs-14 fw-medium">{{ activeNotification.data.taskDetails.taskCount }} task{{ activeNotification.data.taskDetails.taskCount > 1 ? 's' : '' }}</p>
                                </div>
                            </div>
                            <div class="col-12" *ngIf="activeNotification.data.taskDetails.taskTitle">
                                <div class="info-item">
                                    <label class="fs-12 fw-medium text-muted text-uppercase mb-1">Task Title</label>
                                    <p class="mb-0 fs-14 fw-medium">{{ activeNotification.data.taskDetails.taskTitle }}</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="info-item">
                                    <label class="fs-12 fw-medium text-muted text-uppercase mb-1">Case</label>
                                    <p class="mb-0 fs-14 fw-medium">{{ activeNotification.data.taskDetails.caseTitle }}</p>
                                    <p class="mb-0 fs-12 text-muted">{{ activeNotification.data.taskDetails.caseNumber }}</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="info-item">
                                    <label class="fs-12 fw-medium text-muted text-uppercase mb-1">Assignment Date</label>
                                    <p class="mb-0 fs-14 fw-medium">{{ activeNotification.data.taskDetails.assignmentDate | date:'short' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time info -->
                    <div class="d-flex align-items-center mb-4 p-3 rounded bg-light-subtle border shadow-sm">
                        <div class="avatar-xs me-3 flex-shrink-0 rounded-circle bg-primary-subtle text-primary">
                            <i class="bx bx-time fs-16"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fs-14 fw-medium">Received</h6>
                            <p class="text-muted mb-0 fs-13">
                                {{ activeNotification.timestamp | date:'EEEE, MMMM d, y, h:mm a' }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal" (click)="modal.dismiss('Close')">
                <i class="ri-close-line me-1 align-middle"></i> Close
            </button>
            <button type="button" class="btn btn-primary" *ngIf="activeNotification?.data?.url" (click)="modal.close('Navigate')">
                <i class="bx bx-link-external me-1 align-middle"></i> Open Related Item
            </button>
        </div>
    </div>
</ng-template>

<!-- Hidden audio element for notification sound -->
<audio id="notificationSound" preload="auto" style="display: none;">
    <source src="/assets/sounds/notification.mp3" type="audio/mpeg">
</audio>
