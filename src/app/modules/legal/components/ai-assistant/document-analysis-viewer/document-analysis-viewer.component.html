<div class="document-analysis-viewer" #viewerContainer>
  <!-- Top Action Bar -->
  <div class="viewer-action-bar">
    <div class="action-bar-left">
      <button class="btn btn-link back-btn" (click)="onClose()" title="Back to upload">
        <i class="ri-arrow-left-line"></i>
      </button>

      <div class="document-info">
        <h5 class="document-title mb-0">
          <i class="ri-file-text-line me-2"></i>
          {{ getCleanFileName(document.fileName) }}
        </h5>
        <div class="document-meta">
          <span class="badge me-2" [ngClass]="getDocTypeColorClass(document.detectedType)">
            {{ document.detectedType || 'Document' }}
          </span>
          <span class="meta-item text-muted">
            <i class="ri-file-info-line me-1"></i>
            {{ formatFileSize(document.fileSize) }}
          </span>
          <span class="meta-item text-muted ms-2">
            <i class="ri-time-line me-1"></i>
            {{ formatDate(document.timestamp) }}
          </span>
        </div>
      </div>
    </div>

    <div class="action-bar-right">
      <!-- Toggle Sidebar Button -->
      <button class="btn btn-soft-secondary btn-sm me-2"
              (click)="toggleSidebarCollapsed()"
              [title]="(viewerSidebarCollapsed$ | async) ? 'Show sidebar' : 'Hide sidebar for full width'">
        <i [class]="(viewerSidebarCollapsed$ | async) ? 'ri-layout-right-line' : 'ri-layout-left-line'"></i>
      </button>

      <!-- Add to Collection Button -->
      <button class="btn btn-soft-info btn-sm me-2" (click)="openAddToCollectionModal()" title="Add to Collection">
        <i class="ri-folder-add-line me-1"></i>
        Collection
      </button>

      <!-- Compare Button (future feature) -->
      <button class="btn btn-soft-secondary btn-sm me-2" disabled title="Compare with another document (coming soon)">
        <i class="ri-file-copy-2-line me-1"></i>
        Compare
      </button>

      <!-- Export Dropdown -->
      <div class="btn-group" ngbDropdown>
        <button id="export-dropdown" ngbDropdownToggle type="button" class="btn btn-primary btn-sm">
          <i class="ri-download-line me-1"></i>
          Export
        </button>
        <div ngbDropdownMenu class="dropdown-menu dropdown-menu-end">
          <a class="dropdown-item" (click)="onExportPdf()">
            <i class="ri-file-pdf-line me-2 text-danger"></i>
            Export as PDF
          </a>
          <a class="dropdown-item" (click)="onExportWord()">
            <i class="ri-file-word-line me-2 text-primary"></i>
            Export as Word
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" (click)="onSaveToFileManager()">
            <i class="ri-folder-upload-line me-2 text-success"></i>
            Save to File Manager
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="viewer-tabs">
    <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" class="nav nav-tabs nav-tabs-custom">
      <li [ngbNavItem]="'overview'" *ngIf="visibleTabs.overview">
        <a ngbNavLink>
          <i class="ri-file-list-3-line me-1"></i>
          Overview
        </a>
        <ng-template ngbNavContent>
          <div class="tab-content-wrapper">
            <div class="analysis-content card">
              <div class="card-body">
                <!-- Summary Card -->
                <div class="summary-card mb-4" *ngIf="document.analysis?.summary">
                  <div class="summary-header">
                    <i class="ri-lightbulb-flash-line"></i>
                    <h6>Executive Summary</h6>
                  </div>
                  <div class="summary-text" [innerHTML]="document.analysis.summary | markdownToHtml"></div>
                </div>

                <!-- Key Insights Grid -->
                <div class="insights-grid mb-4" *ngIf="partiesInfo || timelineEventsCount > 0 || actionItemsCount > 0">
                  <div class="insight-card" *ngIf="partiesInfo">
                    <div class="insight-icon bg-soft-primary text-primary">
                      <i class="ri-user-line"></i>
                    </div>
                    <div class="insight-content">
                      <span class="insight-label">Parties</span>
                      <span class="insight-value">{{ partiesInfo }}</span>
                    </div>
                  </div>
                  <div class="insight-card" *ngIf="timelineEventsCount > 0">
                    <div class="insight-icon bg-soft-info text-info">
                      <i class="ri-calendar-line"></i>
                    </div>
                    <div class="insight-content">
                      <span class="insight-label">Timeline Events</span>
                      <span class="insight-value">{{ timelineEventsCount }} events</span>
                    </div>
                  </div>
                  <div class="insight-card" *ngIf="actionItemsCount > 0">
                    <div class="insight-icon bg-soft-success text-success">
                      <i class="ri-checkbox-circle-line"></i>
                    </div>
                    <div class="insight-content">
                      <span class="insight-label">Action Items</span>
                      <span class="insight-value">{{ actionItemsCount }} items</span>
                    </div>
                  </div>
                </div>

                <!-- Full Analysis -->
                <div class="full-analysis">
                  <h6 class="section-title">
                    <i class="ri-file-text-line me-2"></i>
                    Strategic Analysis
                  </h6>
                  <div class="analysis-text"
                       [innerHTML]="parsedSections.overview | markdownToHtml">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>

      <li [ngbNavItem]="'actions'" *ngIf="visibleTabs.actions">
        <a ngbNavLink>
          <i class="ri-checkbox-multiple-line me-1"></i>
          Action Items
        </a>
        <ng-template ngbNavContent>
          <div class="tab-content-wrapper">
            <div class="card">
              <div class="card-body">
                <app-action-items-list
                  *ngIf="document.databaseId"
                  [analysisId]="document.databaseId">
                </app-action-items-list>
                <div class="empty-state" *ngIf="!document.databaseId">
                  <i class="ri-checkbox-circle-line empty-icon"></i>
                  <p>No action items available</p>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>

      <li [ngbNavItem]="'timeline'" *ngIf="visibleTabs.timeline">
        <a ngbNavLink>
          <i class="ri-calendar-event-line me-1"></i>
          Timeline
        </a>
        <ng-template ngbNavContent>
          <div class="tab-content-wrapper">
            <div class="card">
              <div class="card-body">
                <app-timeline-view
                  *ngIf="document.databaseId"
                  [analysisId]="document.databaseId">
                </app-timeline-view>
                <div class="empty-state" *ngIf="!document.databaseId">
                  <i class="ri-calendar-line empty-icon"></i>
                  <p>No timeline events available</p>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>

      <li [ngbNavItem]="'risk'" *ngIf="visibleTabs.keyFindings">
        <a ngbNavLink>
          <i class="ri-focus-3-line me-1"></i>
          Key Findings
        </a>
        <ng-template ngbNavContent>
          <div class="tab-content-wrapper">
            <div class="card">
              <div class="card-body">
                <!-- Weaknesses Section -->
                <div class="risk-section mb-4" *ngIf="parsedSections.weaknesses">
                  <h6 class="section-title text-danger">
                    <i class="ri-alert-line me-2"></i>
                    Identified Weaknesses
                  </h6>
                  <div class="section-content" [innerHTML]="parsedSections.weaknesses | markdownToHtml"></div>
                </div>

                <!-- Evidence Section -->
                <div class="risk-section mb-4" *ngIf="parsedSections.evidence">
                  <h6 class="section-title text-info">
                    <i class="ri-file-search-line me-2"></i>
                    Evidence Analysis
                  </h6>
                  <div class="section-content" [innerHTML]="parsedSections.evidence | markdownToHtml"></div>
                </div>

                <!-- Strategy Section -->
                <div class="risk-section" *ngIf="parsedSections.strategy">
                  <h6 class="section-title text-success">
                    <i class="ri-lightbulb-line me-2"></i>
                    Recommended Strategy
                  </h6>
                  <div class="section-content" [innerHTML]="parsedSections.strategy | markdownToHtml"></div>
                </div>

                <!-- Empty state if no sections found -->
                <div class="empty-state" *ngIf="!parsedSections.weaknesses && !parsedSections.evidence && !parsedSections.strategy">
                  <i class="ri-focus-3-line empty-icon"></i>
                  <p>Key findings will be extracted from specific document types (complaints, motions, briefs)</p>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>

      <!-- Contract-specific tabs -->
      <li [ngbNavItem]="'key-terms'" *ngIf="visibleTabs.keyTerms">
        <a ngbNavLink>
          <i class="ri-money-dollar-circle-line me-1"></i>
          Key Terms
        </a>
        <ng-template ngbNavContent>
          <div class="tab-content-wrapper">
            <div class="card">
              <div class="card-body">
                <div class="contract-section" *ngIf="contractSections.keyTerms">
                  <h6 class="section-title text-primary">
                    <i class="ri-money-dollar-circle-line me-2"></i>
                    Financial &amp; Key Terms
                  </h6>
                  <div class="section-content" [innerHTML]="contractSections.keyTerms | markdownToHtml"></div>
                </div>
                <div class="empty-state" *ngIf="!contractSections.keyTerms">
                  <i class="ri-money-dollar-circle-line empty-icon"></i>
                  <p>No key terms section found in this contract analysis</p>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>

      <li [ngbNavItem]="'risk-assessment'" *ngIf="visibleTabs.riskAssessment">
        <a ngbNavLink>
          <i class="ri-shield-check-line me-1"></i>
          Risk Assessment
        </a>
        <ng-template ngbNavContent>
          <div class="tab-content-wrapper">
            <div class="card">
              <div class="card-body">
                <div class="contract-section" *ngIf="contractSections.riskAssessment">
                  <h6 class="section-title text-danger">
                    <i class="ri-error-warning-line me-2"></i>
                    Unfavorable Clauses &amp; Risks
                  </h6>
                  <div class="section-content" [innerHTML]="contractSections.riskAssessment | markdownToHtml"></div>
                </div>
                <div class="empty-state" *ngIf="!contractSections.riskAssessment">
                  <i class="ri-shield-check-line empty-icon"></i>
                  <p>No risk assessment section found in this contract analysis</p>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>

      <li [ngbNavItem]="'obligations'" *ngIf="visibleTabs.obligations">
        <a ngbNavLink>
          <i class="ri-file-list-2-line me-1"></i>
          Obligations
        </a>
        <ng-template ngbNavContent>
          <div class="tab-content-wrapper">
            <div class="card">
              <div class="card-body">
                <div class="contract-section" *ngIf="contractSections.obligations">
                  <h6 class="section-title text-warning">
                    <i class="ri-door-open-line me-2"></i>
                    Termination &amp; Obligations
                  </h6>
                  <div class="section-content" [innerHTML]="contractSections.obligations | markdownToHtml"></div>
                </div>
                <div class="empty-state" *ngIf="!contractSections.obligations">
                  <i class="ri-file-list-2-line empty-icon"></i>
                  <p>No obligations section found in this contract analysis</p>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>

      <li [ngbNavItem]="'ask-ai'" *ngIf="visibleTabs.askAi">
        <a ngbNavLink>
          <i class="ri-question-answer-line me-1"></i>
          Ask AI
        </a>
        <ng-template ngbNavContent>
          <div class="tab-content-wrapper ask-ai-tab">
            <div class="card h-100">
              <div class="card-body d-flex flex-column">
                <!-- Chat Messages Area -->
                <div class="chat-messages-area flex-grow-1">
                  <!-- Empty State -->
                  <div class="ask-ai-empty" *ngIf="askAiMessages.length === 0">
                    <div class="empty-icon">
                      <i class="ri-question-answer-line"></i>
                    </div>
                    <h6>Ask questions about this document</h6>
                    <p class="text-muted">
                      I can help you understand specific clauses, identify risks,
                      or explain legal implications of {{ getCleanFileName(document.fileName) }}.
                    </p>
                    <div class="suggested-questions">
                      <button class="suggested-btn"
                              *ngFor="let sq of suggestedQuestions"
                              (click)="askSuggestedQuestion(sq.question)">
                        <i [class]="sq.icon + ' me-1'"></i>
                        {{ sq.text }}
                      </button>
                    </div>
                  </div>

                  <!-- Messages List (same style as ai-workspace) -->
                  <ul class="list-unstyled chat-conversation-list" *ngIf="askAiMessages.length > 0">
                    <li *ngFor="let msg of askAiMessages"
                        class="chat-list"
                        [ngClass]="{ 'right': msg.role === 'user', 'left': msg.role === 'assistant' }">

                      <!-- User Message -->
                      <div class="conversation-list" *ngIf="msg.role === 'user'">
                        <div class="user-chat-content mb-4">
                          <div class="message-bubble bg-soft-info text-info">
                            <div class="message-content">
                              <p class="mb-0" [innerHTML]="msg.content | markdownToHtml"></p>
                            </div>
                            <div class="message-meta">
                              <small class="text-muted">{{ formatDate(msg.timestamp) }}</small>
                              <i class="ri-check-double-line ms-1 text-success"></i>
                            </div>
                          </div>
                        </div>
                        <!-- User Avatar (right side) -->
                        <div class="chat-avatar ms-3">
                          <div class="avatar-sm">
                            <div class="avatar-title bg-success-subtle text-success rounded-circle">
                              <i class="ri-user-3-fill"></i>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- AI Message -->
                      <div class="ai-message-container" *ngIf="msg.role === 'assistant'">
                        <div class="d-flex align-items-start gap-3">
                          <div class="chat-avatar flex-shrink-0">
                            <img src="/assets/images/new-legal-ai.gif" alt="AI">
                          </div>
                          <div class="message-bubble ai-message flex-grow-1">
                            <div class="message-content" [innerHTML]="msg.content | markdownToHtml"></div>
                            <div class="message-meta">
                              <small class="text-muted">{{ formatDate(msg.timestamp) }}</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </li>

                    <!-- Typing Indicator -->
                    <li class="chat-list left" *ngIf="isAskingAi">
                      <div class="ai-message-container">
                        <div class="d-flex align-items-start gap-3">
                          <div class="chat-avatar flex-shrink-0">
                            <img src="/assets/images/new-legal-ai.gif" alt="AI">
                          </div>
                          <div class="message-bubble ai-message flex-grow-1">
                            <div class="typing-indicator">
                              <span></span>
                              <span></span>
                              <span></span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </li>

                    <!-- Follow-up Action Chips -->
                    <li class="follow-up-actions" *ngIf="followUpActions.length > 0 && !isAskingAi">
                      <div class="follow-up-label">
                        <i class="ri-arrow-right-line me-1"></i>
                        Quick follow-ups:
                      </div>
                      <div class="follow-up-chips">
                        <button class="follow-up-chip"
                                *ngFor="let action of followUpActions"
                                (click)="askSuggestedQuestion(action.question)">
                          <i [class]="action.icon + ' me-1'"></i>
                          {{ action.text }}
                        </button>
                      </div>
                    </li>
                  </ul>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-area">
                  <div class="input-wrapper">
                    <textarea
                      class="form-control"
                      [(ngModel)]="askAiQuestion"
                      placeholder="Ask a question about this document..."
                      rows="2"
                      (keydown.enter)="onEnterPress($event)"
                      [disabled]="isAskingAi">
                    </textarea>
                    <button
                      class="btn btn-primary send-btn"
                      (click)="askQuestion()"
                      [disabled]="!askAiQuestion.trim() || isAskingAi">
                      <i class="ri-send-plane-fill"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>

      <!-- Related Documents Tab -->
      <li [ngbNavItem]="'related'" *ngIf="visibleTabs.related">
        <a ngbNavLink>
          <i class="ri-links-line me-1"></i>
          Related
          <span class="badge bg-soft-primary text-primary ms-1" *ngIf="documentRelationships.length > 0">
            {{ documentRelationships.length }}
          </span>
        </a>
        <ng-template ngbNavContent>
          <div class="tab-content-wrapper related-tab">
            <div class="card h-100">
              <div class="card-body">
                <!-- Loading State -->
                <div class="text-center py-4" *ngIf="loadingRelationships">
                  <div class="spinner-border text-primary spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="text-muted mt-2 mb-0">Loading relationships...</p>
                </div>

                <!-- Header with Link Button -->
                <div class="d-flex align-items-center justify-content-between mb-3" *ngIf="!loadingRelationships">
                  <h6 class="mb-0">Related Documents</h6>
                  <button class="btn btn-primary btn-sm" (click)="openLinkDocumentModal()">
                    <i class="ri-link me-1"></i> Link Document
                  </button>
                </div>

                <!-- Empty State -->
                <div class="related-empty text-center py-5" *ngIf="!loadingRelationships && documentRelationships.length === 0">
                  <div class="empty-icon mb-3">
                    <i class="ri-git-branch-line text-muted" style="font-size: 3rem;"></i>
                  </div>
                  <h6 class="text-muted">No linked documents</h6>
                  <p class="text-muted small mb-3">
                    Link this document to related files like amendments, responses, or exhibits.
                  </p>
                  <button class="btn btn-soft-primary" (click)="openLinkDocumentModal()">
                    <i class="ri-link me-1"></i> Link a Document
                  </button>
                </div>

                <!-- Relationships List -->
                <div class="relationships-list" *ngIf="!loadingRelationships && documentRelationships.length > 0">
                  <div class="relationship-item"
                       *ngFor="let rel of documentRelationships"
                       [ngClass]="{'incoming': rel.direction === 'incoming', 'outgoing': rel.direction === 'outgoing'}">
                    <div class="relationship-direction">
                      <i *ngIf="rel.direction === 'outgoing'" class="ri-arrow-right-line text-primary"></i>
                      <i *ngIf="rel.direction === 'incoming'" class="ri-arrow-left-line text-success"></i>
                    </div>
                    <div class="relationship-content">
                      <div class="relationship-type">
                        <span class="badge" [ngClass]="{
                          'bg-soft-primary text-primary': rel.relationshipType === 'RESPONDS_TO',
                          'bg-soft-warning text-warning': rel.relationshipType === 'AMENDS',
                          'bg-soft-danger text-danger': rel.relationshipType === 'SUPERSEDES',
                          'bg-soft-info text-info': rel.relationshipType === 'REFERENCES',
                          'bg-soft-secondary text-secondary': rel.relationshipType === 'EXHIBITS'
                        }">
                          {{ getRelationshipLabel(rel.relationshipType) }}
                        </span>
                      </div>
                      <div class="related-doc-info">
                        <div class="related-doc-name">{{ getCleanFileName(rel.relatedDocument.fileName) }}</div>
                        <div class="related-doc-meta">
                          <span class="badge bg-light text-dark me-2">{{ rel.relatedDocument.detectedType }}</span>
                          <small class="text-muted">{{ rel.relatedDocument.createdAt | date:'shortDate' }}</small>
                        </div>
                      </div>
                      <div class="relationship-description" *ngIf="rel.description">
                        <small class="text-muted">{{ rel.description }}</small>
                      </div>
                    </div>
                    <div class="relationship-actions">
                      <button class="btn btn-sm btn-soft-danger" (click)="deleteRelationship(rel.id)" title="Remove link">
                        <i class="ri-close-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>
    </ul>
  </div>

  <!-- Tab Content -->
  <div [ngbNavOutlet]="nav" class="nav-content"></div>

  <!-- Scroll to Top Button -->
  <button class="scroll-to-top-btn"
          *ngIf="showScrollToTop"
          (click)="scrollToTop()"
          title="Back to top">
    <i class="ri-arrow-up-line"></i>
  </button>
</div>

<!-- Link Document Modal -->
<div class="modal fade" [class.show]="showLinkDocumentModal" [style.display]="showLinkDocumentModal ? 'block' : 'none'"
     tabindex="-1" aria-modal="true" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ri-link me-2"></i>Link Related Document
        </h5>
        <button type="button" class="btn-close" (click)="closeLinkDocumentModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Relationship Type Selection -->
        <div class="mb-3">
          <label class="form-label">Relationship Type</label>
          <select class="form-select" [(ngModel)]="linkDocumentForm.relationshipType">
            <option value="">Select relationship...</option>
            <option *ngFor="let type of relationshipTypes" [value]="type.id">
              {{ type.label }} - {{ type.description }}
            </option>
          </select>
          <div class="form-text">How is this document related to the target?</div>
        </div>

        <!-- Document Search -->
        <div class="mb-3">
          <label class="form-label">Search Document</label>
          <input type="text" class="form-control"
                 [(ngModel)]="linkDocumentSearchQuery"
                 (input)="searchDocumentsForLink()"
                 placeholder="Search by file name...">
        </div>

        <!-- Search Results -->
        <div class="link-document-results" *ngIf="linkDocumentSearchResults.length > 0">
          <label class="form-label small text-muted">Select document to link:</label>
          <div class="list-group">
            <button type="button"
                    class="list-group-item list-group-item-action"
                    *ngFor="let doc of linkDocumentSearchResults"
                    [class.active]="linkDocumentForm.targetAnalysisId === doc.databaseId"
                    (click)="selectDocumentToLink(doc)">
              <div class="d-flex align-items-center gap-2">
                <i class="ri-file-text-line"></i>
                <div class="flex-grow-1">
                  <div class="fw-medium">{{ getCleanFileName(doc.fileName) }}</div>
                  <div class="small text-muted">
                    <span class="badge bg-light text-dark me-1">{{ doc.detectedType }}</span>
                    {{ doc.createdAt | date:'shortDate' }}
                  </div>
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- No results -->
        <div class="text-muted text-center py-3" *ngIf="linkDocumentSearchQuery && linkDocumentSearchResults.length === 0 && !isSearchingDocuments">
          <i class="ri-file-unknow-line fs-4"></i>
          <p class="small mb-0">No documents found</p>
        </div>

        <!-- Loading -->
        <div class="text-center py-3" *ngIf="isSearchingDocuments">
          <div class="spinner-border spinner-border-sm text-primary"></div>
        </div>

        <!-- Description (optional) -->
        <div class="mb-3 mt-3" *ngIf="linkDocumentForm.targetAnalysisId">
          <label class="form-label">Description (optional)</label>
          <input type="text" class="form-control"
                 [(ngModel)]="linkDocumentForm.description"
                 placeholder="Add a note about this relationship...">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="closeLinkDocumentModal()">Cancel</button>
        <button type="button" class="btn btn-primary"
                [disabled]="!linkDocumentForm.relationshipType || !linkDocumentForm.targetAnalysisId || isCreatingLink"
                (click)="createDocumentLink()">
          <span *ngIf="!isCreatingLink">
            <i class="ri-link me-1"></i> Link Document
          </span>
          <span *ngIf="isCreatingLink">
            <span class="spinner-border spinner-border-sm me-1"></span> Linking...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showLinkDocumentModal" *ngIf="showLinkDocumentModal"></div>

<!-- Add to Collection Modal -->
<div class="modal fade" [class.show]="showAddToCollectionModal" [style.display]="showAddToCollectionModal ? 'block' : 'none'"
     tabindex="-1" aria-modal="true" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ri-folder-add-line me-2"></i>Add to Collection
        </h5>
        <button type="button" class="btn-close" (click)="closeAddToCollectionModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Loading Collections -->
        <div class="text-center py-4" *ngIf="isLoadingCollections">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <p class="text-muted mt-2 mb-0">Loading collections...</p>
        </div>

        <!-- Collections List -->
        <div *ngIf="!isLoadingCollections">
          <!-- Current Collections Badge -->
          <div class="mb-3" *ngIf="documentCollections.length > 0">
            <label class="form-label small text-muted">Already in collections:</label>
            <div class="d-flex flex-wrap gap-1">
              <span class="badge bg-success-subtle text-success" *ngFor="let col of documentCollections">
                <i class="ri-folder-line me-1"></i>{{ col.name }}
              </span>
            </div>
          </div>

          <label class="form-label">Select a collection:</label>
          <div class="list-group mb-3" *ngIf="availableCollections.length > 0">
            <button type="button"
                    class="list-group-item list-group-item-action"
                    *ngFor="let col of availableCollections"
                    [class.active]="selectedCollectionId === col.id"
                    (click)="selectCollection(col.id)">
              <div class="d-flex align-items-center gap-2">
                <div class="collection-color-dot" [style.background-color]="col.color || '#405189'"></div>
                <div class="flex-grow-1">
                  <div class="fw-medium">{{ col.name }}</div>
                  <small class="text-muted">{{ col.documentCount || 0 }} documents</small>
                </div>
                <i class="ri-check-line text-success" *ngIf="selectedCollectionId === col.id"></i>
              </div>
            </button>
          </div>

          <!-- No collections -->
          <div class="text-muted text-center py-3" *ngIf="availableCollections.length === 0 && documentCollections.length === 0">
            <i class="ri-folder-line fs-3"></i>
            <p class="small mb-0">No collections available</p>
          </div>

          <!-- Create New Collection -->
          <div class="border-top pt-3 mt-3">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="createNewCollection"
                     [(ngModel)]="createNewCollectionMode">
              <label class="form-check-label" for="createNewCollection">
                Create new collection
              </label>
            </div>
            <div *ngIf="createNewCollectionMode">
              <input type="text" class="form-control mb-2"
                     [(ngModel)]="newCollectionName"
                     placeholder="Collection name...">
              <input type="text" class="form-control"
                     [(ngModel)]="newCollectionDescription"
                     placeholder="Description (optional)...">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="closeAddToCollectionModal()">Cancel</button>
        <button type="button" class="btn btn-primary"
                [disabled]="(!selectedCollectionId && !createNewCollectionMode) || (createNewCollectionMode && !newCollectionName) || isAddingToCollection"
                (click)="addToCollection()">
          <span *ngIf="!isAddingToCollection">
            <i class="ri-add-line me-1"></i> Add to Collection
          </span>
          <span *ngIf="isAddingToCollection">
            <span class="spinner-border spinner-border-sm me-1"></span> Adding...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showAddToCollectionModal" *ngIf="showAddToCollectionModal"></div>
