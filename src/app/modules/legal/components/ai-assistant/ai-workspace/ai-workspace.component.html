<!-- ============================================ -->
<!-- DRAFTING PAGE - VELZON THEME DESIGN -->
<!-- 3-Column Layout: Conversations | Main | Chat -->
<!-- ============================================ -->

<div class="drafting-container" style="max-width: 100%;">

  <!-- Mobile Menu Toggle Button - Opens history bottom sheet (hidden when in conversation) -->
  <button class="mobile-menu-toggle"
          *ngIf="!(showChat$ | async) && !(isGenerating$ | async) && !(draftingMode$ | async) && !(documentViewerMode$ | async)"
          (click)="toggleSidebar()"
          aria-label="View history">
    <i class="ri-chat-history-line"></i>
    <span class="toggle-label">History</span>
  </button>

  <!-- Note: Background Tasks Indicator moved to global topbar for app-wide visibility -->

  <!-- Sidebar Backdrop Overlay (Mobile Only) -->
  <div class="sidebar-backdrop" [class.show]="sidebarOpen$ | async" (click)="closeSidebar()"></div>

  <!-- ========================================== -->
  <!-- LEFT SIDEBAR: Document Analysis (Upload mode) -->
  <!-- ========================================== -->
  <aside class="card conversation-sidebar" [class.open]="sidebarOpen$ | async"
         *ngIf="!(draftingMode$ | async) && selectedTask === 'upload' && !((documentViewerMode$ | async) && (viewerSidebarCollapsed$ | async))">

    <!-- Primary Action Button -->
    <div class="p-3 border-bottom">
      <button type="button" class="btn-sidebar-new" (click)="openNewAnalysis()">
        <i class="ri-add-line"></i>
        New Analysis
      </button>
    </div>

    <!-- Search Bar -->
    <div class="sidebar-search-box">
      <div class="search-input-wrapper">
        <i class="ri-search-line"></i>
        <input type="text" placeholder="Search documents..." [(ngModel)]="documentSearchQuery">
      </div>
    </div>

    <!-- Scrollable Content -->
    <div class="sidebar-scroll-container">
      <!-- Document Analyses Section -->
      <div class="px-3">
        <div class="sidebar-section-header">
          <span class="section-title">Document Analyses</span>
        </div>

        <!-- Loading State -->
        <div class="sidebar-empty-state" *ngIf="loadingAnalyses">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <p class="empty-desc mt-2">Loading analyses...</p>
        </div>

        <!-- Empty State -->
        <div class="sidebar-empty-state" *ngIf="!loadingAnalyses && (analyzedDocuments$ | async)?.length === 0">
          <div class="empty-icon"><i class="ri-file-text-line"></i></div>
          <p class="empty-title">No documents analyzed yet</p>
          <p class="empty-desc">Upload a document to get started</p>
        </div>

        <!-- Documents List -->
        <div *ngIf="!loadingAnalyses && (analyzedDocuments$ | async)?.length > 0">
          <div *ngFor="let doc of filteredAnalyzedDocuments"
               class="sidebar-list-item"
               [class.active]="(activeDocumentId$ | async) === doc.id"
               [class.is-analyzing]="doc.status === 'analyzing'"
               (click)="doc.status !== 'analyzing' ? openDocumentInViewer(doc) : null">
            <div class="item-icon icon-document" [class.analyzing]="doc.status === 'analyzing'">
              <!-- Show spinner when analyzing -->
              <span class="spinner-border spinner-border-sm" *ngIf="doc.status === 'analyzing'" role="status"></span>
              <!-- Show file icon when not analyzing -->
              <i class="ri-file-text-line" *ngIf="doc.status !== 'analyzing'"></i>
            </div>
            <div class="item-content">
              <div class="item-title" [title]="getCleanFileName(doc.fileName)">{{ getCleanFileName(doc.fileName) | slice:0:25 }}{{ getCleanFileName(doc.fileName).length > 25 ? '...' : '' }}</div>
              <div class="item-meta">
                <!-- Show analyzing status -->
                <span class="sidebar-badge badge-analyzing" *ngIf="doc.status === 'analyzing'">
                  Analyzing...
                </span>
                <!-- Show document type when completed -->
                <ng-container *ngIf="doc.status !== 'analyzing'">
                  <span class="sidebar-badge" [ngClass]="getDocTypeBadgeClass(doc.detectedType)">{{ doc.detectedType }}</span>
                  <span>{{ doc.timestamp | date:'MMM d' }}</span>
                </ng-container>
              </div>
            </div>
            <button class="item-delete-btn" *ngIf="doc.status !== 'analyzing'" (click)="deleteDocument(doc); $event.stopPropagation()" title="Delete document">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="sidebar-divider"></div>

      <!-- Collections Section -->
      <div class="px-3 pb-3">
        <div class="sidebar-section-header">
          <span class="section-title">Collections</span>
          <span class="section-action action-primary" (click)="showNewCollectionModal = true">
            <i class="ri-add-line"></i> New
          </span>
        </div>

        <!-- Loading State -->
        <div class="text-center py-2" *ngIf="loadingCollections">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        </div>

        <!-- Empty State -->
        <div class="sidebar-empty-state" *ngIf="!loadingCollections && (collections$ | async)?.length === 0" style="padding: 24px;">
          <p class="empty-desc">No collections yet</p>
          <button class="btn btn-sm btn-soft-primary mt-2" (click)="showNewCollectionModal = true">
            <i class="ri-add-line me-1"></i>Create Collection
          </button>
        </div>

        <!-- Collections List -->
        <div *ngIf="!loadingCollections && (collections$ | async)?.length > 0">
          <div class="collection-item" *ngFor="let collection of (collections$ | async)" (click)="openCollection(collection)">
            <div class="collection-icon">
              <i [class]="collection.icon || 'ri-folder-line'"></i>
            </div>
            <span class="collection-name">{{ collection.name }}</span>
            <span class="collection-count">{{ collection.documentCount }} docs</span>
          </div>
        </div>
      </div>
    </div>

    <!-- New Collection Modal -->
    <div class="new-collection-modal-backdrop" *ngIf="showNewCollectionModal" (click)="showNewCollectionModal = false">
      <div class="new-collection-modal card" (click)="$event.stopPropagation()">
        <div class="card-header">
          <h6 class="mb-0">Create New Collection</h6>
          <button type="button" class="btn-close" (click)="showNewCollectionModal = false"></button>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Collection Name</label>
            <input type="text"
                   class="form-control"
                   #collectionNameInput
                   placeholder="e.g., Smith v. Jones Case">
          </div>
          <div class="mb-3">
            <label class="form-label">Description (optional)</label>
            <textarea class="form-control"
                      #collectionDescInput
                      rows="2"
                      placeholder="Brief description..."></textarea>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-light" (click)="showNewCollectionModal = false">Cancel</button>
          <button type="button" class="btn btn-primary"
                  (click)="createCollection(collectionNameInput.value, collectionDescInput.value)">
            Create Collection
          </button>
        </div>
      </div>
    </div>

  </aside>

  <!-- ========================================== -->
  <!-- LEFT SIDEBAR: Non-Upload Modes (Question, Draft, Workflow) -->
  <!-- ========================================== -->
  <aside class="card conversation-sidebar" [class.open]="sidebarOpen$ | async"
         *ngIf="!(draftingMode$ | async) && selectedTask !== 'upload' && !((documentViewerMode$ | async) && (viewerSidebarCollapsed$ | async))">

    <!-- Primary Action Button - Changes based on mode -->
    <div class="p-3 border-bottom">
      <button [hidden]="selectedTask !== 'question'" type="button" class="btn-sidebar-new" (click)="startNewConversation()">
        <i class="ri-add-line"></i>
        New Question
      </button>
      <button [hidden]="selectedTask !== 'draft'" type="button" class="btn-sidebar-new" (click)="startNewConversation()">
        <i class="ri-add-line"></i>
        New Draft
      </button>
      <button [hidden]="selectedTask !== 'workflow'" type="button" class="btn-sidebar-new" (click)="openWorkflowSelection()">
        <i class="ri-add-line"></i>
        New Workflow
      </button>
    </div>

    <!-- Search Bar -->
    <div class="sidebar-search-box">
      <div class="search-input-wrapper">
        <i class="ri-search-line"></i>
        <input [hidden]="selectedTask !== 'question'" type="text" placeholder="Search questions..." [(ngModel)]="conversationSearchQuery">
        <input [hidden]="selectedTask !== 'draft'" type="text" placeholder="Search drafts..." [(ngModel)]="conversationSearchQuery">
        <input [hidden]="selectedTask !== 'workflow'" type="text" placeholder="Search workflows..." [(ngModel)]="workflowSearchQuery">
      </div>
    </div>

    <!-- Filter Chips for Workflow status (only shown in workflow mode) -->
    <div class="sidebar-filter-chips" [hidden]="selectedTask !== 'workflow'">
      <button class="filter-chip" [class.active]="workflowFilter === 'all'" (click)="setWorkflowFilter('all')">All</button>
      <button class="filter-chip" [class.active]="workflowFilter === 'active'" (click)="setWorkflowFilter('active')">Active</button>
      <button class="filter-chip" [class.active]="workflowFilter === 'pending'" (click)="setWorkflowFilter('pending')">Pending</button>
      <button class="filter-chip" [class.active]="workflowFilter === 'completed'" (click)="setWorkflowFilter('completed')">Completed</button>
    </div>

    <!-- Scrollable Content -->
    <div class="sidebar-scroll-container">

      <!-- ====== QUESTION MODE CONTENT ====== -->
      <div [hidden]="selectedTask !== 'question'" class="px-3">
        <div class="sidebar-section-header">
          <span class="section-title">Past 90 Days</span>
          <span class="section-action action-primary" (click)="deleteAllConversations()">Clear all</span>
        </div>

        <!-- Loading State -->
        <div class="sidebar-empty-state" *ngIf="loadingDrafts">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <p class="empty-desc mt-2">Loading...</p>
        </div>

        <!-- Empty State -->
        <div class="sidebar-empty-state" *ngIf="!loadingDrafts && filteredQuestionConversations.length === 0">
          <div class="empty-icon"><i class="ri-question-answer-line"></i></div>
          <p class="empty-title">No questions yet</p>
          <p class="empty-desc">Ask a legal question to get started</p>
        </div>

        <!-- Questions List -->
        <div *ngIf="!loadingDrafts && filteredQuestionConversations.length > 0">
          <div *ngFor="let conv of filteredQuestionConversations"
               class="sidebar-list-item"
               [class.active]="(activeConversationId$ | async) === conv.id"
               (click)="switchConversation(conv.id)">
            <div class="item-icon icon-conversation">
              <i class="ri-chat-3-line"></i>
            </div>
            <div class="item-content">
              <div class="item-title">{{ (conv.title || 'Untitled Question') | slice:0:30 }}{{ (conv.title || '').length > 30 ? '...' : '' }}</div>
              <div class="item-meta">
                <span>{{ conv.date | date:'MMM d' }}</span>
                <span><i class="ri-chat-1-line"></i> {{ conv.messageCount || conv.messages?.length || 0 }}</span>
              </div>
            </div>
            <button class="item-delete-btn" (click)="deleteConversation(conv.id); $event.stopPropagation()" title="Delete conversation">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- ====== DRAFT MODE CONTENT ====== -->
      <div [hidden]="selectedTask !== 'draft'" class="px-3">
        <div class="sidebar-section-header">
          <span class="section-title">Recent Drafts</span>
          <span class="section-action action-primary" (click)="deleteAllConversations()">Clear all</span>
        </div>

        <!-- Loading State -->
        <div class="sidebar-empty-state" *ngIf="loadingDrafts">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <p class="empty-desc mt-2">Loading...</p>
        </div>

        <!-- Empty State -->
        <div class="sidebar-empty-state" *ngIf="!loadingDrafts && filteredDraftConversations.length === 0">
          <div class="empty-icon"><i class="ri-file-edit-line"></i></div>
          <p class="empty-title">No drafts yet</p>
          <p class="empty-desc">Generate a draft to get started</p>
        </div>

        <!-- Drafts List -->
        <div *ngIf="!loadingDrafts && filteredDraftConversations.length > 0">
          <div *ngFor="let conv of filteredDraftConversations"
               class="sidebar-list-item"
               [class.active]="(activeConversationId$ | async) === conv.id"
               (click)="switchConversation(conv.id)">
            <div class="item-icon icon-draft">
              <i class="ri-file-text-line"></i>
            </div>
            <div class="item-content">
              <div class="item-title">{{ (conv.title || 'Untitled Draft') | slice:0:30 }}{{ (conv.title || '').length > 30 ? '...' : '' }}</div>
              <div class="item-meta">
                <span class="sidebar-badge" [ngClass]="getDraftStatusClass(conv)">{{ getDraftStatus(conv) }}</span>
                <span>{{ conv.date | date:'MMM d' }}</span>
                <span><i class="ri-chat-1-line"></i> {{ conv.messageCount || conv.messages?.length || 0 }}</span>
              </div>
            </div>
            <button class="item-delete-btn" (click)="deleteConversation(conv.id); $event.stopPropagation()" title="Delete draft">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- ====== WORKFLOW MODE CONTENT ====== -->
      <div [hidden]="selectedTask !== 'workflow'">
        <!-- Loading State -->
        <div class="sidebar-empty-state" *ngIf="loadingWorkflows">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <p class="empty-desc mt-2">Loading...</p>
        </div>

        <!-- Empty State -->
        <div class="sidebar-empty-state" *ngIf="!loadingWorkflows && filteredWorkflows.length === 0">
          <div class="empty-icon"><i class="ri-flow-chart"></i></div>
          <p class="empty-title">No workflows yet</p>
          <p class="empty-desc">Start a workflow to track your case</p>
        </div>

        <!-- Workflows List -->
        <div class="px-3" *ngIf="!loadingWorkflows && filteredWorkflows.length > 0">
          <div class="sidebar-section-header">
            <span class="section-title">{{ getWorkflowSectionTitle() }}</span>
          </div>

          <!-- Workflow Card Style - Matching Screenshot -->
          <div *ngFor="let workflow of filteredWorkflows"
               class="workflow-sidebar-card"
               [class.is-running]="workflow.status === 'RUNNING'"
               [class.is-waiting]="workflow.status === 'WAITING_USER'"
               [class.is-completed]="workflow.status === 'COMPLETED'"
               [class.is-failed]="workflow.status === 'FAILED'"
               (click)="viewWorkflowDetails(workflow)">
            <!-- Header: Dot + Title + Badge -->
            <div class="workflow-card-header">
              <span class="status-dot" [ngClass]="{
                'dot-green': workflow.status === 'COMPLETED',
                'dot-teal': workflow.status === 'RUNNING',
                'dot-yellow': workflow.status === 'WAITING_USER',
                'dot-blue': workflow.status === 'PENDING',
                'dot-red': workflow.status === 'FAILED'
              }"></span>
              <span class="workflow-title">{{ getWorkflowDisplayName(workflow) }}</span>
              <span class="workflow-status-badge" [ngClass]="{
                'badge-completed': workflow.status === 'COMPLETED',
                'badge-running': workflow.status === 'RUNNING',
                'badge-waiting': workflow.status === 'WAITING_USER',
                'badge-pending': workflow.status === 'PENDING',
                'badge-failed': workflow.status === 'FAILED'
              }">{{ getWorkflowStatusLabel(workflow.status) }}</span>
            </div>
            <!-- Progress Bar -->
            <div class="workflow-card-progress">
              <div class="progress-bar-fill" [ngClass]="{
                'fill-green': workflow.status === 'COMPLETED',
                'fill-teal': workflow.status === 'RUNNING',
                'fill-yellow': workflow.status === 'WAITING_USER',
                'fill-blue': workflow.status === 'PENDING',
                'fill-red': workflow.status === 'FAILED'
              }" [style.width.%]="getWorkflowProgressPercentage(workflow)"></div>
            </div>
            <!-- Footer: Steps + Due Date -->
            <div class="workflow-card-footer">
              <span class="steps-info">{{ getCompletedStepsCount(workflow) }} of {{ workflow.totalSteps || 0 }} steps complete</span>
              <span class="due-date" *ngIf="workflow.dueDate">Due {{ workflow.dueDate | date:'MMM d' }}</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </aside>

  <!-- ========================================== -->
  <!-- MAIN CONTENT AREA -->
  <!-- ========================================== -->
  <main class="main-content-area" [class.full-width]="(documentViewerMode$ | async) && (viewerSidebarCollapsed$ | async)">

    <!-- ========================================== -->
    <!-- WORKFLOW DETAILS PAGE (Full-Page View) -->
    <!-- ========================================== -->
    <div class="workflow-details-page" *ngIf="showWorkflowDetailsPage && selectedWorkflowForDetails">
      <!-- Header -->
      <div class="workflow-details-header">
        <div class="header-left">
          <button class="back-btn" (click)="closeWorkflowDetailsPage()">
            <i class="ri-arrow-left-line"></i>
          </button>
          <div class="header-info">
            <h2 class="workflow-title">{{ selectedWorkflowForDetails.name || selectedWorkflowForDetails.template?.name || 'Workflow' }}</h2>
            <span class="workflow-meta">
              Started {{ selectedWorkflowForDetails.startedAt | date:'shortTime' }} • {{ selectedWorkflowForDetails.documentIds?.length || 0 }} documents
            </span>
          </div>
        </div>
        <div class="header-actions">
          <ng-container *ngIf="getWorkflowHeaderActions() as actions">
            <button *ngIf="actions.secondary"
                    class="btn btn-outline-secondary"
                    (click)="handleWorkflowHeaderAction(actions.secondary.action)">
              <i [class]="actions.secondary.icon"></i>
              {{ actions.secondary.label }}
            </button>
            <button *ngIf="actions.primary"
                    class="btn"
                    [class.btn-danger]="selectedWorkflowForDetails.status === 'RUNNING'"
                    [class.btn-primary]="selectedWorkflowForDetails.status !== 'RUNNING'"
                    (click)="handleWorkflowHeaderAction(actions.primary.action)">
              <i [class]="actions.primary.icon"></i>
              {{ actions.primary.label }}
            </button>
          </ng-container>
        </div>
      </div>

      <!-- Status Banner -->
      <div class="workflow-status-banner" [ngClass]="getWorkflowStatusBanner().colorClass">
        <div class="status-icon">
          <i [class]="getWorkflowStatusBanner().icon"></i>
        </div>
        <div class="status-text">
          <span class="status-title">{{ getWorkflowStatusBanner().title }}</span>
          <span class="status-subtitle">{{ getWorkflowStatusBanner().subtitle }}</span>
        </div>
      </div>

      <!-- Progress Section -->
      <div class="workflow-progress-section">
        <span class="progress-label">Overall Progress</span>
        <span class="progress-percentage" [ngClass]="{
          'text-success': selectedWorkflowForDetails.status === 'COMPLETED',
          'text-primary': selectedWorkflowForDetails.status === 'RUNNING',
          'text-warning': selectedWorkflowForDetails.status === 'WAITING_USER'
        }">{{ getWorkflowProgressPercentage(selectedWorkflowForDetails) }}% Complete</span>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" [ngClass]="{
            'fill-green': selectedWorkflowForDetails.status === 'COMPLETED',
            'fill-teal': selectedWorkflowForDetails.status === 'RUNNING',
            'fill-yellow': selectedWorkflowForDetails.status === 'WAITING_USER',
            'fill-red': selectedWorkflowForDetails.status === 'FAILED'
          }" [style.width.%]="getWorkflowProgressPercentage(selectedWorkflowForDetails)"></div>
        </div>
      </div>

      <!-- Workflow Steps Section -->
      <div class="workflow-steps-section">
        <div class="steps-header">
          <div class="steps-title">
            <i class="ri-list-check-2"></i>
            <span>Workflow Steps</span>
          </div>
          <button class="expand-all-btn" (click)="toggleExpandAllSteps()">
            <i [class]="allStepsExpanded ? 'ri-contract-up-down-line' : 'ri-expand-up-down-line'"></i>
            {{ allStepsExpanded ? 'Collapse All' : 'Expand All' }}
          </button>
        </div>

        <!-- Steps Timeline -->
        <div class="steps-timeline">
          <div class="step-item" *ngFor="let step of selectedWorkflowForDetails.stepExecutions; let i = index; let last = last"
               [class.is-completed]="step.status === 'COMPLETED'"
               [class.is-running]="step.status === 'IN_PROGRESS' || step.status === 'RUNNING'"
               [class.is-waiting]="step.status === 'WAITING_USER'"
               [class.is-pending]="step.status === 'PENDING' || (!step.status || (step.status !== 'COMPLETED' && step.status !== 'IN_PROGRESS' && step.status !== 'RUNNING' && step.status !== 'WAITING_USER' && step.status !== 'FAILED'))"
               [class.is-failed]="step.status === 'FAILED'">

            <!-- Step Indicator -->
            <div class="step-indicator-container">
              <div class="step-indicator">
                <ng-container [ngSwitch]="step.status">
                  <i *ngSwitchCase="'COMPLETED'" class="ri-check-line"></i>
                  <i *ngSwitchCase="'IN_PROGRESS'" class="ri-loader-4-line spin"></i>
                  <i *ngSwitchCase="'RUNNING'" class="ri-loader-4-line spin"></i>
                  <i *ngSwitchCase="'WAITING_USER'" class="ri-pause-line"></i>
                  <i *ngSwitchCase="'FAILED'" class="ri-close-line"></i>
                  <span *ngSwitchDefault class="step-number">{{ step.stepNumber }}</span>
                </ng-container>
              </div>
              <div class="step-connector" *ngIf="!last"></div>
            </div>

            <!-- Step Content -->
            <div class="step-content">
              <div class="step-header">
                <div class="step-title-row">
                  <span class="step-name">{{ step.stepName }}</span>
                  <span class="step-type-badge" [ngClass]="{
                    'badge-display': step.stepType === 'DISPLAY',
                    'badge-synthesis': step.stepType === 'SYNTHESIS',
                    'badge-generation': step.stepType === 'GENERATION',
                    'badge-integration': step.stepType === 'INTEGRATION',
                    'badge-action': step.stepType === 'ACTION'
                  }">{{ step.stepType }}</span>
                </div>
                <span class="step-duration" *ngIf="getStepDuration(step)">
                  <i class="ri-time-line"></i>
                  {{ getStepDuration(step) }}
                </span>
              </div>

              <!-- Step Description (for pending/running steps) -->
              <p class="step-description" *ngIf="step.status === 'PENDING' || step.status === 'IN_PROGRESS' || step.status === 'RUNNING'">
                {{ step.description || getStepDescription(step) }}
              </p>

              <!-- Processing Indicator -->
              <div class="processing-indicator" *ngIf="step.status === 'IN_PROGRESS' || step.status === 'RUNNING'">
                <div class="processing-dots">
                  <span></span><span></span><span></span>
                </div>
                <span class="processing-text">Processing with AI...</span>
              </div>

              <!-- Action Buttons for WAITING_USER -->
              <div class="step-action-buttons" *ngIf="step.status === 'WAITING_USER'">
                <p class="action-description">{{ step.outputData?.message || 'This step requires your review before continuing.' }}</p>
                <div class="action-btn-group">
                  <button class="btn btn-primary btn-sm" (click)="resumeWorkflowStep(selectedWorkflowForDetails.id, step.id)">
                    <i class="ri-play-line"></i>
                    Continue Workflow
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" *ngIf="step.outputData" (click)="toggleStepExpansion(step.id)">
                    <i class="ri-eye-line"></i>
                    View Output
                  </button>
                </div>
              </div>

              <!-- View Output Button for Completed Steps -->
              <button class="view-output-btn" *ngIf="step.status === 'COMPLETED' && step.outputData"
                      (click)="toggleStepExpansion(step.id)">
                <i class="ri-eye-line"></i>
                {{ isStepExpanded(step.id) ? 'Hide Output' : 'View Output' }}
              </button>

              <!-- Expandable Output Section -->
              <div class="step-output-card" *ngIf="isStepExpanded(step.id) && step.outputData">
                <div class="output-header">
                  <span class="output-label">
                    <i class="ri-file-text-line"></i>
                    OUTPUT
                  </span>
                  <div class="output-actions">
                    <button class="icon-btn" (click)="copyToClipboard(step.outputData.content || step.outputData.draftContent || '')" title="Copy">
                      <i class="ri-file-copy-line"></i>
                    </button>
                    <button class="icon-btn" (click)="expandStepOutput(step)" title="Expand">
                      <i class="ri-fullscreen-line"></i>
                    </button>
                  </div>
                </div>
                <div class="output-content">
                  <!-- Display step output based on type -->
                  <ng-container [ngSwitch]="step.stepType">
                    <!-- DISPLAY type -->
                    <ng-container *ngSwitchCase="'DISPLAY'">
                      <!-- Analysis summaries -->
                      <div *ngIf="step.outputData.analyses?.length" class="output-text mb-2">
                        <strong>Documents Analyzed:</strong> {{ step.outputData.analyses.length }}
                        <div class="analysis-preview" *ngFor="let analysis of step.outputData.analyses.slice(0, 2)">
                          <div class="preview-item">
                            <i class="ri-file-text-line text-primary me-1"></i>
                            <span class="preview-title">{{ analysis.fileName }}</span>
                            <span class="badge bg-soft-info text-info ms-1" *ngIf="analysis.documentType">{{ analysis.documentType }}</span>
                          </div>
                        </div>
                      </div>
                      <!-- Action items with preview -->
                      <div *ngIf="step.outputData.actionItems?.length" class="output-text mb-2">
                        <strong><i class="ri-checkbox-circle-line text-warning me-1"></i>Action Items:</strong> {{ step.outputData.actionItems.length }} items
                        <ul class="action-preview-list">
                          <li *ngFor="let item of step.outputData.actionItems.slice(0, 3)" class="action-preview-item">
                            <span class="badge me-1" [ngClass]="{
                              'bg-soft-danger text-danger': item.priority === 'HIGH',
                              'bg-soft-warning text-warning': item.priority === 'MEDIUM',
                              'bg-soft-success text-success': item.priority === 'LOW'
                            }">{{ item.priority }}</span>
                            {{ item.title || item.description | slice:0:60 }}{{ (item.title || item.description)?.length > 60 ? '...' : '' }}
                          </li>
                          <li *ngIf="step.outputData.actionItems.length > 3" class="text-muted">
                            <i class="ri-more-line"></i> +{{ step.outputData.actionItems.length - 3 }} more items
                          </li>
                        </ul>
                      </div>
                      <!-- Timeline events with preview -->
                      <div *ngIf="step.outputData.timelineEvents?.length" class="output-text">
                        <strong><i class="ri-calendar-event-line text-info me-1"></i>Timeline Events:</strong> {{ step.outputData.timelineEvents.length }} events
                        <ul class="timeline-preview-list">
                          <li *ngFor="let event of step.outputData.timelineEvents.slice(0, 3)" class="timeline-preview-item">
                            <span class="badge bg-soft-primary text-primary me-1" *ngIf="event.eventDate">{{ event.eventDate | slice:0:10 }}</span>
                            <span class="badge bg-soft-danger text-danger me-1" *ngIf="event.isDeadline">DEADLINE</span>
                            {{ event.title | slice:0:50 }}{{ event.title?.length > 50 ? '...' : '' }}
                          </li>
                          <li *ngIf="step.outputData.timelineEvents.length > 3" class="text-muted">
                            <i class="ri-more-line"></i> +{{ step.outputData.timelineEvents.length - 3 }} more events
                          </li>
                        </ul>
                      </div>
                    </ng-container>

                    <!-- SYNTHESIS type -->
                    <ng-container *ngSwitchCase="'SYNTHESIS'">
                      <div class="output-text markdown-content"
                           [innerHTML]="(step.outputData.content || '') | slice:0:500 | markdownToHtml"></div>
                    </ng-container>

                    <!-- GENERATION type -->
                    <ng-container *ngSwitchCase="'GENERATION'">
                      <div class="output-text markdown-content"
                           [innerHTML]="(step.outputData.content || '') | slice:0:500 | markdownToHtml"></div>
                    </ng-container>

                    <!-- INTEGRATION type -->
                    <ng-container *ngSwitchCase="'INTEGRATION'">
                      <div *ngIf="step.outputData.draftContent" class="output-text markdown-content"
                           [innerHTML]="(step.outputData.draftContent || '') | slice:0:500 | markdownToHtml"></div>
                      <div *ngIf="step.outputData.sessionId" class="output-meta">
                        <span class="meta-item">
                          <i class="ri-draft-line"></i>
                          Draft created - Click to edit
                        </span>
                      </div>
                    </ng-container>

                    <!-- Default -->
                    <ng-container *ngSwitchDefault>
                      <div class="output-text" *ngIf="step.outputData.message">{{ step.outputData.message }}</div>
                    </ng-container>
                  </ng-container>

                  <!-- Show More Link -->
                  <button class="show-more-btn" *ngIf="(step.outputData.content?.length > 500) || (step.outputData.draftContent?.length > 500)"
                          (click)="expandStepOutput(step)">
                    <i class="ri-arrow-down-s-line"></i>
                    Show More
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Document Analysis Viewer (Full-width when viewing document) -->
    <app-document-analysis-viewer
      *ngIf="!showWorkflowDetailsPage && (documentViewerMode$ | async) && getActiveDocument()"
      [document]="getActiveDocument()!"
      (close)="closeDocumentViewer()"
      (exportPdf)="onExportPdf($event)"
      (exportWord)="onExportWord($event)"
      (saveToFileManager)="onSaveToFileManager($event)">
    </app-document-analysis-viewer>

    <!-- Collection Viewer (Full-width when viewing collection) -->
    <app-collection-viewer
      *ngIf="isViewingCollection && activeCollectionId"
      [collectionId]="activeCollectionId"
      (close)="closeCollectionViewer()"
      (openDocument)="openDocumentFromCollection($event)"
      (uploadToCollection)="startUploadToCollection($event)">
    </app-collection-viewer>

    <!-- Welcome Screen (No active conversation) -->
    <div class="welcome-screen" *ngIf="!showWorkflowDetailsPage && !(documentViewerMode$ | async) && !isViewingCollection && !(showChat$ | async) && !(isGenerating$ | async) && !(draftingMode$ | async)">
      <div class="welcome-header">
        <h2 class="welcome-title mb-0">Welcome, {{ getUserDisplayName() }}</h2>
        <p class="welcome-subtitle">AI-Powered Document Analysis for Legal Professionals</p>
      </div>

      <!-- Action Cards Grid (always shown for navigation) -->
      <div class="action-cards-main mb-4">
        <div
          class="action-card"
          [class.active]="selectedTask === 'question'"
          (click)="selectTask('question')">
          <div class="icon-box">
            <i class="ri-question-answer-line"></i>
          </div>
          <div class="card-content">
            <span>Ask a legal question</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'draft'"
          (click)="selectTask('draft')">
          <div class="icon-box">
            <i class="ri-file-edit-line"></i>
          </div>
          <div class="card-content">
            <span>Generate a draft</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'upload'"
          (click)="selectTask('upload')">
          <div class="icon-box">
            <i class="ri-file-search-line"></i>
          </div>
          <div class="card-content">
            <span>Analyze Document</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'workflow'"
          (click)="selectTask('workflow')">
          <div class="icon-box">
            <i class="ri-flow-chart"></i>
          </div>
          <div class="card-content">
            <span>Case Workflow</span>
          </div>
        </div>
      </div>

      <!-- Examples Section (hidden for workflow mode and upload mode) -->
      <div class="examples-section card mb-4" *ngIf="selectedTask && selectedTask !== 'workflow' && selectedTask !== 'upload'">
        <div class="card-body">
          <h6 class="mb-3">{{ getExamplesTitle() }}</h6>
          <div class="example-list">
            <p class="text-muted mb-2" *ngFor="let example of getExamples()">• {{ example }}</p>
          </div>
        </div>
      </div>

      <!-- Workflow Header Section (shown only for workflow mode) -->
      <div class="workflow-header-section" *ngIf="selectedTask === 'workflow'">
        <div class="d-flex align-items-center justify-content-between">
          <span class="workflow-label">Select a Workflow Template:</span>
          <button class="btn btn-soft-info btn-sm" (click)="showWorkflowHelpModal = true">
            <i class="ri-question-line me-1"></i> Help
          </button>
        </div>
      </div>

      <!-- Analyze Document Section (shown when Upload task is selected) -->
      <div class="primary-upload-section mb-4" *ngIf="selectedTask === 'upload'">
        <div class="upload-card card">
          <div class="card-body">
            <!-- Context Selection FIRST (What's your goal?) - Sky Blue Theme -->
            <div class="context-selection-section mb-4" *ngIf="!isBatchProcessing">
              <!-- Header -->
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <i class="ri-focus-3-line" style="color: #fff; font-size: 1rem;"></i>
                  </div>
                  <div>
                    <h6 style="margin: 0; font-weight: 600; font-size: 0.95rem; color: #495057;">What's your goal?</h6>
                    <span style="font-size: 0.75rem; color: #878a99;">Select analysis context for better results</span>
                  </div>
                </div>
              </div>

              <!-- Context Options Grid -->
              <div class="context-options-grid">
                <div *ngFor="let option of analysisContextOptions"
                     class="context-option"
                     [class.selected]="selectedAnalysisContext === option.id"
                     (click)="selectAnalysisContext(option.id)">

                  <!-- Icon -->
                  <div class="context-option-icon">
                    <i [class]="option.icon"></i>
                  </div>

                  <!-- Content -->
                  <div class="context-option-content">
                    <span class="context-option-label">{{ option.label }}</span>
                    <span class="context-option-sublabel">{{ option.sublabel }}</span>
                  </div>

                  <!-- Selected Indicator -->
                  <div *ngIf="selectedAnalysisContext === option.id" class="context-option-check">
                    <i class="ri-check-line"></i>
                  </div>
                </div>
              </div>

              <!-- Description -->
              <div *ngIf="getSelectedContextOption()" class="context-description">
                <i class="ri-information-line"></i>
                <span>{{ getSelectedContextOption()?.description }}</span>
              </div>

              <!-- Smart Context Suggestion -->
              <div *ngIf="suggestedContext && selectedAnalysisContext === 'general'" class="context-suggestion">
                <div class="suggestion-content">
                  <i class="ri-lightbulb-flash-line"></i>
                  <span>Try <strong>{{ getSuggestedContextLabel() }}</strong> for this document type</span>
                </div>
                <button type="button" class="btn-apply" (click)="applySuggestedContext()">Apply</button>
              </div>
            </div>

            <!-- URL Fetch Input (Above upload zone) -->
            <div class="url-fetch-section mb-3">
              <div class="input-group">
                <span class="input-group-text"><i class="ri-link"></i></span>
                <input type="url"
                       class="form-control"
                       [(ngModel)]="documentUrl"
                       name="documentUrl"
                       placeholder="Paste document URL to fetch...">
                <button type="button"
                        class="btn btn-fetch"
                        (click)="fetchFromUrl()"
                        [disabled]="!documentUrl || isFetchingUrl">
                  <i class="ri-download-cloud-line me-1"></i>
                  {{ isFetchingUrl ? 'Fetching...' : 'Fetch' }}
                </button>
              </div>
            </div>

            <!-- Drag & Drop Zone -->
            <div class="upload-drop-zone-primary"
                 [class.dragover]="isDragover"
                 (drop)="onFileDrop($event)"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (click)="fileInput.click()">
              <input #fileInput
                     type="file"
                     hidden
                     (change)="onFileSelect($event)"
                     accept=".pdf,.docx,.doc,.txt"
                     multiple>

              <div class="upload-icon-large">
                <i class="ri-upload-cloud-2-line"></i>
              </div>
              <h5 class="upload-title">Drop documents here or click to upload</h5>
              <p class="upload-description text-muted">
                Supports PDF, DOCX, DOC, TXT • Auto-detection enabled
              </p>
            </div>

            <!-- Uploaded Files List -->
            <div class="uploaded-files-list mt-3" *ngIf="uploadedFiles.length > 0">
              <h6 class="mb-2 d-flex align-items-center justify-content-between">
                <span *ngIf="!isBatchProcessing">Ready to analyze ({{uploadedFiles.length}})</span>
                <span *ngIf="isBatchProcessing">
                  Processing ({{getCompletedFilesCount()}}/{{uploadedFiles.length}})
                </span>
                <div class="batch-progress-bar" *ngIf="isBatchProcessing">
                  <div class="progress" style="width: 100px; height: 6px;">
                    <div class="progress-bar bg-primary"
                         [style.width.%]="(getCompletedFilesCount() / uploadedFiles.length) * 100">
                    </div>
                  </div>
                </div>
              </h6>
              <div class="file-item" *ngFor="let file of uploadedFiles; let i = index"
                   [ngClass]="{'processing': file.status === 'analyzing', 'completed': file.status === 'completed', 'failed': file.status === 'failed'}">
                <div class="file-info">
                  <!-- Status Icon -->
                  <div class="file-status-icon">
                    <i *ngIf="file.status === 'ready'" class="ri-file-text-line text-secondary"></i>
                    <i *ngIf="file.status === 'analyzing'" class="ri-loader-4-line text-primary spin"></i>
                    <i *ngIf="file.status === 'completed'" class="ri-checkbox-circle-fill text-success"></i>
                    <i *ngIf="file.status === 'failed'" class="ri-close-circle-fill text-danger"></i>
                  </div>
                  <div class="file-details">
                    <div class="file-name">{{file.name}}</div>
                    <div class="file-meta">
                      <span>{{formatFileSize(file.size)}}</span>
                      <span class="file-status-text ms-2" *ngIf="file.status !== 'ready'">
                        <span *ngIf="file.status === 'analyzing'" class="text-primary">Analyzing...</span>
                        <span *ngIf="file.status === 'completed'" class="text-success">Complete</span>
                        <span *ngIf="file.status === 'failed'" class="text-danger">Failed</span>
                      </span>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-sm btn-light" (click)="removeFile(i)"
                        *ngIf="file.status === 'ready'" [disabled]="isBatchProcessing">
                  <i class="ri-close-line"></i>
                </button>
              </div>

              <!-- Case Selection (optional) -->
              <div class="case-selection-section mt-3" *ngIf="!isBatchProcessing">
                <h6 class="mb-2">
                  <i class="ri-briefcase-line me-1 text-primary"></i>
                  Link to a case (optional)
                </h6>
                <select class="form-select form-select-sm" [(ngModel)]="selectedCaseId" name="selectedCaseId">
                  <option [ngValue]="null">-- No case selected --</option>
                  <option *ngFor="let case of userCases" [ngValue]="case.id">
                    {{ case.caseNumber ? case.caseNumber + ' - ' : '' }}{{ case.title }}
                  </option>
                </select>
                <small class="text-muted">
                  <i class="ri-information-line me-1"></i>
                  Linking to a case makes this document appear in the case's AI Documents tab.
                </small>
              </div>

              <!-- Analyze Button -->
              <button type="button"
                      class="btn btn-primary w-100 mt-3"
                      (click)="startCustomDraft()"
                      [disabled]="uploadedFiles.length === 0 || (isGenerating$ | async)">
                <i class="ri-file-search-line me-2"></i>
                Analyze {{ uploadedFiles.length }} Document{{ uploadedFiles.length > 1 ? 's' : '' }}
                <span *ngIf="createCollectionOnUpload && uploadedFiles.length > 1" class="ms-1">
                  <i class="ri-folder-add-line"></i>
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Document Type Selector - Custom Dropdown (when Generate a draft is selected) -->
      <div class="document-type-selector" *ngIf="selectedTask === 'draft'">
        <div class="selector-header">
          <div class="selector-label">Draft:</div>

          <!-- Custom Dropdown Button -->
          <div class="custom-dropdown-wrapper">
            <button
              type="button"
              class="custom-dropdown-toggle"
              (click)="toggleDocTypeDropdown()"
              [class.active]="showDocTypeDropdown">
              <span class="dropdown-text">{{selectedDocTypeName}}</span>
              <i class="ri-arrow-down-s-line dropdown-arrow" [class.rotated]="showDocTypeDropdown"></i>
            </button>

            <!-- Dropdown Menu -->
            <div class="custom-dropdown-menu" *ngIf="showDocTypeDropdown">
              <div class="dropdown-content">
                <div class="dropdown-category" *ngFor="let category of documentTypeCategories">
                  <div class="category-header" (click)="toggleCategory(category.id)">
                    <span class="category-icon">{{category.icon}}</span>
                    <span class="category-name">{{category.name}}</span>
                    <i class="ri-arrow-down-s-line toggle-icon" [class.rotated]="category.expanded"></i>
                  </div>

                  <div class="category-items" *ngIf="category.expanded">
                    <button
                      type="button"
                      class="dropdown-item"
                      *ngFor="let type of category.types"
                      [class.selected]="selectedDocTypePill === type.id"
                      (click)="selectDocTypePill(type.id)">
                      {{type.name}}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Search input (optional filter) -->
          <div class="doc-type-search-wrapper">
            <i class="ri-search-line search-icon"></i>
            <input
              type="text"
              class="form-control form-control-sm doc-type-search"
              [(ngModel)]="documentTypeSearchText"
              placeholder="Or search types..."
              name="docTypeSearch">
          </div>

          <a (click)="showPromptTips()" class="prompt-tips-link">
            <i class="ri-lightbulb-line"></i>
            Prompt Tips
          </a>
        </div>

        <!-- Quick access pills (filtered by search if active) -->
        <div class="quick-pills" *ngIf="documentTypeSearchText && filteredDocumentTypes.length > 0">
          <button
            class="pill-btn"
            *ngFor="let type of filteredDocumentTypes"
            [class.active]="selectedDocTypePill === type.id"
            (click)="selectDocTypePill(type.id)">
            {{type.name}}
          </button>
        </div>
      </div>

      <!-- Warning: Document Type Required (only show when user focuses prompt) -->
      <div class="alert alert-warning doc-type-warning"
           *ngIf="selectedTask === 'draft' && showDocTypeWarning && !selectedDocTypePill">
        <i class="ri-alert-line me-1"></i>
        <strong>Please select a document type above</strong> to ensure proper citation formatting
      </div>

      <!-- Case Workflow Section (shown when Case Workflow task is selected) -->
      <div class="case-workflow-section mb-4" *ngIf="selectedTask === 'workflow'">

        <!-- ====== TEMPLATE SELECTION & DOCUMENT CONFIG ====== -->
        <div class="card" *ngIf="!selectedWorkflowForDetails">
          <div class="card-body">
            <!-- Step 1: Template Selection (when no template selected) -->
            <div *ngIf="!selectedWorkflowTemplate" class="workflow-template-selection">

              <!-- ====== WORKFLOW RECOMMENDATIONS PANEL ====== -->
              <div class="workflow-recommendations-panel" *ngIf="workflowRecommendations.length > 0 || loadingRecommendations">
                <!-- Panel Header -->
                <div class="recommendations-header" (click)="toggleRecommendationsPanel()">
                  <div class="header-left">
                    <i class="ri-lightbulb-flash-line"></i>
                    <span class="header-title">Suggested Workflows</span>
                    <span class="recommendation-count-badge" *ngIf="workflowRecommendations.length > 0">
                      {{ workflowRecommendations.length }}
                    </span>
                    <!-- Urgent Count Badge -->
                    <span class="urgent-badge" *ngIf="getUrgentRecommendationsCount() > 0">
                      <i class="ri-alarm-warning-line"></i>
                      {{ getUrgentRecommendationsCount() }} urgent
                    </span>
                  </div>
                  <div class="header-right">
                    <button class="btn btn-link btn-sm p-0" (click)="loadWorkflowRecommendations(); $event.stopPropagation()">
                      <i class="ri-refresh-line"></i>
                    </button>
                    <i [class]="showRecommendationsPanel ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"></i>
                  </div>
                </div>

                <!-- Panel Content (Collapsible) -->
                <div class="recommendations-content" *ngIf="showRecommendationsPanel">
                  <!-- Loading State -->
                  <div class="recommendations-loading" *ngIf="loadingRecommendations">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span>Loading suggestions...</span>
                  </div>

                  <!-- Recommendations List -->
                  <div class="recommendations-list" *ngIf="!loadingRecommendations && workflowRecommendations.length > 0">
                    <div class="recommendation-item" *ngFor="let rec of workflowRecommendations"
                         [class.urgency-critical]="rec.urgency === 'CRITICAL'"
                         [class.urgency-high]="rec.urgency === 'HIGH'"
                         [class.urgency-medium]="rec.urgency === 'MEDIUM'"
                         [class.urgency-low]="rec.urgency === 'LOW'">
                      <!-- Urgency Badge -->
                      <div class="urgency-indicator"
                           [style.background-color]="caseWorkflowService.getUrgencyBadgeBgColor(rec.urgency)"
                           [style.color]="caseWorkflowService.getUrgencyBadgeTextColor(rec.urgency)">
                        <i [class]="rec.urgency === 'CRITICAL' ? 'ri-alarm-warning-fill' :
                                    rec.urgency === 'HIGH' ? 'ri-error-warning-fill' :
                                    rec.urgency === 'MEDIUM' ? 'ri-time-fill' : 'ri-information-fill'"></i>
                        <span>{{ rec.urgencyLabel }}</span>
                      </div>

                      <!-- Recommendation Content -->
                      <div class="recommendation-content">
                        <div class="rec-header">
                          <span class="rec-template-icon" [style.background-color]="caseWorkflowService.getTemplateColor(rec.templateType)">
                            {{ caseWorkflowService.getTemplateIcon(rec.templateType) }}
                          </span>
                          <div class="rec-info">
                            <span class="rec-template-name">{{ rec.templateName }}</span>
                            <span class="rec-case-info">
                              <i class="ri-briefcase-line"></i>
                              {{ rec.caseNumber }} - {{ rec.caseTitle | slice:0:30 }}{{ rec.caseTitle?.length > 30 ? '...' : '' }}
                            </span>
                          </div>
                        </div>
                        <p class="rec-reason">{{ rec.reason }}</p>
                      </div>

                      <!-- Action Button -->
                      <button class="btn-start-workflow" (click)="startWorkflowFromRecommendation(rec)">
                        <i class="ri-play-circle-line"></i>
                        Start
                      </button>
                    </div>
                  </div>

                  <!-- Empty State -->
                  <div class="recommendations-empty" *ngIf="!loadingRecommendations && workflowRecommendations.length === 0">
                    <i class="ri-checkbox-circle-line"></i>
                    <span>No urgent workflows needed</span>
                  </div>
                </div>
              </div>

              <!-- Loading state -->
              <div *ngIf="loadingWorkflowTemplates" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-3">Loading workflow templates...</p>
              </div>

              <!-- Template Grid - 2x2 Layout -->
              <div class="workflow-template-grid" *ngIf="!loadingWorkflowTemplates">
                <div
                  class="workflow-template-card"
                  *ngFor="let template of workflowTemplates"
                  (click)="selectWorkflowTemplate(template)">
                  <!-- Emoji Icon -->
                  <div class="template-icon-wrapper">
                    <div class="template-icon" [style.background-color]="getWorkflowTemplateColor(template.templateType)">
                      <span class="template-emoji">{{ getWorkflowTemplateIcon(template.templateType) }}</span>
                    </div>
                  </div>
                  <!-- Title -->
                  <h6 class="template-name">{{ template.name }}</h6>
                  <!-- Description -->
                  <p class="template-description">{{ template.description }}</p>
                  <!-- Footer: Steps + Duration -->
                  <div class="template-meta">
                    <span class="meta-item">
                      <i class="ri-edit-line"></i>
                      {{ template.stepsConfig?.steps?.length || 0 }} steps
                    </span>
                    <span class="meta-item">
                      <i class="ri-time-line"></i>
                      ~{{ template.estimatedDays || 30 }} days
                    </span>
                  </div>
                </div>
              </div>

              <!-- Empty state -->
              <div *ngIf="!loadingWorkflowTemplates && workflowTemplates.length === 0" class="text-center py-5">
                <i class="ri-flow-chart text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">No workflow templates available</p>
              </div>
            </div>

            <!-- Step 2: Document Selection - NOW MOVED TO MODAL (hidden) -->
            <div *ngIf="false && selectedWorkflowTemplate" class="workflow-document-selection">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <button class="btn btn-link text-muted p-0 me-2" (click)="clearWorkflowTemplate()">
                    <i class="ri-arrow-left-line"></i>
                  </button>
                  <div class="template-icon-small me-2" [style.background-color]="getWorkflowTemplateColor(selectedWorkflowTemplate.templateType)">
                    <span class="template-emoji-small">{{ getWorkflowTemplateIcon(selectedWorkflowTemplate.templateType) }}</span>
                  </div>
                  <div>
                    <h5 class="mb-0">{{ selectedWorkflowTemplate.name }}</h5>
                    <small class="text-muted">{{ selectedWorkflowTemplate.description }}</small>
                  </div>
                </div>
              </div>

              <!-- Workflow Steps Preview -->
              <div class="workflow-steps-preview mb-4">
                <h6 class="mb-2">
                  <i class="ri-list-ordered me-1"></i>
                  Workflow Steps
                </h6>
                <div class="steps-list">
                  <div class="step-item" *ngFor="let step of selectedWorkflowTemplate.stepsConfig?.steps; let i = index">
                    <span class="step-number">{{ i + 1 }}</span>
                    <span class="step-name">{{ step.name }}</span>
                    <span class="step-type badge" [ngClass]="{
                      'bg-info': step.type === 'display',
                      'bg-warning': step.type === 'synthesis',
                      'bg-danger': step.type === 'generation',
                      'bg-primary': step.type === 'integration',
                      'bg-secondary': step.type === 'action'
                    }">{{ step.type }}</span>
                  </div>
                </div>
              </div>

              <!-- Workflow Name Input -->
              <div class="workflow-name-section mb-4">
                <h6 class="mb-2">
                  <i class="ri-pencil-line me-1"></i>
                  Workflow Name
                </h6>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="workflowName"
                  placeholder="e.g., Smith v. Acme, TechCorp Contract Review..."
                  maxlength="100">
                <small class="text-muted">Give your workflow a descriptive name for easy identification</small>
              </div>

              <!-- Document Selection -->
              <div class="document-selection-section">
                <h6 class="mb-2">
                  <i class="ri-file-list-3-line me-1"></i>
                  Select Documents for This Workflow
                </h6>
                <p class="text-muted small mb-3">
                  Choose from your analyzed documents or
                  <a href="javascript:void(0)" (click)="selectTask('upload')" class="text-primary">
                    <i class="ri-upload-2-line"></i> analyze new documents
                  </a>
                </p>

                <!-- Documents list from analyzed documents -->
                <div class="analyzed-documents-list" *ngIf="(analyzedDocuments$ | async) as docs">
                  <div *ngIf="docs.length === 0" class="text-center py-3 text-muted">
                    <i class="ri-file-search-line" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">No analyzed documents yet</p>
                    <button class="btn btn-outline-primary btn-sm mt-2" (click)="selectTask('upload')">
                      <i class="ri-upload-2-line me-1"></i>
                      Analyze Documents
                    </button>
                  </div>

                  <div class="document-checkbox-list" *ngIf="docs.length > 0">
                    <div
                      class="document-checkbox-item"
                      *ngFor="let doc of docs"
                      [class.selected]="isDocumentSelectedForWorkflow(doc.databaseId)"
                      (click)="toggleWorkflowDocument(doc.databaseId)">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [checked]="isDocumentSelectedForWorkflow(doc.databaseId)"
                          (click)="$event.stopPropagation()">
                        <label class="form-check-label d-flex align-items-center">
                          <i class="ri-file-text-line me-2 text-primary"></i>
                          <div>
                            <div class="doc-name">{{ getCleanFileName(doc.fileName) }}</div>
                            <small class="text-muted">{{ doc.documentType || 'Unknown type' }}</small>
                          </div>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Selected count and Start button -->
                <div class="workflow-actions mt-4 d-flex justify-content-between align-items-center">
                  <span class="text-muted">
                    <i class="ri-checkbox-circle-line me-1"></i>
                    {{ workflowSelectedDocuments.length }} document(s) selected
                  </span>
                  <button
                    class="btn btn-primary"
                    [disabled]="workflowSelectedDocuments.length === 0 || startingWorkflow"
                    (click)="startWorkflow()">
                    <span *ngIf="!startingWorkflow">
                      <i class="ri-play-line me-1"></i>
                      Start Workflow
                    </span>
                    <span *ngIf="startingWorkflow">
                      <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                      Starting...
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Prompt Input (hidden for upload, summarize, and workflow modes) -->
      <div class="main-prompt-area" *ngIf="selectedTask !== 'upload' && selectedTask !== 'summarize' && selectedTask !== 'workflow'">
        <form (ngSubmit)="startCustomDraft()" class="prompt-form card">
          <div class="card-body">
            <!-- Upload mode: Hide textarea, analysis is automatic -->
            <textarea
              *ngIf="selectedTask !== 'upload'"
              class="form-control prompt-textarea"
              [(ngModel)]="customPrompt"
              (focus)="onPromptFocus()"
              name="customPrompt"
              [placeholder]="promptPlaceholder"
              rows="3"></textarea>

            <!-- Case Selector (Draft task only) -->
            <div class="case-selector-section" *ngIf="selectedTask === 'draft'" style="margin-top: 1rem; margin-bottom: 1rem;">
              <label class="form-label" style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                <i class="ri-briefcase-line me-1"></i>
                Link to Case (Optional):
              </label>
              <select [(ngModel)]="selectedCaseId" class="form-select" name="caseSelector" style="margin-bottom: 0.5rem;">
                <option [ngValue]="null">None - General Draft</option>
                <option *ngFor="let case of userCases" [ngValue]="case.id">
                  {{case.caseNumber}} - {{case.title}}
                </option>
              </select>
              <small class="text-muted" style="font-size: 0.75rem;">
                <i class="ri-information-line"></i>
                Select a case to include case context in the draft
              </small>
            </div>

            <div class="prompt-footer">
              <!-- Hide jurisdiction and mode selectors for upload mode -->
              <div class="jurisdiction-selector" *ngIf="selectedTask !== 'upload'">
                <label>Jurisdiction:</label>
                <select class="form-select" [(ngModel)]="selectedJurisdiction" name="jurisdiction">
                  <option *ngFor="let jur of jurisdictions" [value]="jur">{{jur}}</option>
                </select>
              </div>

              <!-- Research Mode Selector (Compact) - Only shown for question mode -->
              <div class="mode-selector-compact" *ngIf="selectedTask === 'question'">
                <label>Mode:</label>
                <div class="btn-group" ngbDropdown placement="top-start">
                  <button id="mode-dropdown-compact"
                          ngbDropdownToggle
                          type="button"
                          class="btn btn-light btn-sm mode-btn-compact"
                          [attr.aria-label]="'Selected mode: ' + (selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough')">
                    <span class="mode-name-compact">{{ selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough' }}</span>
                    <span class="mode-cost-compact">{{ selectedResearchMode === 'FAST' ? '~15s' : '~90s' }}</span>
                  </button>
                  <div ngbDropdownMenu class="dropdown-menu mode-dropdown-minimal">
                    <!-- FAST Mode Option -->
                    <a class="dropdown-item mode-option-minimal"
                       [class.active]="selectedResearchMode === 'FAST'"
                       (click)="onResearchModeChange('FAST')">
                      <div class="mode-header-minimal">
                        <span class="mode-title">Fast</span>
                        <span class="mode-meta">~15s</span>
                      </div>
                      <p class="mode-desc-minimal">Quick guidance, no citations</p>
                    </a>

                    <div class="dropdown-divider"></div>

                    <!-- THOROUGH Mode Option -->
                    <a class="dropdown-item mode-option-minimal"
                       [class.active]="selectedResearchMode === 'THOROUGH'"
                       (click)="onResearchModeChange('THOROUGH')">
                      <div class="mode-header-minimal">
                        <span class="mode-title">Thorough</span>
                        <span class="mode-meta">~90s</span>
                      </div>
                      <p class="mode-desc-minimal">Verified citations via CourtListener</p>
                    </a>
                  </div>
                </div>
              </div>

              <button type="submit"
                      class="btn btn-submit"
                      [class.btn-analyze]="selectedTask === 'upload'"
                      [class.btn-primary]="selectedTask !== 'upload'"
                      [disabled]="selectedTask === 'upload' ? (uploadedFiles.length === 0 || (isGenerating$ | async)) : !canSend">
                <i [class]="selectedTask === 'upload' ? 'ri-file-search-line' : 'ri-send-plane-fill'"></i>
                {{ selectedTask === 'upload' ? 'Analyze Documents' : 'Send' }}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Top Action Bar (when in drafting mode) -->
    <div class="top-action-bar" *ngIf="draftingMode$ | async">
      <div class="action-bar-left">
        <button class="btn btn-link back-btn" (click)="exitDraftingMode()" title="Exit drafting mode">
          <i class="ri-arrow-left-line"></i>
        </button>
        <div class="drafting-mode-indicator">
          <i class="ri-file-edit-line"></i>
          <span>Drafting Mode</span>
        </div>
        <div class="document-stats">
          <span class="word-count">{{currentDocumentWordCount}}/500000</span>
          <span class="date-stamp">{{currentDate | date:'MMM d, yyyy'}}</span>
        </div>
      </div>
      <div class="action-bar-right">
        <!-- Thorough Mode Indicator (static - drafting always uses thorough mode) -->
        <div class="mode-indicator">
          <span class="btn btn-soft-primary btn-sm" style="cursor: default; pointer-events: none;">
            <i class="ri-verified-badge-line me-1"></i>
            <span class="mode-label">Thorough</span>
            <span class="mode-badge">~90s</span>
          </span>
        </div>

        <!-- Export Dropdown Button -->
        <div class="btn-group" ngbDropdown>
          <button id="export-dropdown" ngbDropdownToggle type="button" class="btn btn-primary btn-sm">
            <i class="ri-download-line"></i>
            Export
          </button>
          <div ngbDropdownMenu class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" (click)="exportToPDF()">
              <i class="ri-file-pdf-line me-2"></i>
              Save as PDF
            </a>
            <a class="dropdown-item" (click)="exportToWord()">
              <i class="ri-file-word-line me-2"></i>
              Save as Word
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" (click)="saveToFileManager()">
              <i class="ri-folder-upload-line me-2"></i>
              Save to File Manager
            </a>
          </div>
        </div>
        <a href="javascript:void(0)" class="help-link" (click)="openHowItWorksModal()">
          <i class="ri-question-line"></i>
          How does it work?
        </a>
      </div>
    </div>

    <!-- Split View Container (when document is generated) -->
    <div class="split-view-container" *ngIf="draftingMode$ | async" [class.chat-closed]="!(showChat$ | async)">
      <!-- Document Preview Panel (60%) -->
      <div class="document-preview-panel">
        <div class="document-preview-header">
          <div class="header-left">
            <h3 class="document-title">
              <i class="ri-file-text-line"></i>
              {{activeDocumentTitle}}
            </h3>
            <div class="document-metadata">
              <span class="meta-item" *ngIf="currentDocumentWordCount > 0">
                <i class="ri-file-word-line"></i>
                {{currentDocumentWordCount}} words
              </span>
              <span class="meta-item" *ngIf="currentDocumentPageCount > 0">
                <i class="ri-file-copy-line"></i>
                {{currentDocumentPageCount}} pages
              </span>
              <span class="meta-item generated-by">
                <i class="ri-sparkling-line"></i>
                Generated by Legience
              </span>

              <!-- Version Dropdown -->
              <div class="version-dropdown" ngbDropdown container="body" placement="bottom-end" *ngIf="documentMetadata.version">
                <button class="version-dropdown-toggle" ngbDropdownToggle type="button">
                  <i class="ri-git-commit-line me-1"></i>
                  v{{documentMetadata.version}}
                </button>
                <div ngbDropdownMenu class="version-dropdown-menu">
                  <div class="version-dropdown-header">
                    <h6 class="mb-0">Version History</h6>
                  </div>

                  <!-- Loading State -->
                  <div class="version-dropdown-loading" *ngIf="loadingVersions">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading versions...</span>
                  </div>

                  <!-- Empty State -->
                  <div class="version-dropdown-empty" *ngIf="!loadingVersions && documentVersions.length === 0">
                    <i class="ri-inbox-line"></i>
                    <p class="mb-0">No versions found</p>
                  </div>

                  <!-- Version List -->
                  <div class="version-dropdown-list" *ngIf="!loadingVersions && documentVersions.length > 0">
                    <button
                      *ngFor="let version of documentVersions"
                      class="version-dropdown-item"
                      [class.current-version]="version.versionNumber === documentMetadata.version"
                      (click)="restoreVersionWithConfirmation(version)"
                      [disabled]="version.versionNumber === documentMetadata.version">

                      <div class="version-item-header">
                        <span class="version-number">v{{version.versionNumber}}</span>
                        <span class="version-badge" [ngClass]="{
                          'badge-primary': version.transformationType === 'INITIAL_GENERATION',
                          'badge-info': version.transformationType === 'SIMPLIFY' || version.transformationType === 'CONDENSE',
                          'badge-success': version.transformationType === 'EXPAND',
                          'badge-warning': version.transformationType === 'REDRAFT',
                          'badge-secondary': version.transformationType === 'MANUAL_EDIT',
                          'badge-danger': version.transformationType === 'RESTORE_VERSION'
                        }">
                          {{getTransformationLabel(version.transformationType)}}
                        </span>
                        <span class="current-badge" *ngIf="version.versionNumber === documentMetadata.version">
                          <i class="ri-check-line"></i> CURRENT
                        </span>
                      </div>

                      <div class="version-item-meta">
                        <span class="version-date">
                          <i class="ri-time-line"></i>
                          {{version.createdAt | date:'MMM d, h:mm a'}}
                        </span>
                        <span class="version-words">
                          <i class="ri-file-word-line"></i>
                          {{version.wordCount}} words
                        </span>
                      </div>

                      <div class="version-item-note" *ngIf="version.versionNote">
                        <i class="ri-sticky-note-line"></i>
                        {{version.versionNote}}
                      </div>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="preview-actions">
            <button class="btn-icon" (click)="saveManualVersion()"
                    title="Save Version">
              <i class="ri-save-line"></i>
            </button>
            <button class="btn-icon" (click)="increaseTextSize()" title="Zoom in">
              <i class="ri-zoom-in-line"></i>
            </button>
            <button class="btn-icon" (click)="decreaseTextSize()" title="Zoom out">
              <i class="ri-zoom-out-line"></i>
            </button>
            <button class="btn-icon" (click)="toggleFullscreen()" [title]="isFullscreen ? 'Exit fullscreen' : 'Enter fullscreen'">
              <i [class]="isFullscreen ? 'ri-fullscreen-exit-line' : 'ri-fullscreen-line'"></i>
            </button>
            <button class="btn-icon" (click)="openDocumentPreviewModal()" title="Preview document">
              <i class="ri-eye-line"></i>
            </button>
            <button class="btn-icon" *ngIf="!(showChat$ | async)" (click)="reopenChatPanel()" title="Open conversation">
              <i class="ri-chat-3-line"></i>
            </button>
          </div>
        </div>

        <div class="document-preview-content">

          <!-- Rich Text Editor (Quill) -->
          <!-- showEditor flag toggled OFF→ON to force destruction and recreation -->
          <quill-editor
            *ngIf="showEditor"
            #documentEditor
            [modules]="quillModules"
            [formats]="quillFormats"
            [styles]="{
              'min-height': '500px',
              'height': '100%',
              'font-family': 'Georgia, Times New Roman, serif',
              'font-size': '16px',
              'line-height': '1.8'
            }"
            (onEditorCreated)="onEditorCreated($event)"
            (onSelectionChanged)="onTextSelectionChanged($event)"
            placeholder="Your generated document will appear here...">
          </quill-editor>
        </div>

        <!-- Drafting Tools Menu -->
        <div class="drafting-tools-menu">
          <button class="tool-btn" (click)="applyDraftingTool('simplify')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Simplify language'">
            <i class="ri-subtract-line"></i>
            Simplify
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('condense')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Condense document'">
            <i class="ri-file-reduce-line"></i>
            Condense
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('expand')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Expand with more detail'">
            <i class="ri-file-add-line"></i>
            Expand
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('redraft')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Redraft entirely'">
            <i class="ri-refresh-line"></i>
            Redraft entirely
          </button>
        </div>
      </div>

      <!-- Chat Panel (40%) -->
      <div class="chat-panel-side" *ngIf="showChat$ | async">
        <div class="chat-panel-header">
          <h4>Conversation</h4>
          <button class="btn-close-panel" (click)="closeChatPanel()">
            <i class="ri-close-line"></i>
          </button>
        </div>

        <div class="chat-messages-area-side">
          <ul class="list-unstyled chat-conversation-list">
            <!-- User & AI Messages -->
            <ng-container *ngFor="let message of (conversationMessages$ | async); let i = index">
              <li class="chat-list" [ngClass]="{ 'right': message.role === 'user', 'left': message.role === 'assistant' }">

                <!-- User Message -->
                <div class="conversation-list" *ngIf="message.role === 'user'">
                  <div class="user-chat-content">
                    <div class="message-bubble bg-soft-info text-info">
                      <div class="message-content">
                        <p class="mb-0">{{message.content}}</p>
                      </div>
                      <div class="message-meta">
                        <small class="text-muted">{{message.timestamp ? (message.timestamp | date:'short') : 'Just now'}}</small>
                        <i class="ri-check-double-line ms-1 text-success"></i>
                      </div>
                    </div>
                  </div>
                  <!-- User Avatar (right side) -->
                  <div class="chat-avatar ms-3">
                    <div class="avatar-sm">
                      <div class="avatar-title bg-success-subtle text-success rounded-circle">
                        <i class="ri-user-3-fill"></i>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- AI Message -->
                <div class="ai-message-container" *ngIf="message.role === 'assistant'">
                  <div class="d-flex align-items-start gap-3">
                    <div class="chat-avatar flex-shrink-0">
                      <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                    </div>
                    <div class="message-bubble ai-message flex-grow-1">
                      <!-- Research Mode Badge -->
                      <div class="research-mode-badge" *ngIf="message.researchMode">
                        <span class="badge" [ngClass]="message.researchMode === 'THOROUGH' ? 'badge-thorough' : 'badge-fast'">
                          <i [class]="message.researchMode === 'THOROUGH' ? 'ri-search-eye-line' : 'ri-flashlight-line'"></i>
                          {{ message.researchMode === 'THOROUGH' ? 'Thorough' : 'Fast' }}
                        </span>
                      </div>

                      <!-- Strategic Analysis Tabs (if present) -->
                      <div class="strategic-analysis-tabs" *ngIf="message.hasStrategicAnalysis">
                        <ul class="nav nav-tabs nav-tabs-custom mb-3" role="tablist">
                          <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#overview-{{i}}" role="tab">
                              <i class="ri-file-list-3-line me-1"></i> Overview
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#action-items-{{i}}" role="tab">
                              <i class="bi bi-check2-square me-1"></i> Action Items
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#timeline-view-{{i}}" role="tab">
                              <i class="bi bi-calendar-event me-1"></i> Timeline
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#weaknesses-{{i}}" role="tab">
                              <i class="ri-alert-line me-1"></i> Weaknesses
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#evidence-{{i}}" role="tab">
                              <i class="ri-checkbox-line me-1"></i> Evidence
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#strategy-{{i}}" role="tab">
                              <i class="ri-lightbulb-line me-1"></i> Strategy
                            </a>
                          </li>
                        </ul>

                        <div class="tab-content">
                          <div class="tab-pane fade show active" id="overview-{{i}}" role="tabpanel">
                            <div [innerHTML]="message.parsedSections?.overview || message.content" apexChartsContainer></div>
                          </div>
                          <div class="tab-pane fade" id="action-items-{{i}}" role="tabpanel">
                            <app-action-items-list *ngIf="message.analysisId" [analysisId]="message.analysisId"></app-action-items-list>
                            <p *ngIf="!message.analysisId" class="text-muted">No action items available</p>
                          </div>
                          <div class="tab-pane fade" id="timeline-view-{{i}}" role="tabpanel">
                            <app-timeline-view *ngIf="message.analysisId" [analysisId]="message.analysisId"></app-timeline-view>
                            <p *ngIf="!message.analysisId" class="text-muted">No timeline available</p>
                          </div>
                          <div class="tab-pane fade" id="weaknesses-{{i}}" role="tabpanel">
                            <div [innerHTML]="message.parsedSections?.weaknesses || 'No weaknesses section found'" apexChartsContainer></div>
                          </div>
                          <div class="tab-pane fade" id="evidence-{{i}}" role="tabpanel">
                            <div [innerHTML]="message.parsedSections?.evidence || 'No evidence section found'" apexChartsContainer></div>
                          </div>
                          <div class="tab-pane fade" id="strategy-{{i}}" role="tabpanel">
                            <div [innerHTML]="message.parsedSections?.strategy || 'No strategy section found'" apexChartsContainer></div>
                          </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="analysis-quick-actions mt-3">
                          <button class="btn btn-sm btn-soft-primary me-2" (click)="exportAnalysisToPDF(message)">
                            <i class="ri-file-pdf-line me-1"></i> Export PDF
                          </button>
                          <button class="btn btn-sm btn-soft-success me-2" (click)="createDraftFromAnalysis(message)">
                            <i class="ri-file-edit-line me-1"></i> Draft Response
                          </button>
                          <button class="btn btn-sm btn-soft-info me-2" (click)="researchCitations(message)">
                            <i class="ri-search-line me-1"></i> Research Citations
                          </button>
                          <button class="btn btn-sm btn-soft-warning" (click)="scheduleReminders(message)">
                            <i class="ri-calendar-check-line me-1"></i> Set Reminders
                          </button>
                        </div>
                      </div>

                      <!-- Regular message content (if not strategic analysis) -->
                      <div class="message-content" *ngIf="!message.hasStrategicAnalysis" [innerHTML]="message.hasStrategicAnalysis ? message.content : (message.content | markdownToHtml)" apexChartsContainer></div>

                      <!-- Transformation Comparison - Refactored Component -->
                      <app-transformation-preview
                        *ngIf="message.transformationComparison"
                        [transformation]="message.transformationComparison"
                        [messageId]="message.id!"
                        (accept)="acceptTransformation($event)"
                        (reject)="rejectTransformation($event)">
                      </app-transformation-preview>
                    </div>
                  </div>
                </div>

              </li>
            </ng-container>

            <!-- AI Generating State -->
            <li class="message-item assistant" *ngIf="isGenerating$ | async">
              <div class="ai-message-container">
                <div class="d-flex align-items-start gap-3 mb-3">
                  <div class="chat-avatar flex-shrink-0">
                    <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                  </div>

                  <div class="message-bubble ai-message flex-grow-1">
                    <!-- AI Activity Loading -->
                    <div class="ai-activity-loader">
                      <!-- Header -->
                      <div class="activity-header">
                        <span>Generating response</span>
                        <i class="ri-arrow-up-s-line"></i>
                      </div>

                      <!-- Activity Steps - Refactored Component -->
                      <app-workflow-steps
                        [steps]="workflowSteps$ | async"
                        [isGenerating]="isGenerating$ | async">
                      </app-workflow-steps>

                      <button class="btn-stop-response" (click)="stopGeneration()">
                        <i class="ri-stop-circle-line"></i>
                        Stop response
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </li>

          </ul>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-side">
          <form (ngSubmit)="sendFollowUpMessage()">
            <textarea
              class="form-control"
              [(ngModel)]="followUpMessage"
              name="followUpMessage"
              placeholder="Ask for revisions..."
              rows="3"
              (keydown.enter)="onEnterPress($event)"></textarea>
            <button type="submit" class="btn btn-primary btn-sm" [disabled]="!followUpMessage?.trim()">
              <i class="ri-send-plane-fill"></i>
              Send
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Chat Container (Active conversation - full width when not in drafting mode, hidden when document viewer is open) -->
    <div class="chat-container-main" *ngIf="((showChat$ | async) || (isGenerating$ | async)) && !(draftingMode$ | async) && !(documentViewerMode$ | async)">
      <!-- Mobile Back Button Header -->
      <div class="mobile-chat-header">
        <button class="btn-back" (click)="goBackToTaskSelection()" aria-label="Go back">
          <i class="ri-arrow-left-s-line"></i>
        </button>
        <span class="chat-header-title">{{ getActiveConversationTitle() || 'Conversation' }}</span>
      </div>
      <div class="chat-messages-area">
        <ul class="list-unstyled chat-conversation-list">

          <!-- User & AI Messages -->
          <ng-container *ngFor="let message of (conversationMessages$ | async); let i = index">
            <li class="chat-list" [ngClass]="{ 'right': message.role === 'user', 'left': message.role === 'assistant' }">

              <!-- User Message -->
              <div class="conversation-list" *ngIf="message.role === 'user'">
                <div class="user-chat-content mb-4">
                  <div class="message-bubble bg-soft-info text-info">
                    <div class="message-content">
                      <p class="mb-0">{{message.content}}</p>
                    </div>
                    <div class="message-meta">
                      <small class="text-muted">{{message.timestamp ? (message.timestamp | date:'short') : 'Just now'}}</small>
                      <i class="ri-check-double-line ms-1 text-success"></i>
                    </div>
                  </div>
                </div>
                <!-- User Avatar (right side) -->
                <div class="chat-avatar ms-3">
                  <div class="avatar-sm">
                    <div class="avatar-title bg-success-subtle text-success rounded-circle">
                      <i class="ri-user-3-fill"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- AI Message -->
              <div class="ai-message-container" *ngIf="message.role === 'assistant'">
                <div class="d-flex align-items-start gap-3 mb-3">
                  <div class="chat-avatar flex-shrink-0">
                    <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                  </div>

                  <div class="message-bubble ai-message flex-grow-1">
                    <!-- Research Mode Badge -->
                    <div class="research-mode-badge" *ngIf="message.researchMode">
                      <span class="badge" [ngClass]="message.researchMode === 'THOROUGH' ? 'badge-thorough' : 'badge-fast'">
                        <i [class]="message.researchMode === 'THOROUGH' ? 'ri-search-eye-line' : 'ri-flashlight-line'"></i>
                        {{ message.researchMode === 'THOROUGH' ? 'Thorough Research' : 'Fast Mode' }}
                      </span>
                    </div>

                    <!-- Strategic Analysis Tabs (if present) -->
                    <div class="strategic-analysis-tabs" *ngIf="message.hasStrategicAnalysis">
                      <ul class="nav nav-tabs nav-tabs-custom mb-3" role="tablist">
                        <li class="nav-item">
                          <a class="nav-link active" data-bs-toggle="tab" href="#overview-main-{{i}}" role="tab">
                            <i class="ri-file-list-3-line me-1"></i> Overview
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#action-items-main-{{i}}" role="tab">
                            <i class="bi bi-check2-square me-1"></i> Action Items
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#timeline-view-main-{{i}}" role="tab">
                            <i class="bi bi-calendar-event me-1"></i> Timeline
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#weaknesses-main-{{i}}" role="tab">
                            <i class="ri-alert-line me-1"></i> Weaknesses
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#evidence-main-{{i}}" role="tab">
                            <i class="ri-checkbox-line me-1"></i> Evidence
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#strategy-main-{{i}}" role="tab">
                            <i class="ri-lightbulb-line me-1"></i> Strategy
                          </a>
                        </li>
                      </ul>

                      <div class="tab-content">
                        <div class="tab-pane fade show active" id="overview-main-{{i}}" role="tabpanel">
                          <div [innerHTML]="(message.parsedSections?.overview || message.content) | markdownToHtml" apexChartsContainer></div>
                        </div>
                        <div class="tab-pane fade" id="action-items-main-{{i}}" role="tabpanel">
                          <app-action-items-list *ngIf="message.analysisId" [analysisId]="message.analysisId"></app-action-items-list>
                          <p *ngIf="!message.analysisId" class="text-muted">No action items available</p>
                        </div>
                        <div class="tab-pane fade" id="timeline-view-main-{{i}}" role="tabpanel">
                          <app-timeline-view *ngIf="message.analysisId" [analysisId]="message.analysisId"></app-timeline-view>
                          <p *ngIf="!message.analysisId" class="text-muted">No timeline available</p>
                        </div>
                        <div class="tab-pane fade" id="weaknesses-main-{{i}}" role="tabpanel">
                          <div [innerHTML]="(message.parsedSections?.weaknesses || 'No weaknesses section found') | markdownToHtml" apexChartsContainer></div>
                        </div>
                        <div class="tab-pane fade" id="evidence-main-{{i}}" role="tabpanel">
                          <div [innerHTML]="(message.parsedSections?.evidence || 'No evidence section found') | markdownToHtml" apexChartsContainer></div>
                        </div>
                        <div class="tab-pane fade" id="strategy-main-{{i}}" role="tabpanel">
                          <div [innerHTML]="(message.parsedSections?.strategy || 'No strategy section found') | markdownToHtml" apexChartsContainer></div>
                        </div>
                      </div>
                    </div>

                    <!-- Regular message content (if not strategic analysis) -->
                    <div class="message-content" *ngIf="!message.hasStrategicAnalysis" [innerHTML]="message.content | markdownToHtml" apexChartsContainer></div>

                    <!-- Transformation Comparison - Refactored Component -->
                    <app-transformation-preview
                      *ngIf="message.transformationComparison"
                      [transformation]="message.transformationComparison"
                      [messageId]="message.id!"
                      (accept)="acceptTransformation($event)"
                      (reject)="rejectTransformation($event)">
                    </app-transformation-preview>

                    <!-- Suggested Actions -->
                    <div class="suggested-actions" *ngIf="message.documentGenerated">
                      <div class="actions-label">Suggested actions:</div>
                      <div class="actions-buttons">
                        <button class="action-btn" (click)="executeSuggestedAction('view-document', message.documentId)">
                          <i class="ri-eye-line"></i>
                          View Document
                        </button>
                        <button class="action-btn" (click)="executeSuggestedAction('export-pdf', message.documentId)">
                          <i class="ri-file-pdf-line"></i>
                          Export to PDF
                        </button>
                        <button class="action-btn" (click)="executeSuggestedAction('summarize-authority', message.documentId)">
                          <i class="ri-file-text-line"></i>
                          Summarize case authority
                        </button>
                      </div>
                    </div>

                    <!-- Follow-up Questions -->
                    <div class="follow-up-questions-section" *ngIf="(followUpQuestions$ | async)?.length > 0 && i === (conversationMessages$ | async)?.length - 1">
                      <div class="follow-up-label">
                        <i class="ri-question-line"></i>
                        Suggested follow up questions:
                      </div>
                      <div class="follow-up-list">
                        <button
                          *ngFor="let question of (followUpQuestions$ | async)"
                          class="follow-up-btn"
                          (click)="askFollowUpQuestion(question)"
                          [disabled]="isGenerating$ | async">
                          <i class="ri-add-line"></i>
                          <span>{{ question }}</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </li>
          </ng-container>

          <!-- AI Generating State -->
          <li class="message-item assistant" *ngIf="isGenerating$ | async">
            <div class="ai-message-container">
              <div class="d-flex align-items-start gap-3 mb-3">
                <div class="chat-avatar flex-shrink-0">
                  <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                </div>

                <div class="message-bubble ai-message flex-grow-1">
                  <!-- AI Activity Loading -->
                  <div class="ai-activity-loader">
                    <!-- Header -->
                    <div class="activity-header">
                      <span>Generating response</span>
                      <i class="ri-arrow-up-s-line"></i>
                    </div>

                    <!-- Activity Steps - Refactored Component -->
                    <app-workflow-steps
                      [steps]="workflowSteps$ | async"
                      [isGenerating]="isGenerating$ | async">
                    </app-workflow-steps>

                    <button class="btn-stop-response" (click)="stopGeneration()">
                      <i class="ri-stop-circle-line"></i>
                      Stop response
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </li>

        </ul>
      </div>

      <!-- Bottom Input Bar (in chat mode) -->
      <div class="chat-input-bar-bottom" *ngIf="(showBottomSearchBar$ | async) && !(isGenerating$ | async)">
        <form (ngSubmit)="sendFollowUpMessage()" class="chat-input-form">
          <textarea
            class="form-control chat-input"
            [(ngModel)]="followUpMessage"
            name="followUpMessage"
            [placeholder]="followUpPlaceholder"
            rows="1"
            (keydown.enter)="onEnterPress($event)"></textarea>

          <div class="input-footer">
            <div class="jurisdiction-selector-inline">
              <label>Jurisdiction:</label>
              <select class="form-select form-select-sm" [(ngModel)]="selectedJurisdiction" name="jurisdictionInline">
                <option *ngFor="let jur of jurisdictions" [value]="jur">{{jur}}</option>
              </select>
            </div>

            <!-- Research Mode Selector (for follow-up) -->
            <div class="mode-selector-inline" *ngIf="selectedTask === 'question'">
              <label>Mode:</label>
              <div class="btn-group" ngbDropdown placement="top-start">
                <button id="mode-dropdown-followup"
                        ngbDropdownToggle
                        type="button"
                        class="btn btn-light btn-sm mode-btn-compact"
                        [attr.aria-label]="'Selected mode: ' + (selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough')">
                  <span class="mode-name-compact">{{ selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough' }}</span>
                  <span class="mode-cost-compact">{{ selectedResearchMode === 'FAST' ? '~15s' : '~90s' }}</span>
                </button>
                <div ngbDropdownMenu class="dropdown-menu mode-dropdown-minimal">
                  <a class="dropdown-item mode-option-minimal"
                     [class.active]="selectedResearchMode === 'FAST'"
                     (click)="onResearchModeChange('FAST')">
                    <div class="mode-header-minimal">
                      <span class="mode-title">Fast</span>
                      <span class="mode-meta">~15s</span>
                    </div>
                    <p class="mode-desc-minimal">Quick guidance, no citations</p>
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item mode-option-minimal"
                     [class.active]="selectedResearchMode === 'THOROUGH'"
                     (click)="onResearchModeChange('THOROUGH')">
                    <div class="mode-header-minimal">
                      <span class="mode-title">Thorough</span>
                      <span class="mode-meta">~90s</span>
                    </div>
                    <p class="mode-desc-minimal">Verified citations via CourtListener</p>
                  </a>
                </div>
              </div>
            </div>

            <button type="submit" class="btn btn-primary btn-send" [disabled]="!followUpMessage?.trim()">
              <i class="ri-send-plane-fill"></i>
            </button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <!-- Document Editor Modal -->

</div>

<!-- How It Works Modal -->
<ng-template #howItWorksModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="ri-lightbulb-line me-2"></i>
      How AI Drafting Assistant Works
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="feature-list">
      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-file-add-line"></i>
        </div>
        <div class="feature-content">
          <h6>Draft Generation</h6>
          <p>Generate professional legal documents using AI. Simply describe what you need, and the AI will create a complete draft based on your requirements and jurisdiction.</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-pencil-line"></i>
        </div>
        <div class="feature-content">
          <h6>Smart Transformations</h6>
          <p>Select any text in your document and request changes. The AI will show you a side-by-side comparison before applying edits, giving you full control over modifications.</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-history-line"></i>
        </div>
        <div class="feature-content">
          <h6>Version History</h6>
          <p>Every change creates a version snapshot. Review, compare, or restore any previous version of your document at any time.</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-download-line"></i>
        </div>
        <div class="feature-content">
          <h6>Export & Save</h6>
          <p>Download your document as a formatted Word file (.docx) or save it to your file manager for future access and collaboration.</p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="modal.close()">Got it!</button>
  </div>
</ng-template>

<!-- Prompt Tips Modal -->
<ng-template #promptTipsModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="ri-lightbulb-line"></i>
      Prompt Tips & Examples
    </h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <p class="text-muted mb-3" style="font-size: 0.875rem;">
      Get better results by providing clear, detailed prompts. Here are some examples for each document type:
    </p>

    <div class="tips-category" *ngFor="let category of promptTipsByCategory">
      <div class="category-header">
        <span class="category-icon">{{category.icon}}</span>
        <h6>{{category.name}}</h6>
      </div>

      <div class="tip-item" *ngFor="let tip of category.tips">
        <div class="tip-text">"{{tip}}"</div>
        <button class="use-tip-btn" (click)="usePromptExample(tip); modal.dismiss()">
          <i class="ri-file-copy-line"></i>
          Use This Prompt
        </button>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Close</button>
  </div>
</ng-template>

<!-- Step Output Full View Modal -->
<div class="step-output-modal-backdrop" *ngIf="showStepOutputModal && expandedStepOutput" (click)="closeStepOutputModal()">
  <div class="step-output-modal card" (click)="$event.stopPropagation()">
    <div class="card-header d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="step-type-badge" [ngClass]="{
          'bg-info': expandedStepOutput.stepType === 'DISPLAY',
          'bg-warning': expandedStepOutput.stepType === 'SYNTHESIS',
          'bg-danger': expandedStepOutput.stepType === 'GENERATION',
          'bg-primary': expandedStepOutput.stepType === 'INTEGRATION',
          'bg-secondary': expandedStepOutput.stepType === 'ACTION'
        }">{{ expandedStepOutput.stepType }}</span>
        <h6 class="mb-0">{{ expandedStepOutput.stepName }}</h6>
      </div>
      <button type="button" class="btn-close" (click)="closeStepOutputModal()"></button>
    </div>

    <div class="card-body">
      <!-- Synthesis/Generation content -->
      <div class="output-full-content" *ngIf="expandedStepOutput.outputData?.content">
        <div class="output-meta mb-3">
          <span class="badge bg-soft-success text-success me-2" *ngIf="expandedStepOutput.outputData.synthesisType">
            <i class="ri-magic-line me-1"></i>{{ expandedStepOutput.outputData.synthesisType }}
          </span>
          <span class="badge bg-soft-danger text-danger me-2" *ngIf="expandedStepOutput.outputData.generationType">
            <i class="ri-file-edit-line me-1"></i>{{ expandedStepOutput.outputData.generationType }}
          </span>
          <span class="badge bg-soft-secondary text-secondary" *ngIf="expandedStepOutput.outputData.generatedAt">
            <i class="ri-time-line me-1"></i>{{ expandedStepOutput.outputData.generatedAt }}
          </span>
        </div>
        <div class="content-text markdown-content" [innerHTML]="expandedStepOutput.outputData.content | markdownToHtml"></div>
      </div>

      <!-- Integration draft content -->
      <div class="output-full-content" *ngIf="expandedStepOutput.outputData?.draftContent">
        <div class="output-meta mb-3">
          <span class="badge bg-soft-primary text-primary">
            <i class="ri-draft-line me-1"></i>Generated Draft
          </span>
        </div>
        <div class="content-text markdown-content" [innerHTML]="expandedStepOutput.outputData.draftContent | markdownToHtml"></div>
      </div>

      <!-- Display step data -->
      <div class="output-full-content" *ngIf="expandedStepOutput.outputData?.stepType === 'display'">
        <!-- Analyses -->
        <div class="mb-4" *ngIf="expandedStepOutput.outputData.analyses?.length > 0">
          <h6 class="text-muted mb-3"><i class="ri-file-text-line me-2"></i>Document Analyses</h6>
          <div class="analysis-card" *ngFor="let analysis of expandedStepOutput.outputData.analyses">
            <div class="fw-medium">{{ getCleanFileName(analysis.fileName) }}</div>
            <small class="text-muted d-block">Type: {{ analysis.documentType }}</small>
            <p class="mt-2 mb-0" *ngIf="analysis.summary">{{ analysis.summary }}</p>
          </div>
        </div>

        <!-- Action Items -->
        <div class="mb-4" *ngIf="expandedStepOutput.outputData.actionItems?.length > 0">
          <h6 class="text-muted mb-3"><i class="ri-checkbox-circle-line me-2"></i>Action Items</h6>
          <div class="action-item-card" *ngFor="let item of expandedStepOutput.outputData.actionItems">
            <div class="d-flex align-items-start gap-2">
              <span class="badge" [ngClass]="{
                'bg-danger': item.priority === 'high',
                'bg-warning': item.priority === 'medium',
                'bg-info': item.priority === 'low'
              }">{{ item.priority }}</span>
              <div>
                <div class="fw-medium">{{ item.title }}</div>
                <small class="text-muted" *ngIf="item.deadline">Due: {{ item.deadline }}</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Timeline Events -->
        <div *ngIf="expandedStepOutput.outputData.timelineEvents?.length > 0">
          <h6 class="text-muted mb-3"><i class="ri-calendar-event-line me-2"></i>Timeline Events</h6>
          <div class="timeline-event-card" *ngFor="let event of expandedStepOutput.outputData.timelineEvents">
            <div class="d-flex align-items-start gap-2">
              <span class="badge" [ngClass]="event.isDeadline ? 'bg-danger' : 'bg-secondary'">
                {{ event.eventDate }}
              </span>
              <div>
                <div class="fw-medium">{{ event.title }}</div>
                <small class="text-muted" *ngIf="event.description">{{ event.description }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-footer d-flex justify-content-end gap-2">
      <button type="button" class="btn btn-outline-primary" (click)="copyToClipboard(expandedStepOutput.outputData?.content || expandedStepOutput.outputData?.draftContent)">
        <i class="ri-clipboard-line me-1"></i>Copy
      </button>
      <button type="button" class="btn btn-light" (click)="closeStepOutputModal()">Close</button>
    </div>
  </div>
</div>

<!-- Workflow Help Modal -->
<div class="workflow-help-modal-backdrop" *ngIf="showWorkflowHelpModal" (click)="showWorkflowHelpModal = false">
  <div class="workflow-help-modal" (click)="$event.stopPropagation()">
    <div class="modal-header-custom">
      <div class="d-flex align-items-center gap-2">
        <i class="ri-lightbulb-line text-warning fs-4"></i>
        <h5 class="modal-title mb-0">How Case Workflows Work</h5>
      </div>
      <button type="button" class="modal-close-btn" (click)="showWorkflowHelpModal = false">
        <i class="ri-close-line"></i>
      </button>
    </div>
    <div class="modal-body-custom">
      <div class="workflow-tips-list">
        <div class="tip-item">
          <span class="tip-number">1</span>
          <div class="tip-content">
            <strong>Select a Workflow Template</strong>
            <p class="text-muted mb-0">Choose a template that matches your case type (e.g., Complaint Response, Contract Review, Due Diligence)</p>
          </div>
        </div>
        <div class="tip-item">
          <span class="tip-number">2</span>
          <div class="tip-content">
            <strong>Name Your Workflow</strong>
            <p class="text-muted mb-0">Give your workflow a descriptive name for easy tracking in the sidebar</p>
          </div>
        </div>
        <div class="tip-item">
          <span class="tip-number">3</span>
          <div class="tip-content">
            <strong>Select Documents</strong>
            <p class="text-muted mb-0">Choose analyzed documents to include - these will be used by AI during processing</p>
          </div>
        </div>
        <div class="tip-item">
          <span class="tip-number">4</span>
          <div class="tip-content">
            <strong>AI Processes Each Step</strong>
            <p class="text-muted mb-0">The AI will automatically work through each step, generating analysis and drafts</p>
          </div>
        </div>
      </div>
      <div class="workflow-benefits-box mt-4">
        <div class="d-flex align-items-start gap-2">
          <i class="ri-checkbox-circle-fill text-success fs-5"></i>
          <p class="mb-0">Workflows automate repetitive legal tasks and ensure consistent quality across your cases.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Preview Modal (Workflow Recommendation) -->
<div class="quick-preview-modal-backdrop" *ngIf="showQuickPreviewModal" (click)="closeQuickPreviewModal()">
  <div class="quick-preview-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="quick-preview-header">
      <div class="d-flex align-items-center gap-3">
        <div class="template-emoji-icon" [style.background-color]="caseWorkflowService.getTemplateColor(quickPreviewRecommendation?.templateType)">
          <span>{{ caseWorkflowService.getTemplateIcon(quickPreviewRecommendation?.templateType) }}</span>
        </div>
        <div>
          <h5 class="modal-title mb-0">{{ quickPreviewRecommendation?.templateName }}</h5>
          <span class="quick-preview-case-info">
            <i class="ri-briefcase-line"></i>
            {{ quickPreviewRecommendation?.caseNumber }} - {{ quickPreviewRecommendation?.caseTitle }}
          </span>
        </div>
      </div>
      <button type="button" class="modal-close-btn" (click)="closeQuickPreviewModal()">
        <i class="ri-close-line"></i>
      </button>
    </div>

    <!-- Urgency Badge -->
    <div class="quick-preview-urgency" *ngIf="quickPreviewRecommendation?.urgency">
      <span class="urgency-badge" [ngStyle]="getUrgencyBadgeStyle(quickPreviewRecommendation?.urgency)">
        {{ quickPreviewRecommendation?.urgencyLabel || quickPreviewRecommendation?.urgency }}
      </span>
      <span class="urgency-reason">{{ quickPreviewRecommendation?.reason }}</span>
    </div>

    <!-- Documents Section -->
    <div class="quick-preview-body">
      <!-- Loading State -->
      <div class="quick-preview-loading" *ngIf="loadingCaseDocuments">
        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        <span>Loading case documents...</span>
      </div>

      <!-- Documents Available -->
      <div class="quick-preview-documents" *ngIf="!loadingCaseDocuments && caseDocumentsForPreview.length > 0">
        <div class="documents-header">
          <i class="ri-file-list-3-line"></i>
          <span>Select Documents ({{ previewSelectedDocuments.length }}/{{ caseDocumentsForPreview.length }})</span>
        </div>
        <div class="documents-list">
          <div class="document-item" *ngFor="let doc of caseDocumentsForPreview"
               [class.selected]="isPreviewDocumentSelected(doc.id)"
               (click)="togglePreviewDocument(doc.id)">
            <div class="document-checkbox">
              <i class="ri-checkbox-circle-fill" *ngIf="isPreviewDocumentSelected(doc.id)"></i>
              <i class="ri-checkbox-blank-circle-line" *ngIf="!isPreviewDocumentSelected(doc.id)"></i>
            </div>
            <div class="document-info">
              <span class="document-name">{{ doc.fileName }}</span>
              <span class="document-type">{{ doc.detectedType || 'Document' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- No Documents Available -->
      <div class="quick-preview-no-docs" *ngIf="!loadingCaseDocuments && caseDocumentsForPreview.length === 0">
        <div class="no-docs-icon">
          <i class="ri-folder-upload-line"></i>
        </div>
        <p class="no-docs-title">No Analyzed Documents</p>
        <p class="no-docs-desc">This case doesn't have any analyzed documents yet. Upload and analyze documents to use this workflow.</p>
        <button class="btn btn-primary btn-upload-docs" (click)="navigateToUploadForCase()">
          <i class="ri-upload-2-line"></i>
          Upload Documents
        </button>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="quick-preview-footer">
      <button type="button" class="btn btn-light" (click)="closeQuickPreviewModal()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary"
              [disabled]="loadingCaseDocuments || (caseDocumentsForPreview.length === 0)"
              (click)="confirmQuickPreview()">
        <i class="ri-play-circle-line"></i>
        Start Workflow
      </button>
    </div>
  </div>
</div>

<!-- Start Workflow Modal -->
<div class="start-workflow-modal-backdrop" *ngIf="showStartWorkflowModal" (click)="closeStartWorkflowModal()">
  <div class="start-workflow-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header-custom">
      <div class="d-flex align-items-center gap-3">
        <div class="template-emoji-icon" [style.background-color]="getWorkflowTemplateColor(selectedWorkflowTemplate?.templateType)">
          <span>{{ getWorkflowTemplateIcon(selectedWorkflowTemplate?.templateType) }}</span>
        </div>
        <h5 class="modal-title mb-0">Start {{ selectedWorkflowTemplate?.name }}</h5>
      </div>
      <button type="button" class="modal-close-btn" (click)="closeStartWorkflowModal()">
        <i class="ri-close-line"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body-custom">
      <!-- Workflow Configuration Section -->
      <div class="config-section">
        <h6 class="section-label">Workflow Configuration</h6>

        <!-- Workflow Name -->
        <div class="config-field">
          <label class="field-label">Workflow Name <span class="text-danger">*</span></label>
          <input
            type="text"
            class="form-control field-input"
            [(ngModel)]="workflowName"
            placeholder="e.g., Personal Injury Workflow"
            maxlength="100"
            [class.is-invalid]="!workflowName.trim() && workflowSelectedDocuments.length > 0">
        </div>

        <!-- Associated Case -->
        <div class="config-field">
          <label class="field-label">Associated Case</label>
          <select class="form-select field-input" [(ngModel)]="selectedCaseId">
            <option [ngValue]="null">None - General Draft</option>
            <option *ngFor="let c of userCases" [ngValue]="c.id">
              {{ c.caseNumber }} - {{ c.title }}
            </option>
          </select>
        </div>

        <!-- Select Documents -->
        <div class="config-field">
          <label class="field-label">Select Documents to Analyze</label>
          <div class="documents-list" *ngIf="(analyzedDocuments$ | async) as docs">
            <div *ngIf="docs.length === 0" class="no-docs-message">
              No analyzed documents available.
              <a href="javascript:void(0)" (click)="closeStartWorkflowModal(); selectTask('upload')">Analyze documents first</a>
            </div>
            <div class="document-item" *ngFor="let doc of docs"
                 [class.selected]="workflowSelectedDocuments.includes(doc.databaseId)"
                 (click)="toggleWorkflowDocument(doc.databaseId)">
              <span class="doc-checkbox-visual" [class.checked]="workflowSelectedDocuments.includes(doc.databaseId)">
                <i class="ri-check-line" *ngIf="workflowSelectedDocuments.includes(doc.databaseId)"></i>
              </span>
              <span class="doc-name">{{ getCleanFileName(doc.fileName) }}</span>
            </div>
          </div>
          <div class="selected-count mt-2" *ngIf="workflowSelectedDocuments.length > 0">
            <small class="text-success"><i class="ri-checkbox-circle-line me-1"></i>{{ workflowSelectedDocuments.length }} document(s) selected</small>
          </div>
        </div>
      </div>

      <!-- Workflow Steps Preview -->
      <div class="steps-section">
        <h6 class="section-label">Workflow Steps Preview</h6>
        <div class="steps-list-modal">
          <div class="step-row" *ngFor="let step of selectedWorkflowTemplate?.stepsConfig?.steps; let i = index">
            <div class="step-number-circle">{{ i + 1 }}</div>
            <div class="step-info">
              <div class="step-name-row">
                <span class="step-name">{{ step.name }}</span>
                <span class="step-badge" [ngClass]="{
                  'badge-display': step.type === 'display',
                  'badge-synthesis': step.type === 'synthesis',
                  'badge-generation': step.type === 'generation',
                  'badge-action': step.type === 'action',
                  'badge-integration': step.type === 'integration'
                }">{{ step.type | uppercase }}</span>
              </div>
              <p class="step-description" *ngIf="step.description">{{ step.description }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer-custom">
      <div class="footer-alert" *ngIf="!workflowName.trim() && workflowSelectedDocuments.length > 0">
        <i class="ri-error-warning-line"></i>
        <span>Please enter a workflow name above</span>
      </div>
      <div class="footer-actions">
        <button type="button" class="btn-cancel" (click)="closeStartWorkflowModal()">Cancel</button>
        <button type="button" class="btn-start" [disabled]="!workflowName.trim() || workflowSelectedDocuments.length === 0 || startingWorkflow" (click)="startWorkflow()">
          <span *ngIf="!startingWorkflow">
            <i class="ri-checkbox-circle-line me-1"></i>
            Start Workflow
          </span>
          <span *ngIf="startingWorkflow">
            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
            Starting...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Document Preview Modal (Actual PDF Preview) -->
<div class="document-preview-modal-backdrop" *ngIf="showDocumentPreviewModal" (click)="closeDocumentPreviewModal()">
  <div class="document-preview-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header - PDF Reader Toolbar -->
    <div class="preview-modal-header">
      <div class="header-left">
        <div class="pdf-icon-badge">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
            <path d="M5 4H15V8H19V20H5V4ZM3.9985 2C3.44749 2 3 2.44405 3 2.9918V21.0082C3 21.5447 3.44476 22 3.9934 22H20.0066C20.5551 22 21 21.5489 21 20.9925L20.9997 7L16 2H3.9985ZM10.4999 7.5C10.4999 9.07749 10.0442 10.9373 9.27493 12.6534C8.50287 14.3757 7.46143 15.8502 6.37524 16.7191L7.55464 18.3321C10.4821 16.3804 13.7233 15.0421 16.8585 15.49L17.3162 13.5513C14.6435 12.6604 12.4999 9.98994 12.4999 7.5H10.4999ZM11.0999 13.4716C11.3673 12.8752 11.6042 12.2563 11.8037 11.6285C12.2753 12.3531 12.8553 13.0182 13.5101 13.5953C12.5283 13.7711 11.5665 14.0596 10.6352 14.4276C10.7999 14.1143 10.9551 13.7948 11.0999 13.4716Z"></path>
          </svg>
        </div>
        <div class="header-title-section">
          <h5>{{ activeDocumentTitle || 'Document Preview' }}.pdf</h5>
          <div class="header-subtitle">
            <span class="meta-item">PDF Preview</span>
            <span class="meta-divider">•</span>
            <span class="meta-item" *ngIf="!isLoadingPreview && previewPdfUrl">Ready to download</span>
            <span class="meta-item" *ngIf="isLoadingPreview">Generating PDF...</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn-action btn-download" (click)="downloadPreviewedPdf()" [disabled]="isLoadingPreview || !previewPdfUrl">
          <i class="ri-download-2-line"></i>
          <span>Download PDF</span>
        </button>
        <button class="btn-action btn-word" (click)="exportToWord(); closeDocumentPreviewModal()">
          <i class="ri-file-word-line"></i>
          <span>Download Word</span>
        </button>
        <button type="button" class="btn-close-preview" (click)="closeDocumentPreviewModal()">
          <i class="ri-close-line"></i>
        </button>
      </div>
    </div>

    <!-- Modal Body - Actual PDF in iframe -->
    <div class="preview-modal-body">
      <!-- Loading State -->
      <div class="pdf-loading-state" *ngIf="isLoadingPreview">
        <div class="loading-spinner">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <p class="loading-text">Generating PDF...</p>
        <p class="loading-subtext">Please wait</p>
      </div>

      <!-- PDF iframe -->
      <iframe
        *ngIf="sanitizedPreviewUrl && !isLoadingPreview"
        [src]="sanitizedPreviewUrl"
        class="pdf-preview-iframe"
        frameborder="0">
      </iframe>

      <!-- Error/Empty State -->
      <div class="pdf-empty-state" *ngIf="!sanitizedPreviewUrl && !isLoadingPreview">
        <i class="ri-file-damage-line"></i>
        <p>Failed to generate PDF preview</p>
        <button class="btn btn-soft-primary" (click)="generatePdfForPreview()">
          <i class="ri-refresh-line me-1"></i>
          Try Again
        </button>
      </div>
    </div>
  </div>
</div>
