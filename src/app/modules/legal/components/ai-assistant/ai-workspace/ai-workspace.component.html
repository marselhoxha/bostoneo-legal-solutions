<!-- ============================================ -->
<!-- DRAFTING PAGE - VELZON THEME DESIGN -->
<!-- 3-Column Layout: Conversations | Main | Chat -->
<!-- ============================================ -->

<div class="drafting-container" style="margin-top: 100px; max-width: 100%;">

  <!-- Mobile Menu Toggle Button -->
  <button class="mobile-menu-toggle" (click)="toggleSidebar()" aria-label="Toggle sidebar">
    <i class="ri-menu-line"></i>
  </button>

  <!-- Sidebar Backdrop Overlay (Mobile Only) -->
  <div class="sidebar-backdrop" [class.show]="sidebarOpen$ | async" (click)="closeSidebar()"></div>

  <!-- ========================================== -->
  <!-- LEFT SIDEBAR: Document Analysis (Upload mode) -->
  <!-- ========================================== -->
  <aside class="card conversation-sidebar" [class.open]="sidebarOpen$ | async"
         *ngIf="!(draftingMode$ | async) && selectedTask === 'upload' && !((documentViewerMode$ | async) && (viewerSidebarCollapsed$ | async))">
    <div class="conversation-sidebar-header">
      <button type="button" class="btn btn-soft-primary rounded-pill waves-effect waves-light w-100"
              (click)="triggerFileUpload()">
        <i class="ri-add-line fs-16 me-2"></i>New Analysis
      </button>
    </div>

    <!-- Search Bar -->
    <div class="conversation-search">
      <div class="search-input-wrapper">
        <i class="ri-search-line search-icon"></i>
        <input
          type="text"
          class="form-control"
          placeholder="Search documents..."
          [(ngModel)]="documentSearchQuery">
      </div>
    </div>

    <!-- Document Analyses Section -->
    <div class="document-analyses-section">
      <div class="section-header">
        <i class="ri-file-search-line me-2"></i>
        <span>Document Analyses</span>
      </div>

      <!-- Loading State -->
      <div class="conversation-loading" *ngIf="loadingAnalyses">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted small">Loading analyses...</p>
      </div>

      <!-- Empty State -->
      <div class="conversation-empty" *ngIf="!loadingAnalyses && (analyzedDocuments$ | async)?.length === 0">
        <i class="ri-file-text-line empty-icon"></i>
        <p class="empty-title">No documents analyzed yet</p>
        <p class="empty-description">Upload a document to get started</p>
      </div>

      <!-- Documents List -->
      <div class="documents-list" *ngIf="(analyzedDocuments$ | async)?.length > 0">
        <div
          *ngFor="let doc of filteredAnalyzedDocuments"
          class="document-item"
          [class.active]="(activeDocumentId$ | async) === doc.id"
          (click)="openDocumentInViewer(doc)">
          <div class="document-icon">
            <i class="ri-file-text-line"></i>
          </div>
          <div class="document-info">
            <div class="document-name" [title]="doc.fileName">
              {{ doc.fileName | slice:0:22 }}{{ doc.fileName.length > 22 ? '...' : '' }}
            </div>
            <div class="document-meta">
              <span class="badge me-1" [ngClass]="getDocTypeColorClass(doc.detectedType)" style="font-size: 0.65rem;">
                {{ doc.detectedType }}
              </span>
              <span class="document-date">
                {{ doc.timestamp | date:'MMM d' }}
              </span>
            </div>
          </div>
          <div class="document-actions" (click)="$event.stopPropagation()">
            <button class="action-btn" (click)="deleteAnalysis(doc)" title="Delete analysis">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- View All Link -->
      <div class="view-all-link" *ngIf="(analyzedDocuments$ | async)?.length > 10">
        <button class="btn btn-link btn-sm" (click)="openAnalysisHistoryModal()">
          <i class="ri-history-line me-1"></i>
          View All Analyses
        </button>
      </div>
    </div>

    <!-- Collections Section -->
    <div class="collections-section">
      <div class="section-header">
        <i class="ri-folder-line me-2"></i>
        <span>Collections</span>
        <button class="btn btn-sm btn-link ms-auto p-0"
                (click)="showNewCollectionModal = true"
                title="Create new collection">
          <i class="ri-add-line"></i>
        </button>
      </div>

      <!-- Loading State -->
      <div class="text-center py-2" *ngIf="loadingCollections">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <!-- Empty State -->
      <div class="collection-empty" *ngIf="!loadingCollections && (collections$ | async)?.length === 0">
        <p class="text-muted small mb-2">No collections yet</p>
        <button class="btn btn-sm btn-soft-primary" (click)="showNewCollectionModal = true">
          <i class="ri-add-line me-1"></i>Create Collection
        </button>
      </div>

      <!-- Collections List -->
      <div class="collections-list" *ngIf="!loadingCollections && (collections$ | async)?.length > 0">
        <div class="collection-item"
             *ngFor="let collection of (collections$ | async)"
             (click)="openCollection(collection)">
          <div class="collection-icon" [style.background-color]="collection.color + '20'">
            <i [class]="collection.icon || 'ri-folder-line'" [style.color]="collection.color"></i>
          </div>
          <div class="collection-info">
            <div class="collection-name">{{ collection.name }}</div>
            <div class="collection-meta">
              <span class="doc-count">{{ collection.documentCount }} doc{{ collection.documentCount !== 1 ? 's' : '' }}</span>
            </div>
          </div>
          <div class="collection-actions" (click)="$event.stopPropagation()">
            <button class="action-btn" (click)="deleteCollection(collection)" title="Delete collection">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- New Collection Modal -->
    <div class="new-collection-modal-backdrop" *ngIf="showNewCollectionModal" (click)="showNewCollectionModal = false">
      <div class="new-collection-modal card" (click)="$event.stopPropagation()">
        <div class="card-header">
          <h6 class="mb-0">Create New Collection</h6>
          <button type="button" class="btn-close" (click)="showNewCollectionModal = false"></button>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Collection Name</label>
            <input type="text"
                   class="form-control"
                   #collectionNameInput
                   placeholder="e.g., Smith v. Jones Case">
          </div>
          <div class="mb-3">
            <label class="form-label">Description (optional)</label>
            <textarea class="form-control"
                      #collectionDescInput
                      rows="2"
                      placeholder="Brief description..."></textarea>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-light" (click)="showNewCollectionModal = false">Cancel</button>
          <button type="button" class="btn btn-primary"
                  (click)="createCollection(collectionNameInput.value, collectionDescInput.value)">
            Create Collection
          </button>
        </div>
      </div>
    </div>

  </aside>

  <!-- ========================================== -->
  <!-- LEFT SIDEBAR: Conversations (Non-Upload modes) -->
  <!-- ========================================== -->
  <aside class="card conversation-sidebar" [class.open]="sidebarOpen$ | async"
         *ngIf="!(draftingMode$ | async) && selectedTask !== 'upload' && !((documentViewerMode$ | async) && (viewerSidebarCollapsed$ | async))">
    <div class="conversation-sidebar-header">
      <button type="button" class="btn btn-soft-primary rounded-pill waves-effect waves-light w-100"
              (click)="startNewConversation()">
        <i class="ri-add-line fs-16 me-2"></i>New Conversation
      </button>
    </div>

    <!-- Search Bar -->
    <div class="conversation-search">
      <div class="search-input-wrapper">
        <i class="ri-search-line search-icon"></i>
        <input
          type="text"
          class="form-control"
          placeholder="Enter conversation terms"
          [(ngModel)]="conversationSearchQuery">
      </div>
    </div>

    <!-- Conversation List -->
    <div class="conversation-list-container">
      <!-- Loading State -->
      <div class="conversation-loading" *ngIf="loadingDrafts">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading conversations...</p>
      </div>

      <!-- Empty State -->
      <div class="conversation-empty" *ngIf="!loadingDrafts && (conversations$ | async)?.length === 0">
        <i class="ri-chat-3-line empty-icon"></i>
        <p class="empty-title">No conversations yet</p>
        <p class="empty-description">Start a new conversation to see it here</p>
      </div>

      <!-- Conversations List -->
      <div *ngIf="!loadingDrafts && (conversations$ | async)?.length > 0">
        <!-- Past 90 Days -->
        <div class="conversation-group" *ngIf="(groupedConversations$ | async)?.past90Days?.length > 0">
          <div class="conversation-group-header">
            <span>Past 90 Days</span>
            <button class="btn-delete-all" (click)="deleteAllConversations()">Delete all</button>
          </div>

          <div class="conversation-list">
            <div
              *ngFor="let conv of filteredConversations"
              class="conversation-item"
              [class.active]="(activeConversationId$ | async) === conv.id"
              (click)="switchConversation(conv.id)">
              <div class="conversation-title">{{conv.title}}</div>
              <div class="conversation-meta">
                <span class="badge bg-soft-primary me-2" *ngIf="conv.caseId" style="font-size: 0.7rem;">
                  <i class="ri-briefcase-line"></i> Case
                </span>
                <div class="conversation-date">
                  <i class="ri-time-line"></i>
                  <span>{{conv.date | date:'MMM d'}}</span>
                </div>
                <div class="conversation-count" *ngIf="(conv.messageCount || conv.messages.length) > 0">
                  <i class="ri-message-3-line"></i>
                  <span>{{conv.messageCount || conv.messages.length}}</span>
                </div>
              </div>
              <div class="conversation-actions" (click)="$event.stopPropagation()">
                <button class="action-btn" (click)="deleteConversation(conv.id)" title="Delete conversation">
                  <i class="ri-delete-bin-line"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- ========================================== -->
  <!-- MAIN CONTENT AREA -->
  <!-- ========================================== -->
  <main class="main-content-area" [class.full-width]="(documentViewerMode$ | async) && (viewerSidebarCollapsed$ | async)">

    <!-- Document Analysis Viewer (Full-width when viewing document) -->
    <app-document-analysis-viewer
      *ngIf="(documentViewerMode$ | async) && getActiveDocument()"
      [document]="getActiveDocument()!"
      (close)="closeDocumentViewer()"
      (exportPdf)="onExportPdf($event)"
      (exportWord)="onExportWord($event)"
      (saveToFileManager)="onSaveToFileManager($event)">
    </app-document-analysis-viewer>

    <!-- Welcome Screen (No active conversation) -->
    <div class="welcome-screen" *ngIf="!(documentViewerMode$ | async) && !(showChat$ | async) && !(isGenerating$ | async) && !(draftingMode$ | async)">
      <div class="welcome-header">
        <h2 class="welcome-title mb-0">Welcome, {{ getUserDisplayName() }}</h2>
        <p class="welcome-subtitle">AI-Powered Document Analysis for Legal Professionals</p>
      </div>

      <!-- Action Cards Grid (always shown for navigation) -->
      <div class="action-cards-main mb-4">
        <div
          class="action-card"
          [class.active]="selectedTask === 'question'"
          (click)="selectTask('question')">
          <div class="icon-box">
            <i class="ri-question-answer-line"></i>
          </div>
          <div class="card-content">
            <span>Ask a legal question</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'draft'"
          (click)="selectTask('draft')">
          <div class="icon-box">
            <i class="ri-file-edit-line"></i>
          </div>
          <div class="card-content">
            <span>Generate a draft</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'summarize'"
          (click)="selectTask('summarize')">
          <div class="icon-box">
            <i class="ri-file-list-3-line"></i>
          </div>
          <div class="card-content">
            <span>Summarize a case</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'upload'"
          (click)="selectTask('upload')">
          <div class="icon-box">
            <i class="ri-upload-cloud-line"></i>
          </div>
          <div class="card-content">
            <span>Upload document</span>
          </div>
        </div>
      </div>

      <!-- Examples Section -->
      <div class="examples-section card mb-4" *ngIf="selectedTask">
        <div class="card-body">
          <h6 class="mb-3">{{ getExamplesTitle() }}</h6>
          <div class="example-list">
            <p class="text-muted mb-2" *ngFor="let example of getExamples()">• {{ example }}</p>
          </div>
        </div>
      </div>

      <!-- Upload Document Section (shown when Upload task is selected) -->
      <div class="primary-upload-section mb-4" *ngIf="selectedTask === 'upload'">
        <div class="upload-card card">
          <div class="card-body">
            <!-- Drag & Drop Zone -->
            <div class="upload-drop-zone-primary"
                 [class.dragover]="isDragover"
                 (drop)="onFileDrop($event)"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (click)="fileInput.click()">
              <input #fileInput
                     type="file"
                     hidden
                     (change)="onFileSelect($event)"
                     accept=".pdf,.docx,.doc,.txt"
                     multiple>

              <div class="upload-icon-large">
                <i class="ri-upload-cloud-2-line"></i>
              </div>
              <h5 class="upload-title">Drop documents here or click to upload</h5>
              <p class="upload-description text-muted">
                Supports PDF, DOCX, DOC, TXT • Auto-detection enabled
              </p>
            </div>

            <!-- URL Fetch Input -->
            <div class="url-fetch-section mt-3">
              <div class="input-group">
                <span class="input-group-text"><i class="ri-link"></i></span>
                <input type="url"
                       class="form-control"
                       [(ngModel)]="documentUrl"
                       name="documentUrl"
                       placeholder="Or paste document URL...">
                <button type="button"
                        class="btn btn-primary"
                        (click)="fetchFromUrl()"
                        [disabled]="!documentUrl || isFetchingUrl">
                  <i class="ri-download-cloud-line me-1"></i>
                  {{ isFetchingUrl ? 'Fetching...' : 'Fetch' }}
                </button>
              </div>
            </div>

            <!-- Uploaded Files List -->
            <div class="uploaded-files-list mt-3" *ngIf="uploadedFiles.length > 0">
              <h6 class="mb-2">Ready to analyze ({{uploadedFiles.length}})</h6>
              <div class="file-item" *ngFor="let file of uploadedFiles; let i = index">
                <div class="file-info">
                  <i class="ri-file-text-line file-icon"></i>
                  <div class="file-details">
                    <div class="file-name">{{file.name}}</div>
                    <div class="file-meta">{{formatFileSize(file.size)}}</div>
                  </div>
                </div>
                <button type="button" class="btn btn-sm btn-light" (click)="removeFile(i)">
                  <i class="ri-close-line"></i>
                </button>
              </div>

              <!-- Analyze Button -->
              <button type="button"
                      class="btn btn-primary w-100 mt-3"
                      (click)="startCustomDraft()"
                      [disabled]="uploadedFiles.length === 0 || (isGenerating$ | async)">
                <i class="ri-file-search-line me-2"></i>
                Analyze {{ uploadedFiles.length }} Document{{ uploadedFiles.length > 1 ? 's' : '' }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Document Type Selector - Custom Dropdown (when Generate a draft is selected) -->
      <div class="document-type-selector" *ngIf="selectedTask === 'draft'">
        <div class="selector-header">
          <div class="selector-label">Draft:</div>

          <!-- Custom Dropdown Button -->
          <div class="custom-dropdown-wrapper">
            <button
              type="button"
              class="custom-dropdown-toggle"
              (click)="toggleDocTypeDropdown()"
              [class.active]="showDocTypeDropdown">
              <span class="dropdown-text">{{selectedDocTypeName}}</span>
              <i class="ri-arrow-down-s-line dropdown-arrow" [class.rotated]="showDocTypeDropdown"></i>
            </button>

            <!-- Dropdown Menu -->
            <div class="custom-dropdown-menu" *ngIf="showDocTypeDropdown">
              <div class="dropdown-content">
                <div class="dropdown-category" *ngFor="let category of documentTypeCategories">
                  <div class="category-header" (click)="toggleCategory(category.id)">
                    <span class="category-icon">{{category.icon}}</span>
                    <span class="category-name">{{category.name}}</span>
                    <i class="ri-arrow-down-s-line toggle-icon" [class.rotated]="category.expanded"></i>
                  </div>

                  <div class="category-items" *ngIf="category.expanded">
                    <button
                      type="button"
                      class="dropdown-item"
                      *ngFor="let type of category.types"
                      [class.selected]="selectedDocTypePill === type.id"
                      (click)="selectDocTypePill(type.id)">
                      {{type.name}}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Search input (optional filter) -->
          <div class="doc-type-search-wrapper">
            <i class="ri-search-line search-icon"></i>
            <input
              type="text"
              class="form-control form-control-sm doc-type-search"
              [(ngModel)]="documentTypeSearchText"
              placeholder="Or search types..."
              name="docTypeSearch">
          </div>

          <a (click)="showPromptTips()" class="prompt-tips-link">
            <i class="ri-lightbulb-line"></i>
            Prompt Tips
          </a>
        </div>

        <!-- Quick access pills (filtered by search if active) -->
        <div class="quick-pills" *ngIf="documentTypeSearchText && filteredDocumentTypes.length > 0">
          <button
            class="pill-btn"
            *ngFor="let type of filteredDocumentTypes"
            [class.active]="selectedDocTypePill === type.id"
            (click)="selectDocTypePill(type.id)">
            {{type.name}}
          </button>
        </div>
      </div>

      <!-- Warning: Document Type Required (only show when user focuses prompt) -->
      <div class="alert alert-warning doc-type-warning"
           *ngIf="selectedTask === 'draft' && showDocTypeWarning && !selectedDocTypePill">
        <i class="ri-alert-line me-1"></i>
        <strong>Please select a document type above</strong> to ensure proper citation formatting
      </div>

      <!-- Main Prompt Input -->
      <div class="main-prompt-area">
        <form (ngSubmit)="startCustomDraft()" class="prompt-form card">
          <div class="card-body">
            <!-- Upload mode: Hide textarea, analysis is automatic -->
            <textarea
              *ngIf="selectedTask !== 'upload'"
              class="form-control prompt-textarea"
              [(ngModel)]="customPrompt"
              (focus)="onPromptFocus()"
              name="customPrompt"
              [placeholder]="promptPlaceholder"
              rows="3"></textarea>

            <!-- Upload mode: Show instructions instead -->
            <div *ngIf="selectedTask === 'upload'" class="upload-instructions">
              <p class="text-muted mb-2">
                <i class="ri-information-line"></i>
                Upload your documents above, then click <strong>Analyze Documents</strong> to process them using the selected analysis type.
              </p>
            </div>

            <!-- Case Selector (Draft task only) -->
            <div class="case-selector-section" *ngIf="selectedTask === 'draft'" style="margin-top: 1rem; margin-bottom: 1rem;">
              <label class="form-label" style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                <i class="ri-briefcase-line me-1"></i>
                Link to Case (Optional):
              </label>
              <select [(ngModel)]="selectedCaseId" class="form-select" name="caseSelector" style="margin-bottom: 0.5rem;">
                <option [ngValue]="null">None - General Draft</option>
                <option *ngFor="let case of userCases" [ngValue]="case.id">
                  {{case.caseNumber}} - {{case.title}}
                </option>
              </select>
              <small class="text-muted" style="font-size: 0.75rem;">
                <i class="ri-information-line"></i>
                Select a case to include case context in the draft
              </small>
            </div>

            <div class="prompt-footer">
              <!-- Hide jurisdiction and mode selectors for upload mode -->
              <div class="jurisdiction-selector" *ngIf="selectedTask !== 'upload'">
                <label>Jurisdiction:</label>
                <select class="form-select" [(ngModel)]="selectedJurisdiction" name="jurisdiction">
                  <option *ngFor="let jur of jurisdictions" [value]="jur">{{jur}}</option>
                </select>
              </div>

              <!-- Research Mode Selector (Compact) - Hidden for upload mode -->
              <div class="mode-selector-compact" *ngIf="selectedTask !== 'upload'">
                <label>Mode:</label>
                <div class="btn-group" ngbDropdown placement="top-start">
                  <button id="mode-dropdown-compact"
                          ngbDropdownToggle
                          type="button"
                          class="btn btn-light btn-sm mode-btn-compact"
                          [attr.aria-label]="'Selected mode: ' + (selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough')">
                    <span class="mode-name-compact">{{ selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough' }}</span>
                    <span class="mode-cost-compact">{{ selectedResearchMode === 'FAST' ? '~15s' : '~90s' }}</span>
                  </button>
                  <div ngbDropdownMenu class="dropdown-menu mode-dropdown-minimal">
                    <!-- FAST Mode Option -->
                    <a class="dropdown-item mode-option-minimal"
                       [class.active]="selectedResearchMode === 'FAST'"
                       (click)="onResearchModeChange('FAST')">
                      <div class="mode-header-minimal">
                        <span class="mode-title">Fast</span>
                        <span class="mode-meta">~15s</span>
                      </div>
                      <p class="mode-desc-minimal">Quick guidance, no citations</p>
                    </a>

                    <div class="dropdown-divider"></div>

                    <!-- THOROUGH Mode Option -->
                    <a class="dropdown-item mode-option-minimal"
                       [class.active]="selectedResearchMode === 'THOROUGH'"
                       (click)="onResearchModeChange('THOROUGH')">
                      <div class="mode-header-minimal">
                        <span class="mode-title">Thorough</span>
                        <span class="mode-meta">~90s</span>
                      </div>
                      <p class="mode-desc-minimal">Verified citations via CourtListener</p>
                    </a>
                  </div>
                </div>
              </div>

              <button type="submit" class="btn btn-primary btn-submit"
                      [disabled]="selectedTask === 'upload' ? (uploadedFiles.length === 0 || (isGenerating$ | async)) : !canSend">
                <i [class]="selectedTask === 'upload' ? 'ri-file-search-line' : 'ri-send-plane-fill'"></i>
                {{ selectedTask === 'upload' ? 'Analyze Documents' : 'Send' }}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Top Action Bar (when in drafting mode) -->
    <div class="top-action-bar" *ngIf="draftingMode$ | async">
      <div class="action-bar-left">
        <button class="btn btn-link back-btn" (click)="exitDraftingMode()" title="Exit drafting mode">
          <i class="ri-arrow-left-line"></i>
        </button>
        <div class="drafting-mode-indicator">
          <i class="ri-file-edit-line"></i>
          <span>Drafting Mode</span>
        </div>
        <div class="document-stats">
          <span class="word-count">{{currentDocumentWordCount}}/500000</span>
          <span class="date-stamp">{{currentDate | date:'MMM d, yyyy'}}</span>
        </div>
      </div>
      <div class="action-bar-right">
        <!-- Research Mode Selector -->
        <div class="mode-selector" ngbDropdown>
          <button id="mode-dropdown"
                  ngbDropdownToggle
                  type="button"
                  class="btn btn-light btn-sm mode-selector-btn"
                  [attr.aria-label]="'Selected mode: ' + (selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough')">
            <span class="mode-label">{{ selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough' }}</span>
            <span class="mode-badge">{{ selectedResearchMode === 'FAST' ? '~15s' : '~90s' }}</span>
          </button>
          <div ngbDropdownMenu class="dropdown-menu mode-dropdown-minimal">
            <!-- FAST Mode Option -->
            <a class="dropdown-item mode-option-minimal"
               [class.active]="selectedResearchMode === 'FAST'"
               (click)="onResearchModeChange('FAST')">
              <div class="mode-header-minimal">
                <span class="mode-title">Fast</span>
                <span class="mode-meta">~15s</span>
              </div>
              <p class="mode-desc-minimal">Quick guidance, no citations</p>
            </a>

            <div class="dropdown-divider"></div>

            <!-- THOROUGH Mode Option -->
            <a class="dropdown-item mode-option-minimal"
               [class.active]="selectedResearchMode === 'THOROUGH'"
               (click)="onResearchModeChange('THOROUGH')">
              <div class="mode-header-minimal">
                <span class="mode-title">Thorough</span>
                <span class="mode-meta">~90s</span>
              </div>
              <p class="mode-desc-minimal">Verified citations via CourtListener</p>
            </a>
          </div>
        </div>

        <!-- Export Dropdown Button -->
        <div class="btn-group" ngbDropdown>
          <button id="export-dropdown" ngbDropdownToggle type="button" class="btn btn-primary btn-sm">
            <i class="ri-download-line"></i>
            Export
          </button>
          <div ngbDropdownMenu class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" (click)="exportToPDF()">
              <i class="ri-file-pdf-line me-2"></i>
              Save as PDF
            </a>
            <a class="dropdown-item" (click)="exportToWord()">
              <i class="ri-file-word-line me-2"></i>
              Save as Word
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" (click)="saveToFileManager()">
              <i class="ri-folder-upload-line me-2"></i>
              Save to File Manager
            </a>
          </div>
        </div>
        <a href="javascript:void(0)" class="help-link" (click)="openHowItWorksModal()">
          <i class="ri-question-line"></i>
          How does it work?
        </a>
      </div>
    </div>

    <!-- Split View Container (when document is generated) -->
    <div class="split-view-container" *ngIf="draftingMode$ | async">
      <!-- Document Preview Panel (60%) -->
      <div class="document-preview-panel">
        <div class="document-preview-header">
          <div class="header-left">
            <h3 class="document-title">
              <i class="ri-file-text-line"></i>
              {{activeDocumentTitle}}
            </h3>
            <div class="document-metadata">
              <span class="meta-item" *ngIf="currentDocumentWordCount > 0">
                <i class="ri-file-word-line"></i>
                {{currentDocumentWordCount}} words
              </span>
              <span class="meta-item" *ngIf="currentDocumentPageCount > 0">
                <i class="ri-file-copy-line"></i>
                {{currentDocumentPageCount}} pages
              </span>
              <span class="meta-item" *ngIf="documentMetadata.tokensUsed">
                <i class="ri-code-s-slash-line"></i>
                {{documentMetadata.tokensUsed}} tokens
              </span>
              <span class="meta-item" *ngIf="documentMetadata.costEstimate">
                <i class="ri-money-dollar-circle-line"></i>
                ${{documentMetadata.costEstimate | number:'1.4-4'}}
              </span>

              <!-- Version Dropdown -->
              <div class="version-dropdown" ngbDropdown container="body" placement="bottom-end" *ngIf="documentMetadata.version">
                <button class="version-dropdown-toggle" ngbDropdownToggle type="button">
                  <i class="ri-git-commit-line me-1"></i>
                  v{{documentMetadata.version}}
                </button>
                <div ngbDropdownMenu class="version-dropdown-menu">
                  <div class="version-dropdown-header">
                    <h6 class="mb-0">Version History</h6>
                  </div>

                  <!-- Loading State -->
                  <div class="version-dropdown-loading" *ngIf="loadingVersions">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading versions...</span>
                  </div>

                  <!-- Empty State -->
                  <div class="version-dropdown-empty" *ngIf="!loadingVersions && documentVersions.length === 0">
                    <i class="ri-inbox-line"></i>
                    <p class="mb-0">No versions found</p>
                  </div>

                  <!-- Version List -->
                  <div class="version-dropdown-list" *ngIf="!loadingVersions && documentVersions.length > 0">
                    <button
                      *ngFor="let version of documentVersions"
                      class="version-dropdown-item"
                      [class.current-version]="version.versionNumber === documentMetadata.version"
                      (click)="restoreVersionWithConfirmation(version)"
                      [disabled]="version.versionNumber === documentMetadata.version">

                      <div class="version-item-header">
                        <span class="version-number">v{{version.versionNumber}}</span>
                        <span class="version-badge" [ngClass]="{
                          'badge-primary': version.transformationType === 'INITIAL_GENERATION',
                          'badge-info': version.transformationType === 'SIMPLIFY' || version.transformationType === 'CONDENSE',
                          'badge-success': version.transformationType === 'EXPAND',
                          'badge-warning': version.transformationType === 'REDRAFT',
                          'badge-secondary': version.transformationType === 'MANUAL_EDIT',
                          'badge-danger': version.transformationType === 'RESTORE_VERSION'
                        }">
                          {{getTransformationLabel(version.transformationType)}}
                        </span>
                        <span class="current-badge" *ngIf="version.versionNumber === documentMetadata.version">
                          <i class="ri-check-line"></i> CURRENT
                        </span>
                      </div>

                      <div class="version-item-meta">
                        <span class="version-date">
                          <i class="ri-time-line"></i>
                          {{version.createdAt | date:'MMM d, h:mm a'}}
                        </span>
                        <span class="version-words">
                          <i class="ri-file-word-line"></i>
                          {{version.wordCount}} words
                        </span>
                      </div>

                      <div class="version-item-note" *ngIf="version.versionNote">
                        <i class="ri-sticky-note-line"></i>
                        {{version.versionNote}}
                      </div>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="preview-actions">
            <button class="btn-icon" (click)="saveManualVersion()"
                    title="Save Version">
              <i class="ri-save-line"></i>
            </button>
            <button class="btn-icon" (click)="increaseTextSize()" title="Zoom in">
              <i class="ri-zoom-in-line"></i>
            </button>
            <button class="btn-icon" (click)="decreaseTextSize()" title="Zoom out">
              <i class="ri-zoom-out-line"></i>
            </button>
            <button class="btn-icon" (click)="toggleFullscreen()" [title]="isFullscreen ? 'Exit fullscreen' : 'Enter fullscreen'">
              <i [class]="isFullscreen ? 'ri-fullscreen-exit-line' : 'ri-fullscreen-line'"></i>
            </button>
            <button class="btn-icon" *ngIf="!(showChat$ | async)" (click)="reopenChatPanel()" title="Open conversation">
              <i class="ri-chat-3-line"></i>
            </button>
          </div>
        </div>

        <div class="document-preview-content">

          <!-- Rich Text Editor (Quill) -->
          <!-- showEditor flag toggled OFF→ON to force destruction and recreation -->
          <quill-editor
            *ngIf="showEditor"
            #documentEditor
            [modules]="quillModules"
            [formats]="quillFormats"
            [styles]="{
              'min-height': '500px',
              'height': '100%',
              'font-family': 'Georgia, Times New Roman, serif',
              'font-size': '16px',
              'line-height': '1.8'
            }"
            (onEditorCreated)="onEditorCreated($event)"
            (onSelectionChanged)="onTextSelectionChanged($event)"
            placeholder="Your generated document will appear here...">
          </quill-editor>
        </div>

        <!-- Drafting Tools Menu -->
        <div class="drafting-tools-menu">
          <button class="tool-btn" (click)="applyDraftingTool('simplify')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Simplify language'">
            <i class="ri-subtract-line"></i>
            Simplify
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('condense')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Condense document'">
            <i class="ri-file-reduce-line"></i>
            Condense
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('expand')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Expand with more detail'">
            <i class="ri-file-add-line"></i>
            Expand
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('redraft')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Redraft entirely'">
            <i class="ri-refresh-line"></i>
            Redraft entirely
          </button>
        </div>
      </div>

      <!-- Chat Panel (40%) -->
      <div class="chat-panel-side" *ngIf="showChat$ | async">
        <div class="chat-panel-header">
          <h4>Conversation</h4>
          <button class="btn-close-panel" (click)="closeChatPanel()">
            <i class="ri-close-line"></i>
          </button>
        </div>

        <div class="chat-messages-area-side">
          <ul class="list-unstyled chat-conversation-list">
            <!-- User & AI Messages -->
            <ng-container *ngFor="let message of (conversationMessages$ | async); let i = index">
              <li class="chat-list" [ngClass]="{ 'right': message.role === 'user', 'left': message.role === 'assistant' }">

                <!-- User Message -->
                <div class="conversation-list" *ngIf="message.role === 'user'">
                  <div class="user-chat-content">
                    <div class="message-bubble bg-soft-info text-info">
                      <div class="message-content">
                        <p class="mb-0">{{message.content}}</p>
                      </div>
                      <div class="message-meta">
                        <small class="text-muted">{{message.timestamp ? (message.timestamp | date:'short') : 'Just now'}}</small>
                        <i class="ri-check-double-line ms-1 text-success"></i>
                      </div>
                    </div>
                  </div>
                  <!-- User Avatar (right side) -->
                  <div class="chat-avatar ms-3">
                    <div class="avatar-sm">
                      <div class="avatar-title bg-success-subtle text-success rounded-circle">
                        <i class="ri-user-3-fill"></i>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- AI Message -->
                <div class="ai-message-container" *ngIf="message.role === 'assistant'">
                  <div class="d-flex align-items-start gap-3">
                    <div class="chat-avatar flex-shrink-0">
                      <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                    </div>
                    <div class="message-bubble ai-message flex-grow-1">
                      <!-- Strategic Analysis Tabs (if present) -->
                      <div class="strategic-analysis-tabs" *ngIf="message.hasStrategicAnalysis">
                        <ul class="nav nav-tabs nav-tabs-custom mb-3" role="tablist">
                          <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#overview-{{i}}" role="tab">
                              <i class="ri-file-list-3-line me-1"></i> Overview
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#action-items-{{i}}" role="tab">
                              <i class="bi bi-check2-square me-1"></i> Action Items
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#timeline-view-{{i}}" role="tab">
                              <i class="bi bi-calendar-event me-1"></i> Timeline
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#weaknesses-{{i}}" role="tab">
                              <i class="ri-alert-line me-1"></i> Weaknesses
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#evidence-{{i}}" role="tab">
                              <i class="ri-checkbox-line me-1"></i> Evidence
                            </a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#strategy-{{i}}" role="tab">
                              <i class="ri-lightbulb-line me-1"></i> Strategy
                            </a>
                          </li>
                        </ul>

                        <div class="tab-content">
                          <div class="tab-pane fade show active" id="overview-{{i}}" role="tabpanel">
                            <div [innerHTML]="message.parsedSections?.overview || message.content" apexChartsContainer></div>
                          </div>
                          <div class="tab-pane fade" id="action-items-{{i}}" role="tabpanel">
                            <app-action-items-list *ngIf="message.analysisId" [analysisId]="message.analysisId"></app-action-items-list>
                            <p *ngIf="!message.analysisId" class="text-muted">No action items available</p>
                          </div>
                          <div class="tab-pane fade" id="timeline-view-{{i}}" role="tabpanel">
                            <app-timeline-view *ngIf="message.analysisId" [analysisId]="message.analysisId"></app-timeline-view>
                            <p *ngIf="!message.analysisId" class="text-muted">No timeline available</p>
                          </div>
                          <div class="tab-pane fade" id="weaknesses-{{i}}" role="tabpanel">
                            <div [innerHTML]="message.parsedSections?.weaknesses || 'No weaknesses section found'" apexChartsContainer></div>
                          </div>
                          <div class="tab-pane fade" id="evidence-{{i}}" role="tabpanel">
                            <div [innerHTML]="message.parsedSections?.evidence || 'No evidence section found'" apexChartsContainer></div>
                          </div>
                          <div class="tab-pane fade" id="strategy-{{i}}" role="tabpanel">
                            <div [innerHTML]="message.parsedSections?.strategy || 'No strategy section found'" apexChartsContainer></div>
                          </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="analysis-quick-actions mt-3">
                          <button class="btn btn-sm btn-soft-primary me-2" (click)="exportAnalysisToPDF(message)">
                            <i class="ri-file-pdf-line me-1"></i> Export PDF
                          </button>
                          <button class="btn btn-sm btn-soft-success me-2" (click)="createDraftFromAnalysis(message)">
                            <i class="ri-file-edit-line me-1"></i> Draft Response
                          </button>
                          <button class="btn btn-sm btn-soft-info me-2" (click)="researchCitations(message)">
                            <i class="ri-search-line me-1"></i> Research Citations
                          </button>
                          <button class="btn btn-sm btn-soft-warning" (click)="scheduleReminders(message)">
                            <i class="ri-calendar-check-line me-1"></i> Set Reminders
                          </button>
                        </div>
                      </div>

                      <!-- Regular message content (if not strategic analysis) -->
                      <div class="message-content" *ngIf="!message.hasStrategicAnalysis" [innerHTML]="message.hasStrategicAnalysis ? message.content : (message.content | markdownToHtml)" apexChartsContainer></div>

                      <!-- Transformation Comparison - Refactored Component -->
                      <app-transformation-preview
                        *ngIf="message.transformationComparison"
                        [transformation]="message.transformationComparison"
                        [messageId]="message.id!"
                        (accept)="acceptTransformation($event)"
                        (reject)="rejectTransformation($event)">
                      </app-transformation-preview>
                    </div>
                  </div>
                </div>

              </li>
            </ng-container>

            <!-- AI Generating State -->
            <li class="message-item assistant" *ngIf="isGenerating$ | async">
              <div class="ai-message-container">
                <div class="d-flex align-items-start gap-3 mb-3">
                  <div class="chat-avatar flex-shrink-0">
                    <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                  </div>

                  <div class="message-bubble ai-message flex-grow-1">
                    <!-- AI Activity Loading -->
                    <div class="ai-activity-loader">
                      <!-- Header -->
                      <div class="activity-header">
                        <span>Generating response</span>
                        <i class="ri-arrow-up-s-line"></i>
                      </div>

                      <!-- Activity Steps - Refactored Component -->
                      <app-workflow-steps
                        [steps]="workflowSteps$ | async"
                        [isGenerating]="isGenerating$ | async">
                      </app-workflow-steps>

                      <button class="btn-stop-response" (click)="stopGeneration()">
                        <i class="ri-stop-circle-line"></i>
                        Stop response
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </li>

          </ul>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-side">
          <form (ngSubmit)="sendFollowUpMessage()">
            <textarea
              class="form-control"
              [(ngModel)]="followUpMessage"
              name="followUpMessage"
              placeholder="Ask for revisions..."
              rows="3"
              (keydown.enter)="onEnterPress($event)"></textarea>
            <button type="submit" class="btn btn-primary btn-sm" [disabled]="!followUpMessage?.trim()">
              <i class="ri-send-plane-fill"></i>
              Send
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Chat Container (Active conversation - full width when not in drafting mode, hidden when document viewer is open) -->
    <div class="chat-container-main" *ngIf="((showChat$ | async) || (isGenerating$ | async)) && !(draftingMode$ | async) && !(documentViewerMode$ | async)">
      <div class="chat-messages-area">
        <ul class="list-unstyled chat-conversation-list">

          <!-- User & AI Messages -->
          <ng-container *ngFor="let message of (conversationMessages$ | async); let i = index">
            <li class="chat-list" [ngClass]="{ 'right': message.role === 'user', 'left': message.role === 'assistant' }">

              <!-- User Message -->
              <div class="conversation-list" *ngIf="message.role === 'user'">
                <div class="user-chat-content mb-4">
                  <div class="message-bubble bg-soft-info text-info">
                    <div class="message-content">
                      <p class="mb-0">{{message.content}}</p>
                    </div>
                    <div class="message-meta">
                      <small class="text-muted">{{message.timestamp ? (message.timestamp | date:'short') : 'Just now'}}</small>
                      <i class="ri-check-double-line ms-1 text-success"></i>
                    </div>
                  </div>
                </div>
                <!-- User Avatar (right side) -->
                <div class="chat-avatar ms-3">
                  <div class="avatar-sm">
                    <div class="avatar-title bg-success-subtle text-success rounded-circle">
                      <i class="ri-user-3-fill"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- AI Message -->
              <div class="ai-message-container" *ngIf="message.role === 'assistant'">
                <div class="d-flex align-items-start gap-3 mb-3">
                  <div class="chat-avatar flex-shrink-0">
                    <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                  </div>

                  <div class="message-bubble ai-message flex-grow-1">
                    <!-- Strategic Analysis Tabs (if present) -->
                    <div class="strategic-analysis-tabs" *ngIf="message.hasStrategicAnalysis">
                      <ul class="nav nav-tabs nav-tabs-custom mb-3" role="tablist">
                        <li class="nav-item">
                          <a class="nav-link active" data-bs-toggle="tab" href="#overview-main-{{i}}" role="tab">
                            <i class="ri-file-list-3-line me-1"></i> Overview
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#action-items-main-{{i}}" role="tab">
                            <i class="bi bi-check2-square me-1"></i> Action Items
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#timeline-view-main-{{i}}" role="tab">
                            <i class="bi bi-calendar-event me-1"></i> Timeline
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#weaknesses-main-{{i}}" role="tab">
                            <i class="ri-alert-line me-1"></i> Weaknesses
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#evidence-main-{{i}}" role="tab">
                            <i class="ri-checkbox-line me-1"></i> Evidence
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-bs-toggle="tab" href="#strategy-main-{{i}}" role="tab">
                            <i class="ri-lightbulb-line me-1"></i> Strategy
                          </a>
                        </li>
                      </ul>

                      <div class="tab-content">
                        <div class="tab-pane fade show active" id="overview-main-{{i}}" role="tabpanel">
                          <div [innerHTML]="(message.parsedSections?.overview || message.content) | markdownToHtml" apexChartsContainer></div>
                        </div>
                        <div class="tab-pane fade" id="action-items-main-{{i}}" role="tabpanel">
                          <app-action-items-list *ngIf="message.analysisId" [analysisId]="message.analysisId"></app-action-items-list>
                          <p *ngIf="!message.analysisId" class="text-muted">No action items available</p>
                        </div>
                        <div class="tab-pane fade" id="timeline-view-main-{{i}}" role="tabpanel">
                          <app-timeline-view *ngIf="message.analysisId" [analysisId]="message.analysisId"></app-timeline-view>
                          <p *ngIf="!message.analysisId" class="text-muted">No timeline available</p>
                        </div>
                        <div class="tab-pane fade" id="weaknesses-main-{{i}}" role="tabpanel">
                          <div [innerHTML]="(message.parsedSections?.weaknesses || 'No weaknesses section found') | markdownToHtml" apexChartsContainer></div>
                        </div>
                        <div class="tab-pane fade" id="evidence-main-{{i}}" role="tabpanel">
                          <div [innerHTML]="(message.parsedSections?.evidence || 'No evidence section found') | markdownToHtml" apexChartsContainer></div>
                        </div>
                        <div class="tab-pane fade" id="strategy-main-{{i}}" role="tabpanel">
                          <div [innerHTML]="(message.parsedSections?.strategy || 'No strategy section found') | markdownToHtml" apexChartsContainer></div>
                        </div>
                      </div>
                    </div>

                    <!-- Regular message content (if not strategic analysis) -->
                    <div class="message-content" *ngIf="!message.hasStrategicAnalysis" [innerHTML]="message.content | markdownToHtml" apexChartsContainer></div>

                    <!-- Transformation Comparison - Refactored Component -->
                    <app-transformation-preview
                      *ngIf="message.transformationComparison"
                      [transformation]="message.transformationComparison"
                      [messageId]="message.id!"
                      (accept)="acceptTransformation($event)"
                      (reject)="rejectTransformation($event)">
                    </app-transformation-preview>

                    <!-- Suggested Actions -->
                    <div class="suggested-actions" *ngIf="message.documentGenerated">
                      <div class="actions-label">Suggested actions:</div>
                      <div class="actions-buttons">
                        <button class="action-btn" (click)="executeSuggestedAction('view-document', message.documentId)">
                          <i class="ri-eye-line"></i>
                          View Document
                        </button>
                        <button class="action-btn" (click)="executeSuggestedAction('export-pdf', message.documentId)">
                          <i class="ri-file-pdf-line"></i>
                          Export to PDF
                        </button>
                        <button class="action-btn" (click)="executeSuggestedAction('summarize-authority', message.documentId)">
                          <i class="ri-file-text-line"></i>
                          Summarize case authority
                        </button>
                      </div>
                    </div>

                    <!-- Follow-up Questions -->
                    <div class="follow-up-questions-section" *ngIf="(followUpQuestions$ | async)?.length > 0 && i === (conversationMessages$ | async)?.length - 1">
                      <div class="follow-up-label">
                        <i class="ri-question-line"></i>
                        Suggested follow up questions:
                      </div>
                      <div class="follow-up-list">
                        <button
                          *ngFor="let question of (followUpQuestions$ | async)"
                          class="follow-up-btn"
                          (click)="askFollowUpQuestion(question)"
                          [disabled]="isGenerating$ | async">
                          <i class="ri-add-line"></i>
                          <span>{{ question }}</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </li>
          </ng-container>

          <!-- AI Generating State -->
          <li class="message-item assistant" *ngIf="isGenerating$ | async">
            <div class="ai-message-container">
              <div class="d-flex align-items-start gap-3 mb-3">
                <div class="chat-avatar flex-shrink-0">
                  <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                </div>

                <div class="message-bubble ai-message flex-grow-1">
                  <!-- AI Activity Loading -->
                  <div class="ai-activity-loader">
                    <!-- Header -->
                    <div class="activity-header">
                      <span>Generating response</span>
                      <i class="ri-arrow-up-s-line"></i>
                    </div>

                    <!-- Activity Steps - Refactored Component -->
                    <app-workflow-steps
                      [steps]="workflowSteps$ | async"
                      [isGenerating]="isGenerating$ | async">
                    </app-workflow-steps>

                    <button class="btn-stop-response" (click)="stopGeneration()">
                      <i class="ri-stop-circle-line"></i>
                      Stop response
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </li>

        </ul>
      </div>

      <!-- Bottom Input Bar (in chat mode) -->
      <div class="chat-input-bar-bottom" *ngIf="(showBottomSearchBar$ | async) && !(isGenerating$ | async)">
        <form (ngSubmit)="sendFollowUpMessage()" class="chat-input-form">
          <textarea
            class="form-control chat-input"
            [(ngModel)]="followUpMessage"
            name="followUpMessage"
            [placeholder]="followUpPlaceholder"
            rows="1"
            (keydown.enter)="onEnterPress($event)"></textarea>

          <div class="input-footer">
            <div class="jurisdiction-selector-inline">
              <label>Jurisdiction:</label>
              <select class="form-select form-select-sm" [(ngModel)]="selectedJurisdiction" name="jurisdictionInline">
                <option *ngFor="let jur of jurisdictions" [value]="jur">{{jur}}</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary btn-send" [disabled]="!followUpMessage?.trim()">
              <i class="ri-send-plane-fill"></i>
            </button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <!-- Document Editor Modal -->

</div>

<!-- How It Works Modal -->
<ng-template #howItWorksModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="ri-lightbulb-line me-2"></i>
      How AI Drafting Assistant Works
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="feature-list">
      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-file-add-line"></i>
        </div>
        <div class="feature-content">
          <h6>Draft Generation</h6>
          <p>Generate professional legal documents using AI. Simply describe what you need, and the AI will create a complete draft based on your requirements and jurisdiction.</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-pencil-line"></i>
        </div>
        <div class="feature-content">
          <h6>Smart Transformations</h6>
          <p>Select any text in your document and request changes. The AI will show you a side-by-side comparison before applying edits, giving you full control over modifications.</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-history-line"></i>
        </div>
        <div class="feature-content">
          <h6>Version History</h6>
          <p>Every change creates a version snapshot. Review, compare, or restore any previous version of your document at any time.</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-download-line"></i>
        </div>
        <div class="feature-content">
          <h6>Export & Save</h6>
          <p>Download your document as a formatted Word file (.docx) or save it to your file manager for future access and collaboration.</p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="modal.close()">Got it!</button>
  </div>
</ng-template>

<!-- Prompt Tips Modal -->
<ng-template #promptTipsModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="ri-lightbulb-line"></i>
      Prompt Tips & Examples
    </h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <p class="text-muted mb-3" style="font-size: 0.875rem;">
      Get better results by providing clear, detailed prompts. Here are some examples for each document type:
    </p>

    <div class="tips-category" *ngFor="let category of promptTipsByCategory">
      <div class="category-header">
        <span class="category-icon">{{category.icon}}</span>
        <h6>{{category.name}}</h6>
      </div>

      <div class="tip-item" *ngFor="let tip of category.tips">
        <div class="tip-text">"{{tip}}"</div>
        <button class="use-tip-btn" (click)="usePromptExample(tip); modal.dismiss()">
          <i class="ri-file-copy-line"></i>
          Use This Prompt
        </button>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Close</button>
  </div>
</ng-template>

