<!-- ============================================ -->
<!-- DRAFTING PAGE - VELZON THEME DESIGN -->
<!-- 3-Column Layout: Conversations | Main | Chat -->
<!-- ============================================ -->

<div class="drafting-container" style="margin-top: 100px; max-width: 100%;">

  <!-- Mobile Menu Toggle Button -->
  <button class="mobile-menu-toggle" (click)="toggleSidebar()" aria-label="Toggle sidebar">
    <i class="ri-menu-line"></i>
  </button>

  <!-- Sidebar Backdrop Overlay (Mobile Only) -->
  <div class="sidebar-backdrop" [class.show]="sidebarOpen" (click)="closeSidebar()"></div>

  <!-- ========================================== -->
  <!-- LEFT SIDEBAR: Conversation History -->
  <!-- ========================================== -->
  <aside class="card conversation-sidebar" [class.open]="sidebarOpen" *ngIf="!draftingMode">
    <div class="conversation-sidebar-header">
      <button type="button" class="btn btn-soft-primary rounded-pill waves-effect waves-light w-100"
              (click)="startNewConversation()">
        <i class="ri-add-line fs-16 me-2"></i>New Conversation
      </button>
    </div>

    <!-- Search Bar -->
    <div class="conversation-search">
      <div class="search-input-wrapper">
        <i class="ri-search-line search-icon"></i>
        <input
          type="text"
          class="form-control"
          placeholder="Enter conversation terms"
          [(ngModel)]="conversationSearchQuery">
      </div>
    </div>

    <!-- Conversation List -->
    <div class="conversation-list-container">
      <!-- Loading State -->
      <div class="conversation-loading" *ngIf="loadingDrafts">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading conversations...</p>
      </div>

      <!-- Empty State -->
      <div class="conversation-empty" *ngIf="!loadingDrafts && conversations.length === 0">
        <i class="ri-chat-3-line empty-icon"></i>
        <p class="empty-title">No conversations yet</p>
        <p class="empty-description">Start a new conversation to see it here</p>
      </div>

      <!-- Conversations List -->
      <div *ngIf="!loadingDrafts && conversations.length > 0">
        <!-- Past 90 Days -->
        <div class="conversation-group" *ngIf="groupedConversations.past90Days.length > 0">
          <div class="conversation-group-header">
            <span>Past 90 Days</span>
            <button class="btn-delete-all" (click)="deleteAllConversations()">Delete all</button>
          </div>

          <div class="conversation-list">
            <div
              *ngFor="let conv of filteredConversations"
              class="conversation-item"
              [class.active]="activeConversationId === conv.id"
              (click)="switchConversation(conv.id)">
              <div class="conversation-title">{{conv.title}}</div>
              <div class="conversation-meta">
                <span class="badge bg-soft-primary me-2" *ngIf="conv.caseId" style="font-size: 0.7rem;">
                  <i class="ri-briefcase-line"></i> Case
                </span>
                <div class="conversation-date">
                  <i class="ri-time-line"></i>
                  <span>{{conv.date | date:'MMM d'}}</span>
                </div>
                <div class="conversation-count" *ngIf="(conv.messageCount || conv.messages.length) > 0">
                  <i class="ri-message-3-line"></i>
                  <span>{{conv.messageCount || conv.messages.length}}</span>
                </div>
              </div>
              <div class="conversation-actions" (click)="$event.stopPropagation()">
                <button class="action-btn" (click)="deleteConversation(conv.id)" title="Delete conversation">
                  <i class="ri-delete-bin-line"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  
  </aside>

  <!-- ========================================== -->
  <!-- MAIN CONTENT AREA -->
  <!-- ========================================== -->
  <main class="main-content-area">

    <!-- Welcome Screen (No active conversation) -->
    <div class="welcome-screen" *ngIf="!showChat && !isGenerating && !draftingMode">
      <div class="welcome-header">

        <h2 class="welcome-title mb-0">Welcome, {{ getUserDisplayName() }}</h2>
        <p class="welcome-subtitle">Which legal task can AI accelerate for you today?</p>
      </div>

      <!-- Action Cards Grid -->
      <div class="action-cards-main mb-4">
        <div
          class="action-card"
          [class.active]="selectedTask === 'question'"
          (click)="selectTask('question')">
          <div class="icon-box">
            <i class="ri-question-answer-line"></i>
          </div>
          <div class="card-content">
            <span>Ask a legal question</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'draft'"
          (click)="selectTask('draft')">
          <div class="icon-box">
            <i class="ri-file-edit-line"></i>
          </div>
          <div class="card-content">
            <span>Generate a draft</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'summarize'"
          (click)="selectTask('summarize')">
          <div class="icon-box">
            <i class="ri-file-list-3-line"></i>
          </div>
          <div class="card-content">
            <span>Summarize a case</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'upload'"
          (click)="selectTask('upload')">
          <div class="icon-box">
            <i class="ri-upload-cloud-line"></i>
          </div>
          <div class="card-content">
            <span>Upload document</span>
          </div>
        </div>
      </div>

      <!-- Examples Section -->
      <div class="examples-section card mb-4" *ngIf="selectedTask">
        <div class="card-body">
          <h6 class="mb-3">{{ getExamplesTitle() }}</h6>
          <div class="example-list">
            <p class="text-muted mb-2" *ngFor="let example of getExamples()">• {{ example }}</p>
          </div>
        </div>
      </div>

      <!-- Document Type Pills (when Generate a draft is selected) -->
      <div class="document-type-pills" *ngIf="selectedTask === 'draft'">
        <div class="pills-label">Draft:</div>
        <div class="pills-container">
          <button
            class="pill-btn"
            *ngFor="let pill of documentTypePills"
            [class.active]="selectedDocTypePill === pill.id"
            (click)="selectDocTypePill(pill.id)">
            {{pill.name}}
          </button>
        </div>
        <a href="javascript:void(0)" class="prompt-tips-link">
          <i class="ri-lightbulb-line"></i>
          Prompt Tips
        </a>
      </div>

      <!-- Main Prompt Input -->
      <div class="main-prompt-area">
        <form (ngSubmit)="startCustomDraft()" class="prompt-form card">
          <div class="card-body">
            <textarea
              class="form-control prompt-textarea"
              [(ngModel)]="customPrompt"
              name="customPrompt"
              [placeholder]="promptPlaceholder"
              rows="3"></textarea>

            <!-- Case Selector (Draft task only) -->
            <div class="case-selector-section" *ngIf="selectedTask === 'draft'" style="margin-top: 1rem; margin-bottom: 1rem;">
              <label class="form-label" style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                <i class="ri-briefcase-line me-1"></i>
                Link to Case (Optional):
              </label>
              <select [(ngModel)]="selectedCaseId" class="form-select" name="caseSelector" style="margin-bottom: 0.5rem;">
                <option [ngValue]="null">None - General Draft</option>
                <option *ngFor="let case of userCases" [ngValue]="case.id">
                  {{case.caseNumber}} - {{case.title}}
                </option>
              </select>
              <small class="text-muted" style="font-size: 0.75rem;">
                <i class="ri-information-line"></i>
                Select a case to include case context in the draft
              </small>
            </div>

            <div class="prompt-footer">
              <div class="jurisdiction-selector">
                <label>Jurisdiction:</label>
                <select class="form-select" [(ngModel)]="selectedJurisdiction" name="jurisdiction">
                  <option *ngFor="let jur of jurisdictions" [value]="jur">{{jur}}</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary btn-submit">
                <i class="ri-send-plane-fill"></i> Send
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Top Action Bar (when in drafting mode) -->
    <div class="top-action-bar" *ngIf="draftingMode">
      <div class="action-bar-left">
        <button class="btn btn-link back-btn" (click)="exitDraftingMode()" title="Exit drafting mode">
          <i class="ri-arrow-left-line"></i>
        </button>
        <div class="drafting-mode-indicator">
          <i class="ri-file-edit-line"></i>
          <span>Drafting Mode</span>
        </div>
        <div class="document-stats">
          <span class="word-count">{{currentDocumentWordCount}}/500000</span>
          <span class="date-stamp">{{currentDate | date:'MMM d, yyyy'}}</span>
        </div>
      </div>
      <div class="action-bar-right">
        <!-- Export Dropdown Button -->
        <div class="btn-group" ngbDropdown>
          <button id="export-dropdown" ngbDropdownToggle type="button" class="btn btn-primary btn-sm">
            <i class="ri-download-line"></i>
            Export
          </button>
          <div ngbDropdownMenu class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" (click)="exportToPDF()">
              <i class="ri-file-pdf-line me-2"></i>
              Save as PDF
            </a>
            <a class="dropdown-item" (click)="exportToWord()">
              <i class="ri-file-word-line me-2"></i>
              Save as Word
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" (click)="saveToFileManager()">
              <i class="ri-folder-upload-line me-2"></i>
              Save to File Manager
            </a>
          </div>
        </div>
        <a href="javascript:void(0)" class="help-link">
          <i class="ri-question-line"></i>
          How does it work?
        </a>
      </div>
    </div>

    <!-- Split View Container (when document is generated) -->
    <div class="split-view-container" *ngIf="draftingMode">
      <!-- Document Preview Panel (60%) -->
      <div class="document-preview-panel">
        <div class="document-preview-header">
          <div class="header-left">
            <h3 class="document-title">
              <i class="ri-file-text-line"></i>
              {{activeDocumentTitle}}
            </h3>
            <div class="document-metadata">
              <span class="meta-item" *ngIf="currentDocumentWordCount > 0">
                <i class="ri-file-word-line"></i>
                {{currentDocumentWordCount}} words
              </span>
              <span class="meta-item" *ngIf="currentDocumentPageCount > 0">
                <i class="ri-file-copy-line"></i>
                {{currentDocumentPageCount}} pages
              </span>
              <span class="meta-item" *ngIf="documentMetadata.tokensUsed">
                <i class="ri-code-s-slash-line"></i>
                {{documentMetadata.tokensUsed}} tokens
              </span>
              <span class="meta-item" *ngIf="documentMetadata.costEstimate">
                <i class="ri-money-dollar-circle-line"></i>
                ${{documentMetadata.costEstimate | number:'1.4-4'}}
              </span>
              <span class="meta-item" *ngIf="documentMetadata.version">
                <i class="ri-git-commit-line"></i>
                v{{documentMetadata.version}}
              </span>
            </div>
          </div>
          <div class="preview-actions">
            <button class="btn-icon" (click)="saveManualVersion()"
                    title="Save Version">
              <i class="ri-save-line"></i>
            </button>
            <button class="btn-icon" (click)="openVersionHistoryModal()"
                    title="Version History">
              <i class="ri-history-line"></i>
            </button>
            <button class="btn-icon" (click)="increaseTextSize()" title="Zoom in">
              <i class="ri-zoom-in-line"></i>
            </button>
            <button class="btn-icon" (click)="decreaseTextSize()" title="Zoom out">
              <i class="ri-zoom-out-line"></i>
            </button>
            <button class="btn-icon" (click)="toggleFullscreen()" [title]="isFullscreen ? 'Exit fullscreen' : 'Enter fullscreen'">
              <i [class]="isFullscreen ? 'ri-fullscreen-exit-line' : 'ri-fullscreen-line'"></i>
            </button>
            <button class="btn-icon" *ngIf="!showChat" (click)="reopenChatPanel()" title="Open conversation">
              <i class="ri-chat-3-line"></i>
            </button>
          </div>
        </div>

        <!-- Version History Sidebar -->
        <div class="version-history-sidebar" *ngIf="showVersionHistory">
          <div class="version-history-header">
            <h5>Version History</h5>
            <button class="btn-close-mini" (click)="toggleVersionHistory()">
              <i class="ri-close-line"></i>
            </button>
          </div>
          <div class="version-history-content">
            <div class="version-item" *ngFor="let version of documentVersions"
                 [class.active]="selectedVersionNumber === version.versionNumber"
                 (click)="previewVersion(version)">
              <div class="version-header">
                <span class="version-number">v{{version.versionNumber}}</span>
                <span class="version-date">{{version.createdAt | date:'short'}}</span>
              </div>
              <div class="version-details">
                <span class="version-type">{{getTransformationLabel(version.transformationType)}}</span>
                <span class="version-scope" *ngIf="version.transformationScope === 'SELECTION'">
                  <i class="ri-text-snippet"></i> Selection
                </span>
              </div>
              <div class="version-meta">
                <span *ngIf="version.tokensUsed">{{version.tokensUsed}} tokens</span>
                <span *ngIf="version.wordCount">{{version.wordCount}} words</span>
              </div>
              <div class="version-actions" *ngIf="version.versionNumber !== documentMetadata.version">
                <button class="btn-restore" (click)="restoreVersion(version.versionNumber); $event.stopPropagation()">
                  <i class="ri-arrow-go-back-line"></i> Restore
                </button>
                <button class="btn-compare" (click)="compareVersions(documentMetadata.version, version.versionNumber); $event.stopPropagation()">
                  <i class="ri-git-compare-line"></i> Compare
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="document-preview-content">
          <!-- Rich Text Editor (Quill) -->
          <quill-editor
            #documentEditor
            [(ngModel)]="activeDocumentContent"
            [modules]="quillModules"
            [formats]="quillFormats"
            [styles]="{
              'min-height': '500px',
              'height': '100%',
              'font-family': 'Georgia, serif',
              'font-size': '14px',
              'line-height': '1.6'
            }"
            (onSelectionChanged)="onTextSelectionChanged($event)"
            (onContentChanged)="onDocumentContentChanged($event)"
            placeholder="Your generated document will appear here...">
          </quill-editor>
        </div>

        <!-- Drafting Tools Menu -->
        <div class="drafting-tools-menu">
          <button class="tool-btn" (click)="applyDraftingTool('simplify')">
            <i class="ri-subtract-line"></i>
            Simplify
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('condense')">
            <i class="ri-file-reduce-line"></i>
            Condense
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('expand')">
            <i class="ri-file-add-line"></i>
            Expand
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('redraft')">
            <i class="ri-refresh-line"></i>
            Redraft entirely
          </button>
        </div>
      </div>

      <!-- Chat Panel (40%) -->
      <div class="chat-panel-side" *ngIf="showChat">
        <div class="chat-panel-header">
          <h4>Conversation</h4>
          <button class="btn-close-panel" (click)="closeChatPanel()">
            <i class="ri-close-line"></i>
          </button>
        </div>

        <div class="chat-messages-area-side">
          <ul class="list-unstyled chat-conversation-list">
            <!-- User & AI Messages -->
            <ng-container *ngFor="let message of conversationMessages">
              <li class="chat-list" [ngClass]="{ 'right': message.role === 'user', 'left': message.role === 'assistant' }">

                <!-- User Message -->
                <div class="conversation-list" *ngIf="message.role === 'user'">
                  <div class="user-chat-content">
                    <div class="message-bubble bg-soft-info text-info">
                      <div class="message-content">
                        <p class="mb-0">{{message.content}}</p>
                      </div>
                      <div class="message-meta">
                        <small class="text-muted">{{message.timestamp ? (message.timestamp | date:'short') : 'Just now'}}</small>
                        <i class="ri-check-double-line ms-1 text-success"></i>
                      </div>
                    </div>
                  </div>
                  <!-- User Avatar (right side) -->
                  <div class="chat-avatar ms-3">
                    <div class="avatar-sm">
                      <div class="avatar-title bg-success-subtle text-success rounded-circle">
                        <i class="ri-user-3-fill"></i>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- AI Message -->
                <div class="ai-message-container" *ngIf="message.role === 'assistant'">
                  <div class="d-flex align-items-start gap-3">
                    <div class="chat-avatar flex-shrink-0">
                      <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                    </div>
                    <div class="message-bubble ai-message flex-grow-1">
                      <div class="message-content" [innerHTML]="message.content | markdownToHtml" apexChartsContainer></div>

                      <!-- Transformation Comparison (Inline) -->
                      <div class="transformation-comparison-inline" *ngIf="message.transformationComparison">
                        <div class="comparison-header">
                          <i class="ri-magic-line me-2"></i>
                          <span>Review {{ message.transformationComparison.transformationType | titlecase }} Transformation</span>
                        </div>

                        <!-- Transformation Metadata -->
                        <div class="transformation-meta mb-3">
                          <span class="badge bg-soft-primary me-2">
                            <i class="ri-file-text-line me-1"></i>
                            {{ message.transformationComparison.scope === 'FULL_DOCUMENT' ? 'Full Document' : 'Selection' }}
                          </span>
                          <span class="badge bg-soft-info me-2">
                            <i class="ri-file-word-line me-1"></i>
                            {{ message.transformationComparison.response?.wordCount || 0 }} words
                          </span>
                          <span class="badge bg-soft-success me-2">
                            <i class="ri-code-s-slash-line me-1"></i>
                            {{ message.transformationComparison.response?.tokensUsed || 0 }} tokens
                          </span>
                          <span class="badge bg-soft-warning">
                            <i class="ri-money-dollar-circle-line me-1"></i>
                            ${{ message.transformationComparison.response?.costEstimate || 0 | number:'1.4-4' }}
                          </span>
                        </div>

                        <!-- Document Context (for SELECTION scope) -->
                        <div class="document-context-panel mb-3"
                             *ngIf="message.transformationComparison.scope === 'SELECTION' && message.transformationComparison.fullDocumentContent">
                          <div class="context-panel-header">
                            <i class="ri-file-search-line me-2"></i>
                            <span>Document Context</span>
                            <span class="badge bg-soft-info ms-auto">Selected text highlighted</span>
                          </div>
                          <div class="context-panel-content"
                               [innerHTML]="highlightSelectionInContext(message.transformationComparison.fullDocumentContent, message.transformationComparison.oldContent) | markdownToHtml">
                          </div>
                        </div>

                        <!-- Side-by-side Comparison -->
                        <div class="comparison-panels-inline">
                          <div class="comparison-column comparison-original">
                            <div class="comparison-panel-header">
                              <i class="ri-file-text-line me-1"></i> Original
                            </div>
                            <div class="comparison-panel-content" [innerHTML]="message.transformationComparison.oldContent | markdownToHtml"></div>
                          </div>
                          <div class="comparison-column comparison-transformed">
                            <div class="comparison-panel-header">
                              <i class="ri-sparkle-line me-1"></i> Transformed
                            </div>
                            <div class="comparison-panel-content" [innerHTML]="message.transformationComparison.newContent | markdownToHtml"></div>
                          </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="comparison-actions mt-3">
                          <button class="btn btn-sm btn-secondary me-2" (click)="rejectTransformation(message.id)">
                            <i class="ri-close-line me-1"></i> Reject
                          </button>
                          <button class="btn btn-sm btn-primary" (click)="acceptTransformation(message.id)">
                            <i class="ri-check-line me-1"></i> Accept Changes
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </li>
            </ng-container>

            <!-- AI Generating State -->
            <li class="message-item assistant" *ngIf="isGenerating">
              <div class="ai-message-container">
                <div class="d-flex align-items-start gap-3 mb-3">
                  <div class="chat-avatar flex-shrink-0">
                    <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                  </div>

                  <div class="message-bubble ai-message flex-grow-1">
                    <!-- AI Activity Loading -->
                    <div class="ai-activity-loader">
                      <!-- Header -->
                      <div class="activity-header">
                        <span>Generating response</span>
                        <i class="ri-arrow-up-s-line"></i>
                      </div>

                      <!-- Activity Steps -->
                      <div class="activity-steps">
                        <div *ngFor="let step of workflowSteps"
                             class="activity-step"
                             [class.active]="step.status === 'active'"
                             [class.pending]="step.status === 'pending'"
                             [class.completed]="step.status === 'completed'"
                             [class.error]="step.status === 'error'">
                          <i [class]="step.icon" class="step-icon" *ngIf="step.status !== 'completed'"></i>
                          <i class="ri-check-line step-icon step-check" *ngIf="step.status === 'completed'"></i>
                          <span class="step-text">{{ step.description }}</span>
                        </div>
                      </div>

                      <button class="btn-stop-response" (click)="stopGeneration()">
                        <i class="ri-stop-circle-line"></i>
                        Stop response
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </li>

          </ul>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-side">
          <form (ngSubmit)="sendFollowUpMessage()">
            <textarea
              class="form-control"
              [(ngModel)]="followUpMessage"
              name="followUpMessage"
              placeholder="Ask for revisions..."
              rows="3"
              (keydown.enter)="onEnterPress($event)"></textarea>
            <button type="submit" class="btn btn-primary btn-sm" [disabled]="!followUpMessage?.trim()">
              <i class="ri-send-plane-fill"></i>
              Send
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Chat Container (Active conversation - full width when not in drafting mode) -->
    <div class="chat-container-main" *ngIf="(showChat || isGenerating) && !draftingMode">
      <div class="chat-messages-area">
        <ul class="list-unstyled chat-conversation-list">

          <!-- User & AI Messages -->
          <ng-container *ngFor="let message of conversationMessages; let i = index">
            <li class="chat-list" [ngClass]="{ 'right': message.role === 'user', 'left': message.role === 'assistant' }">

              <!-- User Message -->
              <div class="conversation-list" *ngIf="message.role === 'user'">
                <div class="user-chat-content mb-4">
                  <div class="message-bubble bg-soft-info text-info">
                    <div class="message-content">
                      <p class="mb-0">{{message.content}}</p>
                    </div>
                    <div class="message-meta">
                      <small class="text-muted">{{message.timestamp ? (message.timestamp | date:'short') : 'Just now'}}</small>
                      <i class="ri-check-double-line ms-1 text-success"></i>
                    </div>
                  </div>
                </div>
                <!-- User Avatar (right side) -->
                <div class="chat-avatar ms-3">
                  <div class="avatar-sm">
                    <div class="avatar-title bg-success-subtle text-success rounded-circle">
                      <i class="ri-user-3-fill"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- AI Message -->
              <div class="ai-message-container" *ngIf="message.role === 'assistant'">
                <div class="d-flex align-items-start gap-3 mb-3">
                  <div class="chat-avatar flex-shrink-0">
                    <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                  </div>

                  <div class="message-bubble ai-message flex-grow-1">
                    <div class="message-content" [innerHTML]="message.content | markdownToHtml" apexChartsContainer></div>

                    <!-- Transformation Comparison (Inline) -->
                    <div class="transformation-comparison-inline" *ngIf="message.transformationComparison">
                      <div class="comparison-header">
                        <i class="ri-magic-line me-2"></i>
                        <span>Review {{ message.transformationComparison.transformationType | titlecase }} Transformation</span>
                      </div>

                      <!-- Transformation Metadata -->
                      <div class="transformation-meta mb-3">
                        <span class="badge bg-soft-primary me-2">
                          <i class="ri-file-text-line me-1"></i>
                          {{ message.transformationComparison.scope === 'FULL_DOCUMENT' ? 'Full Document' : 'Selection' }}
                        </span>
                        <span class="badge bg-soft-info me-2">
                          <i class="ri-file-word-line me-1"></i>
                          {{ message.transformationComparison.response?.wordCount || 0 }} words
                        </span>
                        <span class="badge bg-soft-success me-2">
                          <i class="ri-code-s-slash-line me-1"></i>
                          {{ message.transformationComparison.response?.tokensUsed || 0 }} tokens
                        </span>
                        <span class="badge bg-soft-warning">
                          <i class="ri-money-dollar-circle-line me-1"></i>
                          ${{ message.transformationComparison.response?.costEstimate || 0 | number:'1.4-4' }}
                        </span>
                      </div>

                      <!-- Side-by-side Comparison -->
                      <div class="comparison-panels-inline">
                        <div class="comparison-column">
                          <div class="comparison-panel-header">
                            <i class="ri-file-text-line me-1"></i> Original
                          </div>
                          <div class="comparison-panel-content" [innerHTML]="message.transformationComparison.oldContent | markdownToHtml"></div>
                        </div>
                        <div class="comparison-column">
                          <div class="comparison-panel-header transformed">
                            <i class="ri-sparkle-line me-1"></i> Transformed
                          </div>
                          <div class="comparison-panel-content" [innerHTML]="message.transformationComparison.newContent | markdownToHtml"></div>
                        </div>
                      </div>

                      <!-- Action Buttons -->
                      <div class="comparison-actions mt-3">
                        <button class="btn btn-sm btn-secondary me-2" (click)="rejectTransformation(message.id)">
                          <i class="ri-close-line me-1"></i> Reject
                        </button>
                        <button class="btn btn-sm btn-primary" (click)="acceptTransformation(message.id)">
                          <i class="ri-check-line me-1"></i> Accept Changes
                        </button>
                      </div>
                    </div>

                    <!-- Suggested Actions -->
                    <div class="suggested-actions" *ngIf="message.documentGenerated">
                      <div class="actions-label">Suggested actions:</div>
                      <div class="actions-buttons">
                        <button class="action-btn" (click)="executeSuggestedAction('view-document', message.documentId)">
                          <i class="ri-eye-line"></i>
                          View Document
                        </button>
                        <button class="action-btn" (click)="executeSuggestedAction('export-pdf', message.documentId)">
                          <i class="ri-file-pdf-line"></i>
                          Export to PDF
                        </button>
                        <button class="action-btn" (click)="executeSuggestedAction('summarize-authority', message.documentId)">
                          <i class="ri-file-text-line"></i>
                          Summarize case authority
                        </button>
                      </div>
                    </div>

                    <!-- Follow-up Questions -->
                    <div class="follow-up-questions-section" *ngIf="followUpQuestions.length > 0 && i === conversationMessages.length - 1">
                      <div class="follow-up-label">
                        <i class="ri-question-line"></i>
                        Suggested follow up questions:
                      </div>
                      <div class="follow-up-list">
                        <button
                          *ngFor="let question of followUpQuestions"
                          class="follow-up-btn"
                          (click)="askFollowUpQuestion(question)"
                          [disabled]="isGenerating">
                          <i class="ri-add-line"></i>
                          <span>{{ question }}</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </li>
          </ng-container>

          <!-- AI Generating State -->
          <li class="message-item assistant" *ngIf="isGenerating">
            <div class="ai-message-container">
              <div class="d-flex align-items-start gap-3 mb-3">
                <div class="chat-avatar flex-shrink-0">
                  <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                </div>

                <div class="message-bubble ai-message flex-grow-1">
                  <!-- AI Activity Loading -->
                  <div class="ai-activity-loader">
                    <!-- Header -->
                    <div class="activity-header">
                      <span>Generating response</span>
                      <i class="ri-arrow-up-s-line"></i>
                    </div>

                    <!-- Activity Steps -->
                    <div class="activity-steps">
                      <div *ngFor="let step of workflowSteps"
                           class="activity-step"
                           [class.active]="step.status === 'active'"
                           [class.pending]="step.status === 'pending'"
                           [class.completed]="step.status === 'completed'"
                           [class.error]="step.status === 'error'">
                        <i [class]="step.icon" class="step-icon" *ngIf="step.status !== 'completed'"></i>
                        <i class="ri-check-line step-icon step-check" *ngIf="step.status === 'completed'"></i>
                        <span class="step-text">{{ step.description }}</span>
                      </div>
                    </div>

                    <button class="btn-stop-response" (click)="stopGeneration()">
                      <i class="ri-stop-circle-line"></i>
                      Stop response
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </li>

        </ul>
      </div>

      <!-- Bottom Input Bar (in chat mode) -->
      <div class="chat-input-bar-bottom" *ngIf="showBottomSearchBar && !isGenerating">
        <form (ngSubmit)="sendFollowUpMessage()" class="chat-input-form">
          <textarea
            class="form-control chat-input"
            [(ngModel)]="followUpMessage"
            name="followUpMessage"
            [placeholder]="followUpPlaceholder"
            rows="1"
            (keydown.enter)="onEnterPress($event)"></textarea>

          <div class="input-footer">
            <div class="jurisdiction-selector-inline">
              <label>Jurisdiction:</label>
              <select class="form-select form-select-sm" [(ngModel)]="selectedJurisdiction" name="jurisdictionInline">
                <option *ngFor="let jur of jurisdictions" [value]="jur">{{jur}}</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary btn-send" [disabled]="!followUpMessage?.trim()">
              <i class="ri-send-plane-fill"></i>
            </button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <!-- Document Editor Modal -->

</div>

<!-- Version History Modal -->
<ng-template #versionHistoryModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Version History</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div *ngIf="loadingVersions" class="text-center py-4">
      <div class="spinner-border text-primary" role="status"></div>
    </div>
    <div *ngIf="!loadingVersions && documentVersions.length === 0" class="text-center py-4 text-muted">
      No versions found
    </div>
    <div class="version-list" *ngIf="!loadingVersions">
      <div class="version-item" *ngFor="let version of documentVersions" [class.current-version]="version.versionNumber === currentVersionNumber">
        <div class="version-header">
          <strong>Version {{ version.versionNumber }}</strong>
          <span class="badge bg-primary ms-2" *ngIf="version.versionNumber === currentVersionNumber">Current</span>
          <span class="badge bg-success ms-2" *ngIf="version.createdByUser">Manual Save</span>
        </div>
        <div class="version-meta text-muted small">
          {{ version.createdAt | date:'MMM d, y h:mm a' }} • {{ version.wordCount }} words
          <span *ngIf="version.transformationType"> • {{ version.transformationType }}</span>
        </div>
        <div class="version-note" *ngIf="version.versionNote">
          <i class="ri-sticky-note-line me-1"></i> {{ version.versionNote }}
        </div>
        <div class="version-actions mt-2">
          <button class="btn btn-sm btn-outline-primary" (click)="previewVersion(version)" *ngIf="version.versionNumber !== currentVersionNumber">
            <i class="ri-eye-line"></i> View
          </button>
          <button class="btn btn-sm btn-outline-success ms-2" (click)="modal.dismiss(); restoreVersion(version.versionNumber)" *ngIf="version.versionNumber !== currentVersionNumber">
            <i class="ri-restart-line"></i> Restore
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>

