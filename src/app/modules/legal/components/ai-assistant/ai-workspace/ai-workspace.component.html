<!-- ============================================ -->
<!-- DRAFTING PAGE - VELZON THEME DESIGN -->
<!-- 3-Column Layout: Conversations | Main | Chat -->
<!-- ============================================ -->

<div class="drafting-container" style="margin-top: 100px; max-width: 100%;">

  <!-- Mobile Menu Toggle Button -->
  <button class="mobile-menu-toggle" (click)="toggleSidebar()" aria-label="Toggle sidebar">
    <i class="ri-menu-line"></i>
  </button>

  <!-- Sidebar Backdrop Overlay (Mobile Only) -->
  <div class="sidebar-backdrop" [class.show]="sidebarOpen$ | async" (click)="closeSidebar()"></div>

  <!-- ========================================== -->
  <!-- LEFT SIDEBAR: Conversation History -->
  <!-- ========================================== -->
  <aside class="card conversation-sidebar" [class.open]="sidebarOpen$ | async" *ngIf="!(draftingMode$ | async)">
    <div class="conversation-sidebar-header">
      <button type="button" class="btn btn-soft-primary rounded-pill waves-effect waves-light w-100"
              (click)="startNewConversation()">
        <i class="ri-add-line fs-16 me-2"></i>New Conversation
      </button>
    </div>

    <!-- Search Bar -->
    <div class="conversation-search">
      <div class="search-input-wrapper">
        <i class="ri-search-line search-icon"></i>
        <input
          type="text"
          class="form-control"
          placeholder="Enter conversation terms"
          [(ngModel)]="conversationSearchQuery">
      </div>
    </div>

    <!-- Conversation List -->
    <div class="conversation-list-container">
      <!-- Loading State -->
      <div class="conversation-loading" *ngIf="loadingDrafts">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading conversations...</p>
      </div>

      <!-- Empty State -->
      <div class="conversation-empty" *ngIf="!loadingDrafts && (conversations$ | async)?.length === 0">
        <i class="ri-chat-3-line empty-icon"></i>
        <p class="empty-title">No conversations yet</p>
        <p class="empty-description">Start a new conversation to see it here</p>
      </div>

      <!-- Conversations List -->
      <div *ngIf="!loadingDrafts && (conversations$ | async)?.length > 0">
        <!-- Past 90 Days -->
        <div class="conversation-group" *ngIf="(groupedConversations$ | async)?.past90Days?.length > 0">
          <div class="conversation-group-header">
            <span>Past 90 Days</span>
            <button class="btn-delete-all" (click)="deleteAllConversations()">Delete all</button>
          </div>

          <div class="conversation-list">
            <div
              *ngFor="let conv of filteredConversations"
              class="conversation-item"
              [class.active]="(activeConversationId$ | async) === conv.id"
              (click)="switchConversation(conv.id)">
              <div class="conversation-title">{{conv.title}}</div>
              <div class="conversation-meta">
                <span class="badge bg-soft-primary me-2" *ngIf="conv.caseId" style="font-size: 0.7rem;">
                  <i class="ri-briefcase-line"></i> Case
                </span>
                <div class="conversation-date">
                  <i class="ri-time-line"></i>
                  <span>{{conv.date | date:'MMM d'}}</span>
                </div>
                <div class="conversation-count" *ngIf="(conv.messageCount || conv.messages.length) > 0">
                  <i class="ri-message-3-line"></i>
                  <span>{{conv.messageCount || conv.messages.length}}</span>
                </div>
              </div>
              <div class="conversation-actions" (click)="$event.stopPropagation()">
                <button class="action-btn" (click)="deleteConversation(conv.id)" title="Delete conversation">
                  <i class="ri-delete-bin-line"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  
  </aside>

  <!-- ========================================== -->
  <!-- MAIN CONTENT AREA -->
  <!-- ========================================== -->
  <main class="main-content-area">

    <!-- Welcome Screen (No active conversation) -->
    <div class="welcome-screen" *ngIf="!(showChat$ | async) && !(isGenerating$ | async) && !(draftingMode$ | async)">
      <div class="welcome-header">

        <h2 class="welcome-title mb-0">Welcome, {{ getUserDisplayName() }}</h2>
        <p class="welcome-subtitle">Which legal task can AI accelerate for you today?</p>
      </div>

      <!-- Action Cards Grid -->
      <div class="action-cards-main mb-4">
        <div
          class="action-card"
          [class.active]="selectedTask === 'question'"
          (click)="selectTask('question')">
          <div class="icon-box">
            <i class="ri-question-answer-line"></i>
          </div>
          <div class="card-content">
            <span>Ask a legal question</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'draft'"
          (click)="selectTask('draft')">
          <div class="icon-box">
            <i class="ri-file-edit-line"></i>
          </div>
          <div class="card-content">
            <span>Generate a draft</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'summarize'"
          (click)="selectTask('summarize')">
          <div class="icon-box">
            <i class="ri-file-list-3-line"></i>
          </div>
          <div class="card-content">
            <span>Summarize a case</span>
          </div>
        </div>

        <div
          class="action-card"
          [class.active]="selectedTask === 'upload'"
          (click)="selectTask('upload')">
          <div class="icon-box">
            <i class="ri-upload-cloud-line"></i>
          </div>
          <div class="card-content">
            <span>Upload document</span>
          </div>
        </div>
      </div>

      <!-- Examples Section -->
      <div class="examples-section card mb-4" *ngIf="selectedTask">
        <div class="card-body">
          <h6 class="mb-3">{{ getExamplesTitle() }}</h6>
          <div class="example-list">
            <p class="text-muted mb-2" *ngFor="let example of getExamples()">• {{ example }}</p>
          </div>
        </div>
      </div>

      <!-- Document Type Pills (when Generate a draft is selected) -->
      <div class="document-type-pills" *ngIf="selectedTask === 'draft'">
        <div class="pills-label">Draft:</div>
        <div class="pills-container">
          <button
            class="pill-btn"
            *ngFor="let pill of documentTypePills"
            [class.active]="selectedDocTypePill === pill.id"
            (click)="selectDocTypePill(pill.id)">
            {{pill.name}}
          </button>
        </div>
        <a href="javascript:void(0)" class="prompt-tips-link">
          <i class="ri-lightbulb-line"></i>
          Prompt Tips
        </a>
      </div>

      <!-- Main Prompt Input -->
      <div class="main-prompt-area">
        <form (ngSubmit)="startCustomDraft()" class="prompt-form card">
          <div class="card-body">
            <textarea
              class="form-control prompt-textarea"
              [(ngModel)]="customPrompt"
              name="customPrompt"
              [placeholder]="promptPlaceholder"
              rows="3"></textarea>

            <!-- Case Selector (Draft task only) -->
            <div class="case-selector-section" *ngIf="selectedTask === 'draft'" style="margin-top: 1rem; margin-bottom: 1rem;">
              <label class="form-label" style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                <i class="ri-briefcase-line me-1"></i>
                Link to Case (Optional):
              </label>
              <select [(ngModel)]="selectedCaseId" class="form-select" name="caseSelector" style="margin-bottom: 0.5rem;">
                <option [ngValue]="null">None - General Draft</option>
                <option *ngFor="let case of userCases" [ngValue]="case.id">
                  {{case.caseNumber}} - {{case.title}}
                </option>
              </select>
              <small class="text-muted" style="font-size: 0.75rem;">
                <i class="ri-information-line"></i>
                Select a case to include case context in the draft
              </small>
            </div>

            <div class="prompt-footer">
              <div class="jurisdiction-selector">
                <label>Jurisdiction:</label>
                <select class="form-select" [(ngModel)]="selectedJurisdiction" name="jurisdiction">
                  <option *ngFor="let jur of jurisdictions" [value]="jur">{{jur}}</option>
                </select>
              </div>

              <!-- Research Mode Selector (Compact) -->
              <div class="mode-selector-compact">
                <label>Mode:</label>
                <div class="btn-group" ngbDropdown placement="top-start">
                  <button id="mode-dropdown-compact"
                          ngbDropdownToggle
                          type="button"
                          class="btn btn-light btn-sm mode-btn-compact"
                          [attr.aria-label]="'Selected mode: ' + (selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough')">
                    <span class="mode-name-compact">{{ selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough' }}</span>
                    <span class="mode-cost-compact">{{ selectedResearchMode === 'FAST' ? '$0.15' : '$2-4' }}</span>
                  </button>
                  <div ngbDropdownMenu class="dropdown-menu mode-dropdown-minimal">
                    <!-- FAST Mode Option -->
                    <a class="dropdown-item mode-option-minimal"
                       [class.active]="selectedResearchMode === 'FAST'"
                       (click)="onResearchModeChange('FAST')">
                      <div class="mode-header-minimal">
                        <span class="mode-title">Fast</span>
                        <span class="mode-meta">~15s • $0.15</span>
                      </div>
                      <p class="mode-desc-minimal">Quick guidance, no citations</p>
                    </a>

                    <div class="dropdown-divider"></div>

                    <!-- THOROUGH Mode Option -->
                    <a class="dropdown-item mode-option-minimal"
                       [class.active]="selectedResearchMode === 'THOROUGH'"
                       (click)="onResearchModeChange('THOROUGH')">
                      <div class="mode-header-minimal">
                        <span class="mode-title">Thorough</span>
                        <span class="mode-meta">~90s • $2-4</span>
                      </div>
                      <p class="mode-desc-minimal">Verified citations via CourtListener</p>
                    </a>
                  </div>
                </div>
              </div>

              <button type="submit" class="btn btn-primary btn-submit">
                <i class="ri-send-plane-fill"></i> Send
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Top Action Bar (when in drafting mode) -->
    <div class="top-action-bar" *ngIf="draftingMode$ | async">
      <div class="action-bar-left">
        <button class="btn btn-link back-btn" (click)="exitDraftingMode()" title="Exit drafting mode">
          <i class="ri-arrow-left-line"></i>
        </button>
        <div class="drafting-mode-indicator">
          <i class="ri-file-edit-line"></i>
          <span>Drafting Mode</span>
        </div>
        <div class="document-stats">
          <span class="word-count">{{currentDocumentWordCount}}/500000</span>
          <span class="date-stamp">{{currentDate | date:'MMM d, yyyy'}}</span>
        </div>
      </div>
      <div class="action-bar-right">
        <!-- Research Mode Selector -->
        <div class="mode-selector" ngbDropdown>
          <button id="mode-dropdown"
                  ngbDropdownToggle
                  type="button"
                  class="btn btn-light btn-sm mode-selector-btn"
                  [attr.aria-label]="'Selected mode: ' + (selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough')">
            <span class="mode-label">{{ selectedResearchMode === 'FAST' ? 'Fast' : 'Thorough' }}</span>
            <span class="mode-badge">{{ selectedResearchMode === 'FAST' ? '$0.15' : '$2-4' }}</span>
          </button>
          <div ngbDropdownMenu class="dropdown-menu mode-dropdown-minimal">
            <!-- FAST Mode Option -->
            <a class="dropdown-item mode-option-minimal"
               [class.active]="selectedResearchMode === 'FAST'"
               (click)="onResearchModeChange('FAST')">
              <div class="mode-header-minimal">
                <span class="mode-title">Fast</span>
                <span class="mode-meta">~15s • $0.15</span>
              </div>
              <p class="mode-desc-minimal">Quick guidance, no citations</p>
            </a>

            <div class="dropdown-divider"></div>

            <!-- THOROUGH Mode Option -->
            <a class="dropdown-item mode-option-minimal"
               [class.active]="selectedResearchMode === 'THOROUGH'"
               (click)="onResearchModeChange('THOROUGH')">
              <div class="mode-header-minimal">
                <span class="mode-title">Thorough</span>
                <span class="mode-meta">~90s • $2-4</span>
              </div>
              <p class="mode-desc-minimal">Verified citations via CourtListener</p>
            </a>
          </div>
        </div>

        <!-- Export Dropdown Button -->
        <div class="btn-group" ngbDropdown>
          <button id="export-dropdown" ngbDropdownToggle type="button" class="btn btn-primary btn-sm">
            <i class="ri-download-line"></i>
            Export
          </button>
          <div ngbDropdownMenu class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" (click)="exportToPDF()">
              <i class="ri-file-pdf-line me-2"></i>
              Save as PDF
            </a>
            <a class="dropdown-item" (click)="exportToWord()">
              <i class="ri-file-word-line me-2"></i>
              Save as Word
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" (click)="saveToFileManager()">
              <i class="ri-folder-upload-line me-2"></i>
              Save to File Manager
            </a>
          </div>
        </div>
        <a href="javascript:void(0)" class="help-link" (click)="openHowItWorksModal()">
          <i class="ri-question-line"></i>
          How does it work?
        </a>
      </div>
    </div>

    <!-- Split View Container (when document is generated) -->
    <div class="split-view-container" *ngIf="draftingMode$ | async">
      <!-- Document Preview Panel (60%) -->
      <div class="document-preview-panel">
        <div class="document-preview-header">
          <div class="header-left">
            <h3 class="document-title">
              <i class="ri-file-text-line"></i>
              {{activeDocumentTitle}}
            </h3>
            <div class="document-metadata">
              <span class="meta-item" *ngIf="currentDocumentWordCount > 0">
                <i class="ri-file-word-line"></i>
                {{currentDocumentWordCount}} words
              </span>
              <span class="meta-item" *ngIf="currentDocumentPageCount > 0">
                <i class="ri-file-copy-line"></i>
                {{currentDocumentPageCount}} pages
              </span>
              <span class="meta-item" *ngIf="documentMetadata.tokensUsed">
                <i class="ri-code-s-slash-line"></i>
                {{documentMetadata.tokensUsed}} tokens
              </span>
              <span class="meta-item" *ngIf="documentMetadata.costEstimate">
                <i class="ri-money-dollar-circle-line"></i>
                ${{documentMetadata.costEstimate | number:'1.4-4'}}
              </span>

              <!-- Version Dropdown -->
              <div class="version-dropdown" ngbDropdown container="body" placement="bottom-end" *ngIf="documentMetadata.version">
                <button class="version-dropdown-toggle" ngbDropdownToggle type="button">
                  <i class="ri-git-commit-line me-1"></i>
                  v{{documentMetadata.version}}
                </button>
                <div ngbDropdownMenu class="version-dropdown-menu">
                  <div class="version-dropdown-header">
                    <h6 class="mb-0">Version History</h6>
                  </div>

                  <!-- Loading State -->
                  <div class="version-dropdown-loading" *ngIf="loadingVersions">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading versions...</span>
                  </div>

                  <!-- Empty State -->
                  <div class="version-dropdown-empty" *ngIf="!loadingVersions && documentVersions.length === 0">
                    <i class="ri-inbox-line"></i>
                    <p class="mb-0">No versions found</p>
                  </div>

                  <!-- Version List -->
                  <div class="version-dropdown-list" *ngIf="!loadingVersions && documentVersions.length > 0">
                    <button
                      *ngFor="let version of documentVersions"
                      class="version-dropdown-item"
                      [class.current-version]="version.versionNumber === documentMetadata.version"
                      (click)="restoreVersionWithConfirmation(version)"
                      [disabled]="version.versionNumber === documentMetadata.version">

                      <div class="version-item-header">
                        <span class="version-number">v{{version.versionNumber}}</span>
                        <span class="version-badge" [ngClass]="{
                          'badge-primary': version.transformationType === 'INITIAL_GENERATION',
                          'badge-info': version.transformationType === 'SIMPLIFY' || version.transformationType === 'CONDENSE',
                          'badge-success': version.transformationType === 'EXPAND',
                          'badge-warning': version.transformationType === 'REDRAFT',
                          'badge-secondary': version.transformationType === 'MANUAL_EDIT',
                          'badge-danger': version.transformationType === 'RESTORE_VERSION'
                        }">
                          {{getTransformationLabel(version.transformationType)}}
                        </span>
                        <span class="current-badge" *ngIf="version.versionNumber === documentMetadata.version">
                          <i class="ri-check-line"></i> CURRENT
                        </span>
                      </div>

                      <div class="version-item-meta">
                        <span class="version-date">
                          <i class="ri-time-line"></i>
                          {{version.createdAt | date:'MMM d, h:mm a'}}
                        </span>
                        <span class="version-words">
                          <i class="ri-file-word-line"></i>
                          {{version.wordCount}} words
                        </span>
                      </div>

                      <div class="version-item-note" *ngIf="version.versionNote">
                        <i class="ri-sticky-note-line"></i>
                        {{version.versionNote}}
                      </div>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="preview-actions">
            <button class="btn-icon" (click)="saveManualVersion()"
                    title="Save Version">
              <i class="ri-save-line"></i>
            </button>
            <button class="btn-icon" (click)="increaseTextSize()" title="Zoom in">
              <i class="ri-zoom-in-line"></i>
            </button>
            <button class="btn-icon" (click)="decreaseTextSize()" title="Zoom out">
              <i class="ri-zoom-out-line"></i>
            </button>
            <button class="btn-icon" (click)="toggleFullscreen()" [title]="isFullscreen ? 'Exit fullscreen' : 'Enter fullscreen'">
              <i [class]="isFullscreen ? 'ri-fullscreen-exit-line' : 'ri-fullscreen-line'"></i>
            </button>
            <button class="btn-icon" *ngIf="!(showChat$ | async)" (click)="reopenChatPanel()" title="Open conversation">
              <i class="ri-chat-3-line"></i>
            </button>
          </div>
        </div>

        <div class="document-preview-content">

          <!-- Rich Text Editor (Quill) -->
          <!-- showEditor flag toggled OFF→ON to force destruction and recreation -->
          <quill-editor
            *ngIf="showEditor"
            #documentEditor
            [modules]="quillModules"
            [formats]="quillFormats"
            [styles]="{
              'min-height': '500px',
              'height': '100%',
              'font-family': 'Georgia, Times New Roman, serif',
              'font-size': '16px',
              'line-height': '1.8'
            }"
            (onEditorCreated)="onEditorCreated($event)"
            (onSelectionChanged)="onTextSelectionChanged($event)"
            placeholder="Your generated document will appear here...">
          </quill-editor>
        </div>

        <!-- Drafting Tools Menu -->
        <div class="drafting-tools-menu">
          <button class="tool-btn" (click)="applyDraftingTool('simplify')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Simplify language'">
            <i class="ri-subtract-line"></i>
            Simplify
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('condense')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Condense document'">
            <i class="ri-file-reduce-line"></i>
            Condense
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('expand')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Expand with more detail'">
            <i class="ri-file-add-line"></i>
            Expand
          </button>
          <button class="tool-btn" (click)="applyDraftingTool('redraft')" [disabled]="isPreviewingVersion" [title]="isPreviewingVersion ? 'Exit preview mode to use tools' : 'Redraft entirely'">
            <i class="ri-refresh-line"></i>
            Redraft entirely
          </button>
        </div>
      </div>

      <!-- Chat Panel (40%) -->
      <div class="chat-panel-side" *ngIf="showChat$ | async">
        <div class="chat-panel-header">
          <h4>Conversation</h4>
          <button class="btn-close-panel" (click)="closeChatPanel()">
            <i class="ri-close-line"></i>
          </button>
        </div>

        <div class="chat-messages-area-side">
          <ul class="list-unstyled chat-conversation-list">
            <!-- User & AI Messages -->
            <ng-container *ngFor="let message of (conversationMessages$ | async)">
              <li class="chat-list" [ngClass]="{ 'right': message.role === 'user', 'left': message.role === 'assistant' }">

                <!-- User Message -->
                <div class="conversation-list" *ngIf="message.role === 'user'">
                  <div class="user-chat-content">
                    <div class="message-bubble bg-soft-info text-info">
                      <div class="message-content">
                        <p class="mb-0">{{message.content}}</p>
                      </div>
                      <div class="message-meta">
                        <small class="text-muted">{{message.timestamp ? (message.timestamp | date:'short') : 'Just now'}}</small>
                        <i class="ri-check-double-line ms-1 text-success"></i>
                      </div>
                    </div>
                  </div>
                  <!-- User Avatar (right side) -->
                  <div class="chat-avatar ms-3">
                    <div class="avatar-sm">
                      <div class="avatar-title bg-success-subtle text-success rounded-circle">
                        <i class="ri-user-3-fill"></i>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- AI Message -->
                <div class="ai-message-container" *ngIf="message.role === 'assistant'">
                  <div class="d-flex align-items-start gap-3">
                    <div class="chat-avatar flex-shrink-0">
                      <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                    </div>
                    <div class="message-bubble ai-message flex-grow-1">
                      <div class="message-content" [innerHTML]="message.content | markdownToHtml" apexChartsContainer></div>

                      <!-- Transformation Comparison - Refactored Component -->
                      <app-transformation-preview
                        *ngIf="message.transformationComparison"
                        [transformation]="message.transformationComparison"
                        [messageId]="message.id!"
                        (accept)="acceptTransformation($event)"
                        (reject)="rejectTransformation($event)">
                      </app-transformation-preview>
                    </div>
                  </div>
                </div>

              </li>
            </ng-container>

            <!-- AI Generating State -->
            <li class="message-item assistant" *ngIf="isGenerating$ | async">
              <div class="ai-message-container">
                <div class="d-flex align-items-start gap-3 mb-3">
                  <div class="chat-avatar flex-shrink-0">
                    <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                  </div>

                  <div class="message-bubble ai-message flex-grow-1">
                    <!-- AI Activity Loading -->
                    <div class="ai-activity-loader">
                      <!-- Header -->
                      <div class="activity-header">
                        <span>Generating response</span>
                        <i class="ri-arrow-up-s-line"></i>
                      </div>

                      <!-- Activity Steps - Refactored Component -->
                      <app-workflow-steps
                        [steps]="workflowSteps$ | async"
                        [isGenerating]="isGenerating$ | async">
                      </app-workflow-steps>

                      <button class="btn-stop-response" (click)="stopGeneration()">
                        <i class="ri-stop-circle-line"></i>
                        Stop response
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </li>

          </ul>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-side">
          <form (ngSubmit)="sendFollowUpMessage()">
            <textarea
              class="form-control"
              [(ngModel)]="followUpMessage"
              name="followUpMessage"
              placeholder="Ask for revisions..."
              rows="3"
              (keydown.enter)="onEnterPress($event)"></textarea>
            <button type="submit" class="btn btn-primary btn-sm" [disabled]="!followUpMessage?.trim()">
              <i class="ri-send-plane-fill"></i>
              Send
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Chat Container (Active conversation - full width when not in drafting mode) -->
    <div class="chat-container-main" *ngIf="((showChat$ | async) || (isGenerating$ | async)) && !(draftingMode$ | async)">
      <div class="chat-messages-area">
        <ul class="list-unstyled chat-conversation-list">

          <!-- User & AI Messages -->
          <ng-container *ngFor="let message of (conversationMessages$ | async); let i = index">
            <li class="chat-list" [ngClass]="{ 'right': message.role === 'user', 'left': message.role === 'assistant' }">

              <!-- User Message -->
              <div class="conversation-list" *ngIf="message.role === 'user'">
                <div class="user-chat-content mb-4">
                  <div class="message-bubble bg-soft-info text-info">
                    <div class="message-content">
                      <p class="mb-0">{{message.content}}</p>
                    </div>
                    <div class="message-meta">
                      <small class="text-muted">{{message.timestamp ? (message.timestamp | date:'short') : 'Just now'}}</small>
                      <i class="ri-check-double-line ms-1 text-success"></i>
                    </div>
                  </div>
                </div>
                <!-- User Avatar (right side) -->
                <div class="chat-avatar ms-3">
                  <div class="avatar-sm">
                    <div class="avatar-title bg-success-subtle text-success rounded-circle">
                      <i class="ri-user-3-fill"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- AI Message -->
              <div class="ai-message-container" *ngIf="message.role === 'assistant'">
                <div class="d-flex align-items-start gap-3 mb-3">
                  <div class="chat-avatar flex-shrink-0">
                    <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                  </div>

                  <div class="message-bubble ai-message flex-grow-1">
                    <div class="message-content" [innerHTML]="message.content | markdownToHtml" apexChartsContainer></div>

                    <!-- Transformation Comparison - Refactored Component -->
                    <app-transformation-preview
                      *ngIf="message.transformationComparison"
                      [transformation]="message.transformationComparison"
                      [messageId]="message.id!"
                      (accept)="acceptTransformation($event)"
                      (reject)="rejectTransformation($event)">
                    </app-transformation-preview>

                    <!-- Suggested Actions -->
                    <div class="suggested-actions" *ngIf="message.documentGenerated">
                      <div class="actions-label">Suggested actions:</div>
                      <div class="actions-buttons">
                        <button class="action-btn" (click)="executeSuggestedAction('view-document', message.documentId)">
                          <i class="ri-eye-line"></i>
                          View Document
                        </button>
                        <button class="action-btn" (click)="executeSuggestedAction('export-pdf', message.documentId)">
                          <i class="ri-file-pdf-line"></i>
                          Export to PDF
                        </button>
                        <button class="action-btn" (click)="executeSuggestedAction('summarize-authority', message.documentId)">
                          <i class="ri-file-text-line"></i>
                          Summarize case authority
                        </button>
                      </div>
                    </div>

                    <!-- Follow-up Questions -->
                    <div class="follow-up-questions-section" *ngIf="(followUpQuestions$ | async)?.length > 0 && i === (conversationMessages$ | async)?.length - 1">
                      <div class="follow-up-label">
                        <i class="ri-question-line"></i>
                        Suggested follow up questions:
                      </div>
                      <div class="follow-up-list">
                        <button
                          *ngFor="let question of (followUpQuestions$ | async)"
                          class="follow-up-btn"
                          (click)="askFollowUpQuestion(question)"
                          [disabled]="isGenerating$ | async">
                          <i class="ri-add-line"></i>
                          <span>{{ question }}</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </li>
          </ng-container>

          <!-- AI Generating State -->
          <li class="message-item assistant" *ngIf="isGenerating$ | async">
            <div class="ai-message-container">
              <div class="d-flex align-items-start gap-3 mb-3">
                <div class="chat-avatar flex-shrink-0">
                  <img src="/assets/images/new-legal-ai.gif" alt="AI Assistant" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;">
                </div>

                <div class="message-bubble ai-message flex-grow-1">
                  <!-- AI Activity Loading -->
                  <div class="ai-activity-loader">
                    <!-- Header -->
                    <div class="activity-header">
                      <span>Generating response</span>
                      <i class="ri-arrow-up-s-line"></i>
                    </div>

                    <!-- Activity Steps - Refactored Component -->
                    <app-workflow-steps
                      [steps]="workflowSteps$ | async"
                      [isGenerating]="isGenerating$ | async">
                    </app-workflow-steps>

                    <button class="btn-stop-response" (click)="stopGeneration()">
                      <i class="ri-stop-circle-line"></i>
                      Stop response
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </li>

        </ul>
      </div>

      <!-- Bottom Input Bar (in chat mode) -->
      <div class="chat-input-bar-bottom" *ngIf="(showBottomSearchBar$ | async) && !(isGenerating$ | async)">
        <form (ngSubmit)="sendFollowUpMessage()" class="chat-input-form">
          <textarea
            class="form-control chat-input"
            [(ngModel)]="followUpMessage"
            name="followUpMessage"
            [placeholder]="followUpPlaceholder"
            rows="1"
            (keydown.enter)="onEnterPress($event)"></textarea>

          <div class="input-footer">
            <div class="jurisdiction-selector-inline">
              <label>Jurisdiction:</label>
              <select class="form-select form-select-sm" [(ngModel)]="selectedJurisdiction" name="jurisdictionInline">
                <option *ngFor="let jur of jurisdictions" [value]="jur">{{jur}}</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary btn-send" [disabled]="!followUpMessage?.trim()">
              <i class="ri-send-plane-fill"></i>
            </button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <!-- Document Editor Modal -->

</div>

<!-- How It Works Modal -->
<ng-template #howItWorksModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="ri-lightbulb-line me-2"></i>
      How AI Drafting Assistant Works
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="feature-list">
      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-file-add-line"></i>
        </div>
        <div class="feature-content">
          <h6>Draft Generation</h6>
          <p>Generate professional legal documents using AI. Simply describe what you need, and the AI will create a complete draft based on your requirements and jurisdiction.</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-pencil-line"></i>
        </div>
        <div class="feature-content">
          <h6>Smart Transformations</h6>
          <p>Select any text in your document and request changes. The AI will show you a side-by-side comparison before applying edits, giving you full control over modifications.</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-history-line"></i>
        </div>
        <div class="feature-content">
          <h6>Version History</h6>
          <p>Every change creates a version snapshot. Review, compare, or restore any previous version of your document at any time.</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-download-line"></i>
        </div>
        <div class="feature-content">
          <h6>Export & Save</h6>
          <p>Download your document as a formatted Word file (.docx) or save it to your file manager for future access and collaboration.</p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="modal.close()">Got it!</button>
  </div>
</ng-template>

