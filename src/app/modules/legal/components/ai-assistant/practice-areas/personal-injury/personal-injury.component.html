<div class="container-fluid">

  <!-- ==================== DASHBOARD VIEW ==================== -->
  <div *ngIf="viewMode === 'dashboard'">
    <!-- Dashboard Header -->
    <div class="row">
      <div class="col-12">
        <div class="page-header-wrapper">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div>
              <div class="text-muted fs-11 fw-semibold letter-spacing text-uppercase mb-1">Practice Areas</div>
              <h4 class="mb-0">Personal Injury Portfolio</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-soft-info" (click)="openProviderDirectory()">
                <i class="ri-contacts-book-line me-1"></i> Provider Directory
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Stats Row -->
    <div class="stats-row mb-4">
      <div class="stat-item">
        <div class="stat-header">
          <span class="stat-label">ACTIVE CASES</span>
          <span class="stat-indicator stat-indicator-primary">
            <i class="ri-briefcase-line"></i>
          </span>
        </div>
        <div class="stat-body">
          <i class="ri-folder-open-line stat-icon text-primary"></i>
          <span class="stat-value">{{ portfolioStats?.activeCases || 0 }}</span>
        </div>
        <div class="stat-footer" *ngIf="portfolioStats?.totalCases">
          <small class="text-muted">of {{ portfolioStats.totalCases }} total cases</small>
        </div>
      </div>

      <div class="stat-item">
        <div class="stat-header">
          <span class="stat-label">PORTFOLIO VALUE</span>
          <span class="stat-indicator stat-indicator-success">
            <i class="ri-money-dollar-circle-line"></i>
          </span>
        </div>
        <div class="stat-body">
          <i class="ri-funds-line stat-icon text-success"></i>
          <span class="stat-value">{{ formatCompactCurrency(portfolioStats?.totalPortfolioValue || 0) }}</span>
        </div>
        <div class="stat-footer">
          <small class="text-muted">Total estimated value</small>
        </div>
      </div>

      <div class="stat-item">
        <div class="stat-header">
          <span class="stat-label">PENDING DEMANDS</span>
          <span class="stat-indicator stat-indicator-warning">
            <i class="ri-mail-send-line"></i>
          </span>
        </div>
        <div class="stat-body">
          <i class="ri-time-line stat-icon text-warning"></i>
          <span class="stat-value">{{ portfolioStats?.pendingDemands || 0 }}</span>
        </div>
        <div class="stat-footer">
          <small class="text-muted">Awaiting response</small>
        </div>
      </div>

      <div class="stat-item">
        <div class="stat-header">
          <span class="stat-label">AVG CASE VALUE</span>
          <span class="stat-indicator stat-indicator-info">
            <i class="ri-line-chart-line"></i>
          </span>
        </div>
        <div class="stat-body">
          <i class="ri-bar-chart-line stat-icon text-info"></i>
          <span class="stat-value">{{ formatCompactCurrency(portfolioStats?.avgCaseValue || 0) }}</span>
        </div>
        <div class="stat-footer">
          <small class="text-muted">Per case average</small>
        </div>
      </div>
    </div>

    <!-- PI Cases -->
    <div class="row" style="margin-bottom: 60px;">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-transparent border-bottom">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
              <div>
                <h5 class="mb-1 fw-semibold">All Cases</h5>
                <p class="text-muted mb-0 fs-13">Manage and track your personal injury cases</p>
              </div>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <!-- Filter Chips -->
                <div class="filter-chips">
                  <button class="filter-chip" [class.active]="!portfolioStatusFilter && !portfolioSearchTerm" (click)="clearPortfolioFilters()">
                    <i class="ri-list-check-2"></i> All
                  </button>
                  <button class="filter-chip chip-success" [class.active]="portfolioStatusFilter === 'OPEN'" (click)="onPortfolioStatusFilter('OPEN')">
                    <i class="ri-folder-open-line"></i> Open
                  </button>
                  <button class="filter-chip chip-warning" [class.active]="portfolioStatusFilter === 'PENDING'" (click)="onPortfolioStatusFilter('PENDING')">
                    <i class="ri-hourglass-line"></i> Pending
                  </button>
                  <button class="filter-chip chip-info" [class.active]="portfolioStatusFilter === 'IN_SETTLEMENT'" (click)="onPortfolioStatusFilter('IN_SETTLEMENT')">
                    <i class="ri-scales-3-line"></i> Settlement
                  </button>
                </div>
                <!-- Search -->
                <div class="search-box d-none d-md-block">
                  <input type="text" class="form-control search-input"
                         [value]="portfolioSearchTerm"
                         (input)="onPortfolioSearch($event)"
                         placeholder="Search cases...">
                  <i class="ri-search-line search-icon"></i>
                </div>
                <button class="btn btn-soft-secondary btn-sm btn-icon" (click)="loadPICases(0)" [disabled]="isLoadingPICases" ngbTooltip="Refresh">
                  <i class="ri-refresh-line" [class.spin]="isLoadingPICases"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="card-body">
            <!-- Loading -->
            <div class="text-center py-5" *ngIf="isLoadingPICases">
              <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
              <h5 class="mt-4">Loading Cases</h5>
              <p class="text-muted">Fetching your PI cases...</p>
            </div>

            <!-- Table -->
            <div class="table-responsive" *ngIf="!isLoadingPICases">
              <table class="table table-hover table-nowrap align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col" style="width: 12%;"><i class="ri-hashtag text-muted me-1"></i>Case #</th>
                    <th scope="col" style="width: 30%;"><i class="ri-file-text-line text-muted me-1"></i>Case / Client</th>
                    <th scope="col" style="width: 12%;"><i class="ri-flag-line text-muted me-1"></i>Status</th>
                    <th scope="col" style="width: 14%;"><i class="ri-money-dollar-circle-line text-muted me-1"></i>Est. Value</th>
                    <th scope="col" style="width: 14%;"><i class="ri-hospital-line text-muted me-1"></i>Medical</th>
                    <th scope="col" style="width: 10%;"><i class="ri-calendar-line text-muted me-1"></i>Days</th>
                    <th scope="col" style="width: 8%;"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let caseItem of piCaseList" class="cursor-pointer" (click)="selectCaseForWorkspace(caseItem)">
                    <td>
                      <a class="fw-semibold text-primary d-flex align-items-center gap-1">
                        <i class="ri-folder-3-line"></i>{{ caseItem.caseNumber }}
                      </a>
                    </td>
                    <td>
                      <div class="d-flex align-items-start gap-2">
                        <div class="avatar-xs flex-shrink-0">
                          <span class="avatar-title rounded-circle" [ngClass]="{
                            'bg-success-subtle text-success': caseItem.status === 'ACTIVE' || caseItem.status === 'OPEN',
                            'bg-warning-subtle text-warning': caseItem.status === 'PENDING',
                            'bg-info-subtle text-info': caseItem.status === 'IN_SETTLEMENT',
                            'bg-primary-subtle text-primary': caseItem.status !== 'ACTIVE' && caseItem.status !== 'OPEN' && caseItem.status !== 'PENDING' && caseItem.status !== 'IN_SETTLEMENT'
                          }">
                            {{ getClientInitials(caseItem.clientName) }}
                          </span>
                        </div>
                        <div class="flex-grow-1 overflow-hidden">
                          <h6 class="mb-0 text-truncate" style="max-width: 220px;">{{ caseItem.title }}</h6>
                          <small class="text-muted d-flex align-items-center gap-1 mt-1">
                            <i class="ri-user-line fs-12"></i>{{ caseItem.clientName || 'No Client' }}
                          </small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="badge rounded-pill d-inline-flex align-items-center gap-1" [ngClass]="{
                        'bg-success-subtle text-success': caseItem.status === 'ACTIVE' || caseItem.status === 'OPEN',
                        'bg-warning-subtle text-warning': caseItem.status === 'PENDING',
                        'bg-info-subtle text-info': caseItem.status === 'IN_SETTLEMENT',
                        'bg-primary-subtle text-primary': caseItem.status === 'IN_PROGRESS',
                        'bg-secondary-subtle text-secondary': caseItem.status === 'CLOSED' || caseItem.status === 'ARCHIVED'
                      }">
                        <i [ngClass]="{
                          'ri-checkbox-circle-fill': caseItem.status === 'ACTIVE' || caseItem.status === 'OPEN',
                          'ri-time-fill': caseItem.status === 'PENDING',
                          'ri-scales-3-fill': caseItem.status === 'IN_SETTLEMENT',
                          'ri-loader-4-fill': caseItem.status === 'IN_PROGRESS',
                          'ri-archive-fill': caseItem.status === 'CLOSED' || caseItem.status === 'ARCHIVED'
                        }" class="fs-10"></i>
                        {{ formatStatus(caseItem.status) }}
                      </span>
                    </td>
                    <td>
                      <div class="d-flex align-items-center gap-1" *ngIf="getCaseValueDisplay(caseItem) > 0">
                        <i class="ri-funds-line text-success"></i>
                        <span class="fw-semibold text-success">{{ formatCurrency(getCaseValueDisplay(caseItem)) }}</span>
                      </div>
                      <span class="text-muted" *ngIf="getCaseValueDisplay(caseItem) === 0">—</span>
                    </td>
                    <td>
                      <div class="d-flex align-items-center gap-1" *ngIf="caseItem.medicalExpenses > 0">
                        <i class="ri-heart-pulse-line text-danger"></i>
                        <span class="fw-medium">{{ formatCurrency(caseItem.medicalExpenses) }}</span>
                      </div>
                      <span class="text-muted" *ngIf="!caseItem.medicalExpenses">—</span>
                    </td>
                    <td>
                      <span class="badge bg-light text-body d-inline-flex align-items-center gap-1">
                        <i class="ri-timer-line"></i>{{ getDaysOpen(caseItem) }}d
                      </span>
                    </td>
                    <td>
                      <button type="button" class="btn btn-soft-primary btn-icon btn-sm"
                              ngbTooltip="Open Workspace" (click)="selectCaseForWorkspace(caseItem); $event.stopPropagation()">
                        <i class="ri-arrow-right-s-line fs-16"></i>
                      </button>
                    </td>
                  </tr>

                  <!-- Empty -->
                  <tr *ngIf="piCaseList.length === 0">
                    <td colspan="7" class="text-center py-5">
                      <div class="empty-state-container">
                        <div class="empty-state-illustration">
                          <div class="empty-state-icon-lg">
                            <i class="ri-briefcase-line"></i>
                          </div>
                          <div class="empty-state-circles">
                            <span></span><span></span><span></span>
                          </div>
                        </div>
                        <h5 class="fw-semibold mb-2">No PI Cases Found</h5>
                        <p class="text-muted mb-4" *ngIf="!portfolioStatusFilter && !portfolioSearchTerm">Create a new case with "Personal Injury" practice area</p>
                        <p class="text-muted mb-4" *ngIf="portfolioStatusFilter || portfolioSearchTerm">No cases match the selected filter or search</p>
                        <button class="btn btn-soft-secondary" (click)="clearPortfolioFilters()" *ngIf="portfolioStatusFilter || portfolioSearchTerm">
                          <i class="ri-close-line me-1"></i> Clear Filters
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top"
                 *ngIf="portfolioCasesTotalPages > 1 && !isLoadingPICases">
              <div class="text-muted fs-13">
                Showing {{ piCaseList.length }} of {{ portfolioCasesTotal }} cases
              </div>
              <nav>
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item" [class.disabled]="portfolioCasesPage === 0">
                    <a class="page-link cursor-pointer" (click)="portfolioCasesPage > 0 && loadPICases(portfolioCasesPage - 1)">
                      <i class="ri-arrow-left-s-line"></i>
                    </a>
                  </li>
                  <ng-container *ngFor="let page of getVisiblePages()">
                    <li class="page-item" *ngIf="page !== -1" [class.active]="page === portfolioCasesPage">
                      <a class="page-link cursor-pointer" (click)="loadPICases(page)">{{ page + 1 }}</a>
                    </li>
                    <li class="page-item disabled" *ngIf="page === -1">
                      <span class="page-link">...</span>
                    </li>
                  </ng-container>
                  <li class="page-item" [class.disabled]="portfolioCasesPage >= portfolioCasesTotalPages - 1">
                    <a class="page-link cursor-pointer" (click)="portfolioCasesPage < portfolioCasesTotalPages - 1 && loadPICases(portfolioCasesPage + 1)">
                      <i class="ri-arrow-right-s-line"></i>
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== WORKSPACE VIEW ==================== -->
  <div *ngIf="viewMode === 'workspace'">
    <!-- Workspace Header -->
    <div class="row">
      <div class="col-12">
        <div class="workspace-header">
          <div class="d-flex align-items-center gap-3">
            <button class="btn btn-soft-secondary back-btn" (click)="backToDashboard()">
              <i class="ri-arrow-left-line me-1"></i> Dashboard
            </button>
            <div class="workspace-case-info" *ngIf="linkedCase">
              <span class="case-title">{{ linkedCase.title }}</span>
              <span class="badge rounded-pill ms-2" [ngClass]="getStatusBadgeClass(linkedCase.status)">
                {{ formatStatus(linkedCase.status) }}
              </span>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-soft-info btn-sm" (click)="openProviderDirectory()">
              <i class="ri-contacts-book-line"></i>
              <span class="d-none d-md-inline ms-1">Providers</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Workspace Stats (only when case is linked) -->
    <div class="stats-row" *ngIf="linkedCase && activeTab !== 'provider-directory'">
      <!-- Case Value -->
      <div class="stat-item cursor-pointer" (click)="activeTab = 'valuation'">
        <div class="stat-header">
          <span class="stat-label">CASE VALUE</span>
          <span class="stat-indicator stat-indicator-primary">
            <i class="ri-calculator-line"></i>
          </span>
        </div>
        <div class="stat-body">
          <i class="ri-funds-line stat-icon text-primary"></i>
          <span class="stat-value">{{ formatCompactCurrency(getLinkedCaseValue()) }}</span>
        </div>
      </div>

      <!-- Medical Total -->
      <div class="stat-item cursor-pointer" (click)="activeTab = 'medical'; medicalSubTab = 'records'">
        <div class="stat-header">
          <span class="stat-label">MEDICAL TOTAL</span>
          <span class="stat-indicator stat-indicator-success">
            <i class="ri-hospital-line"></i>
          </span>
        </div>
        <div class="stat-body">
          <i class="ri-heart-pulse-line stat-icon text-success"></i>
          <span class="stat-value">{{ formatCompactCurrency(getLinkedCaseMedicalTotal()) }}</span>
        </div>
      </div>

      <!-- Days Since Injury -->
      <div class="stat-item cursor-pointer" (click)="activeTab = 'documents'; documentsSubTab = 'checklist'">
        <div class="stat-header">
          <span class="stat-label">{{ getDaysSinceInjury() ? 'DAYS SINCE INJURY' : 'DOCUMENTS' }}</span>
          <span class="stat-indicator stat-indicator-info">
            <i [class]="getDaysSinceInjury() ? 'ri-calendar-line' : 'ri-file-list-3-line'"></i>
          </span>
        </div>
        <div class="stat-body">
          <i [class]="getDaysSinceInjury() ? 'ri-time-line stat-icon text-info' : 'ri-file-list-line stat-icon text-info'"></i>
          <span class="stat-value">{{ getDaysSinceInjury() || (documentCompleteness?.score || 0) + '%' }}</span>
        </div>
      </div>

      <!-- Settlement -->
      <div class="stat-item cursor-pointer" (click)="activeTab = 'settlement'">
        <div class="stat-header">
          <span class="stat-label">{{ linkedCase.settlementDemandAmount ? 'SETTLEMENT GAP' : 'SETTLEMENT' }}</span>
          <span class="stat-indicator stat-indicator-warning">
            <i class="ri-exchange-dollar-line"></i>
          </span>
        </div>
        <div class="stat-body">
          <i class="ri-money-dollar-circle-line stat-icon text-warning"></i>
          <span class="stat-value" *ngIf="linkedCase.settlementDemandAmount">
            {{ formatCompactCurrency((linkedCase.settlementDemandAmount || 0) - (linkedCase.settlementOfferAmount || 0)) }}
          </span>
          <span class="stat-value" *ngIf="!linkedCase.settlementDemandAmount">--</span>
        </div>
      </div>
    </div>

    <!-- Main Content Card with Tabs -->
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-transparent border-bottom">
            <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" class="nav nav-pills nav-custom-pills gap-2">
              <!-- Summary Tab (Overview) -->
              <li [ngbNavItem]="'overview'">
                <a ngbNavLink class="d-flex align-items-center gap-2">
                  <i class="ri-dashboard-line fs-16"></i>
                  <span>Summary</span>
                </a>
              <ng-template ngbNavContent>
                <!-- Summary Tab Content - Case Overview -->
                <div class="py-4">
                  <!-- Case Overview Section (when case is linked) -->
                  <div class="case-overview-section" *ngIf="linkedCase">
                    <!-- Summary Header -->
                    <div class="summary-header mb-4">
                      <div class="d-flex align-items-start gap-3">
                        <div class="summary-avatar">
                          <span class="avatar-title rounded-circle bg-primary-subtle text-primary">
                            {{ getClientInitials(linkedCase.clientName) }}
                          </span>
                        </div>
                        <div class="summary-info flex-grow-1">
                          <div class="d-flex align-items-center gap-2 mb-1 flex-wrap">
                            <h5 class="mb-0 fw-semibold case-title-full">{{ linkedCase.title }}</h5>
                            <span class="badge rounded-pill" [ngClass]="getStatusBadgeClass(linkedCase.status)">
                              {{ formatStatus(linkedCase.status) }}
                            </span>
                          </div>
                          <div class="d-flex align-items-center gap-3 text-muted fs-13 flex-wrap">
                            <span><i class="ri-hashtag me-1"></i>{{ linkedCase.caseNumber }}</span>
                            <span *ngIf="linkedCase.injuryDate"><i class="ri-calendar-event-line me-1"></i>Injury: {{ linkedCase.injuryDate | date:'mediumDate' }}</span>
                            <span><i class="ri-time-line me-1"></i>{{ getDaysOpen(linkedCase) }} days open</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Stats Cards Row -->
                    <div class="row g-3 mb-4">
                      <div class="col-6 col-lg-3">
                        <div class="summary-stat-card primary" (click)="activeTab = 'valuation'">
                          <div class="ssc-icon"><i class="ri-funds-line"></i></div>
                          <div class="ssc-content">
                            <div class="ssc-value">{{ formatCompactCurrency(getLinkedCaseValue()) }}</div>
                            <div class="ssc-label">Case Value</div>
                          </div>
                          <div class="ssc-action"><i class="ri-arrow-right-s-line"></i></div>
                        </div>
                      </div>
                      <div class="col-6 col-lg-3">
                        <div class="summary-stat-card success" (click)="activeTab = 'medical'; medicalSubTab = 'records'">
                          <div class="ssc-icon"><i class="ri-heart-pulse-line"></i></div>
                          <div class="ssc-content">
                            <div class="ssc-value">{{ formatCompactCurrency(getLinkedCaseMedicalTotal()) }}</div>
                            <div class="ssc-label">Medical Bills</div>
                          </div>
                          <div class="ssc-action"><i class="ri-arrow-right-s-line"></i></div>
                        </div>
                      </div>
                      <div class="col-6 col-lg-3">
                        <div class="summary-stat-card info" (click)="activeTab = 'documents'; documentsSubTab = 'checklist'">
                          <div class="ssc-icon"><i class="ri-file-list-3-line"></i></div>
                          <div class="ssc-content">
                            <div class="ssc-value">{{ documentCompleteness?.score || 0 }}<span class="ssc-unit">%</span></div>
                            <div class="ssc-label">Documents</div>
                          </div>
                          <div class="ssc-action"><i class="ri-arrow-right-s-line"></i></div>
                        </div>
                      </div>
                      <div class="col-6 col-lg-3">
                        <div class="summary-stat-card warning" (click)="activeTab = 'settlement'">
                          <div class="ssc-icon"><i class="ri-scales-3-line"></i></div>
                          <div class="ssc-content">
                            <div class="ssc-value">{{ linkedCase.settlementDemandAmount ? formatCompactCurrency(linkedCase.settlementDemandAmount) : '--' }}</div>
                            <div class="ssc-label">Demand</div>
                          </div>
                          <div class="ssc-action"><i class="ri-arrow-right-s-line"></i></div>
                        </div>
                      </div>
                    </div>

                    <!-- Case Details - Medical Summary Style -->
                    <div class="case-info-section">
                      <div class="case-info-header">
                        <i class="ri-information-line"></i>
                        <span>Case Information</span>
                      </div>
                      <div class="case-info-grid">
                        <!-- Client -->
                        <div class="case-info-item client">
                          <div class="info-icon">
                            <i class="ri-user-3-line"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-value">{{ linkedCase.clientName || 'Not specified' }}</span>
                            <span class="info-label">Client</span>
                          </div>
                        </div>

                        <!-- Defendant -->
                        <div class="case-info-item defendant" *ngIf="linkedCase.defendantName">
                          <div class="info-icon">
                            <i class="ri-user-unfollow-line"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-value">{{ linkedCase.defendantName }}</span>
                            <span class="info-label">Defendant</span>
                          </div>
                        </div>

                        <!-- Insurance -->
                        <div class="case-info-item insurance" *ngIf="linkedCase.insuranceCompany">
                          <div class="info-icon">
                            <i class="ri-shield-check-line"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-value">{{ linkedCase.insuranceCompany }}</span>
                            <span class="info-label">Insurance Carrier</span>
                          </div>
                        </div>

                        <!-- Policy Limit -->
                        <div class="case-info-item policy" *ngIf="linkedCase.policyLimit">
                          <div class="info-icon">
                            <i class="ri-money-dollar-circle-line"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-value text-success">{{ formatCurrency(linkedCase.policyLimit) }}</span>
                            <span class="info-label">Policy Limit</span>
                          </div>
                        </div>

                        <!-- Accident Location -->
                        <div class="case-info-item location" *ngIf="linkedCase.accidentLocation">
                          <div class="info-icon">
                            <i class="ri-map-pin-2-line"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-value">{{ linkedCase.accidentLocation }}</span>
                            <span class="info-label">Accident Location</span>
                          </div>
                        </div>

                        <!-- Injury Type -->
                        <div class="case-info-item injury" *ngIf="linkedCase.injuryType">
                          <div class="info-icon">
                            <i class="ri-heart-pulse-line"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-value">{{ getInjuryTypeLabel(linkedCase.injuryType) }}</span>
                            <span class="info-label">Injury Type</span>
                          </div>
                        </div>

                        <!-- Case Opened -->
                        <div class="case-info-item date">
                          <div class="info-icon">
                            <i class="ri-calendar-check-line"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-value">{{ linkedCase.createdAt | date:'MMM d, yyyy' }}</span>
                            <span class="info-label">Case Opened</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- No Case Linked State -->
                  <div class="no-case-state text-center py-5" *ngIf="!linkedCase">
                    <div class="empty-state-illustration mb-4">
                      <div class="empty-state-icon-lg">
                        <i class="ri-folder-open-line"></i>
                      </div>
                      <div class="empty-state-circles">
                        <span></span><span></span><span></span>
                      </div>
                    </div>
                    <h5 class="fw-semibold mb-2">No Case Selected</h5>
                    <p class="text-muted fs-13 mb-4">Select a case from the dashboard to view details and work on it.</p>
                    <button class="btn btn-primary" (click)="backToDashboard()">
                      <i class="ri-arrow-left-line me-1"></i> Go to Dashboard
                    </button>
                  </div>
                </div>
              </ng-template>
            </li>

            <!-- Valuation Tab -->
            <li [ngbNavItem]="'valuation'">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-funds-line fs-16"></i>
                <span>Valuation</span>
                <span class="badge bg-primary-subtle text-primary ms-1" *ngIf="latestCaseValue > 0">{{ formatCompactCurrency(latestCaseValue) }}</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Unified Case Valuation Tab Content -->
                <div class="case-valuation-container py-4">
                  <!-- Header with Actions -->
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                    <div>
                      <h5 class="mb-1 fw-semibold">Case Valuation</h5>
                      <p class="text-muted mb-0 fs-13">Comprehensive damage analysis with AI-powered case value estimation</p>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="prefilled-badge" *ngIf="linkedCase && prefilledFromCase">
                        <i class="ri-magic-line me-1"></i> Pre-filled from {{ linkedCase.caseNumber }}
                      </span>
                      <button class="btn btn-soft-success" (click)="syncMedicalExpenses()" [disabled]="!linkedCase" title="Sync damage elements from medical records">
                        <i class="ri-refresh-line me-1"></i> Sync Medical
                      </button>
                      <button class="btn btn-primary" (click)="calculateAndAnalyze()" [disabled]="caseValueForm.invalid || isCalculating || isCalculatingDamages">
                        <span *ngIf="!isCalculating && !isCalculatingDamages">
                          <i class="ri-calculator-line me-1"></i> Calculate & Analyze
                        </span>
                        <span *ngIf="isCalculating || isCalculatingDamages">
                          <span class="spinner-border spinner-border-sm me-1"></span> {{ isCalculating ? 'Calculating...' : 'Analyzing...' }}
                        </span>
                      </button>
                    </div>
                  </div>

                  <!-- EXECUTIVE DECISION PANEL (Shows when we have calculation data or saved damage calculation WITH actual supporting data) -->
                  <div class="executive-decision-panel" *ngIf="calculatedValue || (damageCalculation?.lowValue && damageCalculation?.midValue && hasActualDamageData())">
                    <!-- Value Range Visual Bar -->
                    <div class="value-range-visual">
                      <div class="range-track">
                        <div class="range-segment low" [style.width.%]="getValueBarWidth('low')"></div>
                        <div class="range-segment likely" [style.width.%]="getValueBarWidth('likely')"></div>
                        <div class="range-segment high" [style.width.%]="getValueBarWidth('high')"></div>
                        <!-- Policy Limit Marker -->
                        <div class="policy-limit-marker" *ngIf="caseValueForm.get('policyLimit')?.value"
                             [style.left.%]="getPolicyLimitPosition()"
                             [class.exceeds-value]="getPolicyLimitPosition() < 100">
                          <div class="marker-line"></div>
                          <div class="marker-label">Policy: {{ formatCompactCurrency(caseValueForm.get('policyLimit')?.value) }}</div>
                        </div>
                      </div>
                      <div class="range-labels">
                        <div class="range-label low">
                          <span class="label-text">LOW</span>
                          <span class="label-value">{{ formatCurrency(damageCalculation?.lowValue || calculatedValue?.settlementRangeLow || 0) }}</span>
                        </div>
                        <div class="range-label likely">
                          <span class="label-text">LIKELY</span>
                          <span class="label-value">{{ formatCurrency(damageCalculation?.midValue || calculatedValue?.realisticRecovery || 0) }}</span>
                        </div>
                        <div class="range-label high">
                          <span class="label-text">HIGH</span>
                          <span class="label-value">{{ formatCurrency(damageCalculation?.highValue || calculatedValue?.settlementRangeHigh || 0) }}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Key Metrics Row -->
                    <div class="key-metrics-grid">
                      <!-- Case Strength Ring -->
                      <div class="metric-card strength-card" *ngIf="calculatedValue?.caseStrength">
                        <div class="case-strength-ring" [class]="getStrengthClass(calculatedValue.caseStrength)">
                          <svg viewBox="0 0 36 36" class="strength-svg">
                            <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <path class="ring-fill" [attr.stroke-dasharray]="(calculatedValue.caseStrength * 10) + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <text x="18" y="20.35" class="strength-text">{{ calculatedValue.caseStrength }}</text>
                          </svg>
                        </div>
                        <div class="metric-info">
                          <span class="metric-value">{{ calculatedValue.caseStrength }}/10</span>
                          <span class="metric-label">CASE STRENGTH</span>
                        </div>
                      </div>
                      <!-- Fallback when no case strength -->
                      <div class="metric-card strength-card" *ngIf="!calculatedValue?.caseStrength">
                        <div class="metric-icon"><i class="ri-bar-chart-2-line"></i></div>
                        <div class="metric-info">
                          <span class="metric-value">--</span>
                          <span class="metric-label">CASE STRENGTH</span>
                        </div>
                      </div>

                      <!-- Economic Damages -->
                      <div class="metric-card economic-card">
                        <div class="metric-icon"><i class="ri-money-dollar-circle-line"></i></div>
                        <div class="metric-info">
                          <span class="metric-value">{{ formatCompactCurrency(damageCalculation?.economicDamagesTotal || calculatedValue?.economicDamages || getEconomicDamagesFromElements()) }}</span>
                          <span class="metric-label">ECONOMIC</span>
                        </div>
                      </div>

                      <!-- Non-Economic Damages -->
                      <div class="metric-card noneconomic-card">
                        <div class="metric-icon"><i class="ri-heart-pulse-line"></i></div>
                        <div class="metric-info">
                          <span class="metric-value">{{ formatCompactCurrency(damageCalculation?.nonEconomicDamagesTotal || calculatedValue?.nonEconomicDamages || getNonEconomicDamagesFromElements()) }}</span>
                          <span class="metric-label">NON-ECONOMIC</span>
                        </div>
                      </div>

                      <!-- Multiplier -->
                      <div class="metric-card multiplier-card">
                        <div class="metric-icon"><i class="ri-scales-3-line"></i></div>
                        <div class="metric-info">
                          <span class="metric-value">{{ calculatedValue?.multiplier || getMultiplier() }}x</span>
                          <span class="metric-label">MULTIPLIER</span>
                        </div>
                      </div>
                    </div>

                    <!-- Strategy Banner -->
                    <div class="strategy-banner" *ngIf="calculatedValue?.recommendations">
                      <i class="ri-lightbulb-flash-line"></i>
                      <span class="strategy-text">{{ calculatedValue.recommendations }}</span>
                    </div>

                    <!-- Underinsured Warning -->
                    <div class="underinsured-warning" *ngIf="calculatedValue?.isUnderinsured || (caseValueForm.get('policyLimit')?.value && (calculatedValue?.medicalExpenses || 0) > (caseValueForm.get('policyLimit')?.value * 0.6))">
                      <i class="ri-alarm-warning-line"></i>
                      <div class="warning-content">
                        <strong>Underinsured Case</strong>
                        <span>Medical expenses exceed 60% of policy limit. Consider policy limits demand strategy.</span>
                      </div>
                    </div>
                  </div>

                  <!-- Two Column Layout -->
                  <div class="row g-4">
                    <!-- Left Column: Add Element + Case Context -->
                    <div class="col-lg-4">
                      <!-- Add Damage Element Card -->
                      <div class="panel-card mb-3">
                        <div class="panel-header">
                          <h6 class="mb-0"><i class="ri-add-line me-2 text-primary"></i>Add Damage Element</h6>
                        </div>
                        <div class="panel-body">
                          <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select form-select-sm" [(ngModel)]="newDamageElement.elementType">
                              <option *ngFor="let type of damageElementTypes" [value]="type.value">{{ type.label }}</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label class="form-label">Description *</label>
                            <input type="text" class="form-control form-control-sm" [(ngModel)]="newDamageElement.elementName" placeholder="e.g., Boston Medical ER">
                          </div>
                          <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <div class="input-group input-group-sm">
                              <span class="input-group-text">$</span>
                              <input type="number" class="form-control" [(ngModel)]="newDamageElement.baseAmount">
                            </div>
                          </div>
                          <div class="row mb-3">
                            <div class="col-6">
                              <label class="form-label">Method</label>
                              <select class="form-select form-select-sm" [(ngModel)]="newDamageElement.calculationMethod">
                                <option *ngFor="let method of calculationMethods" [value]="method.value">{{ method.label }}</option>
                              </select>
                            </div>
                            <div class="col-6">
                              <label class="form-label">Confidence</label>
                              <select class="form-select form-select-sm" [(ngModel)]="newDamageElement.confidenceLevel">
                                <option *ngFor="let level of confidenceLevels" [value]="level.value">{{ level.label }}</option>
                              </select>
                            </div>
                          </div>
                          <button class="btn btn-primary btn-sm w-100" (click)="addDamageElement()" [disabled]="!newDamageElement.elementName || !linkedCase">
                            <i class="ri-add-line me-1"></i> Add Element
                          </button>
                        </div>
                      </div>

                      <!-- Case Context Card -->
                      <div class="panel-card mb-3">
                        <div class="panel-header">
                          <h6 class="mb-0"><i class="ri-information-line me-2 text-info"></i>Case Context</h6>
                        </div>
                        <div class="panel-body">
                          <form [formGroup]="caseValueForm">
                            <div class="mb-3">
                              <label class="form-label">Injury Type</label>
                              <select class="form-select form-select-sm" formControlName="injuryType">
                                <option *ngFor="let type of injuryTypes" [value]="type.value">{{ type.label }}</option>
                              </select>
                              <small class="form-text">Multiplier: <strong>{{ getMultiplier() }}x</strong></small>
                            </div>
                            <div class="mb-3">
                              <label class="form-label">Liability</label>
                              <select class="form-select form-select-sm" formControlName="liabilityAssessment">
                                <option *ngFor="let option of liabilityOptions" [value]="option.value">{{ option.label }}</option>
                              </select>
                            </div>
                            <div class="mb-3" *ngIf="caseValueForm.get('liabilityAssessment')?.value === 'COMPARATIVE'">
                              <label class="form-label">Comparative Negligence</label>
                              <div class="input-group input-group-sm">
                                <input type="number" class="form-control" formControlName="comparativeNegligence" min="0" max="100">
                                <span class="input-group-text">%</span>
                              </div>
                            </div>
                            <div class="mb-3">
                              <label class="form-label">Policy Limit</label>
                              <div class="input-group input-group-sm">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" formControlName="policyLimit" placeholder="e.g., 100000">
                              </div>
                            </div>
                            <div class="mb-3">
                              <label class="form-label">Injury Description</label>
                              <textarea class="form-control form-control-sm" formControlName="injuryDescription" rows="2" placeholder="Brief description..."></textarea>
                            </div>
                          </form>
                        </div>
                      </div>

                    </div>

                    <!-- Right Column: AI Analysis + Damage Elements -->
                    <div class="col-lg-8">
                      <!-- AI SETTLEMENT ANALYSIS (Moved above damage elements for prominence) -->
                      <div class="ai-settlement-analysis" *ngIf="calculatedValue?.settlementRangeLow || damageCalculation?.comparableAnalysis || calculatedValue?.keyFactors?.length">
                        <div class="analysis-header">
                          <h6 class="mb-0"><i class="ri-robot-line me-2"></i>AI Settlement Analysis</h6>
                          <button class="btn btn-soft-primary btn-sm" (click)="calculateComprehensiveDamages()" [disabled]="!linkedCase || isCalculatingDamages">
                            <i class="ri-refresh-line me-1"></i> Refresh Analysis
                          </button>
                        </div>

                        <div class="analysis-cards-row">
                          <!-- Settlement Range Card -->
                          <div class="settlement-range-card" *ngIf="calculatedValue?.settlementRangeLow || damageCalculation?.lowValue">
                            <div class="card-title"><i class="ri-funds-box-line me-2"></i>Settlement Range</div>
                            <div class="range-values">
                              <div class="range-item">
                                <span class="percentile">25th</span>
                                <span class="amount">{{ formatCurrency(damageCalculation?.lowValue || calculatedValue?.settlementRangeLow || 0) }}</span>
                              </div>
                              <div class="range-item median">
                                <span class="percentile">Median</span>
                                <span class="amount">{{ formatCurrency(damageCalculation?.midValue || calculatedValue?.realisticRecovery || 0) }}</span>
                              </div>
                              <div class="range-item">
                                <span class="percentile">75th</span>
                                <span class="amount">{{ formatCurrency(damageCalculation?.highValue || calculatedValue?.settlementRangeHigh || 0) }}</span>
                              </div>
                            </div>
                          </div>

                          <!-- Value Factors Card -->
                          <div class="value-factors-card" *ngIf="calculatedValue?.keyFactors?.length">
                            <div class="card-title"><i class="ri-scales-3-line me-2"></i>Value Factors</div>
                            <div class="factors-columns">
                              <div class="factors-column strengthens">
                                <div class="column-header"><i class="ri-arrow-up-circle-fill"></i> Strengthens</div>
                                <div class="factor-list">
                                  <div class="factor-item" *ngFor="let factor of getPositiveFactors()">
                                    <i class="ri-check-line"></i>
                                    <span>{{ factor }}</span>
                                  </div>
                                  <div class="factor-item empty" *ngIf="getPositiveFactors().length === 0">
                                    <span class="text-muted">No strengthening factors identified</span>
                                  </div>
                                </div>
                              </div>
                              <div class="factors-column weakens">
                                <div class="column-header"><i class="ri-arrow-down-circle-fill"></i> Weakens</div>
                                <div class="factor-list">
                                  <div class="factor-item" *ngFor="let factor of getNegativeFactors()">
                                    <i class="ri-close-line"></i>
                                    <span>{{ factor }}</span>
                                  </div>
                                  <div class="factor-item empty" *ngIf="getNegativeFactors().length === 0">
                                    <span class="text-muted">No weakening factors identified</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Comparable Analysis Section (Expandable, no max-height) -->
                        <div class="comparable-analysis-section" *ngIf="damageCalculation?.comparableAnalysis?.analysis">
                          <div class="comparable-header" (click)="comparableAnalysisExpanded = !comparableAnalysisExpanded">
                            <i class="ri-file-search-line me-2"></i>
                            <span>Comparable Cases Analysis</span>
                            <i class="expand-icon" [class.ri-arrow-down-s-line]="!comparableAnalysisExpanded" [class.ri-arrow-up-s-line]="comparableAnalysisExpanded"></i>
                          </div>
                          <div class="comparable-content" [class.expanded]="comparableAnalysisExpanded">
                            <div [innerHTML]="damageCalculation.comparableAnalysis.analysis | aiResponseFormatter"></div>
                          </div>
                        </div>
                      </div>

                      <!-- Grouped Damage Elements -->
                      <div class="damage-elements-grouped" *ngIf="damageElements.length > 0">
                        <!-- Past Medical Group -->
                        <div class="damage-group" *ngIf="getDamageElementsByCategory('PAST_MEDICAL').length > 0">
                          <div class="group-header" (click)="toggleDamageGroup('PAST_MEDICAL')">
                            <i class="ri-arrow-down-s-line group-toggle" [class.collapsed]="collapsedDamageGroups['PAST_MEDICAL']"></i>
                            <i class="ri-hospital-line group-icon text-danger"></i>
                            <span class="group-title">Past Medical</span>
                            <span class="group-total">({{ formatCurrency(getDamageCategoryTotal('PAST_MEDICAL')) }})</span>
                          </div>
                          <div class="group-items" [class.collapsed]="collapsedDamageGroups['PAST_MEDICAL']">
                            <div class="damage-element-item" *ngFor="let element of getDamageElementsByCategory('PAST_MEDICAL')">
                              <span class="element-name">{{ element.elementName }}</span>
                              <span class="element-amount">{{ formatCurrency(element.calculatedAmount || element.baseAmount || 0) }}</span>
                              <span class="confidence-badge" [class]="'confidence-' + (element.confidenceLevel || 'MEDIUM').toLowerCase()">{{ element.confidenceLevel }}</span>
                              <button class="btn-delete" (click)="deleteDamageElement(element)"><i class="ri-close-line"></i></button>
                            </div>
                          </div>
                        </div>

                        <!-- Lost Wages Group -->
                        <div class="damage-group" *ngIf="getDamageElementsByCategory('LOST_WAGES').length > 0">
                          <div class="group-header" (click)="toggleDamageGroup('LOST_WAGES')">
                            <i class="ri-arrow-down-s-line group-toggle" [class.collapsed]="collapsedDamageGroups['LOST_WAGES']"></i>
                            <i class="ri-briefcase-line group-icon text-warning"></i>
                            <span class="group-title">Lost Wages</span>
                            <span class="group-total">({{ formatCurrency(getDamageCategoryTotal('LOST_WAGES')) }})</span>
                          </div>
                          <div class="group-items" [class.collapsed]="collapsedDamageGroups['LOST_WAGES']">
                            <div class="damage-element-item" *ngFor="let element of getDamageElementsByCategory('LOST_WAGES')">
                              <span class="element-name">{{ element.elementName }}</span>
                              <span class="element-amount">{{ formatCurrency(element.calculatedAmount || element.baseAmount || 0) }}</span>
                              <span class="confidence-badge" [class]="'confidence-' + (element.confidenceLevel || 'MEDIUM').toLowerCase()">{{ element.confidenceLevel }}</span>
                              <button class="btn-delete" (click)="deleteDamageElement(element)"><i class="ri-close-line"></i></button>
                            </div>
                          </div>
                        </div>

                        <!-- Future Medical Group -->
                        <div class="damage-group" *ngIf="getDamageElementsByCategory('FUTURE_MEDICAL').length > 0">
                          <div class="group-header" (click)="toggleDamageGroup('FUTURE_MEDICAL')">
                            <i class="ri-arrow-down-s-line group-toggle" [class.collapsed]="collapsedDamageGroups['FUTURE_MEDICAL']"></i>
                            <i class="ri-calendar-check-line group-icon text-info"></i>
                            <span class="group-title">Future Medical</span>
                            <span class="group-total">({{ formatCurrency(getDamageCategoryTotal('FUTURE_MEDICAL')) }})</span>
                          </div>
                          <div class="group-items" [class.collapsed]="collapsedDamageGroups['FUTURE_MEDICAL']">
                            <div class="damage-element-item" *ngFor="let element of getDamageElementsByCategory('FUTURE_MEDICAL')">
                              <span class="element-name">{{ element.elementName }}</span>
                              <span class="element-amount">{{ formatCurrency(element.calculatedAmount || element.baseAmount || 0) }}</span>
                              <span class="confidence-badge" [class]="'confidence-' + (element.confidenceLevel || 'MEDIUM').toLowerCase()">{{ element.confidenceLevel }}</span>
                              <button class="btn-delete" (click)="deleteDamageElement(element)"><i class="ri-close-line"></i></button>
                            </div>
                          </div>
                        </div>

                        <!-- Pain & Suffering Group -->
                        <div class="damage-group" *ngIf="getDamageElementsByCategory('PAIN_SUFFERING').length > 0">
                          <div class="group-header" (click)="toggleDamageGroup('PAIN_SUFFERING')">
                            <i class="ri-arrow-down-s-line group-toggle" [class.collapsed]="collapsedDamageGroups['PAIN_SUFFERING']"></i>
                            <i class="ri-heart-pulse-line group-icon text-danger"></i>
                            <span class="group-title">Pain & Suffering</span>
                            <span class="group-total">({{ formatCurrency(getDamageCategoryTotal('PAIN_SUFFERING')) }})</span>
                          </div>
                          <div class="group-items" [class.collapsed]="collapsedDamageGroups['PAIN_SUFFERING']">
                            <div class="damage-element-item" *ngFor="let element of getDamageElementsByCategory('PAIN_SUFFERING')">
                              <span class="element-name">{{ element.elementName }}</span>
                              <span class="element-amount">{{ formatCurrency(element.calculatedAmount || element.baseAmount || 0) }}</span>
                              <span class="confidence-badge" [class]="'confidence-' + (element.confidenceLevel || 'MEDIUM').toLowerCase()">{{ element.confidenceLevel }}</span>
                              <button class="btn-delete" (click)="deleteDamageElement(element)"><i class="ri-close-line"></i></button>
                            </div>
                          </div>
                        </div>

                        <!-- Other Damages Group -->
                        <div class="damage-group" *ngIf="getOtherDamageElements().length > 0">
                          <div class="group-header" (click)="toggleDamageGroup('OTHER')">
                            <i class="ri-arrow-down-s-line group-toggle" [class.collapsed]="collapsedDamageGroups['OTHER']"></i>
                            <i class="ri-file-list-line group-icon text-secondary"></i>
                            <span class="group-title">Other Damages</span>
                            <span class="group-total">({{ formatCurrency(getOtherDamagesTotal()) }})</span>
                          </div>
                          <div class="group-items" [class.collapsed]="collapsedDamageGroups['OTHER']">
                            <div class="damage-element-item" *ngFor="let element of getOtherDamageElements()">
                              <span class="element-type-badge">{{ getDamageTypeLabel(element.elementType) }}</span>
                              <span class="element-name">{{ element.elementName }}</span>
                              <span class="element-amount">{{ formatCurrency(element.calculatedAmount || element.baseAmount || 0) }}</span>
                              <span class="confidence-badge" [class]="'confidence-' + (element.confidenceLevel || 'MEDIUM').toLowerCase()">{{ element.confidenceLevel }}</span>
                              <button class="btn-delete" (click)="deleteDamageElement(element)"><i class="ri-close-line"></i></button>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Empty State for Damage Elements -->
                      <div class="damage-elements-empty" *ngIf="damageElements.length === 0 && linkedCase && !isLoadingDamages">
                        <div class="empty-state-illustration">
                          <div class="empty-state-icon-lg">
                            <i class="ri-bar-chart-grouped-line"></i>
                          </div>
                          <div class="empty-state-circles">
                            <span></span><span></span><span></span>
                          </div>
                        </div>
                        <h6 class="fw-semibold mb-2">No Damage Elements</h6>
                        <p class="text-muted mb-3">Add damage elements using the form or sync from medical records.</p>
                        <button class="btn btn-soft-success btn-sm" (click)="syncMedicalExpenses()">
                          <i class="ri-refresh-line me-1"></i> Sync from Medical Records
                        </button>
                      </div>

                      <!-- No Case Linked -->
                      <div class="alert alert-info d-flex align-items-center" *ngIf="!linkedCase">
                        <i class="ri-information-line fs-4 me-3"></i>
                        <div>
                          <strong>Link a Case</strong>
                          <p class="mb-0">Use the case selector above to link a PI case for full damage tracking and AI analysis.</p>
                        </div>
                      </div>

                      <!-- Consolidated Action Buttons (3 buttons only) -->
                      <div class="valuation-actions mt-3" *ngIf="linkedCase">
                        <button class="btn btn-success" (click)="saveCaseValueToCase()" [disabled]="!calculatedValue">
                          <i class="ri-save-line me-1"></i> Save to Case
                        </button>
                        <button class="btn btn-outline-secondary" (click)="exportResults()">
                          <i class="ri-download-line me-1"></i> Export
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>

            <!-- Documents Tab (Checklist + Demand Letter) -->
            <li [ngbNavItem]="'documents'">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-file-list-3-line fs-16"></i>
                <span>Documents</span>
                <span class="badge bg-success-subtle text-success ms-1" *ngIf="documentCompleteness?.score >= 80">{{ documentCompleteness?.score }}%</span>
                <span class="badge bg-warning-subtle text-warning ms-1" *ngIf="documentCompleteness?.score >= 50 && documentCompleteness?.score < 80">{{ documentCompleteness?.score }}%</span>
                <span class="badge bg-danger-subtle text-danger ms-1" *ngIf="documentCompleteness?.score > 0 && documentCompleteness?.score < 50">{{ documentCompleteness?.score }}%</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Documents Tab Content with Sub-tabs -->
                <div class="py-3">
                  <!-- Sub-tab Navigation -->
                  <div class="documents-subtabs mb-4">
                    <button class="subtab-btn" [class.active]="documentsSubTab === 'checklist'"
                            (click)="documentsSubTab = 'checklist'">
                      <i class="ri-checkbox-multiple-line me-1"></i> Document Checklist
                      <span class="subtab-badge" *ngIf="documentCompleteness">{{ documentCompleteness.received }}/{{ documentCompleteness.total }}</span>
                    </button>
                    <button class="subtab-btn" [class.active]="documentsSubTab === 'demand-letter'"
                            (click)="documentsSubTab = 'demand-letter'">
                      <i class="ri-file-text-line me-1"></i> Demand Letter
                      <span class="subtab-indicator editing" *ngIf="isEditingDemand && hasUnsavedDemandChanges"></span>
                      <span class="subtab-indicator saved" *ngIf="isEditingDemand && !hasUnsavedDemandChanges"></span>
                      <span class="subtab-indicator draft" *ngIf="generatedDemand && !isEditingDemand"></span>
                    </button>
                  </div>

                  <!-- Demand Letter Sub-tab Content -->
                  <div *ngIf="documentsSubTab === 'demand-letter'">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                      <div>
                        <h5 class="mb-1 fw-semibold">Demand Letter Generator</h5>
                        <p class="text-muted mb-0 fs-13">Generate professional demand packages with AI assistance</p>
                      </div>
                    </div>

                  <div class="tool-layout">
                    <!-- Input Panel -->
                    <div class="input-panel">
                      <div class="panel-card">
                        <div class="panel-header">
                          <h6 class="mb-0"><i class="ri-edit-line me-2 text-primary"></i>Letter Details</h6>
                        </div>
                        <div class="panel-body">
                          <form [formGroup]="demandForm">
                            <!-- Party Information -->
                            <div class="demand-form-section">
                              <div class="section-title"><i class="ri-user-line"></i> Party Information</div>
                              <div class="row g-3">
                                <div class="col-md-6">
                                  <label class="form-label">Client Name</label>
                                  <input type="text" class="form-control" formControlName="clientName" placeholder="Client's full name">
                                </div>
                                <div class="col-md-6">
                                  <label class="form-label">Defendant Name</label>
                                  <input type="text" class="form-control" formControlName="defendantName" placeholder="Defendant's full name">
                                </div>
                              </div>
                            </div>

                            <!-- Insurance Information -->
                            <div class="demand-form-section">
                              <div class="section-title"><i class="ri-shield-check-line"></i> Insurance Information</div>
                              <div class="row g-3">
                                <div class="col-md-4">
                                  <label class="form-label">Insurance Company</label>
                                  <input type="text" class="form-control" formControlName="insuranceCompany" placeholder="Company name">
                                </div>
                                <div class="col-md-4">
                                  <label class="form-label">Adjuster Name</label>
                                  <input type="text" class="form-control" formControlName="adjusterName" placeholder="Optional">
                                </div>
                                <div class="col-md-4">
                                  <label class="form-label">Claim Number</label>
                                  <input type="text" class="form-control" formControlName="claimNumber" placeholder="Optional">
                                </div>
                              </div>
                            </div>

                            <!-- Accident Details -->
                            <div class="demand-form-section">
                              <div class="section-title"><i class="ri-car-line"></i> Accident Details</div>
                              <div class="row g-3">
                                <div class="col-md-6">
                                  <label class="form-label">Accident Date</label>
                                  <input type="date" class="form-control" formControlName="accidentDate">
                                </div>
                                <div class="col-md-6">
                                  <label class="form-label">Accident Location</label>
                                  <input type="text" class="form-control" formControlName="accidentLocation" placeholder="Where did it occur?">
                                </div>
                              </div>
                            </div>

                            <!-- Injury Details -->
                            <div class="demand-form-section">
                              <div class="section-title"><i class="ri-heart-pulse-line"></i> Injury Details</div>
                              <div class="row g-3">
                                <div class="col-md-6">
                                  <label class="form-label">Injury Type</label>
                                  <select class="form-select" formControlName="injuryType">
                                    <option value="">Select injury type</option>
                                    <option *ngFor="let type of injuryTypes" [value]="type.value">{{ type.label }}</option>
                                  </select>
                                </div>
                                <div class="col-md-6">
                                  <label class="form-label">Policy Limit (if known)</label>
                                  <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" formControlName="policyLimit" placeholder="Optional">
                                  </div>
                                </div>
                                <div class="col-12">
                                  <label class="form-label">Injury Description</label>
                                  <textarea class="form-control" formControlName="injuryDescription" rows="2"
                                            placeholder="Describe the injuries and symptoms..."></textarea>
                                </div>
                                <div class="col-12">
                                  <label class="form-label">Liability Details</label>
                                  <textarea class="form-control" formControlName="liabilityDetails" rows="2"
                                            placeholder="Explain why defendant is at fault..."></textarea>
                                </div>
                              </div>
                            </div>

                            <!-- Damages -->
                            <div class="demand-form-section">
                              <div class="section-title"><i class="ri-money-dollar-box-line"></i> Damages</div>
                              <div class="row g-3">
                                <div class="col-md-3">
                                  <label class="form-label">Medical Expenses</label>
                                  <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" formControlName="medicalExpenses">
                                  </div>
                                </div>
                                <div class="col-md-3">
                                  <label class="form-label">Lost Wages</label>
                                  <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" formControlName="lostWages">
                                  </div>
                                </div>
                                <div class="col-md-3">
                                  <label class="form-label">Future Medical</label>
                                  <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" formControlName="futureMedical">
                                  </div>
                                </div>
                                <div class="col-md-3">
                                  <label class="form-label">P&S Multiplier</label>
                                  <input type="number" class="form-control" formControlName="painSufferingMultiplier" step="0.5" min="1" max="10">
                                </div>
                              </div>
                            </div>

                            <!-- Demand Total -->
                            <div class="demand-total-display">
                              <div class="total-label">
                                <i class="ri-money-dollar-circle-line"></i> Total Demand
                              </div>
                              <div class="total-value">{{ formatCurrency(calculateDemandTotal()) }}</div>
                            </div>

                            <!-- Generate Button -->
                            <div class="mt-4">
                              <button type="button" class="btn btn-primary w-100" (click)="generateDemandLetter()"
                                      [disabled]="demandForm.invalid || isGeneratingDemand">
                                <span *ngIf="!isGeneratingDemand">
                                  <i class="ri-quill-pen-line me-1"></i> Generate Letter
                                </span>
                                <span *ngIf="isGeneratingDemand">
                                  <span class="spinner-border spinner-border-sm me-2"></span>Generating...
                                </span>
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Preview Panel (when NOT editing) -->
                    <div class="results-panel" *ngIf="!isEditingDemand">
                      <div class="panel-card">
                        <div class="panel-header d-flex justify-content-between align-items-center">
                          <h6 class="mb-0"><i class="ri-file-paper-2-line me-2 text-info"></i>Document Preview</h6>
                          <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-soft-info" *ngIf="demandConversationId" (click)="openInAIWorkspace()">
                              <i class="ri-edit-box-line me-1"></i> Edit in AI Workspace
                            </button>
                            <button class="btn btn-sm btn-success" *ngIf="linkedCase && generatedDemand" (click)="saveDemandDataToCase()">
                              <i class="ri-save-line me-1"></i> Save to Case
                            </button>
                            <button class="btn btn-sm btn-soft-primary" *ngIf="generatedDemand" (click)="exportDemandLetter()">
                              <i class="ri-download-line me-1"></i> Export
                            </button>
                          </div>
                        </div>
                        <div class="panel-body p-0">
                          <div class="demand-preview-panel">
                            <div class="preview-header">
                              <div class="letterhead-title">LAW OFFICES</div>
                              <div class="letterhead-subtitle">Attorneys at Law</div>
                            </div>
                            <div class="preview-content" *ngIf="generatedDemand">
                              <div [innerHTML]="generatedDemand | aiResponseFormatter"></div>
                            </div>
                            <div class="preview-empty" *ngIf="!generatedDemand">
                              <div class="empty-state-illustration">
                                <div class="empty-state-icon-lg">
                                  <i class="ri-file-text-line"></i>
                                </div>
                                <div class="empty-state-circles">
                                  <span></span><span></span><span></span>
                                </div>
                              </div>
                              <h6 class="fw-semibold mb-2">No Letter Generated</h6>
                              <p class="text-muted mb-0">Fill in the form and click "Generate Letter" to create your demand letter.</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Document Editor (when editing) -->
                    <div class="results-panel demand-editor-panel" *ngIf="isEditingDemand && demandDocumentId">
                      <div class="panel-card h-100 d-flex flex-column">
                        <!-- Editor Header with Tools -->
                        <div class="editor-header border-bottom p-3">
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                              <h6 class="mb-0"><i class="ri-edit-2-line me-2 text-info"></i>Demand Letter</h6>
                              <span class="badge bg-warning-subtle text-warning" *ngIf="hasUnsavedDemandChanges">Unsaved</span>
                              <span class="badge bg-success-subtle text-success" *ngIf="!hasUnsavedDemandChanges && demandDocumentId">Saved</span>
                            </div>
                            <div class="d-flex gap-2">
                              <!-- AI Refine Dropdown -->
                              <div ngbDropdown>
                                <button class="btn btn-sm btn-soft-info" ngbDropdownToggle [disabled]="isTransformingDemand">
                                  <span *ngIf="!isTransformingDemand"><i class="ri-magic-line me-1"></i> Refine</span>
                                  <span *ngIf="isTransformingDemand"><span class="spinner-border spinner-border-sm me-1"></span> Refining...</span>
                                </button>
                                <div ngbDropdownMenu class="dropdown-menu-end">
                                  <button ngbDropdownItem (click)="transformDemand('SIMPLIFY')">
                                    <i class="ri-subtract-line me-2 text-primary"></i> Simplify Language
                                  </button>
                                  <button ngbDropdownItem (click)="transformDemand('CONDENSE')">
                                    <i class="ri-compress-line me-2 text-info"></i> Condense
                                  </button>
                                  <button ngbDropdownItem (click)="transformDemand('EXPAND')">
                                    <i class="ri-expand-line me-2 text-success"></i> Expand Details
                                  </button>
                                  <div class="dropdown-divider"></div>
                                  <button ngbDropdownItem (click)="transformDemand('MAKE_FORMAL')">
                                    <i class="ri-briefcase-line me-2 text-secondary"></i> Make More Formal
                                  </button>
                                  <button ngbDropdownItem (click)="transformDemand('MAKE_PERSUASIVE')">
                                    <i class="ri-award-line me-2 text-warning"></i> Make More Persuasive
                                  </button>
                                </div>
                              </div>
                              <!-- Version History -->
                              <button class="btn btn-sm btn-soft-secondary" (click)="toggleDemandVersionHistory()"
                                      [class.active]="showDemandVersionHistory" title="Version History">
                                <i class="ri-history-line"></i>
                              </button>
                              <!-- Save -->
                              <button class="btn btn-sm btn-success" (click)="saveDemandDocument()"
                                      [disabled]="isSavingDemand || !hasUnsavedDemandChanges">
                                <span *ngIf="!isSavingDemand"><i class="ri-save-line me-1"></i>Save</span>
                                <span *ngIf="isSavingDemand"><span class="spinner-border spinner-border-sm me-1"></span>Saving...</span>
                              </button>
                              <!-- Export Dropdown -->
                              <div ngbDropdown>
                                <button class="btn btn-sm btn-primary" ngbDropdownToggle>
                                  <i class="ri-download-line me-1"></i> Export
                                </button>
                                <div ngbDropdownMenu class="dropdown-menu-end">
                                  <button ngbDropdownItem (click)="exportDemand('pdf')">
                                    <i class="ri-file-pdf-line me-2 text-danger"></i> PDF
                                  </button>
                                  <button ngbDropdownItem (click)="exportDemand('docx')">
                                    <i class="ri-file-word-line me-2 text-primary"></i> Word
                                  </button>
                                </div>
                              </div>
                              <!-- New Letter Button -->
                              <button class="btn btn-sm btn-soft-secondary" (click)="resetDemandEditor()" title="Start New Letter">
                                <i class="ri-refresh-line"></i>
                              </button>
                            </div>
                          </div>
                        </div>

                        <!-- Quill Editor -->
                        <div class="editor-body flex-grow-1">
                          <app-document-editor
                            [(content)]="demandDocumentContent"
                            (contentChange)="onDemandContentChange($event)"
                            [readOnly]="isTransformingDemand"
                            placeholder="Your demand letter content...">
                          </app-document-editor>
                        </div>
                      </div>

                      <!-- Version History Sidebar -->
                      <div class="version-history-sidebar" *ngIf="showDemandVersionHistory" [@fadeSlide]>
                        <div class="sidebar-header">
                          <h6 class="mb-0"><i class="ri-history-line me-2"></i>Version History</h6>
                          <button class="btn btn-sm btn-close" (click)="showDemandVersionHistory = false"></button>
                        </div>
                        <div class="sidebar-body">
                          <div class="version-list" *ngIf="demandVersions.length > 0">
                            <div class="version-item" *ngFor="let version of demandVersions"
                                 (click)="restoreDemandVersion(version)">
                              <div class="version-number">v{{ version.versionNumber }}</div>
                              <div class="version-info">
                                <div class="version-type">{{ version.transformationType | titlecase }}</div>
                                <div class="version-meta">
                                  <span>{{ version.wordCount }} words</span>
                                  <span class="mx-1">•</span>
                                  <span>{{ version.createdAt | date:'short' }}</span>
                                </div>
                              </div>
                              <div class="version-action">
                                <i class="ri-arrow-go-back-line"></i>
                              </div>
                            </div>
                          </div>
                          <div class="version-empty" *ngIf="demandVersions.length === 0">
                            <i class="ri-file-history-line fs-2 text-muted mb-2"></i>
                            <p class="text-muted mb-0">No version history yet</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  </div><!-- End Demand Letter Sub-tab -->

                  <!-- Document Checklist Sub-tab Content -->
                  <div *ngIf="documentsSubTab === 'checklist'">
                    <div class="professional-tool-content document-checklist-content">
                      <!-- Header -->
                      <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                          <h5 class="mb-1">Document Checklist</h5>
                          <p class="text-muted mb-0">Track required documents and send requests via Email/SMS</p>
                        </div>
                        <div class="d-flex gap-2" *ngIf="linkedCase && documentChecklist.length > 0">
                          <button class="btn btn-sm"
                                  [class.btn-primary]="bulkSelectMode"
                                  [class.btn-soft-secondary]="!bulkSelectMode"
                                  (click)="toggleBulkSelectMode()">
                            <i class="ri-checkbox-multiple-line me-1"></i>
                            {{ bulkSelectMode ? 'Cancel' : 'Bulk Select' }}
                          </button>
                          <button class="btn btn-success btn-sm"
                                  *ngIf="bulkSelectMode && selectedForBulk.size > 0"
                                  (click)="sendBulkRequests()">
                            <i class="ri-send-plane-line me-1"></i>
                            Request Selected ({{ selectedForBulk.size }})
                          </button>
                          <button class="btn btn-soft-warning btn-sm" (click)="resetDocumentChecklist()">
                            <i class="ri-refresh-line me-1"></i> Reset
                          </button>
                        </div>
                      </div>

                      <!-- No Case Linked Warning -->
                      <div class="alert alert-warning d-flex align-items-center" *ngIf="!linkedCase">
                        <i class="ri-information-line fs-4 me-3"></i>
                        <div>
                          <strong>Link a Case</strong>
                          <p class="mb-0">Use the case selector above to link a PI case and track required documents.</p>
                        </div>
                      </div>

                      <!-- Loading State -->
                      <div class="text-center py-5" *ngIf="linkedCase && isLoadingChecklist">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-muted mt-2 mb-0">Loading checklist...</p>
                      </div>

                      <!-- Document Checklist Content -->
                      <div class="row" *ngIf="linkedCase && !isLoadingChecklist">
                        <!-- Left Sidebar: Stats -->
                        <div class="col-lg-3">
                          <!-- Completeness Ring -->
                          <div class="completeness-card mb-3" *ngIf="documentCompleteness">
                            <div class="completeness-ring-wrapper">
                              <svg class="completeness-ring" viewBox="0 0 100 100">
                                <circle class="ring-bg" cx="50" cy="50" r="42" />
                                <circle class="ring-fill"
                                        [class.ring-success]="getCompletenessPercent() >= 80"
                                        [class.ring-warning]="getCompletenessPercent() >= 50 && getCompletenessPercent() < 80"
                                        [class.ring-danger]="getCompletenessPercent() < 50"
                                        cx="50" cy="50" r="42"
                                        [style.stroke-dasharray]="(getCompletenessPercent() * 2.64) + ', 264'" />
                              </svg>
                              <div class="completeness-value">
                                <span class="percent">{{ getCompletenessPercent() }}</span>
                                <span class="symbol">%</span>
                              </div>
                            </div>
                            <div class="completeness-label">Document Completeness</div>
                            <div class="completeness-detail">
                              {{ documentCompleteness.receivedCount }} of {{ documentCompleteness.totalCount || documentChecklist.length }} received
                            </div>
                          </div>

                          <!-- Quick Stats -->
                          <div class="checklist-stats">
                            <div class="stat-item stat-received">
                              <i class="ri-checkbox-circle-fill"></i>
                              <div class="stat-info">
                                <span class="stat-value">{{ getDocumentCountByStatus('RECEIVED') }}</span>
                                <span class="stat-label">Received</span>
                              </div>
                            </div>
                            <div class="stat-item stat-missing">
                              <i class="ri-close-circle-fill"></i>
                              <div class="stat-info">
                                <span class="stat-value">{{ getMissingDocuments().length }}</span>
                                <span class="stat-label">Missing</span>
                              </div>
                            </div>
                            <div class="stat-item stat-requested">
                              <i class="ri-time-fill"></i>
                              <div class="stat-info">
                                <span class="stat-value">{{ getDocumentCountByStatus('REQUESTED') }}</span>
                                <span class="stat-label">Requested</span>
                              </div>
                            </div>
                          </div>

                          <!-- Missing Documents Alert -->
                          <div class="missing-docs-card" *ngIf="getMissingDocuments().length > 0">
                            <div class="missing-header">
                              <i class="ri-alert-fill"></i>
                              <span>Missing ({{ getMissingDocuments().length }})</span>
                            </div>
                            <div class="missing-list">
                              <div class="missing-item" *ngFor="let doc of getMissingDocuments()">
                                <i [class]="getDocumentTypeIcon(doc.documentType)"></i>
                                <span>{{ doc.documentSubtype || getDocumentTypeLabel(doc.documentType) }}</span>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Right: Document Groups -->
                        <div class="col-lg-9">
                          <div class="document-groups-container" *ngIf="documentChecklist.length > 0">
                            <!-- Document Group -->
                            <div class="document-group" *ngFor="let group of groupedDocuments; trackBy: trackByGroupType"
                                 [class]="getGroupStatusClass(group)">
                              <!-- Group Header -->
                              <div class="group-header">
                                <div class="group-title">
                                  <i [class]="group.icon"></i>
                                  <span>{{ group.label }}</span>
                                </div>
                                <div class="group-stats">
                                  <span class="group-count" [class.all-received]="group.receivedCount === group.totalCount">
                                    {{ group.receivedCount }}/{{ group.totalCount }}
                                  </span>
                                  <i class="ri-checkbox-circle-fill text-success" *ngIf="group.receivedCount === group.totalCount"></i>
                                </div>
                              </div>

                              <!-- Group Items -->
                              <div class="group-items">
                                <div class="document-item" *ngFor="let item of group.items; trackBy: trackByDocId"
                                     [class.item-received]="item.status === 'RECEIVED'"
                                     [class.item-missing]="item.status === 'MISSING'"
                                     [class.item-requested]="item.status === 'REQUESTED'"
                                     [class.item-selected]="bulkSelectMode && isSelectedForBulk(item.id!)">
                                  <!-- Bulk Selection Checkbox -->
                                  <div class="item-checkbox" *ngIf="bulkSelectMode && item.status !== 'RECEIVED'">
                                    <input type="checkbox" class="form-check-input"
                                           [checked]="isSelectedForBulk(item.id!)"
                                           (click)="toggleBulkSelection(item, $event)">
                                  </div>
                                  <!-- Item Info -->
                                  <div class="item-info">
                                    <span class="item-name">{{ item.documentSubtype || 'General' }}</span>
                                    <span class="item-meta" *ngIf="item.requestCount && item.requestCount > 0">
                                      <i class="ri-mail-send-line"></i> {{ item.requestCount }}x requested
                                    </span>
                                  </div>
                                  <!-- Status -->
                                  <div class="item-status">
                                    <span class="status-badge"
                                          [class.status-received]="item.status === 'RECEIVED'"
                                          [class.status-missing]="item.status === 'MISSING'"
                                          [class.status-requested]="item.status === 'REQUESTED'"
                                          [class.status-pending]="item.status === 'PENDING'"
                                          [class.status-na]="item.status === 'NOT_APPLICABLE'">
                                      {{ getStatusLabel(item.status) }}
                                    </span>
                                  </div>
                                  <!-- Actions -->
                                  <div class="item-actions">
                                    <button class="action-btn action-receive"
                                            *ngIf="item.status !== 'RECEIVED'"
                                            (click)="markDocumentReceived(item)"
                                            title="Mark as Received">
                                      <i class="ri-checkbox-circle-line"></i>
                                    </button>
                                    <button class="action-btn action-request"
                                            *ngIf="item.status !== 'RECEIVED'"
                                            (click)="requestDocument(item)"
                                            title="Send Request">
                                      <i class="ri-send-plane-line"></i>
                                    </button>
                                    <!-- Status Change Dropdown -->
                                    <div class="action-dropdown" ngbDropdown container="body" placement="bottom-right">
                                      <button class="action-btn action-status" ngbDropdownToggle title="Change Status">
                                        <i class="ri-exchange-line"></i>
                                      </button>
                                      <div ngbDropdownMenu class="status-dropdown-menu">
                                        <div class="dropdown-header">Change Status</div>
                                        <button ngbDropdownItem *ngFor="let status of documentStatuses"
                                                [class.active]="item.status === status.value"
                                                (click)="changeDocumentStatus(item, status.value)">
                                          <span class="status-dot" [class]="'dot-' + status.color"></span>
                                          {{ status.label }}
                                        </button>
                                      </div>
                                    </div>
                                    <button class="action-btn action-delete"
                                            (click)="deleteDocumentChecklistItem(item)"
                                            title="Remove">
                                      <i class="ri-delete-bin-line"></i>
                                    </button>
                                    <div class="received-check" *ngIf="item.status === 'RECEIVED'">
                                      <i class="ri-check-double-line"></i>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Empty State -->
                          <div class="empty-checklist" *ngIf="documentChecklist.length === 0 && !isLoadingChecklist">
                            <div class="empty-icon">
                              <i class="ri-checkbox-multiple-line"></i>
                            </div>
                            <h6>No Document Checklist</h6>
                            <p>Initialize a checklist to track required documents for this case.</p>
                            <button class="btn btn-primary" (click)="initializeDocumentChecklist()">
                              <i class="ri-file-add-line me-1"></i> Initialize Checklist
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div><!-- End Document Checklist Sub-tab -->

                </div><!-- End Documents Tab py-3 -->
              </ng-template>
            </li>

            <!-- Settlement Tab -->
            <li [ngbNavItem]="'settlement'">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-money-dollar-circle-line fs-16"></i>
                <span>Settlement</span>
                <span class="badge bg-warning-subtle text-warning ms-1" *ngIf="settlementHistory.length > 0">{{ settlementHistory.length }}</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Settlement Tracker Tab Content -->
                <div class="py-4">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                    <div>
                      <h5 class="mb-1 fw-semibold">Settlement Tracker</h5>
                      <p class="text-muted mb-0 fs-13">Track negotiations, offers, and counter-offers</p>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-lg-6">
                      <div class="settlement-form-card">
                        <div class="form-header">
                          <h6 class="mb-0"><i class="ri-add-line me-2 text-warning"></i>Log Settlement Event</h6>
                        </div>
                        <div class="form-body">
                          <form [formGroup]="settlementForm">
                            <div class="row g-3">
                              <div class="col-md-6">
                                <label class="form-label">Demand Amount</label>
                                <div class="input-group">
                                  <span class="input-group-text">$</span>
                                  <input type="number" class="form-control" formControlName="demandAmount">
                                </div>
                              </div>
                              <div class="col-md-6">
                                <label class="form-label">Offer Amount</label>
                                <div class="input-group">
                                  <span class="input-group-text">$</span>
                                  <input type="number" class="form-control" formControlName="offerAmount">
                                </div>
                              </div>
                              <div class="col-md-6">
                                <label class="form-label">Offer Date</label>
                                <input type="date" class="form-control" formControlName="offerDate">
                              </div>
                              <div class="col-md-6">
                                <label class="form-label">Counter Offer</label>
                                <div class="input-group">
                                  <span class="input-group-text">$</span>
                                  <input type="number" class="form-control" formControlName="counterAmount">
                                </div>
                              </div>
                              <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" formControlName="notes" rows="2" placeholder="Add notes about this negotiation event..."></textarea>
                              </div>
                            </div>
                            <div class="mt-4 d-flex gap-2">
                              <button type="button" class="btn btn-primary" (click)="addSettlementEvent()" [disabled]="settlementForm.invalid">
                                <i class="ri-add-line me-1"></i> Log Event
                              </button>
                              <button type="button" class="btn btn-success" *ngIf="linkedCase"
                                      (click)="saveSettlementToCase()"
                                      [disabled]="settlementForm.get('demandAmount')?.value <= 0">
                                <i class="ri-save-line me-1"></i> Save to Case
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>

                      <!-- Gap Visualization -->
                      <div class="negotiation-gap-visual mt-3" *ngIf="getLatestDemand() > 0 || getLatestOffer() > 0">
                        <div class="gap-header">
                          <span class="gap-title">Negotiation Gap</span>
                          <span class="gap-amount">{{ formatCurrency(getNegotiationGap()) }}</span>
                        </div>
                        <div class="gap-bars">
                          <div class="bar-wrapper">
                            <div class="bar-label">
                              <span class="label-text">Demand</span>
                              <span class="label-value">{{ formatCurrency(getLatestDemand()) }}</span>
                            </div>
                            <div class="bar-track">
                              <div class="bar-fill demand" [style.width.%]="100"></div>
                            </div>
                          </div>
                          <div class="bar-wrapper">
                            <div class="bar-label">
                              <span class="label-text">Offer</span>
                              <span class="label-value">{{ formatCurrency(getLatestOffer()) }}</span>
                            </div>
                            <div class="bar-track">
                              <div class="bar-fill offer" [style.width.%]="getOfferPercent()"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-lg-6">
                      <div class="settlement-timeline-card">
                        <div class="timeline-header">
                          <div class="d-flex align-items-center gap-2">
                            <div class="timeline-icon">
                              <i class="ri-history-line"></i>
                            </div>
                            <div>
                              <h6 class="mb-0">Negotiation Timeline</h6>
                              <small class="text-muted" *ngIf="settlementHistory.length > 0">{{ settlementHistory.length }} event{{ settlementHistory.length !== 1 ? 's' : '' }} recorded</small>
                            </div>
                          </div>
                          <button class="clear-btn" *ngIf="settlementHistory.length > 0" (click)="confirmClearHistory()">
                            <i class="ri-delete-bin-line"></i> Clear All
                          </button>
                        </div>
                        <div class="timeline-body">
                          <div class="settlement-timeline-v2" *ngIf="settlementHistory.length > 0">
                            <div class="timeline-event-v2" *ngFor="let event of settlementHistory; let i = index; let first = first; let last = last">
                              <div class="event-connector" [class.first]="first" [class.last]="last">
                                <div class="connector-line top" *ngIf="!first"></div>
                                <div class="connector-dot" [class.has-offer]="event.offerAmount" [class.has-counter]="event.counterAmount">
                                  <i class="ri-checkbox-blank-circle-fill" *ngIf="!event.offerAmount && !event.counterAmount"></i>
                                  <i class="ri-arrow-left-right-line" *ngIf="event.offerAmount && !event.counterAmount"></i>
                                  <i class="ri-refresh-line" *ngIf="event.counterAmount"></i>
                                </div>
                                <div class="connector-line bottom" *ngIf="!last"></div>
                              </div>
                              <div class="event-content">
                                <div class="event-card-v2">
                                  <div class="event-card-header">
                                    <div class="event-date-badge">
                                      <i class="ri-calendar-line"></i>
                                      {{ event.date | date:'MMM d, yyyy' }}
                                    </div>
                                    <button class="event-delete-btn" (click)="deleteSettlementEvent(event.id, i)" title="Delete event">
                                      <i class="ri-delete-bin-6-line"></i>
                                    </button>
                                  </div>
                                  <div class="event-amounts-v2">
                                    <div class="amount-pill demand" *ngIf="event.demandAmount">
                                      <div class="pill-icon"><i class="ri-arrow-up-line"></i></div>
                                      <div class="pill-content">
                                        <span class="pill-label">Demand</span>
                                        <span class="pill-value">{{ formatCurrency(event.demandAmount) }}</span>
                                      </div>
                                    </div>
                                    <div class="amount-pill offer" *ngIf="event.offerAmount">
                                      <div class="pill-icon"><i class="ri-arrow-down-line"></i></div>
                                      <div class="pill-content">
                                        <span class="pill-label">Offer</span>
                                        <span class="pill-value">{{ formatCurrency(event.offerAmount) }}</span>
                                      </div>
                                    </div>
                                    <div class="amount-pill counter" *ngIf="event.counterAmount">
                                      <div class="pill-icon"><i class="ri-reply-line"></i></div>
                                      <div class="pill-content">
                                        <span class="pill-label">Counter</span>
                                        <span class="pill-value">{{ formatCurrency(event.counterAmount) }}</span>
                                      </div>
                                    </div>
                                  </div>
                                  <div class="event-notes-v2" *ngIf="event.notes">
                                    <i class="ri-chat-quote-line"></i>
                                    <span>{{ event.notes }}</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="settlement-empty-v2" *ngIf="settlementHistory.length === 0">
                            <div class="empty-illustration">
                              <div class="empty-icon-wrapper">
                                <i class="ri-exchange-dollar-line"></i>
                              </div>
                            </div>
                            <h6 class="fw-semibold mb-2">No Negotiation History</h6>
                            <p class="text-muted mb-0 fs-13">Use the form to log demands, offers, and counter-offers as your settlement negotiations progress.</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>

            <!-- Medical Tab (Records + Summary) -->
            <li ngbNavItem="medical">
              <a ngbNavLink class="d-flex align-items-center gap-2">
                <i class="ri-hospital-line fs-16"></i>
                <span>Medical</span>
                <span class="badge bg-success-subtle text-success ms-1" *ngIf="medicalRecords.length > 0">{{ medicalRecords.length }}</span>
              </a>
              <ng-template ngbNavContent>
                <!-- Medical Tab Content with Sub-tabs -->
                <div class="py-3">
                  <!-- Sub-tab Navigation -->
                  <div class="medical-subtabs mb-4">
                    <button class="subtab-btn" [class.active]="medicalSubTab === 'records'"
                            (click)="medicalSubTab = 'records'">
                      <i class="ri-file-list-3-line me-1"></i> Medical Records
                      <span class="subtab-badge" *ngIf="medicalRecords.length > 0">{{ medicalRecords.length }}</span>
                    </button>
                    <button class="subtab-btn" [class.active]="medicalSubTab === 'summary'"
                            (click)="medicalSubTab = 'summary'">
                      <i class="ri-article-line me-1"></i> Medical Summary
                      <span class="subtab-indicator exists" *ngIf="medicalSummary"></span>
                    </button>
                  </div>

                  <!-- Medical Records Sub-tab -->
                  <div *ngIf="medicalSubTab === 'records'">
                    <div class="medical-records-container">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
                        <div>
                          <h5 class="mb-1 fw-semibold">Medical Records</h5>
                          <p class="text-muted mb-0 fs-13">Track all providers, treatment dates, and billing</p>
                        </div>
                        <div class="d-flex gap-2">
                          <button class="btn btn-primary" (click)="openQuickAddModal()" [disabled]="!linkedCase">
                            <i class="ri-add-line me-1"></i> Quick Add
                          </button>
                          <button class="btn btn-soft-info" (click)="scanCaseDocuments()" [disabled]="!linkedCase || isScanningDocuments">
                            <span *ngIf="!isScanningDocuments">
                              <i class="ri-robot-line me-1"></i> Scan
                            </span>
                            <span *ngIf="isScanningDocuments">
                              <span class="spinner-border spinner-border-sm me-1"></span>
                            </span>
                          </button>
                        </div>
                      </div>

                  <!-- Scan Result Alert -->
                  <div class="alert alert-success d-flex align-items-center mb-3" *ngIf="scanResult && scanResult.recordsCreated > 0">
                    <i class="ri-checkbox-circle-line fs-4 me-3"></i>
                    <div>
                      <strong>Documents Scanned!</strong>
                      <p class="mb-0">Created {{ scanResult.recordsCreated }} medical records from {{ scanResult.documentsScanned }} documents.</p>
                    </div>
                    <button class="btn-close ms-auto" (click)="scanResult = null"></button>
                  </div>

                  <!-- No Case Linked Warning -->
                  <div class="alert alert-warning d-flex align-items-center" *ngIf="!linkedCase">
                    <i class="ri-information-line fs-4 me-3"></i>
                    <div>
                      <strong>Link a Case</strong>
                      <p class="mb-0">Use the case selector above to link a PI case and track medical records.</p>
                    </div>
                  </div>

                  <!-- Medical Records Content -->
                  <div class="row" *ngIf="linkedCase">
                    <div class="col-lg-8">
                      <!-- Providers Grid -->
                      <div class="providers-grid">
                        <div class="provider-card" *ngFor="let record of medicalRecords" (click)="openRecordDetailModal(record)">
                          <button class="provider-delete" (click)="deleteMedicalRecord(record); $event.stopPropagation()">
                            <i class="ri-close-line"></i>
                          </button>
                          <div class="provider-header">
                            <div class="specialty-icon" [ngClass]="getProviderTypeClass(record.providerType)">
                              <i [class]="getProviderTypeIcon(record.providerType)"></i>
                            </div>
                            <div class="provider-info">
                              <div class="provider-name">{{ record.providerName }}</div>
                              <div class="provider-specialty">{{ getProviderTypeLabel(record.providerType) || 'Medical Provider' }}</div>
                            </div>
                          </div>
                          <div class="provider-details">
                            <span class="treatment-dates">
                              <i class="ri-calendar-line me-1"></i>
                              {{ record.treatmentDate | date:'MMM d, yyyy' }}
                              <span *ngIf="record.treatmentEndDate"> - {{ record.treatmentEndDate | date:'MMM d, yyyy' }}</span>
                            </span>
                            <span class="total-bills">{{ formatCurrency(record.billedAmount || 0) }}</span>
                          </div>
                          <div class="provider-card-footer" *ngIf="record.keyFindings || record.recordType">
                            <span class="badge bg-primary-subtle text-primary me-2" *ngIf="record.recordType">{{ getRecordTypeLabel(record.recordType) }}</span>
                            <span class="text-muted small text-truncate" *ngIf="record.keyFindings">{{ record.keyFindings }}</span>
                          </div>
                          <div class="provider-card-actions">
                            <button class="btn btn-sm btn-soft-primary" (click)="editMedicalRecord(record); $event.stopPropagation()" title="Edit">
                              <i class="ri-edit-line"></i>
                            </button>
                          </div>
                        </div>

                        <!-- Empty State -->
                        <div class="providers-empty" *ngIf="medicalRecords.length === 0 && !isLoadingMedicalRecords">
                          <div class="empty-state-illustration">
                            <div class="empty-state-icon-lg">
                              <i class="ri-hospital-line"></i>
                            </div>
                            <div class="empty-state-circles">
                              <span></span><span></span><span></span>
                            </div>
                          </div>
                          <h6 class="fw-semibold mb-2">No Medical Records</h6>
                          <p class="text-muted mb-3">Add medical records to track treatment and expenses.</p>
                          <button class="btn btn-primary" (click)="openQuickAddModal()">
                            <i class="ri-add-line me-1"></i> Add First Record
                          </button>
                        </div>

                        <!-- Loading State -->
                        <div class="providers-empty" *ngIf="isLoadingMedicalRecords">
                          <div class="spinner-border text-primary" role="status"></div>
                          <p class="text-muted mt-2 mb-0">Loading records...</p>
                        </div>
                      </div>
                    </div>

                    <!-- Summary Sidebar -->
                    <div class="col-lg-4">
                      <div class="medical-summary-card">
                        <div class="summary-header">
                          <h6 class="mb-0"><i class="ri-pie-chart-2-line me-2 text-success"></i>Summary</h6>
                        </div>
                        <div class="summary-body">
                          <div class="stat-row">
                            <span class="stat-label">Total Records</span>
                            <span class="stat-value count">{{ medicalRecords.length }}</span>
                          </div>
                          <div class="stat-row">
                            <span class="stat-label">Unique Providers</span>
                            <span class="stat-value count">{{ getUniqueProviderCount() }}</span>
                          </div>
                          <div class="stat-row">
                            <span class="stat-label">Total Billed</span>
                            <span class="stat-value amount">{{ formatCurrency(getTotalMedicalBills()) }}</span>
                          </div>
                          <div class="stat-row">
                            <span class="stat-label">Total Paid</span>
                            <span class="stat-value amount text-success">{{ formatCurrency(getTotalMedicalPaid()) }}</span>
                          </div>
                          <div class="stat-row">
                            <span class="stat-label">Outstanding</span>
                            <span class="stat-value amount text-warning">{{ formatCurrency(getTotalMedicalOutstanding()) }}</span>
                          </div>
                          <div class="stat-row" *ngIf="getMedicalDateRange().start">
                            <span class="stat-label">Treatment Period</span>
                            <span class="stat-value small">{{ getMedicalDateRange().start | date:'MMM yyyy' }} - {{ getMedicalDateRange().end | date:'MMM yyyy' }}</span>
                          </div>
                          <div class="sync-notice">
                            <i class="ri-refresh-line"></i>
                            <span>Medical expenses are automatically synced with the Case Value Calculator and Demand Letter Generator.</span>
                          </div>

                          <!-- Quick Actions -->
                          <div class="mt-3 d-grid gap-2">
                            <button class="btn btn-soft-primary btn-sm" (click)="activeTab = 'medical-summary'">
                              <i class="ri-article-line me-1"></i> Generate Summary
                            </button>
                            <button class="btn btn-soft-success btn-sm" (click)="syncMedicalToCalculator()">
                              <i class="ri-calculator-line me-1"></i> Sync to Calculator
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div><!-- End row -->
                    </div><!-- End medical-records-container -->
                  </div><!-- End Medical Records Sub-tab -->

                  <!-- Medical Summary Sub-tab -->
                  <div *ngIf="medicalSubTab === 'summary'">
                    <div class="medical-summary-container">
                      <!-- No Case Linked Warning -->
                      <div class="alert alert-warning d-flex align-items-center" *ngIf="!linkedCase">
                        <i class="ri-information-line fs-4 me-3"></i>
                        <div>
                          <strong>Link a Case</strong>
                          <p class="mb-0">Use the case selector above to link a PI case and generate a medical summary.</p>
                        </div>
                      </div>

                      <!-- Loading State -->
                      <div class="text-center py-5" *ngIf="linkedCase && isLoadingMedicalSummary">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-muted mt-2 mb-0">Loading summary...</p>
                      </div>

                      <!-- Medical Summary Content -->
                      <div *ngIf="linkedCase && !isLoadingMedicalSummary">
                        <!-- Summary Not Generated Yet -->
                        <div class="empty-summary-state" *ngIf="!medicalSummary && !isGeneratingSummary && medicalRecords.length > 0">
                          <div class="empty-state-icon">
                            <i class="ri-file-chart-line"></i>
                          </div>
                          <h4>No Medical Summary Generated</h4>
                          <p class="text-muted">Generate an AI-powered comprehensive medical summary based on your medical records.</p>
                          <button class="btn btn-primary btn-lg" (click)="generateMedicalSummary()">
                            <i class="ri-magic-line me-2"></i> Generate Medical Summary
                          </button>
                        </div>

                        <!-- No Records State -->
                        <div class="empty-summary-state" *ngIf="medicalRecords.length === 0">
                          <div class="empty-state-icon">
                            <i class="ri-file-list-3-line"></i>
                          </div>
                          <h4>No Medical Records</h4>
                          <p class="text-muted">Add medical records first to generate a summary.</p>
                          <button class="btn btn-primary" (click)="medicalSubTab = 'records'">
                            <i class="ri-add-line me-1"></i> Add Medical Records
                          </button>
                        </div>

                        <!-- Summary Display -->
                        <div *ngIf="medicalSummary">
                          <!-- Hero Stats Row -->
                          <div class="summary-hero-stats mb-4">
                            <div class="hero-stat-card completeness">
                              <div class="stat-icon">
                                <svg viewBox="0 0 36 36" class="circular-chart">
                                  <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                  <path class="circle" [attr.stroke-dasharray]="(medicalSummary.completenessScore || 0) + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                  <text x="18" y="20.35" class="percentage">{{ medicalSummary.completenessScore || 0 }}%</text>
                                </svg>
                              </div>
                              <div class="stat-content">
                                <span class="stat-label">Completeness</span>
                                <span class="stat-status" [class.text-success]="(medicalSummary.completenessScore || 0) >= 80" [class.text-warning]="(medicalSummary.completenessScore || 0) >= 50 && (medicalSummary.completenessScore || 0) < 80" [class.text-danger]="(medicalSummary.completenessScore || 0) < 50">
                                  {{ (medicalSummary.completenessScore || 0) >= 80 ? 'Excellent' : (medicalSummary.completenessScore || 0) >= 50 ? 'Good' : 'Needs Work' }}
                                </span>
                              </div>
                            </div>
                            <div class="hero-stat-card providers">
                              <div class="stat-icon"><i class="ri-hospital-line"></i></div>
                              <div class="stat-content">
                                <span class="stat-value">{{ medicalSummary.totalProviders || medicalRecords.length }}</span>
                                <span class="stat-label">Providers</span>
                              </div>
                            </div>
                            <div class="hero-stat-card visits">
                              <div class="stat-icon"><i class="ri-calendar-check-line"></i></div>
                              <div class="stat-content">
                                <span class="stat-value">{{ medicalSummary.totalVisits || medicalRecords.length }}</span>
                                <span class="stat-label">Visits</span>
                              </div>
                            </div>
                            <div class="hero-stat-card billing">
                              <div class="stat-icon"><i class="ri-money-dollar-circle-line"></i></div>
                              <div class="stat-content">
                                <span class="stat-value text-success">{{ formatCurrency(medicalSummary.totalBilled || getLinkedCaseMedicalTotal()) }}</span>
                                <span class="stat-label">Total Billed</span>
                              </div>
                            </div>
                            <div class="hero-stat-card duration">
                              <div class="stat-icon"><i class="ri-time-line"></i></div>
                              <div class="stat-content">
                                <span class="stat-value">{{ medicalSummary.treatmentDurationDays || 0 }}</span>
                                <span class="stat-label">Days in Treatment</span>
                              </div>
                            </div>
                            <div class="hero-stat-card action">
                              <button class="btn btn-primary" (click)="generateMedicalSummary()" [disabled]="isGeneratingSummary">
                                <span *ngIf="!isGeneratingSummary"><i class="ri-refresh-line me-1"></i> Regenerate</span>
                                <span *ngIf="isGeneratingSummary"><span class="spinner-border spinner-border-sm me-1"></span> Generating...</span>
                              </button>
                              <small class="text-muted d-block mt-1" *ngIf="medicalSummary.generatedAt">
                                Last updated {{ medicalSummary.generatedAt | date:'short' }}
                              </small>
                            </div>
                          </div>

                          <!-- Main Content Grid -->
                          <div class="row g-4">
                            <!-- Left Column - Diagnoses -->
                            <div class="col-lg-4">
                              <!-- Diagnoses Card -->
                              <div class="summary-card diagnoses-card" *ngIf="medicalSummary.diagnosisList && medicalSummary.diagnosisList.length > 0">
                                <div class="card-icon"><i class="ri-stethoscope-line"></i></div>
                                <h6 class="card-title">Diagnoses (ICD-10)</h6>
                                <div class="diagnoses-list">
                                  <div class="diagnosis-chip" *ngFor="let diag of medicalSummary.diagnosisList" [class.primary]="diag.primary">
                                    <span class="icd-code">{{ diag.icd_code }}</span>
                                    <span class="diagnosis-desc">{{ diag.description }}</span>
                                    <span class="primary-badge" *ngIf="diag.primary">Primary</span>
                                  </div>
                                </div>
                              </div>
                              <!-- Simple Diagnoses if no ICD list -->
                              <div class="summary-card diagnoses-card" *ngIf="(!medicalSummary.diagnosisList || medicalSummary.diagnosisList.length === 0) && medicalSummary.diagnoses?.length > 0">
                                <div class="card-icon"><i class="ri-stethoscope-line"></i></div>
                                <h6 class="card-title">Key Diagnoses</h6>
                                <div class="diagnoses-list">
                                  <div class="diagnosis-chip" *ngFor="let diagnosis of medicalSummary.diagnoses">
                                    <span class="diagnosis-desc">{{ diagnosis.name }}</span>
                                    <span class="diagnosis-date" *ngIf="diagnosis.date">{{ diagnosis.date | date:'mediumDate' }}</span>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Right Column - Highlights & Content -->
                            <div class="col-lg-8">
                              <!-- Key Highlights -->
                              <div class="summary-card highlights-card" *ngIf="medicalSummary.keyHighlights">
                                <div class="card-header-row">
                                  <div class="card-icon primary"><i class="ri-lightbulb-flash-line"></i></div>
                                  <h6 class="card-title">Key Highlights</h6>
                                </div>
                                <div class="card-content highlights-content" [innerHTML]="medicalSummary.keyHighlights | aiResponseFormatter"></div>
                              </div>

                              <!-- Overall Summary -->
                              <div class="summary-card highlights-card" *ngIf="medicalSummary.overallSummary && !medicalSummary.keyHighlights">
                                <div class="card-header-row">
                                  <div class="card-icon primary"><i class="ri-information-line"></i></div>
                                  <h6 class="card-title">Summary</h6>
                                </div>
                                <div class="card-content">
                                  <p class="mb-0">{{ medicalSummary.overallSummary }}</p>
                                </div>
                              </div>

                              <!-- Treatment Timeline -->
                              <div class="summary-card prognosis-card" *ngIf="medicalSummary.treatmentTimeline?.length > 0">
                                <div class="card-header-row">
                                  <div class="card-icon info"><i class="ri-time-line"></i></div>
                                  <h6 class="card-title">Treatment Timeline</h6>
                                </div>
                                <div class="card-content">
                                  <div class="timeline-list">
                                    <div class="timeline-item" *ngFor="let event of medicalSummary.treatmentTimeline">
                                      <div class="timeline-date">{{ event.date | date:'mediumDate' }}</div>
                                      <div class="timeline-content">{{ event.description }}</div>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <!-- Prognosis Assessment -->
                              <div class="summary-card prognosis-card" *ngIf="medicalSummary.prognosisAssessment">
                                <div class="card-header-row">
                                  <div class="card-icon info"><i class="ri-heart-pulse-line"></i></div>
                                  <h6 class="card-title">Prognosis Assessment</h6>
                                </div>
                                <div class="card-content prognosis-content" [innerHTML]="medicalSummary.prognosisAssessment | aiResponseFormatter"></div>
                              </div>
                            </div>

                            <!-- Full Width - Red Flags -->
                            <div class="col-12" *ngIf="medicalSummary.redFlags && medicalSummary.redFlags.length > 0">
                              <div class="summary-card red-flags-card full-width">
                                <div class="card-header-row">
                                  <div class="card-icon danger"><i class="ri-alert-line"></i></div>
                                  <h6 class="card-title text-danger">Red Flags ({{ medicalSummary.redFlags.length }})</h6>
                                </div>
                                <div class="card-content">
                                  <div class="red-flag-list">
                                    <div class="red-flag-item" *ngFor="let flag of medicalSummary.redFlags">
                                      <i class="ri-error-warning-line"></i>
                                      <span>{{ flag.description }}</span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Full Width: Treatment Chronology Section -->
                            <div class="col-12" *ngIf="medicalRecords.length > 0">
                              <div class="chronology-section mt-4">
                                <!-- Treatment Gaps & Documentation Status - Above Table -->
                                <div class="info-row" *ngIf="(medicalSummary.treatmentGapDays && medicalSummary.treatmentGapDays > 0) || medicalSummary.completenessNotes">
                                  <!-- Treatment Gaps -->
                                  <div class="info-card gaps-info" *ngIf="medicalSummary.treatmentGapDays && medicalSummary.treatmentGapDays > 0">
                                    <div class="info-icon warning">
                                      <i class="ri-timer-flash-line"></i>
                                    </div>
                                    <div class="info-content">
                                      <span class="info-label">Treatment Gaps Detected</span>
                                      <div class="info-value">
                                        <span class="gap-number">{{ medicalSummary.treatmentGapDays }}</span>
                                        <span class="gap-unit">days</span>
                                      </div>
                                      <span class="info-note">Gaps longer than 30 days may affect case value</span>
                                    </div>
                                  </div>

                                  <!-- Documentation Status -->
                                  <div class="info-card docs-info" *ngIf="medicalSummary.completenessNotes">
                                    <div class="info-icon" [class.success]="(medicalSummary.completenessScore || 0) >= 80" [class.warning]="(medicalSummary.completenessScore || 0) >= 50 && (medicalSummary.completenessScore || 0) < 80" [class.danger]="(medicalSummary.completenessScore || 0) < 50">
                                      <i class="ri-file-list-3-line"></i>
                                    </div>
                                    <div class="info-content">
                                      <span class="info-label">Documentation Status</span>
                                      <p class="info-text">{{ medicalSummary.completenessNotes }}</p>
                                    </div>
                                  </div>
                                </div>

                                <!-- Treatment Chronology Table -->
                                <div class="chronology-card-wrapper">
                                  <div class="chronology-header">
                                    <div class="header-left">
                                      <i class="ri-calendar-check-line"></i>
                                      <span class="header-title">Treatment Chronology</span>
                                    </div>
                                    <div class="header-right">
                                      <span class="stat-pill visits"><i class="ri-hospital-line"></i> {{ medicalSummary.totalVisits || medicalRecords.length }} visits</span>
                                      <span class="stat-pill duration" *ngIf="medicalSummary.treatmentDurationDays"><i class="ri-time-line"></i> {{ medicalSummary.treatmentDurationDays }} days</span>
                                    </div>
                                  </div>
                                  <div class="chronology-table-container">
                                    <table class="treatment-table">
                                      <thead>
                                        <tr>
                                          <th class="col-date">Date</th>
                                          <th class="col-provider">Provider</th>
                                          <th class="col-type">Type</th>
                                          <th class="col-findings">Key Findings</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr *ngFor="let record of medicalRecords" class="treatment-row">
                                          <td class="col-date"
                                              [class.has-citation]="hasCitation(record, 'treatmentDate')"
                                              (click)="openCitation(record, 'treatmentDate')"
                                              [title]="hasCitation(record, 'treatmentDate') ? 'Click to view source' : ''">
                                            <span class="date-value">{{ record.treatmentDate | date:'MMM d, yyyy' }}</span>
                                            <i class="ri-link citation-indicator" *ngIf="hasCitation(record, 'treatmentDate')"></i>
                                          </td>
                                          <td class="col-provider"
                                              [class.has-citation]="hasCitation(record, 'providerName')"
                                              (click)="openCitation(record, 'providerName')"
                                              [title]="hasCitation(record, 'providerName') ? 'Click to view source' : ''">
                                            <span class="provider-name">{{ record.providerName }}</span>
                                            <i class="ri-link citation-indicator" *ngIf="hasCitation(record, 'providerName')"></i>
                                          </td>
                                          <td class="col-type"
                                              [class.has-citation]="hasCitation(record, 'recordType')"
                                              (click)="openCitation(record, 'recordType')"
                                              [title]="hasCitation(record, 'recordType') ? 'Click to view source' : ''">
                                            <span class="type-badge" [attr.data-type]="record.recordType">
                                              {{ record.recordType }}
                                            </span>
                                            <i class="ri-link citation-indicator" *ngIf="hasCitation(record, 'recordType')"></i>
                                          </td>
                                          <td class="col-findings"
                                              [class.has-citation]="hasCitation(record, 'keyFindings')"
                                              (click)="openCitation(record, 'keyFindings')"
                                              [title]="hasCitation(record, 'keyFindings') ? 'Click to view source' : ''">
                                            <span class="findings-text">{{ record.keyFindings || '-' }}</span>
                                            <i class="ri-link citation-indicator" *ngIf="hasCitation(record, 'keyFindings')"></i>
                                          </td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div><!-- End Medical Summary Sub-tab -->

                </div><!-- End Medical Tab py-3 -->
              </ng-template>
            </li>

            <!-- OLD Medical Summary Tab - HIDDEN (content moved to Medical sub-tab) -->
            <li ngbNavItem="medical-summary" [hidden]="true">
              <a ngbNavLink>
                <i class="ri-article-line me-2"></i> Medical Summary
              </a>
              <ng-template ngbNavContent>
                <div class="medical-summary-container">
                  <!-- No Case Linked Warning -->
                  <div class="alert alert-warning d-flex align-items-center" *ngIf="!linkedCase">
                    <i class="ri-information-line fs-4 me-3"></i>
                    <div>
                      <strong>Link a Case</strong>
                      <p class="mb-0">Use the case selector above to link a PI case and generate a medical summary.</p>
                    </div>
                  </div>

                  <!-- Medical Summary Content -->
                  <div *ngIf="linkedCase">
                    <!-- Summary Not Generated Yet -->
                    <div class="empty-summary-state" *ngIf="!medicalSummary && !isGeneratingSummary">
                      <div class="empty-state-icon">
                        <i class="ri-file-chart-line"></i>
                      </div>
                      <h4>No Medical Summary Generated</h4>
                      <p class="text-muted">Generate an AI-powered comprehensive medical summary based on your medical records.</p>
                      <button class="btn btn-primary btn-lg" (click)="generateMedicalSummary()">
                        <i class="ri-magic-line me-2"></i> Generate Medical Summary
                      </button>
                    </div>

                    <!-- Summary Display -->
                    <div *ngIf="medicalSummary">
                      <!-- Hero Stats Row -->
                      <div class="summary-hero-stats mb-4">
                        <div class="hero-stat-card completeness">
                          <div class="stat-icon">
                            <svg viewBox="0 0 36 36" class="circular-chart">
                              <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                              <path class="circle" [attr.stroke-dasharray]="medicalSummary.completenessScore + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                              <text x="18" y="20.35" class="percentage">{{ medicalSummary.completenessScore }}%</text>
                            </svg>
                          </div>
                          <div class="stat-content">
                            <span class="stat-label">Completeness</span>
                            <span class="stat-status" [class.text-success]="medicalSummary.completenessScore >= 80" [class.text-warning]="medicalSummary.completenessScore >= 50 && medicalSummary.completenessScore < 80" [class.text-danger]="medicalSummary.completenessScore < 50">
                              {{ medicalSummary.completenessScore >= 80 ? 'Excellent' : medicalSummary.completenessScore >= 50 ? 'Good' : 'Needs Work' }}
                            </span>
                          </div>
                        </div>
                        <div class="hero-stat-card providers">
                          <div class="stat-icon"><i class="ri-hospital-line"></i></div>
                          <div class="stat-content">
                            <span class="stat-value">{{ medicalSummary.totalProviders }}</span>
                            <span class="stat-label">Providers</span>
                          </div>
                        </div>
                        <div class="hero-stat-card visits">
                          <div class="stat-icon"><i class="ri-calendar-check-line"></i></div>
                          <div class="stat-content">
                            <span class="stat-value">{{ medicalSummary.totalVisits }}</span>
                            <span class="stat-label">Visits</span>
                          </div>
                        </div>
                        <div class="hero-stat-card billing">
                          <div class="stat-icon"><i class="ri-money-dollar-circle-line"></i></div>
                          <div class="stat-content">
                            <span class="stat-value text-success">{{ formatCurrency(medicalSummary.totalBilled || 0) }}</span>
                            <span class="stat-label">Total Billed</span>
                          </div>
                        </div>
                        <div class="hero-stat-card duration">
                          <div class="stat-icon"><i class="ri-time-line"></i></div>
                          <div class="stat-content">
                            <span class="stat-value">{{ medicalSummary.treatmentDurationDays }}</span>
                            <span class="stat-label">Days in Treatment</span>
                          </div>
                        </div>
                        <div class="hero-stat-card action">
                          <button class="btn btn-primary" (click)="generateMedicalSummary()" [disabled]="isGeneratingSummary">
                            <span *ngIf="!isGeneratingSummary"><i class="ri-refresh-line me-1"></i> Regenerate</span>
                            <span *ngIf="isGeneratingSummary"><span class="spinner-border spinner-border-sm me-1"></span> Generating...</span>
                          </button>
                          <small class="text-muted d-block mt-1" *ngIf="medicalSummary.generatedAt">
                            Last updated {{ medicalSummary.generatedAt | date:'short' }}
                          </small>
                        </div>
                      </div>

                      <!-- Main Content Grid -->
                      <div class="row g-4">
                        <!-- Left Column - Diagnoses -->
                        <div class="col-lg-4">
                          <!-- Diagnoses Card -->
                          <div class="summary-card diagnoses-card" *ngIf="medicalSummary.diagnosisList && medicalSummary.diagnosisList.length > 0">
                            <div class="card-icon"><i class="ri-stethoscope-line"></i></div>
                            <h6 class="card-title">Diagnoses (ICD-10)</h6>
                            <div class="diagnoses-list">
                              <div class="diagnosis-chip" *ngFor="let diag of medicalSummary.diagnosisList" [class.primary]="diag.primary">
                                <span class="icd-code">{{ diag.icd_code }}</span>
                                <span class="diagnosis-desc">{{ diag.description }}</span>
                                <span class="primary-badge" *ngIf="diag.primary">Primary</span>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Right Column - Highlights & Prognosis -->
                        <div class="col-lg-8">
                          <!-- Key Highlights -->
                          <div class="summary-card highlights-card" *ngIf="medicalSummary.keyHighlights">
                            <div class="card-header-row">
                              <div class="card-icon primary"><i class="ri-lightbulb-flash-line"></i></div>
                              <h6 class="card-title">Key Highlights</h6>
                            </div>
                            <div class="card-content highlights-content" [innerHTML]="medicalSummary.keyHighlights | aiResponseFormatter"></div>
                          </div>
                          <div class="summary-card highlights-card empty" *ngIf="!medicalSummary.keyHighlights">
                            <div class="card-header-row">
                              <div class="card-icon muted"><i class="ri-lightbulb-flash-line"></i></div>
                              <h6 class="card-title text-muted">Key Highlights</h6>
                            </div>
                            <div class="empty-content">
                              <p class="mb-0 text-muted">Click "Regenerate" to generate key highlights from your medical records.</p>
                            </div>
                          </div>

                          <!-- Prognosis Assessment -->
                          <div class="summary-card prognosis-card" *ngIf="medicalSummary.prognosisAssessment">
                            <div class="card-header-row">
                              <div class="card-icon info"><i class="ri-heart-pulse-line"></i></div>
                              <h6 class="card-title">Prognosis Assessment</h6>
                            </div>
                            <div class="card-content prognosis-content" [innerHTML]="medicalSummary.prognosisAssessment | aiResponseFormatter"></div>
                          </div>
                          <div class="summary-card prognosis-card empty" *ngIf="!medicalSummary.prognosisAssessment">
                            <div class="card-header-row">
                              <div class="card-icon muted"><i class="ri-heart-pulse-line"></i></div>
                              <h6 class="card-title text-muted">Prognosis Assessment</h6>
                            </div>
                            <div class="empty-content">
                              <p class="mb-0 text-muted">Click "Regenerate" to generate prognosis assessment from your medical records.</p>
                            </div>
                          </div>
                        </div>

                        <!-- Full Width - Red Flags -->
                        <div class="col-12" *ngIf="medicalSummary.redFlags && medicalSummary.redFlags.length > 0">
                          <div class="summary-card red-flags-card full-width">
                            <div class="card-header-row">
                              <div class="card-icon danger"><i class="ri-alert-line"></i></div>
                              <h6 class="card-title text-danger">Red Flags ({{ medicalSummary.redFlags.length }})</h6>
                            </div>
                            <div class="red-flags-grid">
                              <div class="red-flag-chip" *ngFor="let flag of medicalSummary.redFlags" [class.high]="flag.severity === 'HIGH'" [class.medium]="flag.severity === 'MEDIUM'" [class.low]="flag.severity === 'LOW'">
                                <span class="severity-indicator"></span>
                                <span class="flag-text">{{ flag.description }}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Full Width: Treatment Chronology Section -->
                      <div class="chronology-section mt-4">
                        <!-- Treatment Gaps & Documentation Status - Above Table -->
                        <div class="info-row" *ngIf="(medicalSummary.treatmentGapDays && medicalSummary.treatmentGapDays > 0) || medicalSummary.completenessNotes">
                          <!-- Treatment Gaps -->
                          <div class="info-card gaps-info" *ngIf="medicalSummary.treatmentGapDays && medicalSummary.treatmentGapDays > 0">
                            <div class="info-icon warning">
                              <i class="ri-timer-flash-line"></i>
                            </div>
                            <div class="info-content">
                              <span class="info-label">Treatment Gaps Detected</span>
                              <div class="info-value">
                                <span class="gap-number">{{ medicalSummary.treatmentGapDays }}</span>
                                <span class="gap-unit">days</span>
                              </div>
                              <span class="info-note">Gaps longer than 30 days may affect case value</span>
                            </div>
                          </div>

                          <!-- Documentation Status -->
                          <div class="info-card docs-info" *ngIf="medicalSummary.completenessNotes">
                            <div class="info-icon" [class.success]="medicalSummary.completenessScore >= 80" [class.warning]="medicalSummary.completenessScore >= 50 && medicalSummary.completenessScore < 80" [class.danger]="medicalSummary.completenessScore < 50">
                              <i class="ri-file-list-3-line"></i>
                            </div>
                            <div class="info-content">
                              <span class="info-label">Documentation Status</span>
                              <p class="info-text">{{ medicalSummary.completenessNotes }}</p>
                            </div>
                          </div>
                        </div>

                        <!-- Treatment Chronology Table -->
                        <div class="chronology-card-wrapper" *ngIf="medicalSummary.treatmentChronology">
                          <div class="chronology-header">
                            <div class="header-left">
                              <i class="ri-calendar-check-line"></i>
                              <span class="header-title">Treatment Chronology</span>
                            </div>
                            <div class="header-right">
                              <span class="stat-pill visits"><i class="ri-hospital-line"></i> {{ medicalSummary.totalVisits }} visits</span>
                              <span class="stat-pill duration" *ngIf="medicalSummary.treatmentDurationDays"><i class="ri-time-line"></i> {{ medicalSummary.treatmentDurationDays }} days</span>
                            </div>
                          </div>
                          <div class="chronology-table-container">
                            <table class="treatment-table">
                              <thead>
                                <tr>
                                  <th class="col-date">Date</th>
                                  <th class="col-provider">Provider</th>
                                  <th class="col-type">Type</th>
                                  <th class="col-findings">Key Findings</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr *ngFor="let record of medicalRecords; let i = index" class="treatment-row">
                                  <td class="col-date"
                                      [class.has-citation]="hasCitation(record, 'treatmentDate')"
                                      (click)="openCitation(record, 'treatmentDate')"
                                      [title]="hasCitation(record, 'treatmentDate') ? 'Click to view source' : ''">
                                    <span class="date-value">{{ record.treatmentDate | date:'MMM d, yyyy' }}</span>
                                    <i class="ri-link citation-indicator" *ngIf="hasCitation(record, 'treatmentDate')"></i>
                                  </td>
                                  <td class="col-provider"
                                      [class.has-citation]="hasCitation(record, 'providerName')"
                                      (click)="openCitation(record, 'providerName')"
                                      [title]="hasCitation(record, 'providerName') ? 'Click to view source' : ''">
                                    <span class="provider-name">{{ record.providerName }}</span>
                                    <i class="ri-link citation-indicator" *ngIf="hasCitation(record, 'providerName')"></i>
                                  </td>
                                  <td class="col-type"
                                      [class.has-citation]="hasCitation(record, 'recordType')"
                                      (click)="openCitation(record, 'recordType')"
                                      [title]="hasCitation(record, 'recordType') ? 'Click to view source' : ''">
                                    <span class="type-badge" [attr.data-type]="record.recordType">
                                      {{ record.recordType }}
                                    </span>
                                    <i class="ri-link citation-indicator" *ngIf="hasCitation(record, 'recordType')"></i>
                                  </td>
                                  <td class="col-findings"
                                      [class.has-citation]="hasCitation(record, 'keyFindings')"
                                      (click)="openCitation(record, 'keyFindings')"
                                      [title]="hasCitation(record, 'keyFindings') ? 'Click to view source' : ''">
                                    <span class="findings-text">{{ record.keyFindings || '-' }}</span>
                                    <i class="ri-link citation-indicator" *ngIf="hasCitation(record, 'keyFindings')"></i>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>

                        <!-- Empty State -->
                        <div class="chronology-card-wrapper empty" *ngIf="!medicalSummary.treatmentChronology">
                          <div class="empty-state">
                            <i class="ri-calendar-todo-line"></i>
                            <p>Click "Regenerate" to generate treatment chronology</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>

            <!-- OLD Document Checklist Tab - HIDDEN (content moved to Documents sub-tab) -->
            <li ngbNavItem="document-checklist" [hidden]="true">
              <a ngbNavLink>
                <i class="ri-checkbox-multiple-line me-2"></i> Document Checklist
              </a>
              <ng-template ngbNavContent>
                <div class="professional-tool-content document-checklist-content">
                  <!-- Header -->
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                      <h5 class="mb-1">Document Checklist</h5>
                      <p class="text-muted mb-0">Track required documents and send requests via Email/SMS</p>
                    </div>
                    <div class="d-flex gap-2" *ngIf="linkedCase && documentChecklist.length > 0">
                      <button class="btn btn-sm"
                              [class.btn-primary]="bulkSelectMode"
                              [class.btn-soft-secondary]="!bulkSelectMode"
                              (click)="toggleBulkSelectMode()">
                        <i class="ri-checkbox-multiple-line me-1"></i>
                        {{ bulkSelectMode ? 'Cancel' : 'Bulk Select' }}
                      </button>
                      <button class="btn btn-success btn-sm"
                              *ngIf="bulkSelectMode && selectedForBulk.size > 0"
                              (click)="sendBulkRequests()">
                        <i class="ri-send-plane-line me-1"></i>
                        Request Selected ({{ selectedForBulk.size }})
                      </button>
                      <button class="btn btn-soft-warning btn-sm" (click)="resetDocumentChecklist()">
                        <i class="ri-refresh-line me-1"></i> Reset
                      </button>
                    </div>
                  </div>

                  <!-- No Case Linked Warning -->
                  <div class="alert alert-warning d-flex align-items-center" *ngIf="!linkedCase">
                    <i class="ri-information-line fs-4 me-3"></i>
                    <div>
                      <strong>Link a Case</strong>
                      <p class="mb-0">Use the case selector above to link a PI case and track required documents.</p>
                    </div>
                  </div>

                  <!-- Document Checklist Content -->
                  <div class="row" *ngIf="linkedCase">
                    <!-- Left Sidebar: Stats -->
                    <div class="col-lg-3">
                      <!-- Completeness Ring -->
                      <div class="completeness-card mb-3" *ngIf="documentCompleteness">
                        <div class="completeness-ring-wrapper">
                          <svg class="completeness-ring" viewBox="0 0 100 100">
                            <circle class="ring-bg" cx="50" cy="50" r="42" />
                            <circle class="ring-fill"
                                    [class.ring-success]="getCompletenessPercent() >= 80"
                                    [class.ring-warning]="getCompletenessPercent() >= 50 && getCompletenessPercent() < 80"
                                    [class.ring-danger]="getCompletenessPercent() < 50"
                                    cx="50" cy="50" r="42"
                                    [style.stroke-dasharray]="(getCompletenessPercent() * 2.64) + ', 264'" />
                          </svg>
                          <div class="completeness-value">
                            <span class="percent">{{ getCompletenessPercent() }}</span>
                            <span class="symbol">%</span>
                          </div>
                        </div>
                        <div class="completeness-label">Document Completeness</div>
                        <div class="completeness-detail">
                          {{ documentCompleteness.receivedCount }} of {{ documentCompleteness.totalCount || documentChecklist.length }} received
                        </div>
                      </div>

                      <!-- Quick Stats -->
                      <div class="checklist-stats">
                        <div class="stat-item stat-received">
                          <i class="ri-checkbox-circle-fill"></i>
                          <div class="stat-info">
                            <span class="stat-value">{{ getDocumentCountByStatus('RECEIVED') }}</span>
                            <span class="stat-label">Received</span>
                          </div>
                        </div>
                        <div class="stat-item stat-missing">
                          <i class="ri-close-circle-fill"></i>
                          <div class="stat-info">
                            <span class="stat-value">{{ getMissingDocuments().length }}</span>
                            <span class="stat-label">Missing</span>
                          </div>
                        </div>
                        <div class="stat-item stat-requested">
                          <i class="ri-time-fill"></i>
                          <div class="stat-info">
                            <span class="stat-value">{{ getDocumentCountByStatus('REQUESTED') }}</span>
                            <span class="stat-label">Requested</span>
                          </div>
                        </div>
                      </div>

                      <!-- Missing Documents Alert -->
                      <div class="missing-docs-card" *ngIf="getMissingDocuments().length > 0">
                        <div class="missing-header">
                          <i class="ri-alert-fill"></i>
                          <span>Missing ({{ getMissingDocuments().length }})</span>
                        </div>
                        <div class="missing-list">
                          <div class="missing-item" *ngFor="let doc of getMissingDocuments()">
                            <i [class]="getDocumentTypeIcon(doc.documentType)"></i>
                            <span>{{ doc.documentSubtype || getDocumentTypeLabel(doc.documentType) }}</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Right: Document Groups -->
                    <div class="col-lg-9">
                      <div class="document-groups-container" *ngIf="documentChecklist.length > 0">
                        <!-- Document Group -->
                        <div class="document-group" *ngFor="let group of groupedDocuments; trackBy: trackByGroupType"
                             [class]="getGroupStatusClass(group)">
                          <!-- Group Header -->
                          <div class="group-header">
                            <div class="group-title">
                              <i [class]="group.icon"></i>
                              <span>{{ group.label }}</span>
                            </div>
                            <div class="group-stats">
                              <span class="group-count" [class.all-received]="group.receivedCount === group.totalCount">
                                {{ group.receivedCount }}/{{ group.totalCount }}
                              </span>
                              <i class="ri-checkbox-circle-fill text-success" *ngIf="group.receivedCount === group.totalCount"></i>
                            </div>
                          </div>

                          <!-- Group Items -->
                          <div class="group-items">
                            <div class="document-item" *ngFor="let item of group.items; trackBy: trackByDocId"
                                 [class.item-received]="item.status === 'RECEIVED'"
                                 [class.item-missing]="item.status === 'MISSING'"
                                 [class.item-requested]="item.status === 'REQUESTED'"
                                 [class.item-pending]="item.status === 'PENDING'"
                                 [class.item-selected]="bulkSelectMode && isSelectedForBulk(item.id!)">
                              <!-- Bulk Selection Checkbox -->
                              <div class="item-checkbox" *ngIf="bulkSelectMode && item.status !== 'RECEIVED'">
                                <input type="checkbox" class="form-check-input"
                                       [checked]="isSelectedForBulk(item.id!)"
                                       (click)="toggleBulkSelection(item, $event)">
                              </div>
                              <!-- Item Info -->
                              <div class="item-info">
                                <span class="item-name">{{ item.documentSubtype || 'General' }}</span>
                                <span class="item-meta" *ngIf="item.requestCount && item.requestCount > 0">
                                  <i class="ri-mail-send-line"></i> {{ item.requestCount }}x requested
                                </span>
                              </div>
                              <!-- Status -->
                              <div class="item-status">
                                <span class="status-badge"
                                      [class.status-received]="item.status === 'RECEIVED'"
                                      [class.status-missing]="item.status === 'MISSING'"
                                      [class.status-requested]="item.status === 'REQUESTED'"
                                      [class.status-pending]="item.status === 'PENDING'"
                                      [class.status-na]="item.status === 'NOT_APPLICABLE'">
                                  {{ getStatusLabel(item.status) }}
                                </span>
                              </div>
                              <!-- Actions -->
                              <div class="item-actions">
                                <button class="action-btn action-receive"
                                        *ngIf="item.status !== 'RECEIVED'"
                                        (click)="markDocumentReceived(item)"
                                        title="Mark as Received">
                                  <i class="ri-checkbox-circle-line"></i>
                                </button>
                                <button class="action-btn action-request"
                                        *ngIf="item.status !== 'RECEIVED'"
                                        (click)="requestDocument(item)"
                                        title="Send Request">
                                  <i class="ri-send-plane-line"></i>
                                </button>
                                <!-- Status Change Dropdown -->
                                <div class="action-dropdown" ngbDropdown container="body" placement="bottom-right">
                                  <button class="action-btn action-status" ngbDropdownToggle title="Change Status">
                                    <i class="ri-exchange-line"></i>
                                  </button>
                                  <div ngbDropdownMenu class="status-dropdown-menu">
                                    <div class="dropdown-header">Change Status</div>
                                    <button ngbDropdownItem *ngFor="let status of documentStatuses"
                                            [class.active]="item.status === status.value"
                                            (click)="changeDocumentStatus(item, status.value)">
                                      <span class="status-dot" [class]="'dot-' + status.color"></span>
                                      {{ status.label }}
                                    </button>
                                  </div>
                                </div>
                                <button class="action-btn action-delete"
                                        (click)="deleteDocumentChecklistItem(item)"
                                        title="Remove">
                                  <i class="ri-delete-bin-line"></i>
                                </button>
                                <div class="received-check" *ngIf="item.status === 'RECEIVED'">
                                  <i class="ri-check-double-line"></i>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Empty State -->
                      <div class="empty-checklist" *ngIf="documentChecklist.length === 0 && !isLoadingChecklist">
                        <div class="empty-icon">
                          <i class="ri-checkbox-multiple-line"></i>
                        </div>
                        <h6>No Document Checklist</h6>
                        <p>Initialize a checklist to track required documents for this case.</p>
                        <button class="btn btn-primary" (click)="initializeDocumentChecklist()">
                          <i class="ri-file-add-line me-1"></i> Initialize Checklist
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>
          </ul>
        </div>
        <div class="card-body pt-0">
          <div [ngbNavOutlet]="nav"></div>
        </div>
      </div>
    </div>
  </div>
  </div><!-- End Workspace View -->

  <!-- ==================== PROVIDER DIRECTORY VIEW ==================== -->
  <div *ngIf="viewMode === 'directory'">
    <!-- Directory Header -->
    <div class="row">
      <div class="col-12">
        <div class="page-header-wrapper">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div class="d-flex align-items-center gap-3">
              <button class="btn btn-soft-secondary back-btn" (click)="backFromDirectory()">
                <i class="ri-arrow-left-line me-1"></i> Back
              </button>
              <div>
                <div class="text-muted fs-11 fw-semibold letter-spacing text-uppercase mb-1">Personal Injury</div>
                <h4 class="mb-0">Provider Directory</h4>
              </div>
            </div>
            <button class="btn btn-primary" (click)="showAddProviderModal()">
              <i class="ri-add-line me-1"></i> Add Provider
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Provider Directory Content Card -->
    <div class="card border-0 shadow-sm mt-3">
      <div class="card-header bg-transparent py-3">
        <!-- Provider Toolbar - Type Filter & Search -->
        <div class="provider-toolbar">
          <div class="toolbar-left">
            <span class="provider-count">
              <i class="ri-contacts-book-2-line"></i>
              <strong>{{ filteredProviders.length }}</strong>
              <span class="count-label">{{ filteredProviders.length === 1 ? 'Provider' : 'Providers' }}</span>
            </span>
            <div class="type-breakdown" *ngIf="providers.length > 0">
              <button *ngFor="let item of getProviderTypeCounts()"
                      class="type-chip"
                      [class.active]="providerTypeFilter === item.type"
                      [style.--chip-color]="item.color"
                      (click)="providerTypeFilter = providerTypeFilter === item.type ? '' : item.type; filterProviders()">
                <i [class]="item.icon"></i>
                <span class="chip-label">{{ item.label }}</span>
                <span class="chip-count">{{ item.count }}</span>
              </button>
              <button class="type-chip clear" *ngIf="providerTypeFilter"
                      (click)="providerTypeFilter = ''; filterProviders()">
                <i class="ri-close-line"></i>
              </button>
            </div>
          </div>
          <div class="search-filter-group">
            <div class="search-input-enhanced">
              <i class="ri-search-line"></i>
              <input type="text" placeholder="Search providers..."
                     [(ngModel)]="providerSearchTerm"
                     (ngModelChange)="filterProviders()">
              <button class="search-clear" *ngIf="providerSearchTerm" (click)="providerSearchTerm = ''; filterProviders()">
                <i class="ri-close-line"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- Loading -->
        <div *ngIf="isLoadingProviders" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-2">Loading providers...</p>
        </div>

        <!-- Provider Cards Grid -->
        <div class="provider-cards-grid" *ngIf="!isLoadingProviders && filteredProviders.length > 0">
          <div class="provider-card-enhanced" *ngFor="let provider of filteredProviders"
               [attr.data-type]="provider.providerType"
               [class.selected]="selectedProvider?.id === provider.id"
               (click)="selectProvider(provider)">
            <!-- Card Header -->
            <div class="pce-header">
              <div class="pce-icon"
                   [class.icon-hospital]="provider.providerType === 'HOSPITAL'"
                   [class.icon-clinic]="provider.providerType === 'CLINIC'"
                   [class.icon-imaging]="provider.providerType === 'IMAGING'"
                   [class.icon-therapy]="provider.providerType === 'PHYSICAL_THERAPY'"
                   [class.icon-chiro]="provider.providerType === 'CHIROPRACTIC'"
                   [class.icon-pharmacy]="provider.providerType === 'PHARMACY'"
                   [class.icon-lab]="provider.providerType === 'LABORATORY'"
                   [class.icon-urgent]="provider.providerType === 'URGENT_CARE'">
                <i [class]="getProviderIcon(provider.providerType)"></i>
              </div>
            </div>

            <!-- Card Body -->
            <div class="pce-body">
              <h6 class="pce-name">{{ provider.providerName }}</h6>
              <div class="pce-location" *ngIf="provider.city || provider.address">
                <i class="ri-map-pin-2-line"></i>
                <span>{{ provider.city }}{{ provider.state ? ', ' + provider.state : '' }}</span>
              </div>
            </div>

            <!-- Provider Type Badge -->
            <div class="pce-footer">
              <div class="pce-type-badge" [attr.data-type]="provider.providerType">
                <i [class]="getProviderIcon(provider.providerType)"></i>
                {{ providerDirectoryService.getProviderTypeLabel(provider.providerType || 'OTHER') }}
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="pce-actions" (click)="$event.stopPropagation()">
              <button class="pce-action-btn" (click)="selectProvider(provider)" title="View Details">
                <i class="ri-eye-line"></i>
              </button>
              <button class="pce-action-btn" (click)="editProvider(provider)" title="Edit">
                <i class="ri-pencil-line"></i>
              </button>
              <button class="pce-action-btn delete" (click)="deleteProvider(provider)" title="Delete">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Detail Panel (shows when provider selected) -->
        <div class="provider-detail-panel" *ngIf="selectedProvider">
          <div class="pdp-header">
            <div class="pdp-title">
              <i [class]="getProviderIcon(selectedProvider.providerType)"></i>
              <span>{{ selectedProvider.providerName }}</span>
            </div>
            <button class="pdp-close" (click)="selectedProvider = null">
              <i class="ri-close-line"></i>
            </button>
          </div>
          <div class="pdp-body">
            <!-- Location -->
            <div class="pdp-section" *ngIf="selectedProvider.address || selectedProvider.city">
              <div class="pdp-section-title"><i class="ri-map-pin-line"></i> Address</div>
              <div class="pdp-address">
                <span *ngIf="selectedProvider.address">{{ selectedProvider.address }}</span>
                <span>{{ selectedProvider.city }}{{ selectedProvider.state ? ', ' + selectedProvider.state : '' }} {{ selectedProvider.zip }}</span>
              </div>
            </div>

            <!-- Records Department -->
            <div class="pdp-section" *ngIf="selectedProvider.recordsEmail || selectedProvider.recordsPhone || selectedProvider.recordsFax">
              <div class="pdp-section-title"><i class="ri-folder-received-line"></i> Records Department</div>
              <div class="pdp-contact-list">
                <div class="pdp-contact" *ngIf="selectedProvider.recordsContactName">
                  <i class="ri-user-line"></i>
                  <span>{{ selectedProvider.recordsContactName }}</span>
                </div>
                <div class="pdp-contact copyable" *ngIf="selectedProvider.recordsEmail" (click)="copyToClipboard(selectedProvider.recordsEmail, 'Email')">
                  <i class="ri-mail-line"></i>
                  <span>{{ selectedProvider.recordsEmail }}</span>
                  <i class="ri-file-copy-line copy-hint"></i>
                </div>
                <div class="pdp-contact copyable" *ngIf="selectedProvider.recordsPhone" (click)="copyToClipboard(selectedProvider.recordsPhone, 'Phone')">
                  <i class="ri-phone-line"></i>
                  <span>{{ providerDirectoryService.formatPhone(selectedProvider.recordsPhone) }}</span>
                  <i class="ri-file-copy-line copy-hint"></i>
                </div>
                <div class="pdp-contact copyable" *ngIf="selectedProvider.recordsFax" (click)="copyToClipboard(selectedProvider.recordsFax, 'Fax')">
                  <i class="ri-printer-line"></i>
                  <span>{{ providerDirectoryService.formatPhone(selectedProvider.recordsFax) }}</span>
                  <i class="ri-file-copy-line copy-hint"></i>
                </div>
              </div>
            </div>

            <!-- Billing Department -->
            <div class="pdp-section" *ngIf="selectedProvider.billingEmail || selectedProvider.billingPhone">
              <div class="pdp-section-title"><i class="ri-money-dollar-circle-line"></i> Billing Department</div>
              <div class="pdp-contact-list">
                <div class="pdp-contact" *ngIf="selectedProvider.billingContactName">
                  <i class="ri-user-line"></i>
                  <span>{{ selectedProvider.billingContactName }}</span>
                </div>
                <div class="pdp-contact copyable" *ngIf="selectedProvider.billingEmail" (click)="copyToClipboard(selectedProvider.billingEmail, 'Email')">
                  <i class="ri-mail-line"></i>
                  <span>{{ selectedProvider.billingEmail }}</span>
                  <i class="ri-file-copy-line copy-hint"></i>
                </div>
                <div class="pdp-contact copyable" *ngIf="selectedProvider.billingPhone" (click)="copyToClipboard(selectedProvider.billingPhone, 'Phone')">
                  <i class="ri-phone-line"></i>
                  <span>{{ providerDirectoryService.formatPhone(selectedProvider.billingPhone) }}</span>
                  <i class="ri-file-copy-line copy-hint"></i>
                </div>
              </div>
            </div>

            <!-- Fees -->
            <div class="pdp-section" *ngIf="selectedProvider.baseFee || selectedProvider.perPageFee || selectedProvider.rushFee">
              <div class="pdp-section-title"><i class="ri-price-tag-3-line"></i> Fee Schedule</div>
              <div class="pdp-fees">
                <div class="pdp-fee" *ngIf="selectedProvider.baseFee">
                  <span class="fee-label">Base Fee</span>
                  <span class="fee-amount">${{ selectedProvider.baseFee | number:'1.2-2' }}</span>
                </div>
                <div class="pdp-fee" *ngIf="selectedProvider.perPageFee">
                  <span class="fee-label">Per Page</span>
                  <span class="fee-amount">${{ selectedProvider.perPageFee | number:'1.2-2' }}</span>
                </div>
                <div class="pdp-fee rush" *ngIf="selectedProvider.rushFee">
                  <span class="fee-label">Rush Fee</span>
                  <span class="fee-amount">${{ selectedProvider.rushFee | number:'1.2-2' }}</span>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div class="pdp-section" *ngIf="selectedProvider.notes">
              <div class="pdp-section-title"><i class="ri-sticky-note-line"></i> Notes</div>
              <div class="pdp-notes">{{ selectedProvider.notes }}</div>
            </div>
          </div>
          <div class="pdp-footer">
            <button class="btn btn-soft-primary" (click)="editProvider(selectedProvider)">
              <i class="ri-pencil-line me-1"></i> Edit Provider
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoadingProviders && filteredProviders.length === 0" class="providers-empty">
          <div class="empty-state-illustration">
            <div class="empty-state-icon-lg">
              <i class="ri-contacts-book-line"></i>
            </div>
            <div class="empty-state-circles">
              <span></span><span></span><span></span>
            </div>
          </div>
          <h6 class="fw-semibold mb-2" *ngIf="!providerSearchTerm && !providerTypeFilter">No Providers Added</h6>
          <h6 class="fw-semibold mb-2" *ngIf="providerSearchTerm || providerTypeFilter">No Matches Found</h6>
          <p class="text-muted mb-3" *ngIf="!providerSearchTerm && !providerTypeFilter">
            Add medical providers to quickly access their contact info when requesting records.
          </p>
          <p class="text-muted mb-3" *ngIf="providerSearchTerm || providerTypeFilter">
            Try adjusting your search or filter criteria.
          </p>
          <button *ngIf="!providerSearchTerm && !providerTypeFilter" class="btn btn-primary" (click)="showAddProviderModal()">
            <i class="ri-add-line me-1"></i> Add Provider
          </button>
          <button *ngIf="providerSearchTerm || providerTypeFilter" class="btn btn-outline-secondary"
                  (click)="providerSearchTerm = ''; providerTypeFilter = ''; filterProviders()">
            <i class="ri-refresh-line me-1"></i> Clear Filters
          </button>
        </div>
      </div>
    </div>
  </div><!-- End Provider Directory View -->

</div><!-- End container-fluid -->

<!-- Floating Action Button (only in workspace view) -->
<div class="fab-container" [class.fab-expanded]="fabExpanded" *ngIf="viewMode === 'workspace'">
  <button class="fab-main btn btn-primary" (click)="fabExpanded = !fabExpanded" title="Quick Actions">
    <i class="ri-add-line" [class.rotate-45]="fabExpanded"></i>
  </button>
  <div class="fab-actions" *ngIf="fabExpanded">
    <button class="fab-action btn btn-primary" (click)="activeTab = 'valuation'; fabExpanded = false" title="Calculate Case Value">
      <i class="ri-calculator-line"></i>
      <span>Valuation</span>
    </button>
    <button class="fab-action btn btn-info" (click)="activeTab = 'documents'; documentsSubTab = 'demand-letter'; fabExpanded = false" title="Demand Letter">
      <i class="ri-file-text-line"></i>
      <span>Demand Letter</span>
    </button>
    <button class="fab-action btn btn-success" (click)="activeTab = 'medical'; medicalSubTab = 'records'; fabExpanded = false" title="Medical Records">
      <i class="ri-hospital-line"></i>
      <span>Medical</span>
    </button>
    <button class="fab-action btn btn-warning" (click)="activeTab = 'settlement'; fabExpanded = false" title="Settlement Tracker">
      <i class="ri-money-dollar-circle-line"></i>
      <span>Settlement</span>
    </button>
  </div>
  <div class="fab-backdrop" *ngIf="fabExpanded" (click)="fabExpanded = false"></div>
</div>

<!-- Provider Directory Modal -->
<div class="modal fade show" id="providerModal" tabindex="-1" *ngIf="showProviderModal" style="display: block;">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ri-building-line me-2 text-primary"></i>
          {{ editingProvider?.id ? 'Edit Provider' : 'Add Provider' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeProviderModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <!-- Basic Info -->
          <div class="col-12">
            <h6 class="text-primary mb-3"><i class="ri-information-line me-1"></i> Basic Information</h6>
          </div>
          <div class="col-md-8">
            <label class="form-label">Provider Name *</label>
            <input type="text" class="form-control" [(ngModel)]="editingProvider!.providerName"
                   placeholder="e.g., Massachusetts General Hospital">
          </div>
          <div class="col-md-4">
            <label class="form-label">Provider Type</label>
            <select class="form-select" [(ngModel)]="editingProvider!.providerType">
              <option value="">Select type...</option>
              <option *ngFor="let type of providerDirectoryService.getProviderTypes()" [value]="type.value">
                {{ type.label }}
              </option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Main Phone</label>
            <input type="tel" class="form-control" [(ngModel)]="editingProvider!.mainPhone"
                   placeholder="(555) 123-4567">
          </div>
          <div class="col-md-6">
            <label class="form-label">Main Email</label>
            <input type="email" class="form-control" [(ngModel)]="editingProvider!.mainEmail"
                   placeholder="info@provider.com">
          </div>
          <div class="col-12">
            <label class="form-label">Address</label>
            <input type="text" class="form-control" [(ngModel)]="editingProvider!.address"
                   placeholder="Street address">
          </div>
          <div class="col-md-5">
            <label class="form-label">City</label>
            <input type="text" class="form-control" [(ngModel)]="editingProvider!.city">
          </div>
          <div class="col-md-4">
            <label class="form-label">State</label>
            <input type="text" class="form-control" [(ngModel)]="editingProvider!.state">
          </div>
          <div class="col-md-3">
            <label class="form-label">ZIP</label>
            <input type="text" class="form-control" [(ngModel)]="editingProvider!.zip">
          </div>

          <!-- Records Contact -->
          <div class="col-12 mt-4">
            <h6 class="text-success mb-3"><i class="ri-file-text-line me-1"></i> Records Department</h6>
          </div>
          <div class="col-md-4">
            <label class="form-label">Contact Name</label>
            <input type="text" class="form-control" [(ngModel)]="editingProvider!.recordsContactName">
          </div>
          <div class="col-md-4">
            <label class="form-label">Records Email</label>
            <input type="email" class="form-control" [(ngModel)]="editingProvider!.recordsEmail"
                   placeholder="records@provider.com">
          </div>
          <div class="col-md-4">
            <label class="form-label">Records Phone</label>
            <input type="tel" class="form-control" [(ngModel)]="editingProvider!.recordsPhone">
          </div>
          <div class="col-md-4">
            <label class="form-label">Records Fax</label>
            <input type="tel" class="form-control" [(ngModel)]="editingProvider!.recordsFax">
          </div>

          <!-- Billing Contact -->
          <div class="col-12 mt-4">
            <h6 class="text-info mb-3"><i class="ri-money-dollar-circle-line me-1"></i> Billing Department</h6>
          </div>
          <div class="col-md-4">
            <label class="form-label">Contact Name</label>
            <input type="text" class="form-control" [(ngModel)]="editingProvider!.billingContactName">
          </div>
          <div class="col-md-4">
            <label class="form-label">Billing Email</label>
            <input type="email" class="form-control" [(ngModel)]="editingProvider!.billingEmail"
                   placeholder="billing@provider.com">
          </div>
          <div class="col-md-4">
            <label class="form-label">Billing Phone</label>
            <input type="tel" class="form-control" [(ngModel)]="editingProvider!.billingPhone">
          </div>

          <!-- Fees -->
          <div class="col-12 mt-4">
            <h6 class="text-warning mb-3"><i class="ri-price-tag-line me-1"></i> Fee Information</h6>
          </div>
          <div class="col-md-4">
            <label class="form-label">Base Fee ($)</label>
            <input type="number" class="form-control" [(ngModel)]="editingProvider!.baseFee"
                   placeholder="25.00" step="0.01">
          </div>
          <div class="col-md-4">
            <label class="form-label">Per Page Fee ($)</label>
            <input type="number" class="form-control" [(ngModel)]="editingProvider!.perPageFee"
                   placeholder="0.50" step="0.01">
          </div>
          <div class="col-md-4">
            <label class="form-label">Rush Fee ($)</label>
            <input type="number" class="form-control" [(ngModel)]="editingProvider!.rushFee"
                   placeholder="50.00" step="0.01">
          </div>

          <!-- Notes -->
          <div class="col-12 mt-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" rows="2" [(ngModel)]="editingProvider!.notes"
                      placeholder="Any special instructions or notes about this provider..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="closeProviderModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="saveProvider()"
                [disabled]="!editingProvider?.providerName || isSavingProvider">
          <span *ngIf="!isSavingProvider">
            <i class="ri-save-line me-1"></i> {{ editingProvider?.id ? 'Update' : 'Save' }} Provider
          </span>
          <span *ngIf="isSavingProvider">
            <span class="spinner-border spinner-border-sm me-1"></span> Saving...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showProviderModal" (click)="closeProviderModal()"></div>

<!-- Bulk Request Wizard Modal -->
<div class="bulk-wizard-modal" *ngIf="showBulkWizard">
  <div class="bulk-wizard-backdrop" (click)="onBulkWizardCancelled()"></div>
  <div class="bulk-wizard-container">
    <div class="bulk-wizard-header">
      <h5 class="mb-0">
        <i class="ri-mail-send-line me-2"></i>Send Bulk Requests
      </h5>
      <button class="btn-close" (click)="onBulkWizardCancelled()"></button>
    </div>
    <app-bulk-request-wizard
      [caseId]="linkedCase?.id!"
      [selectedItemIds]="bulkWizardItemIds"
      (completed)="onBulkWizardCompleted($event)"
      (cancelled)="onBulkWizardCancelled()">
    </app-bulk-request-wizard>
  </div>
</div>
