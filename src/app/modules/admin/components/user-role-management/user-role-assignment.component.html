<!-- Page Header -->
<div class="page-title-box d-sm-flex align-items-center justify-content-between mb-4">
  <h4 class="mb-sm-0 fw-bold text-primary">
    <i class="ri-user-settings-line me-2"></i>User Role Assignment
  </h4>
  <div class="page-title-right">
    <ol class="breadcrumb m-0">
      <li class="breadcrumb-item"><a href="javascript: void(0);" class="text-muted">Admin</a></li>
      <li class="breadcrumb-item active text-primary">User Role Assignment</li>
    </ol>
  </div>
</div>

<!-- Main Content -->
<div class="row">
  <!-- User Selection -->
  <div class="col-xl-4 col-lg-5">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-light border-bottom">
        <h6 class="card-title fw-semibold mb-0">
          <i class="ri-team-line me-2 text-primary"></i>Select User
        </h6>
      </div>
      <div class="card-body p-0">
        <!-- Search -->
        <div class="p-3 border-bottom">
          <div class="search-box">
            <input type="text" class="form-control" placeholder="Search users..." 
                   [(ngModel)]="searchTerm" (ngModelChange)="filterUsers()">
            <i class="ri-search-line search-icon"></i>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoadingUsers" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading users...</span>
          </div>
        </div>

        <!-- Users List -->
        <div class="user-list" style="max-height: 400px; overflow-y: auto;">
          <div class="user-item p-3 border-bottom cursor-pointer" 
               *ngFor="let user of filteredUsers" 
               (click)="selectUser(user)"
               [class.bg-soft-primary]="selectedUser?.id === user.id">
            <div class="d-flex align-items-center">
              <div class="avatar-sm flex-shrink-0 me-3">
                <div class="avatar-title rounded-circle bg-soft-info text-info">
                  {{ user.firstName?.charAt(0) || 'U' }}{{ user.lastName?.charAt(0) || '' }}
                </div>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-medium">{{ getUserDisplayName(user) }}</h6>
                <p class="text-muted mb-1 fs-12">{{ user.email }}</p>
                <div class="d-flex gap-1 mt-1" *ngIf="user.roles && user.roles.length > 0">
                  <span class="badge bg-soft-info text-info fs-11" *ngFor="let role of user.roles.slice(0, 2)">
                    {{ getRoleDisplayName(role) }}
                  </span>
                  <span class="badge bg-soft-secondary text-secondary fs-11" *ngIf="user.roles.length > 2">
                    +{{ user.roles.length - 2 }} more
                  </span>
                </div>
              </div>
              <div class="flex-shrink-0" *ngIf="selectedUser?.id === user.id">
                <i class="ri-check-line text-success fs-16"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- No Users State -->
        <div *ngIf="!isLoadingUsers && users.length === 0" class="text-center py-4">
          <div class="avatar-md mx-auto mb-3">
            <div class="avatar-title bg-soft-warning text-warning rounded-circle">
              <i class="ri-user-line fs-20"></i>
            </div>
          </div>
          <h6 class="mb-1">No Users Found</h6>
          <p class="text-muted mb-0">No users available for role assignment.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Role Management -->
  <div class="col-xl-8 col-lg-7">
    <!-- User Info Card -->
    <div class="card border-0 shadow-sm mb-4" *ngIf="selectedUser">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="avatar-lg flex-shrink-0 me-3">
            <div class="avatar-title rounded-circle bg-soft-primary text-primary fs-24">
              {{ selectedUser.firstName?.charAt(0) || 'U' }}{{ selectedUser.lastName?.charAt(0) || '' }}
            </div>
          </div>
          <div class="flex-grow-1">
            <h5 class="mb-1 fw-semibold">{{ getUserDisplayName(selectedUser) }}</h5>
            <p class="text-muted mb-2">{{ selectedUser.email }}</p>
            <div class="d-flex gap-2">
              <span class="badge bg-soft-info text-info">
                <i class="ri-shield-user-line me-1"></i>{{ userRoles.length }} Roles
              </span>
              <span class="badge bg-soft-success text-success">
                <i class="ri-briefcase-line me-1"></i>{{ caseRoles.length }} Case Roles
              </span>
              <span class="badge" [ngClass]="selectedUser.enabled ? 'bg-soft-success text-success' : 'bg-soft-danger text-danger'">
                <i class="me-1" [ngClass]="selectedUser.enabled ? 'ri-check-line' : 'ri-close-line'"></i>
                {{ selectedUser.enabled ? 'Active' : 'Inactive' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No User Selected State -->
    <div class="card border-0 shadow-sm" *ngIf="!selectedUser">
      <div class="card-body text-center py-5">
        <div class="avatar-xl mx-auto mb-4">
          <div class="avatar-title bg-soft-primary text-primary rounded-circle">
            <i class="ri-user-settings-line display-4"></i>
          </div>
        </div>
        <h5 class="mb-2 fw-semibold">Select a User</h5>
        <p class="text-muted mb-0">Choose a user from the list to manage their roles and permissions.</p>
      </div>
    </div>

    <!-- Role Management Tabs -->
    <div class="card border-0 shadow-sm" *ngIf="selectedUser">
      <div class="card-header bg-light border-bottom">
        <ul class="nav nav-tabs-custom card-header-tabs border-bottom-0" role="tablist">
          <li class="nav-item">
            <a class="nav-link active fw-semibold" data-bs-toggle="tab" href="#generalRoles" role="tab">
              <i class="ri-shield-user-line me-2"></i>General Roles
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link fw-semibold" data-bs-toggle="tab" href="#caseRoles" role="tab">
              <i class="ri-briefcase-line me-2"></i>Case-Specific Roles
            </a>
          </li>
        </ul>
      </div>

      <div class="card-body">
        <div class="tab-content">
          <!-- General Roles Tab -->
          <div class="tab-pane active" id="generalRoles" role="tabpanel">
            <div class="row">
              <!-- Assign Role Form -->
              <div class="col-lg-5">
                <div class="card border border-dashed border-primary bg-soft-primary">
                  <div class="card-body">
                    <h6 class="card-title fw-semibold text-primary mb-3">
                      <i class="ri-add-circle-line me-2"></i>Assign New Role
                    </h6>
                    <form [formGroup]="roleForm" (ngSubmit)="assignRole()">
                      <div class="mb-3">
                        <label class="form-label fw-medium">Select Role</label>
                        <select class="form-select" formControlName="roleId" [disabled]="isLoadingRoles">
                          <option value="">Choose a role...</option>
                          <option *ngFor="let role of availableRoles" [value]="role.id">
                            {{ getRoleDisplayName(role) }} (Level {{ role.hierarchyLevel }})
                          </option>
                        </select>
                        <div class="invalid-feedback" *ngIf="roleForm.get('roleId')?.invalid && roleForm.get('roleId')?.touched">
                          Please select a role
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label fw-medium">Expiration Date (Optional)</label>
                        <input type="datetime-local" class="form-control" formControlName="expiresAt">
                        <small class="form-text text-muted">Leave empty for permanent assignment</small>
                      </div>
                      <div class="mb-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" formControlName="isPrimary">
                          <label class="form-check-label fw-medium">Set as Primary Role</label>
                        </div>
                        <small class="form-text text-muted">Primary role determines default permissions</small>
                      </div>
                      <button type="submit" class="btn btn-primary w-100 waves-effect waves-light" 
                              [disabled]="roleForm.invalid || isAssigningRole">
                        <span *ngIf="isAssigningRole" class="spinner-border spinner-border-sm me-2"></span>
                        <i class="ri-add-line me-1" *ngIf="!isAssigningRole"></i>
                        {{ isAssigningRole ? 'Assigning...' : 'Assign Role' }}
                      </button>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Current Roles -->
              <div class="col-lg-7">
                <h6 class="fw-semibold mb-3">
                  <i class="ri-shield-check-line me-2 text-success"></i>Current Roles
                  <span class="badge bg-soft-info text-info ms-2">{{ userRoles.length }}</span>
                </h6>

                <!-- Loading State -->
                <div *ngIf="isLoadingUserRoles" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading roles...</span>
                  </div>
                </div>

                <!-- Roles List -->
                <div class="role-list" *ngIf="!isLoadingUserRoles">
                  <div class="role-item border rounded p-3 mb-3" *ngFor="let userRole of userRoles">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm flex-shrink-0 me-3">
                          <div class="avatar-title rounded-circle bg-soft-success text-success">
                            <i class="ri-shield-user-line"></i>
                          </div>
                        </div>
                        <div>
                          <h6 class="mb-1 fw-medium">{{ getRoleDisplayName(userRole) }}</h6>
                          <div class="d-flex gap-2 mb-1">
                            <span class="badge bg-soft-primary text-primary" *ngIf="userRole.primary">
                              <i class="ri-star-fill me-1"></i>Primary
                            </span>
                            <span class="badge bg-soft-warning text-warning" *ngIf="userRole.expiresAt">
                              <i class="ri-time-line me-1"></i>Expires: {{ userRole.expiresAt | date:'short' }}
                            </span>
                          </div>
                          <small class="text-muted" *ngIf="userRole.assignedAt">
                            Assigned: {{ userRole.assignedAt | date:'short' }}
                          </small>
                        </div>
                      </div>
                      <div class="dropdown">
                        <button class="btn btn-soft-secondary btn-sm dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                          <i class="ri-more-2-fill"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                          <li>
                            <a class="dropdown-item" href="javascript:void(0);" 
                               (click)="setPrimaryRole(userRole)" [class.disabled]="userRole.primary">
                              <i class="ri-star-line me-2 text-warning"></i>Set as Primary
                            </a>
                          </li>
                          <li><hr class="dropdown-divider"></li>
                          <li>
                            <a class="dropdown-item text-danger" href="javascript:void(0);" 
                               (click)="removeRole(userRole)">
                              <i class="ri-delete-bin-line me-2"></i>Remove Role
                            </a>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <!-- No Roles State -->
                  <div *ngIf="!isLoadingUserRoles && userRoles.length === 0" class="text-center py-4">
                    <div class="avatar-md mx-auto mb-3">
                      <div class="avatar-title bg-soft-info text-info rounded-circle">
                        <i class="ri-shield-user-line fs-20"></i>
                      </div>
                    </div>
                    <h6 class="mb-1">No Roles Assigned</h6>
                    <p class="text-muted mb-0">This user has no general roles assigned yet.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Case Roles Tab -->
          <div class="tab-pane" id="caseRoles" role="tabpanel">
            <div class="row">
              <!-- Assign Case Role Form -->
              <div class="col-lg-5">
                <div class="card border border-dashed border-success bg-soft-success">
                  <div class="card-body">
                    <h6 class="card-title fw-semibold text-success mb-3">
                      <i class="ri-briefcase-line me-2"></i>Assign Case Role
                    </h6>
                    <form [formGroup]="caseRoleForm" (ngSubmit)="assignCaseRole()">
                      <div class="mb-3">
                        <label class="form-label fw-medium">Select Case</label>
                        <select class="form-select" formControlName="caseId">
                          <option value="">Choose a case...</option>
                          <option *ngFor="let case of cases" [value]="case.id">
                            {{ getCaseDisplayName(case) }}
                          </option>
                        </select>
                        <div class="invalid-feedback" *ngIf="caseRoleForm.get('caseId')?.invalid && caseRoleForm.get('caseId')?.touched">
                          Please select a case
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label fw-medium">Select Role</label>
                        <select class="form-select" formControlName="roleId" [disabled]="isLoadingRoles">
                          <option value="">Choose a role...</option>
                          <option *ngFor="let role of availableRoles" [value]="role.id">
                            {{ getRoleDisplayName(role) }} (Level {{ role.hierarchyLevel }})
                          </option>
                        </select>
                        <div class="invalid-feedback" *ngIf="caseRoleForm.get('roleId')?.invalid && caseRoleForm.get('roleId')?.touched">
                          Please select a role
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label fw-medium">Expiration Date (Optional)</label>
                        <input type="datetime-local" class="form-control" formControlName="expiresAt">
                        <small class="form-text text-muted">Leave empty for permanent assignment</small>
                      </div>
                      <button type="submit" class="btn btn-success w-100 waves-effect waves-light" 
                              [disabled]="caseRoleForm.invalid || isAssigningCaseRole">
                        <span *ngIf="isAssigningCaseRole" class="spinner-border spinner-border-sm me-2"></span>
                        <i class="ri-briefcase-line me-1" *ngIf="!isAssigningCaseRole"></i>
                        {{ isAssigningCaseRole ? 'Assigning...' : 'Assign Case Role' }}
                      </button>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Current Case Roles -->
              <div class="col-lg-7">
                <h6 class="fw-semibold mb-3">
                  <i class="ri-briefcase-check-line me-2 text-success"></i>Current Case Roles
                  <span class="badge bg-soft-info text-info ms-2">{{ caseRoles.length }}</span>
                </h6>

                <!-- Loading State -->
                <div *ngIf="isLoadingCaseRoles" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading case roles...</span>
                  </div>
                </div>

                <!-- Case Roles List -->
                <div class="case-role-list" *ngIf="!isLoadingCaseRoles">
                  <div class="case-role-item border rounded p-3 mb-3" *ngFor="let caseRole of caseRoles">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm flex-shrink-0 me-3">
                          <div class="avatar-title rounded-circle bg-soft-warning text-warning">
                            <i class="ri-briefcase-line"></i>
                          </div>
                        </div>
                        <div>
                          <h6 class="mb-1 fw-medium">{{ getRoleDisplayName(caseRole) }}</h6>
                          <p class="text-muted mb-1 fs-12">
                            <i class="ri-folder-line me-1"></i>{{ getCaseDisplayName(caseRole) }}
                          </p>
                          <div class="d-flex gap-2 mb-1">
                            <span class="badge bg-soft-warning text-warning" *ngIf="caseRole.expiresAt">
                              <i class="ri-time-line me-1"></i>Expires: {{ caseRole.expiresAt | date:'short' }}
                            </span>
                          </div>
                          <small class="text-muted" *ngIf="caseRole.assignedAt">
                            Assigned: {{ caseRole.assignedAt | date:'short' }}
                          </small>
                        </div>
                      </div>
                      <div>
                        <button class="btn btn-soft-danger btn-sm" (click)="removeCaseRole(caseRole)"
                                title="Remove case role">
                          <i class="ri-delete-bin-line"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- No Case Roles State -->
                  <div *ngIf="!isLoadingCaseRoles && caseRoles.length === 0" class="text-center py-4">
                    <div class="avatar-md mx-auto mb-3">
                      <div class="avatar-title bg-soft-warning text-warning rounded-circle">
                        <i class="ri-briefcase-line fs-20"></i>
                      </div>
                    </div>
                    <h6 class="mb-1">No Case Roles Assigned</h6>
                    <p class="text-muted mb-0">This user has no case-specific roles assigned yet.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 