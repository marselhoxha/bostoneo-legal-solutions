<!-- Angular Material Dialog Content -->
<div class="permission-dialog-container">
  
  <!-- Dialog Header -->
  <div class="dialog-header bg-primary text-white p-3">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <div class="avatar-sm me-3">
          <span class="avatar-title rounded-circle bg-white bg-opacity-25 text-white">
            <i class="ri-shield-check-line fs-18"></i>
          </span>
        </div>
        <div>
          <h5 class="mb-1 text-white">Permission Manager</h5>
          <p class="mb-0 fs-13 text-white-50">Manage permissions for {{ role.name }}</p>
        </div>
      </div>
      <button type="button" class="btn-close btn-close-white" (click)="onCancel()"></button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="dialog-body">
    <div class="bg-light border-bottom">
      <div class="row g-0">
        <div class="col-3">
          <div class="p-3 text-center border-end">
            <h4 class="mb-1 text-primary">{{ allPermissions.length }}</h4>
            <p class="text-muted mb-0 fs-13">Total Permissions</p>
          </div>
        </div>
        <div class="col-3">
          <div class="p-3 text-center border-end">
            <h4 class="mb-1 text-success">{{ assignedCount }}</h4>
            <p class="text-muted mb-0 fs-13">Assigned</p>
          </div>
        </div>
        <div class="col-3">
          <div class="p-3 text-center border-end">
            <h4 class="mb-1 text-warning">{{ unassignedCount }}</h4>
            <p class="text-muted mb-0 fs-13">Available</p>
          </div>
        </div>
        <div class="col-3">
          <div class="p-3 text-center">
            <h4 class="mb-1 text-info">{{ getAssignedPercentage() }}%</h4>
            <p class="text-muted mb-0 fs-13">Coverage</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Controls -->
    <div class="p-3 bg-light border-bottom">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label fw-medium">Search Permissions</label>
          <div class="position-relative">
            <input type="text" 
                   class="form-control" 
                   placeholder="Search permissions..."
                   [(ngModel)]="searchTerm"
                   (input)="onSearchChange()">
            <i class="ri-search-line position-absolute top-50 end-0 translate-middle-y me-3 text-muted"></i>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-medium">Filter Status</label>
          <select class="form-select" [(ngModel)]="filterType" (change)="onFilterChange()">
            <option value="all">All Permissions</option>
            <option value="assigned">Assigned Only</option>
            <option value="unassigned">Available Only</option>
          </select>
        </div>
        <div class="col-md-5">
          <label class="form-label fw-medium">Quick Actions</label>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-success btn-sm" (click)="selectAllVisible()">
              <i class="ri-check-double-line me-1"></i>Select All
            </button>
            <button type="button" class="btn btn-danger btn-sm" (click)="deselectAllVisible()">
              <i class="ri-close-line me-1"></i>Clear All
            </button>
            <button type="button" class="btn btn-info btn-sm" (click)="selectBasicPermissions()">
              <i class="ri-shield-line me-1"></i>Basic Set
            </button>
            <button type="button" class="btn btn-secondary btn-sm" (click)="resetFilters()" *ngIf="searchTerm || filterType !== 'all'">
              <i class="ri-refresh-line me-1"></i>Reset
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Permission Categories -->
    <div class="permissions-content p-3">
      
      <!-- Loading State -->
      <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <h6 class="text-muted">Loading permissions...</h6>
      </div>

      <!-- Permission Groups -->
      <div *ngIf="!loading && groupedPermissions.length > 0">
        <div class="accordion" id="permissionAccordion">
          <div class="accordion-item mb-3" *ngFor="let group of groupedPermissions; trackBy: trackByGroupName">
            
            <!-- Category Header -->
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" 
                      type="button" 
                      (click)="toggleGroup(group.name); $event.stopPropagation()">
                <div class="d-flex align-items-center justify-content-between w-100 me-3">
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm me-3">
                      <span class="avatar-title rounded bg-primary-subtle text-primary">
                        <i [class]="getCategoryIcon(group.name)"></i>
                      </span>
                    </div>
                    <div>
                      <h6 class="mb-1 fw-semibold">{{ group.displayName }}</h6>
                      <small class="text-muted">{{ group.assignedCount }}/{{ group.permissions.length }} assigned</small>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="progress" style="width: 60px; height: 6px;">
                      <div class="progress-bar" 
                           [class]="getCategoryProgress(group) === 100 ? 'bg-success' : getCategoryProgress(group) > 0 ? 'bg-warning' : 'bg-secondary'"
                           [style.width.%]="getCategoryProgress(group)"></div>
                    </div>
                    <small class="text-muted fw-medium">{{ getCategoryProgress(group) }}%</small>
                    <div class="dropdown">
                      <button class="btn btn-sm btn-ghost-primary" type="button" (click)="$event.stopPropagation()" data-bs-toggle="dropdown">
                        <i class="ri-more-2-fill"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="javascript:void(0)" (click)="selectAllInCategory(group); $event.stopPropagation()">
                          <i class="ri-check-line me-2"></i>Select All
                        </a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" (click)="deselectAllInCategory(group); $event.stopPropagation()">
                          <i class="ri-close-line me-2"></i>Clear All
                        </a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </button>
            </h2>

            <!-- Category Content -->
            <div class="accordion-collapse collapse" [class.show]="group.isExpanded">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-lg-6" *ngFor="let permission of group.permissions; trackBy: trackByPermissionId">
                    <div class="card border h-100" 
                         [class.border-success]="permission.assigned"
                         [class.bg-success-subtle]="permission.assigned"
                         (click)="togglePermission(permission); $event.stopPropagation()">
                      <div class="card-body p-3">
                        <div class="form-check">
                          <input class="form-check-input" 
                                 type="checkbox" 
                                 [id]="'perm-' + permission.id"
                                 [(ngModel)]="permission.assigned"
                                 [disabled]="role.isSystemRole"
                                 (click)="$event.stopPropagation()"
                                 (change)="onPermissionChange()">
                          <label class="form-check-label w-100" 
                                 [for]="'perm-' + permission.id"
                                 (click)="$event.stopPropagation()">
                            <div class="d-flex justify-content-between align-items-start">
                              <div class="flex-grow-1">
                                <h6 class="mb-2 fw-medium">{{ permission.name }}</h6>
                                <p class="text-muted mb-2 fs-13">{{ getPermissionDescription(permission) }}</p>
                                <div class="d-flex gap-1">
                                  <span class="badge bg-primary-subtle text-primary fs-11">{{ getActionLabel(permission.actionType) }}</span>
                                  <span class="badge bg-secondary-subtle text-secondary fs-11">{{ permission.resourceType }}</span>
                                </div>
                              </div>
                              <div *ngIf="permission.assigned" class="text-success">
                                <i class="ri-check-circle-fill fs-16"></i>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!loading && groupedPermissions.length === 0" class="text-center py-5">
        <div class="avatar-lg mx-auto mb-4">
          <div class="avatar-title bg-light text-muted rounded-circle">
            <i class="ri-search-line fs-24"></i>
          </div>
        </div>
        <h5 class="text-muted">No permissions found</h5>
        <p class="text-muted mb-4">
          {{ searchTerm || filterType !== 'all' ? 
             'Try adjusting your search or filter criteria.' : 
             'No permissions are available for this role.' }}
        </p>
        <button type="button" class="btn btn-primary" (click)="resetFilters()" *ngIf="searchTerm || filterType !== 'all'">
          <i class="ri-refresh-line me-1"></i>Reset Filters
        </button>
      </div>

    </div>
  </div>

  <!-- Dialog Footer -->
  <div class="dialog-footer bg-light p-3 border-top">
    <div class="d-flex align-items-center justify-content-between w-100">
      <div class="d-flex align-items-center gap-3">
        <small class="text-muted">
          <i class="ri-information-line me-1"></i>
          {{ assignedCount }} of {{ allPermissions.length }} permissions assigned
        </small>
        <small class="text-warning" *ngIf="hasChanges()">
          <i class="ri-edit-line me-1"></i>
          Unsaved changes
        </small>
      </div>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-light" (click)="onCancel()" [disabled]="saving">
          Cancel
        </button>
        <button type="button" 
                class="btn btn-primary" 
                (click)="savePermissions()" 
                [disabled]="saving || role.isSystemRole || !hasChanges()">
          <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
          <i class="ri-save-line me-1" *ngIf="!saving"></i>
          {{ saving ? 'Saving...' : 'Save Changes' }}
        </button>
      </div>
    </div>
  </div>

</div>
