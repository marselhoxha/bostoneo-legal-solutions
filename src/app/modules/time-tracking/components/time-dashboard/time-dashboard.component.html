<!-- Velzon Time Dashboard -->
<div class="container-fluid">
  
  <!-- Enhanced Velzon Page Title -->
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-sm-flex align-items-center justify-content-between">
        <div class="page-title-right">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="javascript: void(0);">Time Tracking</a></li>
            <li class="breadcrumb-item active">Time Dashboard</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Simple Velzon Activity Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-lg-8">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <div class="avatar-sm">
                    <span class="avatar-title bg-primary text-white rounded">
                      <i class="ri-timer-line fs-18"></i>
                    </span>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h4 class="mb-1 fw-semibold">Time Tracking Dashboard</h4>
                  <p class="text-muted mb-2">Monitor your time, track productivity, and manage billing efficiently</p>
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="badge bg-success-subtle text-success px-2 py-1" *ngIf="timer.isRunning">
                      <i class="ri-play-fill me-1"></i>Timer Active
                    </span>
                    <span class="badge bg-secondary-subtle text-secondary px-2 py-1" *ngIf="!timer.isRunning">
                      <i class="ri-pause-fill me-1"></i>Timer Idle
                    </span>
                    <span class="badge bg-info-subtle text-info px-2 py-1">
                      <i class="ri-time-line me-1"></i>Real-time tracking
                    </span>
                    <span class="badge bg-primary-subtle text-primary px-2 py-1">
                      <i class="ri-money-dollar-circle-line me-1"></i>Billing ready
                    </span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-4">
              <div class="row g-3">
                <!-- Today's Hours -->
                <div class="col-4">
                  <div class="d-flex align-items-center justify-content-center p-3 bg-primary-subtle rounded">
                    <div class="text-center">
                      <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="ri-time-line text-primary fs-20 me-2"></i>
                        <h4 class="mb-0 text-primary fw-bold">{{ formatHours(stats.todayHours) }}</h4>
                      </div>
                      <small class="text-primary fw-semibold">
                        {{ stats.isShowingToday ? 'Today Hours' : 'Recent Hours' }}
                      </small>
                      <div *ngIf="!stats.isShowingToday && stats.displayDate" class="mt-1">
                        <small class="text-muted fs-11">{{ stats.displayDate | date:'MMM d' }}</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Timer Status -->
                <div class="col-4">
                  <div class="d-flex align-items-center justify-content-center p-3 rounded"
                       [class.bg-success-subtle]="timer.isRunning"
                       [class.bg-secondary-subtle]="!timer.isRunning">
                    <div class="text-center">
                      <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="ri-play-circle-line fs-20 me-2"
                           [class.text-success]="timer.isRunning"
                           [class.text-secondary]="!timer.isRunning"></i>
                        <h4 class="mb-0 fw-bold"
                            [class.text-success]="timer.isRunning"
                            [class.text-secondary]="!timer.isRunning">{{ timer.isRunning ? 'ON' : 'OFF' }}</h4>
                      </div>
                      <small class="fw-semibold"
                             [class.text-success]="timer.isRunning"
                             [class.text-secondary]="!timer.isRunning">Timer</small>
                    </div>
                  </div>
                </div>
                
                <!-- Revenue -->
                <div class="col-4">
                  <div class="d-flex align-items-center justify-content-center p-3 bg-warning-subtle rounded">
                    <div class="text-center">
                      <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="ri-money-dollar-circle-line text-warning fs-20 me-2"></i>
                        <h4 class="mb-0 text-warning fw-bold">
                          <span *ngIf="stats.todayAmount >= 1000">${{ (stats.todayAmount / 1000).toFixed(1) }}K</span>
                          <span *ngIf="stats.todayAmount < 1000">${{ stats.todayAmount.toFixed(0) }}</span>
                        </h4>
                      </div>
                      <small class="text-warning fw-semibold">
                        {{ stats.isShowingToday ? 'Today Revenue' : 'Recent Revenue' }}
                      </small>
                      <div *ngIf="!stats.isShowingToday && stats.displayDate" class="mt-1">
                        <small class="text-muted fs-11">{{ stats.displayDate | date:'MMM d' }}</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Alert -->
  <div class="alert alert-danger" role="alert" *ngIf="error">
    <i class="ri-error-warning-line me-2"></i>{{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <!-- Date Info Alert -->
  <div class="alert alert-info border-0 bg-info bg-opacity-10" role="alert" *ngIf="!loading && stats && !stats.isShowingToday">
    <div class="d-flex align-items-center">
      <i class="ri-information-line me-2 text-info"></i>
      <div class="flex-grow-1">
        <strong class="text-info">Showing data from {{ stats.displayDate | date:'MMMM d, y' }}</strong>
        <p class="mb-0 text-muted">No time entries found for today. Displaying your most recent work day instead.</p>
      </div>
             <button class="btn btn-soft-info btn-sm" (click)="addManualEntry()">
         <i class="ri-add-line me-1"></i>Add Today's Entry
       </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-muted">Loading dashboard...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading">
    
    <!-- Enhanced Statistics Cards with Better Styling -->
    <div class="row g-4 mb-4">
      <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm card-animate card-enhanced">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1 overflow-hidden">
                <p class="text-uppercase fw-semibold text-muted text-truncate mb-0 fs-13 letter-spacing">
                  <i class="ri-time-line me-1 text-primary"></i>{{ stats.isShowingToday ? 'Today\'s Hours' : 'Recent Hours' }}
                  <span *ngIf="!stats.isShowingToday && stats.displayDate" class="text-info ms-1">({{ stats.displayDate | date:'MMM d' }})</span>
                </p>
              </div>
              <div class="flex-shrink-0">
                <div class="trend-badge trend-positive">
                  <i class="ri-arrow-up-line fs-12"></i> +12.5%
                </div>
              </div>
            </div>
            <div class="d-flex align-items-end justify-content-between mt-4">
              <div>
                <h4 class="fs-22 fw-bold ff-secondary mb-3 text-primary">{{ formatHours(stats.todayHours) }}</h4>
                <div class="progress progress-sm mb-2">
                  <div class="progress-bar bg-primary" [style.width.%]="(stats.todayHours / 8) * 100"></div>
                </div>
                <span class="badge bg-primary-subtle text-primary fs-12">
                  <i class="ri-target-line me-1"></i>{{ (stats.todayHours / 8 * 100).toFixed(0) }}% of 8hr goal
                </span>
              </div>
              <div class="avatar-sm flex-shrink-0">
                <span class="avatar-title bg-primary text-white rounded shadow-sm">
                  <i class="ri-time-line fs-18"></i>
                </span>
              </div>
            </div>
          </div>
          <div class="card-footer border-0 bg-primary bg-opacity-10">
            <small class="text-primary fw-medium">
              <i class="ri-calendar-today-line me-1"></i>Updated in real-time
            </small>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm card-animate card-enhanced">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1 overflow-hidden">
                <p class="text-uppercase fw-semibold text-muted text-truncate mb-0 fs-13 letter-spacing">
                  <i class="ri-play-circle-line me-1" 
                     [class.text-success]="timer.isRunning"
                     [class.text-secondary]="!timer.isRunning"></i>Timer Status
                </p>
              </div>
              <div class="flex-shrink-0">
                <div class="status-dot" *ngIf="timer.isRunning"></div>
                <div class="trend-badge trend-stable" *ngIf="!timer.isRunning">
                  <i class="ri-pause-line fs-12"></i> IDLE
                </div>
              </div>
            </div>
            <div class="d-flex align-items-end justify-content-between mt-4">
              <div>
                <h4 class="fs-22 fw-bold ff-secondary mb-3"
                    [class.text-success]="timer.isRunning"
                    [class.text-secondary]="!timer.isRunning">
                  {{ timer.isRunning ? 'RUNNING' : 'STOPPED' }}
                </h4>
                <div class="progress progress-sm mb-2">
                  <div class="progress-bar" 
                       [class.bg-success]="timer.isRunning"
                       [class.bg-secondary]="!timer.isRunning"
                       [style.width.%]="timer.isRunning ? 100 : 0"></div>
                </div>
                <span class="badge fs-12"
                      [class.bg-success-subtle]="timer.isRunning"
                      [class.text-success]="timer.isRunning"
                      [class.bg-secondary-subtle]="!timer.isRunning"
                      [class.text-secondary]="!timer.isRunning">
                  <i class="ri-pulse-line me-1" *ngIf="timer.isRunning"></i>
                  <i class="ri-pause-line me-1" *ngIf="!timer.isRunning"></i>
                  {{ timer.isRunning ? 'Active Tracking' : 'Ready to Start' }}
                </span>
              </div>
              <div class="avatar-sm flex-shrink-0">
                <span class="avatar-title text-white rounded shadow-sm"
                      [class.bg-success]="timer.isRunning"
                      [class.bg-secondary]="!timer.isRunning">
                  <i class="ri-play-circle-line fs-18"></i>
                </span>
              </div>
            </div>
          </div>
          <div class="card-footer border-0 bg-opacity-10"
               [class.bg-success]="timer.isRunning"
               [class.bg-secondary]="!timer.isRunning">
            <small class="fw-medium"
                   [class.text-success]="timer.isRunning"
                   [class.text-secondary]="!timer.isRunning">
              <i class="ri-time-line me-1"></i>{{ timer.isRunning ? 'Elapsed: ' + timer.elapsed : 'Click start to begin' }}
            </small>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm card-animate card-enhanced">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1 overflow-hidden">
                <p class="text-uppercase fw-semibold text-muted text-truncate mb-0 fs-13 letter-spacing">
                  <i class="ri-calendar-line me-1 text-info"></i>Week Total
                </p>
              </div>
              <div class="flex-shrink-0">
                <div class="trend-badge trend-positive">
                  <i class="ri-arrow-up-line fs-12"></i> +8.7%
                </div>
              </div>
            </div>
            <div class="d-flex align-items-end justify-content-between mt-4">
              <div>
                <h4 class="fs-22 fw-bold ff-secondary mb-3 text-info">{{ formatHours(stats.weekTotal) }}</h4>
                <div class="progress progress-sm mb-2">
                  <div class="progress-bar bg-info" [style.width.%]="(stats.weekTotal / 40) * 100"></div>
                </div>
                <span class="badge bg-info-subtle text-info fs-12">
                  <i class="ri-bar-chart-line me-1"></i>{{ (stats.weekTotal / 40 * 100).toFixed(0) }}% of 40hr week
                </span>
              </div>
              <div class="avatar-sm flex-shrink-0">
                <span class="avatar-title bg-info text-white rounded shadow-sm">
                  <i class="ri-calendar-line fs-18"></i>
                </span>
              </div>
            </div>
          </div>
          <div class="card-footer border-0 bg-info bg-opacity-10">
            <small class="text-info fw-medium">
              <i class="ri-refresh-line me-1"></i>Weekly progress tracking
            </small>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm card-animate card-enhanced">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1 overflow-hidden">
                <p class="text-uppercase fw-semibold text-muted text-truncate mb-0 fs-13 letter-spacing">
                  <i class="ri-money-dollar-circle-line me-1 text-warning"></i>{{ stats.isShowingToday ? 'Today\'s Revenue' : 'Recent Revenue' }}
                  <span *ngIf="!stats.isShowingToday && stats.displayDate" class="text-info ms-1">({{ stats.displayDate | date:'MMM d' }})</span>
                </p>
              </div>
              <div class="flex-shrink-0">
                <div class="trend-badge trend-positive">
                  <i class="ri-arrow-up-line fs-12"></i> +22.1%
                </div>
              </div>
            </div>
            <div class="d-flex align-items-end justify-content-between mt-4">
              <div>
                <h4 class="fs-22 fw-bold ff-secondary mb-3 text-warning">{{ formatCurrency(stats.todayAmount) }}</h4>
                <div class="progress progress-sm mb-2">
                  <div class="progress-bar bg-warning" [style.width.%]="(stats.todayAmount / 2000) * 100"></div>
                </div>
                <span class="badge bg-warning-subtle text-warning fs-12">
                  <i class="ri-coin-line me-1"></i>{{ ((stats.todayAmount / 2000) * 100).toFixed(0) }}% of $2K goal
                </span>
              </div>
              <div class="avatar-sm flex-shrink-0">
                <span class="avatar-title bg-warning text-white rounded shadow-sm">
                  <i class="ri-money-dollar-circle-line fs-18"></i>
                </span>
              </div>
            </div>
          </div>
          <div class="card-footer border-0 bg-warning bg-opacity-10">
            <small class="text-warning fw-medium">
              <i class="ri-line-chart-line me-1"></i>Auto-calculated billing
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions Card -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-light border-0">
            <h5 class="card-title mb-0">
              <i class="ri-lightning-bolt-outline me-2 text-warning"></i>Quick Actions
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3 col-sm-6">
                <div class="d-grid">
                  <button type="button" class="btn btn-primary" (click)="addManualEntry()">
                    <i class="ri-add-line me-1"></i>New Time Entry
                  </button>
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <div class="d-grid">
                  <a routerLink="/time-tracking/timesheet" class="btn btn-success">
                    <i class="ri-calendar-check-line me-1"></i>View Timesheet
                  </a>
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <div class="d-grid">
                  <a routerLink="/time-tracking/reports" class="btn btn-info">
                    <i class="ri-bar-chart-box-line me-1"></i>View Reports
                  </a>
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <div class="d-grid">
                  <button type="button" class="btn btn-warning" (click)="navigateToInvoiceGeneration()">
                    <i class="ri-file-list-3-line me-1"></i>Generate Invoice
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      
      <!-- Enhanced Active Timer Widget -->
      <div class="col-lg-5">
        <div class="card border-0 shadow-sm card-enhanced timer-widget">
          <div class="card-header border-0 bg-primary bg-opacity-10">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0 text-primary fw-semibold">
                <i class="ri-timer-line me-2"></i>Active Timer
              </h5>
              <div class="timer-status-indicator">
                <span *ngIf="timer.isRunning" class="status-dot status-running"></span>
                <span *ngIf="!timer.isRunning && timer.id" class="status-dot status-paused"></span>
                <span *ngIf="!timer.id" class="status-dot status-idle"></span>
              </div>
            </div>
          </div>
          <div class="card-body">
            
            <!-- Enhanced Timer Display -->
            <div class="timer-display-container mb-4">
              <div class="timer-display"
                   [class.timer-running]="timer.isRunning"
                   [class.timer-paused]="!timer.isRunning && timer.id"
                   [class.timer-idle]="!timer.id">
                <div class="timer-ring">
                  <div class="timer-ring-fill" 
                       [class.animate-spin]="timer.isRunning"></div>
                </div>
                <div class="timer-content">
                  <div class="timer-time">{{ timer.elapsed }}</div>
                  <div class="timer-description">{{ timer.description }}</div>
                </div>
              </div>
              
              <!-- Enhanced Status Badge with Case Info -->
              <div class="timer-status-badge mt-3">
                <span *ngIf="timer.isRunning" class="badge bg-success-subtle text-success fs-13 fw-semibold">
                  <i class="ri-play-fill me-1"></i>Active • {{ timer.caseName || 'No Case Selected' }}
                </span>
                <span *ngIf="!timer.isRunning && timer.id" class="badge bg-warning-subtle text-warning fs-13 fw-semibold">
                  <i class="ri-pause-fill me-1"></i>Paused • {{ timer.caseName || 'No Case' }}
                </span>
                <span *ngIf="!timer.id" class="badge bg-primary-subtle text-primary fs-13 fw-semibold">
                  <i class="ri-time-line me-1"></i>Ready • Select Case to Start
                </span>
              </div>

              <!-- Timer Stats -->
              <div class="timer-stats mt-3">
                <div class="row g-2">
                  <div class="col-4" *ngIf="timer.id">
                    <div class="timer-stat timer-stat-idle">
                      <div class="timer-stat-value text-primary">{{ formatHours(calculateHoursFromElapsed()) }}</div>
                      <div class="timer-stat-label text-primary">Hours</div>
                    </div>
                  </div>
                  <div class="col-4" *ngIf="timer.id">
                    <div class="timer-stat timer-stat-idle">
                      <div class="timer-stat-value text-info">${{ getCurrentBillableAmount().toFixed(2) }}</div>
                      <div class="timer-stat-label text-info">Billable</div>
                    </div>
                  </div>
                  <div class="col-4" *ngIf="timer.id">
                    <div class="timer-stat timer-stat-idle">
                      <div class="timer-stat-value text-primary">{{ timer.isRunning ? 'LIVE' : 'PAUSE' }}</div>
                      <div class="timer-stat-label text-primary">Status</div>
                    </div>
                  </div>
                  
                  <!-- Idle state stats -->
                  <div class="col-4" *ngIf="!timer.id">
                    <div class="timer-stat timer-stat-idle">
                      <div class="timer-stat-value text-primary">{{ formatHours(stats.todayHours) }}</div>
                      <div class="timer-stat-label text-primary">Today</div>
                    </div>
                  </div>
                  <div class="col-4" *ngIf="!timer.id">
                    <div class="timer-stat timer-stat-idle">
                      <div class="timer-stat-value text-info">
                        <span *ngIf="stats.todayAmount >= 1000">${{ (stats.todayAmount / 1000).toFixed(1) }}K</span>
                        <span *ngIf="stats.todayAmount < 1000">${{ stats.todayAmount.toFixed(0) }}</span>
                      </div>
                      <div class="timer-stat-label text-info">Revenue</div>
                    </div>
                  </div>
                  <div class="col-4" *ngIf="!timer.id">
                    <div class="timer-stat timer-stat-idle">
                      <div class="timer-stat-value text-primary">READY</div>
                      <div class="timer-stat-label text-primary">Status</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Case Selection -->
            <div *ngIf="!timer.id" class="case-selection">
              <div class="case-selection-header mb-3">
                <h6 class="fw-semibold text-dark mb-1">Select a Legal Case</h6>
                <p class="text-muted mb-0 fs-14">Choose an active legal matter to begin tracking time</p>
                <div class="mt-2 d-flex justify-content-between align-items-center">
                  <span class="badge bg-info-subtle text-info fs-12">
                    <i class="ri-scales-line me-1"></i>{{ availableCases.length }} {{ showAllCases ? 'Total' : 'Recent' }} Cases
                  </span>
                  <div class="d-flex gap-1">
                    <button *ngIf="!showAllCases && availableCases.length >= 6" 
                            class="btn btn-soft-primary btn-sm" 
                            (click)="viewAllCases()"
                            title="Show all available cases">
                      <i class="ri-eye-line me-1"></i>View All
                    </button>
                    <button *ngIf="showAllCases" 
                            class="btn btn-soft-secondary btn-sm" 
                            (click)="collapseAllCases()"
                            title="Show fewer cases">
                      <i class="ri-eye-off-line me-1"></i>Show Less
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="case-selection-grid" [class.expanded]="showAllCases">
                <div *ngFor="let case of availableCases; let i = index" 
                     class="case-card"
                     [class.case-card-loading]="isProcessing"
                     [style.animation-delay]="(i * 0.1) + 's'"
                     (click)="!isProcessing && showRateSelection(case.id)">
                  <div class="case-card-header">
                    <div class="case-card-icon">
                      <i class="ri-briefcase-line"></i>
                    </div>
                    <div class="case-card-action">
                      <i class="ri-play-circle-line" *ngIf="!isProcessing"></i>
                      <div class="spinner-border spinner-border-sm" *ngIf="isProcessing"></div>
                    </div>
                  </div>
                  <div class="case-card-content">
                    <div class="case-card-title" [title]="case.name">{{ case.name }}</div>
                    <div class="case-card-number">{{ case.number }}</div>
                    <div class="case-card-rate mb-2">
                      <span class="badge bg-success-subtle text-success fs-12 fw-semibold">
                        <i class="ri-money-dollar-circle-line me-1"></i>${{ case.defaultRate }}/hr
                      </span>
                      <span class="badge ms-1 fs-11" 
                            [class.bg-info-subtle]="case.allowMultipliers"
                            [class.text-info]="case.allowMultipliers"
                            [class.bg-secondary-subtle]="!case.allowMultipliers"
                            [class.text-secondary]="!case.allowMultipliers">
                        <i class="ri-timer-line me-1"></i>{{ case.allowMultipliers ? 'Auto-rate' : 'Fixed' }}
                      </span>
                    </div>
                    <div class="case-card-meta">
                      <small class="text-success">
                        <i class="ri-time-line me-1"></i>Ready to track
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Timer Controls -->
            <div *ngIf="timer.id" class="timer-controls">
              <div class="timer-controls-header mb-3">
                <h6 class="fw-semibold text-dark mb-1">Timer Controls</h6>
                <p class="text-muted mb-0 fs-14">Manage your active time tracking session</p>
              </div>
              
              <div class="timer-control-buttons">
                <div class="row g-2">
                  <div class="col-6">
                    <button *ngIf="timer.isRunning" 
                            class="btn btn-warning w-100 timer-btn timer-btn-pause"
                            [disabled]="isProcessing"
                            (click)="pauseTimer()">
                      <i class="ri-pause-fill me-2"></i>
                      <span>Pause</span>
                    </button>
                    <button *ngIf="!timer.isRunning" 
                            class="btn btn-success w-100 timer-btn timer-btn-resume"
                            [disabled]="isProcessing"
                            (click)="resumeTimer()">
                      <i class="ri-play-fill me-2"></i>
                      <span>Resume</span>
                    </button>
                  </div>
                  <div class="col-6">
                    <button class="btn btn-danger w-100 timer-btn timer-btn-stop" 
                            [disabled]="isProcessing"
                            (click)="openStopModal()">
                      <i class="ri-stop-fill me-2"></i>
                      <span>Stop & Save</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="timer-quick-actions mt-3">
                <div class="d-flex gap-2 justify-content-center">
                  <button class="btn btn-soft-secondary btn-sm" 
                          [disabled]="isProcessing"
                          (click)="addTimeBreak()"
                          title="Add break time">
                    <i class="ri-time-line me-1"></i>Break
                  </button>
                  <button class="btn btn-soft-info btn-sm" 
                          [disabled]="isProcessing"
                          (click)="addTimeNote()"
                          title="Add note to timer">
                    <i class="ri-sticky-note-line me-1"></i>Note
                  </button>
                  <button class="btn btn-soft-primary btn-sm" 
                          [disabled]="isProcessing"
                          (click)="viewCurrentSession()"
                          title="View session details">
                    <i class="ri-eye-line me-1"></i>Details
                  </button>
                </div>
              </div>
            </div>

            <!-- Enhanced Processing State -->
            <div *ngIf="isProcessing" class="timer-processing">
              <div class="processing-overlay">
                <div class="processing-content">
                  <div class="loading-dots enhanced">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                  <p class="processing-text">Processing timer action...</p>
                </div>
              </div>
            </div>

          </div>
          
          <!-- Enhanced Timer Footer -->
          <div class="card-footer border-0">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-primary fw-medium">
                <i class="ri-pulse-line me-1"></i>
                Real-time tracking enabled
              </small>
              <small class="text-muted fw-medium">
                <i class="ri-time-line me-1"></i>
                Last sync: {{ lastUpdated | date:'HH:mm:ss' }}
              </small>
            </div>
          </div>
        </div>

        <!-- Multiple Active Timers List (shown when more than one timer) -->
        <div class="card border-0 shadow-sm card-enhanced mt-3" *ngIf="activeTimers.length > 1">
          <div class="card-header border-0 bg-success bg-opacity-10">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="card-title mb-0 text-success fw-semibold">
                <i class="ri-timer-flash-line me-2"></i>All Active Timers
                <span class="badge bg-success ms-2">{{ activeTimers.length }}</span>
              </h6>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="list-group list-group-flush">
              <div *ngFor="let t of activeTimers"
                   class="list-group-item d-flex align-items-center justify-content-between py-3"
                   [class.bg-success-subtle]="t.isActive"
                   [class.bg-warning-subtle]="!t.isActive">
                <div class="d-flex align-items-center gap-3">
                  <span class="avatar-sm flex-shrink-0">
                    <span class="avatar-title rounded"
                          [class.bg-success]="t.isActive"
                          [class.bg-warning]="!t.isActive">
                      <i [class]="t.isActive ? 'ri-play-fill' : 'ri-pause-fill'"></i>
                    </span>
                  </span>
                  <div>
                    <h6 class="mb-1 fw-semibold">{{ t.caseName || 'Untitled Case' }}</h6>
                    <div class="d-flex align-items-center gap-2">
                      <span class="fs-16 fw-bold"
                            [class.text-success]="t.isActive"
                            [class.text-warning]="!t.isActive"
                            style="font-family: 'SFMono-Regular', Consolas, monospace;">
                        {{ t.formattedDuration || '00:00:00' }}
                      </span>
                      <span *ngIf="!t.isActive" class="badge bg-warning-subtle text-warning fs-10">PAUSED</span>
                    </div>
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-icon"
                          [class.btn-warning]="t.isActive"
                          [class.btn-success]="!t.isActive"
                          (click)="toggleTimerById(t)"
                          [title]="t.isActive ? 'Pause' : 'Resume'">
                    <i [class]="t.isActive ? 'ri-pause-fill' : 'ri-play-fill'"></i>
                  </button>
                  <button class="btn btn-sm btn-icon btn-soft-danger"
                          (click)="stopTimerById(t)"
                          title="Stop Timer">
                    <i class="ri-stop-fill"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Recent Entries -->
      <div class="col-lg-7">
        <div class="card border-0 shadow-sm card-enhanced recent-entries">
          <div class="card-header border-0 bg-info bg-opacity-10">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0 fw-semibold">
                <i class="ri-time-line me-2 text-primary"></i>Recent Time Entries
                <span class="badge bg-primary-subtle text-primary ms-2 fs-12">
                  {{ recentEntries.length }} {{ showAllEntries ? 'total' : 'recent' }}
                </span>
              </h5>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" (click)="addManualEntry()">
                  <i class="ri-add-line me-1"></i>New Entry
                </button>
                <button class="btn btn-soft-info btn-sm" (click)="viewTimesheet()">
                  <i class="ri-eye-line me-1" *ngIf="!showAllEntries"></i>
                  <i class="ri-eye-off-line me-1" *ngIf="showAllEntries"></i>
                  {{ showAllEntries ? 'Show Less' : 'View All' }}
                </button>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            
            <!-- Empty State -->
            <div *ngIf="recentEntries.length === 0" class="text-center py-5">
              <div class="empty-state-wrapper">
                <div class="empty-icon mb-3">
                  <i class="ri-file-list-line display-4 text-muted"></i>
                </div>
                <h6 class="text-muted fw-semibold mb-2">No time entries yet</h6>
                <p class="text-muted mb-3">Start tracking time or create manual entries to see your work history</p>
                <div class="d-flex gap-2 justify-content-center">
                  <button class="btn btn-primary btn-sm" (click)="addManualEntry()">
                    <i class="ri-add-line me-1"></i>Create Entry
                  </button>
                  <button class="btn btn-outline-info btn-sm" (click)="viewTimesheet()">
                    <i class="ri-time-line me-1"></i>View Timesheet
                  </button>
                </div>
              </div>
            </div>

            <!-- Enhanced Table -->
            <div *ngIf="recentEntries.length > 0" class="table-responsive" 
                 [class.expanded-table]="showAllEntries"
                 [style.max-height]="showAllEntries ? '600px' : 'none'"
                 [style.overflow-y]="showAllEntries ? 'auto' : 'visible'">
              <table class="table table-hover mb-0">
                <thead class="sticky-top bg-light">
                  <tr>
                    <th class="fw-semibold">Date & Time</th>
                    <th class="fw-semibold">Case & Description</th>
                    <th class="text-center fw-semibold">Duration</th>
                    <th class="text-center fw-semibold">Billing</th>
                    <th class="text-center fw-semibold">Status</th>
                    <th class="text-end fw-semibold">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let entry of recentEntries; trackBy: trackByEntryId">
                    <!-- Enhanced Date Column -->
                    <td style="min-width: 120px;">
                      <div>
                        <div class="fw-medium">{{ entry.date | date:'MMM d, y' }}</div>
                        <small class="text-muted">
                          <i class="ri-calendar-line me-1"></i>{{ entry.date | date:'EEEE' }}
                        </small>
                        <div *ngIf="entry.startTime && entry.endTime" class="mt-1">
                          <small class="text-info fw-medium">
                            <i class="ri-time-line me-1"></i>{{ entry.startTime }} - {{ entry.endTime }}
                          </small>
                        </div>
                      </div>
                    </td>

                    <!-- Enhanced Case & Description Column -->
                    <td style="min-width: 280px;">
                      <div>
                        <div class="fw-medium text-truncate" style="max-width: 250px;" [title]="entry.description">
                          {{ entry.description }}
                        </div>
                        <div *ngIf="entry.caseName" class="mt-1">
                          <small class="text-muted d-flex align-items-center">
                            <i class="ri-briefcase-line me-1 text-primary"></i>
                            <span class="text-truncate">{{ entry.caseName }}</span>
                          </small>
                        </div>
                        <div *ngIf="entry.caseNumber" class="mt-1">
                          <span class="badge bg-secondary-subtle text-secondary fs-11">
                            {{ entry.caseNumber }}
                          </span>
                        </div>
                      </div>
                    </td>

                    <!-- Enhanced Duration Column -->
                    <td class="text-center" style="min-width: 90px;">
                      <div>
                        <span class="badge bg-info-subtle text-info fs-12 fw-semibold">
                          <i class="ri-time-line me-1"></i>{{ getEntryDuration(entry) }}h
                        </span>
                        <div class="mt-1">
                          <small class="text-muted">
                            {{ getEntryDurationMinutes(entry) }} min
                          </small>
                        </div>
                      </div>
                    </td>

                    <!-- Enhanced Billing Column -->
                    <td class="text-center" style="min-width: 100px;">
                      <div>
                        <div class="fw-medium text-success">
                          {{ formatCurrency(getEntryBillingAmount(entry)) }}
                        </div>
                        <small class="text-muted">
                          {{ formatRate(entry) }}/hr
                        </small>
                        <div class="mt-1">
                          <span class="badge bg-success-subtle text-success fs-11" *ngIf="entry.billable">
                            <i class="ri-money-dollar-circle-line me-1"></i>Billable
                          </span>
                          <span class="badge bg-secondary-subtle text-secondary fs-11" *ngIf="!entry.billable">
                            <i class="ri-subtract-line me-1"></i>Non-billable
                          </span>
                        </div>
                      </div>
                    </td>

                    <!-- Enhanced Status Column -->
                    <td class="text-center" style="min-width: 100px;">
                      <div>
                        <span class="badge fs-12 fw-semibold" [ngClass]="getStatusClass(entry.status)">
                          <i class="ri-circle-fill me-1 fs-10" 
                             [class.text-warning]="entry.status === 'DRAFT'"
                             [class.text-info]="entry.status === 'SUBMITTED'"
                             [class.text-success]="entry.status === 'APPROVED'"
                             [class.text-danger]="entry.status === 'REJECTED'"></i>
                          {{ getStatusText(entry.status) }}
                        </span>
                        <div class="mt-1">
                          <small class="text-muted">
                            <i class="ri-time-line me-1"></i>
                            {{ entry.updatedAt || entry.createdAt | date:'short' }}
                          </small>
                        </div>
                      </div>
                    </td>

                    <!-- Enhanced Actions Column -->
                    <td class="text-end" style="min-width: 120px;">
                      <div class="d-flex gap-1 justify-content-end">
                        <!-- More actions dropdown -->
                        <div class="dropdown">
                          <button class="btn btn-soft-secondary btn-sm dropdown-toggle" 
                                  data-bs-toggle="dropdown"
                                  title="More actions">
                            Actions
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <!-- View Action -->
                            <li>
                              <a class="dropdown-item" href="#" (click)="$event.preventDefault(); viewEntry(entry.id)">
                                <i class="ri-eye-line me-2 text-info"></i>View Details
                              </a>
                            </li>
                            
                            <!-- Edit Action (for DRAFT and REJECTED) -->
                            <li *ngIf="entry.status === 'DRAFT'">
                              <a class="dropdown-item" href="#" (click)="$event.preventDefault(); openEditModal(entry)">
                                <i class="ri-edit-line me-2 text-primary"></i>Edit Entry
                              </a>
                            </li>
                            <li *ngIf="entry.status === 'REJECTED'">
                              <a class="dropdown-item" href="#" (click)="$event.preventDefault(); openEditModal(entry)">
                                <i class="ri-edit-line me-2 text-warning"></i>Edit & Resubmit
                              </a>
                            </li>
                            
                            <!-- Copy Action -->
                            <li>
                              <a class="dropdown-item" href="#" (click)="$event.preventDefault(); duplicateEntry(entry.id)">
                                <i class="ri-file-copy-line me-2 text-secondary"></i>Duplicate Entry
                              </a>
                            </li>
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- Status Actions -->
                            <li *ngIf="entry.status === 'DRAFT'">
                              <a class="dropdown-item" href="#" (click)="$event.preventDefault(); submitEntry(entry.id)">
                                <i class="ri-send-plane-line me-2 text-success"></i>Submit for Approval
                              </a>
                            </li>
                            <li *ngIf="entry.status === 'SUBMITTED'">
                              <a class="dropdown-item" href="#" (click)="$event.preventDefault(); recallEntry(entry.id)">
                                <i class="ri-arrow-go-back-line me-2 text-warning"></i>Recall Submission
                              </a>
                            </li>
                            <li *ngIf="entry.status === 'APPROVED'">
                              <a class="dropdown-item" href="#" (click)="$event.preventDefault(); printEntry(entry.id)">
                                <i class="ri-printer-line me-2 text-info"></i>Generate Invoice
                              </a>
                            </li>
                            
                            <!-- Delete Action (only for draft/rejected) -->
                            <li *ngIf="entry.status === 'DRAFT' || entry.status === 'REJECTED'">
                              <hr class="dropdown-divider">
                            </li>
                            <li *ngIf="entry.status === 'DRAFT' || entry.status === 'REJECTED'">
                              <a class="dropdown-item text-danger" href="#" (click)="$event.preventDefault(); deleteEntry(entry.id)">
                                <i class="ri-delete-bin-line me-2"></i>Delete Entry
                              </a>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
          
          <!-- Enhanced Footer -->
          <div class="card-footer bg-light border-top" *ngIf="recentEntries.length > 0">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex gap-3">
                <small class="text-muted fw-medium">
                  <i class="ri-file-list-line me-1"></i>
                  {{ recentEntries.length }} recent entries
                </small>
                <small class="text-info fw-medium">
                  <i class="ri-time-line me-1"></i>
                  {{ getTotalHours() }}h total
                </small>
                <small class="text-success fw-medium">
                  <i class="ri-money-dollar-circle-line me-1"></i>
                  {{ getTotalAmount() | currency:'USD':'symbol':'1.0-0' }} billable
                </small>
              </div>
              <small class="text-muted fw-medium">
                <i class="ri-refresh-line me-1"></i>
                Updated: {{ lastUpdated | date:'short' }}
              </small>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Enhanced Rate Selection Modal -->
<div class="modal fade" [class.show]="showRateSelectionModal" [style.display]="showRateSelectionModal ? 'block' : 'none'" 
     tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-success bg-opacity-10 border-0">
        <h5 class="modal-title text-success fw-semibold">
          <i class="ri-money-dollar-circle-line me-2"></i>Select Billing Rate
        </h5>
        <button type="button" class="btn-close" (click)="cancelRateSelection()"></button>
      </div>
      <div class="modal-body">
        
        <div *ngIf="selectedCaseForRateSelection" class="mb-4">
          <!-- Case Info -->
          <div class="alert alert-info border-0 bg-info bg-opacity-10 mb-3">
            <h6 class="text-info fw-semibold mb-2">{{ selectedCaseForRateSelection.name }}</h6>
            <small class="text-muted">{{ selectedCaseForRateSelection.number }}</small>
          </div>

          <!-- Rate Selection -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Base Hourly Rate ($)</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" 
                     class="form-control" 
                     [(ngModel)]="selectedRate"
                     min="1"
                     max="2000"
                     step="25">
              <span class="input-group-text">/hr</span>
            </div>
            <div class="form-text">Default rate for this case: ${{ selectedCaseForRateSelection.defaultRate }}/hr</div>
          </div>

          <!-- Multiplier Settings -->
          <div class="mb-3" *ngIf="selectedCaseForRateSelection.allowMultipliers">
            <div class="form-check form-switch">
              <input class="form-check-input" 
                     type="checkbox" 
                     [(ngModel)]="applyMultipliers"
                     id="applyMultipliersSwitch">
              <label class="form-check-label fw-medium" for="applyMultipliersSwitch">
                Apply time-based multipliers
              </label>
            </div>
            <div class="form-text">
              Automatically adjust rate for weekend ({{ selectedCaseForRateSelection.weekendMultiplier }}x), 
              after-hours ({{ selectedCaseForRateSelection.afterHoursMultiplier }}x), 
              or emergency work ({{ selectedCaseForRateSelection.emergencyMultiplier }}x)
            </div>
          </div>

          <!-- Emergency Work Toggle -->
          <div class="mb-3" *ngIf="applyMultipliers && selectedCaseForRateSelection.allowMultipliers">
            <div class="form-check form-switch">
              <input class="form-check-input" 
                     type="checkbox" 
                     [(ngModel)]="isEmergencyWork"
                     id="emergencyWorkSwitch">
              <label class="form-check-label fw-medium" for="emergencyWorkSwitch">
                Emergency work ({{ selectedCaseForRateSelection.emergencyMultiplier }}x rate)
              </label>
            </div>
            <div class="form-text text-warning">
              Emergency multiplier overrides weekend/after-hours multipliers
            </div>
          </div>

          <!-- Rate Preview -->
          <div class="alert alert-success border-0 bg-success bg-opacity-10">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong class="text-success">Final Rate:</strong>
                <span class="fs-18 fw-bold text-success ms-2">${{ getCalculatedRate() }}/hr</span>
              </div>
              <div class="text-end">
                <small class="text-muted">Base: ${{ selectedRate }}</small>
                <div *ngIf="applyMultipliers && getCalculatedRate() !== selectedRate">
                  <small class="text-info">
                    <i class="ri-calculator-line me-1"></i>{{ (getCalculatedRate() / selectedRate).toFixed(2) }}x multiplier
                  </small>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-light" (click)="cancelRateSelection()">
          <i class="ri-close-line me-1"></i>Cancel
        </button>
        <button type="button" 
                class="btn btn-success" 
                (click)="confirmRateAndStartTimer()">
          <i class="ri-play-line me-1"></i>Start Timer
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade" [class.show]="showRateSelectionModal" 
     [style.display]="showRateSelectionModal ? 'block' : 'none'"></div>

<!-- Enhanced Stop Timer Modal -->
<div class="modal fade" [class.show]="showStopModal" [style.display]="showStopModal ? 'block' : 'none'" 
     tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger bg-opacity-10 border-0">
        <h5 class="modal-title text-danger fw-semibold">
          <i class="ri-stop-circle-line me-2"></i>Stop Timer & Create Time Entry
        </h5>
        <button type="button" class="btn-close" (click)="cancelStopTimer()"></button>
      </div>
      <div class="modal-body">
        
        <!-- Timer Summary -->
        <div class="alert alert-info border-0 bg-info bg-opacity-10 mb-4">
          <div class="row g-3">
            <div class="col-md-4">
              <strong class="text-info">Duration:</strong><br>
              <span class="fs-16 fw-semibold">{{ timer.elapsed }}</span>
            </div>
            <div class="col-md-4">
              <strong class="text-info">Case:</strong><br>
              <span class="fs-14">{{ timer.caseName || 'No Case Selected' }}</span>
            </div>
            <div class="col-md-4">
              <strong class="text-info">Billable Amount:</strong><br>
              <span class="fs-16 fw-semibold text-success">${{ (calculateHoursFromElapsed() * stopFormData.rate).toFixed(2) }}</span>
            </div>
          </div>
        </div>

        <!-- Enhanced Form -->
        <form (ngSubmit)="confirmStopTimer()" #stopForm="ngForm">
          <div class="row g-3">
            
            <!-- Work Description -->
            <div class="col-12">
              <label class="form-label fw-semibold required">Work Description</label>
              <textarea class="form-control" 
                        rows="4" 
                        [(ngModel)]="stopFormData.description"
                        name="description"
                        #description="ngModel"
                        required
                        minlength="10"
                        maxlength="500"
                        placeholder="Describe the work performed in detail (minimum 10 characters)..."></textarea>
              <div class="form-text d-flex justify-content-between">
                <span [class.text-danger]="description.invalid && description.touched">
                  {{ description.invalid && description.touched ? 'Description must be at least 10 characters' : 'Detailed description helps with billing accuracy' }}
                </span>
                <span [class.text-danger]="stopFormData.description.length > 450">
                  {{ stopFormData.description.length }}/500 characters
                </span>
              </div>
            </div>

            <!-- Date -->
            <div class="col-md-6">
              <label class="form-label fw-semibold required">Date</label>
              <input type="date" 
                     class="form-control" 
                     [(ngModel)]="stopFormData.date"
                     name="date"
                     required
                     [max]="getCurrentDate()"
                     #dateInput>
            </div>

            <!-- Billable Toggle -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Billing Status</label>
              <div class="d-flex align-items-center mt-2">
                <div class="form-check form-switch">
                  <input class="form-check-input" 
                         type="checkbox" 
                         [(ngModel)]="stopFormData.billable"
                         name="billable"
                         id="billableSwitch">
                  <label class="form-check-label fw-medium" for="billableSwitch">
                    {{ stopFormData.billable ? 'Billable' : 'Non-billable' }}
                  </label>
                </div>
                <span class="badge ms-2" 
                      [class.bg-success-subtle]="stopFormData.billable"
                      [class.text-success]="stopFormData.billable"
                      [class.bg-secondary-subtle]="!stopFormData.billable"
                      [class.text-secondary]="!stopFormData.billable">
                  <i class="ri-money-dollar-circle-line me-1" *ngIf="stopFormData.billable"></i>
                  <i class="ri-subtract-line me-1" *ngIf="!stopFormData.billable"></i>
                  {{ stopFormData.billable ? 'Will be billed' : 'Internal work' }}
                </span>
              </div>
            </div>

            <!-- Enhanced Rate Controls -->
            <div class="col-md-6">
              <label class="form-label fw-semibold required">Base Hourly Rate ($)</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" 
                       class="form-control" 
                       [(ngModel)]="stopFormData.rate"
                       name="rate"
                       required
                       min="1"
                       max="2000"
                       step="25">
                <span class="input-group-text">/hr</span>
              </div>
              <div class="form-text">
                Final rate: <strong>${{ getFinalRate() }}/hr</strong>
                <small class="text-muted d-block">{{ getMultiplierInfo() }}</small>
              </div>
            </div>

            <!-- Multiplier Controls -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Rate Adjustments</label>
              <div class="mt-2">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" 
                         type="checkbox" 
                         [(ngModel)]="stopFormData.applyMultipliers"
                         name="applyMultipliers"
                         id="stopApplyMultipliersSwitch">
                  <label class="form-check-label fw-medium" for="stopApplyMultipliersSwitch">
                    Apply multipliers
                  </label>
                </div>
                <div class="form-check form-switch" *ngIf="stopFormData.applyMultipliers">
                  <input class="form-check-input" 
                         type="checkbox" 
                         [(ngModel)]="stopFormData.isEmergency"
                         name="isEmergency"
                         id="stopEmergencySwitch">
                  <label class="form-check-label fw-medium" for="stopEmergencySwitch">
                    Emergency work
                  </label>
                </div>
              </div>
            </div>

            <!-- Activity Type -->
            <div class="col-12">
              <label class="form-label fw-semibold">Activity Type</label>
              <select class="form-select" 
                      [(ngModel)]="stopFormData.activityType"
                      name="activityType">
                <option value="">Select activity type</option>
                <option value="RESEARCH">Research</option>
                <option value="DRAFTING">Document Drafting</option>
                <option value="REVIEW">Document Review</option>
                <option value="MEETING">Client Meeting</option>
                <option value="COURT">Court Appearance</option>
                <option value="PHONE">Phone Call</option>
                <option value="EMAIL">Email Communication</option>
                <option value="TRAVEL">Travel Time</option>
                <option value="ADMIN">Administrative</option>
                <option value="OTHER">Other</option>
              </select>
            </div>

            <!-- Tags -->
            <div class="col-12">
              <label class="form-label fw-semibold">Tags (optional)</label>
              <input type="text" 
                     class="form-control" 
                     [(ngModel)]="stopFormData.tags"
                     name="tags"
                     placeholder="e.g., urgent, research, client-meeting (comma-separated)">
              <div class="form-text">Add tags to help categorize and search this entry later</div>
            </div>

            <!-- Notes -->
            <div class="col-12">
              <label class="form-label fw-semibold">Additional Notes (optional)</label>
              <textarea class="form-control" 
                        rows="2" 
                        [(ngModel)]="stopFormData.notes"
                        name="notes"
                        maxlength="200"
                        placeholder="Any additional notes or context..."></textarea>
              <div class="form-text">{{ stopFormData.notes.length }}/200 characters</div>
            </div>

          </div>
        </form>

      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-light" (click)="cancelStopTimer()" [disabled]="isProcessing">
          <i class="ri-close-line me-1"></i>Cancel
        </button>
        <button type="button" 
                class="btn btn-primary" 
                (click)="confirmStopTimer()" 
                [disabled]="isProcessing || !isStopFormValid()">
          <span *ngIf="!isProcessing">
            <i class="ri-save-line me-1"></i>Save Time Entry
          </span>
          <span *ngIf="isProcessing">
            <span class="spinner-border spinner-border-sm me-2"></span>Saving...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade" [class.show]="showStopModal" 
     [style.display]="showStopModal ? 'block' : 'none'"></div>

<!-- Edit Time Entry Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" 
     tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary bg-opacity-10 border-0">
        <h5 class="modal-title text-primary fw-semibold">
          <i class="ri-edit-line me-2"></i>Edit Time Entry
        </h5>
        <button type="button" class="btn-close" (click)="cancelEditEntry()"></button>
      </div>
      <div class="modal-body" *ngIf="editingEntry">
        
        <!-- Entry Info -->
        <div class="alert alert-info border-0 bg-info bg-opacity-10 mb-4">
          <div class="row g-3">
            <div class="col-md-4">
              <strong class="text-info">Entry ID:</strong><br>
              <span class="badge bg-secondary">#{{ editingEntry.id }}</span>
            </div>
            <div class="col-md-4">
              <strong class="text-info">Current Status:</strong><br>
              <span class="badge" [ngClass]="getStatusClass(editingEntry.status)">
                {{ getStatusText(editingEntry.status) }}
              </span>
            </div>
            <div class="col-md-4">
              <strong class="text-info">Original Duration:</strong><br>
              <span class="fs-14">{{ getEntryDuration(editingEntry) }} hours</span>
            </div>
          </div>
        </div>

        <!-- Edit Form -->
        <form (ngSubmit)="saveEditedEntry()" #editForm="ngForm">
          <div class="row g-3">
            
            <!-- Work Description -->
            <div class="col-12">
              <label class="form-label fw-semibold required">Work Description</label>
              <textarea class="form-control" 
                        rows="4" 
                        [(ngModel)]="editFormData.description"
                        name="editDescription"
                        #editDescription="ngModel"
                        required
                        minlength="10"
                        maxlength="500"
                        placeholder="Describe the work performed in detail (minimum 10 characters)..."></textarea>
              <div class="form-text d-flex justify-content-between">
                <span [class.text-danger]="editDescription.invalid && editDescription.touched">
                  {{ editDescription.invalid && editDescription.touched ? 'Description must be at least 10 characters' : 'Detailed description helps with billing accuracy' }}
                </span>
                <span [class.text-danger]="editFormData.description.length > 450">
                  {{ editFormData.description.length }}/500 characters
                </span>
              </div>
            </div>

            <!-- Date and Hours -->
            <div class="col-md-6">
              <label class="form-label fw-semibold required">Date</label>
              <input type="date" 
                     class="form-control" 
                     [(ngModel)]="editFormData.date"
                     name="editDate"
                     required
                     [max]="getCurrentDate()">
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold required">Hours Worked</label>
              <div class="input-group">
                <input type="number" 
                       class="form-control" 
                       [(ngModel)]="editFormData.hours"
                       name="editHours"
                       required
                       min="0.1"
                       max="24"
                       step="0.1"
                       placeholder="0.0">
                <span class="input-group-text">hours</span>
              </div>
              <div class="form-text">Original: {{ getEntryDuration(editingEntry) }} hours</div>
            </div>

            <!-- Billable Status and Rate -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Billing Status</label>
              <div class="d-flex align-items-center mt-2">
                <div class="form-check form-switch">
                  <input class="form-check-input" 
                         type="checkbox" 
                         [(ngModel)]="editFormData.billable"
                         name="editBillable"
                         id="editBillableSwitch">
                  <label class="form-check-label fw-medium" for="editBillableSwitch">
                    {{ editFormData.billable ? 'Billable' : 'Non-billable' }}
                  </label>
                </div>
                <span class="badge ms-2" 
                      [class.bg-success-subtle]="editFormData.billable"
                      [class.text-success]="editFormData.billable"
                      [class.bg-secondary-subtle]="!editFormData.billable"
                      [class.text-secondary]="!editFormData.billable">
                  <i class="ri-money-dollar-circle-line me-1" *ngIf="editFormData.billable"></i>
                  <i class="ri-subtract-line me-1" *ngIf="!editFormData.billable"></i>
                  {{ editFormData.billable ? 'Will be billed' : 'Internal work' }}
                </span>
              </div>
            </div>

            <div class="col-md-6" *ngIf="editFormData.billable">
              <label class="form-label fw-semibold required">Hourly Rate ($)</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" 
                       class="form-control" 
                       [(ngModel)]="editFormData.rate"
                       name="editRate"
                       required
                       min="1"
                       max="2000"
                       step="25">
                <span class="input-group-text">/hr</span>
              </div>
              <div class="form-text">
                Total: <strong class="text-success">${{ (editFormData.hours * editFormData.rate).toFixed(2) }}</strong>
              </div>
            </div>

            <!-- Case Assignment -->
            <div class="col-12" *ngIf="availableCases.length > 0">
              <label class="form-label fw-semibold">Legal Case</label>
              <select class="form-select" 
                      [(ngModel)]="editFormData.caseId"
                      name="editCaseId">
                <option value="">No case assigned</option>
                <option *ngFor="let case of availableCases" [value]="case.id">
                  {{ case.name }} ({{ case.number }})
                </option>
              </select>
              <div class="form-text">Current: {{ editingEntry.caseName || 'No case assigned' }}</div>
            </div>

            <!-- Activity Type -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Activity Type</label>
              <select class="form-select" 
                      [(ngModel)]="editFormData.activityType"
                      name="editActivityType">
                <option value="">Select activity type</option>
                <option value="RESEARCH">Research</option>
                <option value="DRAFTING">Document Drafting</option>
                <option value="REVIEW">Document Review</option>
                <option value="MEETING">Client Meeting</option>
                <option value="COURT">Court Appearance</option>
                <option value="PHONE">Phone Call</option>
                <option value="EMAIL">Email Communication</option>
                <option value="TRAVEL">Travel Time</option>
                <option value="ADMIN">Administrative</option>
                <option value="OTHER">Other</option>
              </select>
            </div>

            <!-- Tags -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Tags (optional)</label>
              <input type="text" 
                     class="form-control" 
                     [(ngModel)]="editFormData.tags"
                     name="editTags"
                     placeholder="e.g., urgent, research, client-meeting">
              <div class="form-text">Comma-separated tags</div>
            </div>

            <!-- Notes -->
            <div class="col-12">
              <label class="form-label fw-semibold">Additional Notes (optional)</label>
              <textarea class="form-control" 
                        rows="2" 
                        [(ngModel)]="editFormData.notes"
                        name="editNotes"
                        maxlength="200"
                        placeholder="Any additional notes or context..."></textarea>
              <div class="form-text">{{ editFormData.notes?.length || 0 }}/200 characters</div>
            </div>

          </div>
        </form>

      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-light" (click)="cancelEditEntry()" [disabled]="isProcessing">
          <i class="ri-close-line me-1"></i>Cancel
        </button>
        <button type="button" 
                class="btn btn-primary" 
                (click)="saveEditedEntry()" 
                [disabled]="isProcessing || !isEditFormValid()">
          <span *ngIf="!isProcessing">
            <i class="ri-save-line me-1"></i>Save Changes
          </span>
          <span *ngIf="isProcessing">
            <span class="spinner-border spinner-border-sm me-2"></span>Saving...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade" [class.show]="showEditModal" 
     [style.display]="showEditModal ? 'block' : 'none'"></div> 