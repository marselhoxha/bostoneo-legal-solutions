<!-- Loading State -->
<div class="row" *ngIf="isLoading">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading form...</span>
        </div>
        <p class="mt-3 text-muted">Loading intake form...</p>
      </div>
    </div>
  </div>
</div>

<!-- Error State -->
<div class="row" *ngIf="error && !isLoading && !intakeForm">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <div class="avatar-lg mx-auto mb-4">
          <div class="avatar-title rounded-circle bg-danger-subtle text-danger">
            <i class="ri-error-warning-line display-6"></i>
          </div>
        </div>
        <h5 class="mb-3 text-danger">Form Not Available</h5>
        <p class="text-muted mb-4">{{ error }}</p>
        <div class="d-flex gap-2 justify-content-center">
          <a routerLink="/public/intake-forms" class="btn btn-primary btn-animation waves-effect waves-light">
            <i class="ri-arrow-left-line me-1"></i>View All Forms
          </a>
          <button class="btn btn-soft-primary btn-animation waves-effect waves-light" (click)="loadForm()">
            <i class="ri-refresh-line me-1"></i>Try Again
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Form Content -->
<div class="row" *ngIf="!isLoading && intakeForm">
  <div class="col-lg-10 mx-auto">
    <!-- Hero Section with Professional Header -->
    <div class="hero-section mb-5">
      <div class="card border-0 shadow-lg">
        <div class="card-body bg-primary text-center py-5 rounded">
          <div class="row align-items-center">
            <div class="col-lg-8 mx-auto">
              <div class="avatar-xl mx-auto mb-4">
                <div class="avatar-title rounded-circle bg-white text-primary shadow-sm">
                  <i class="ri-scales-3-line display-5"></i>
                </div>
              </div>
              <h2 class="text-white fw-bold mb-3">Get Your Free Legal Consultation</h2>
              <p class="text-white-50 fs-16 mb-2">
                Connect with experienced attorneys who will fight for your rights. No fees unless we win your case.
              </p>
              <!-- Practice Area Specific Urgency -->
              <div class="alert alert-warning bg-warning bg-opacity-20 border-warning text-white mb-4">
                <div class="d-flex align-items-center">
                  <i class="ri-alarm-warning-line me-2 fs-18"></i>
                  <span class="fs-15">{{ getPracticeAreaSpecificMessage() }}</span>
                </div>
              </div>
              <div class="d-flex justify-content-center gap-4 mb-4">
                <div class="text-center">
                  <div class="badge bg-white bg-opacity-20 text-white fs-14 px-3 py-2 rounded-pill">
                    <i class="ri-shield-check-line me-2"></i>100% Confidential
                  </div>
                </div>
                <div class="text-center">
                  <div class="badge bg-white bg-opacity-20 text-white fs-14 px-3 py-2 rounded-pill">
                    <i class="ri-time-line me-2"></i>24 Hour Response
                  </div>
                </div>
                <div class="text-center">
                  <div class="badge bg-white bg-opacity-20 text-white fs-14 px-3 py-2 rounded-pill">
                    <i class="ri-award-line me-2"></i>No Win, No Fee
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Multi-Step Progress Bar -->
    <div class="card shadow-sm mb-4" role="progressbar" [attr.aria-valuenow]="currentStep" [attr.aria-valuemax]="totalSteps" aria-label="Form progress">
      <div class="card-body p-4">
        <div class="row">
          <div class="col-12">
            <div class="step-progress-bar mb-4">
              <div class="progress-container">
                <div class="progress bg-light" style="height: 8px;">
                  <div class="progress-bar bg-gradient-primary" 
                       role="progressbar" 
                       [style.width.%]="getProgressPercentage()"
                       [attr.aria-valuenow]="getProgressPercentage()" 
                       aria-valuemin="0" 
                       aria-valuemax="100">
                  </div>
                </div>
                <div class="step-indicators mt-3">
                  <div class="d-flex justify-content-between">
                    <div class="step-item" 
                         *ngFor="let step of [1,2,3]; let i = index"
                         [class.active]="currentStep === step"
                         [class.completed]="isStepCompleted(step)"
                         [class.accessible]="isStepAccessible(step)"
                         (click)="isStepAccessible(step) ? goToStep(step) : null"
                         [style.cursor]="isStepAccessible(step) ? 'pointer' : 'not-allowed'">
                      <div class="step-circle">
                        <span *ngIf="!isStepCompleted(step)">{{ step }}</span>
                        <i class="ri-check-line" *ngIf="isStepCompleted(step)"></i>
                      </div>
                      <div class="step-label mt-2">
                        <small class="text-muted" *ngIf="step === 1">Basic Info</small>
                        <small class="text-muted" *ngIf="step === 2">Case Details</small>
                        <small class="text-muted" *ngIf="step === 3">Final Details</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Current Step Info -->
            <div class="text-center">
              <h5 class="text-primary fw-semibold mb-2">{{ getStepTitle() }}</h5>
              <p class="text-muted fs-14">{{ getStepDescription() }}</p>
              
              <!-- Completion Status -->
              <div class="mt-3">
                <div class="d-flex justify-content-center align-items-center gap-3">
                  <small class="text-muted">
                    <i class="ri-checkbox-circle-line me-1 text-success"></i>
                    {{ getCurrentStepCompletionPercentage() }}% Complete
                  </small>
                  <small class="text-success" style="opacity: 0.7;">
                    <i class="ri-save-line me-1"></i>Auto-saved
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Form -->
    <div class="card shadow-sm">
      <div class="card-header bg-light-subtle border-bottom-dashed py-4">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="card-title mb-0 h5" id="step-title">
            <i class="ri-edit-line me-2 text-primary" aria-hidden="true"></i>{{ getStepTitle() }}
          </h1>
          <div class="step-counter">
            <span class="badge bg-primary fs-13" role="status" aria-live="polite">Step {{ currentStep }} of {{ totalSteps }}</span>
          </div>
        </div>
      </div>
      <div class="card-body p-4">
        <!-- Error Alert -->
        <div class="alert alert-danger" *ngIf="error && intakeForm" role="alert">
          <i class="ri-error-warning-line me-2"></i>
          {{ error }}
        </div>

        <form [formGroup]="submissionForm" (ngSubmit)="currentStep === totalSteps ? onSubmit() : nextStep()" 
              role="form" [attr.aria-labelledby]="'step-title'">
          <!-- Dynamic Form Fields for Current Step -->
          <div class="row g-4" *ngFor="let field of getCurrentStepFields(); let i = index">
            <div [ngClass]="{
              'col-12': field.type === 'textarea' || field.fullWidth,
              'col-md-6': field.type !== 'textarea' && !field.fullWidth
            }">
              <!-- Text Input -->
              <div class="mb-3" *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'tel' || field.type === 'date'">
                <label [for]="field.name" class="form-label fw-semibold text-white-dark">
                  {{ field.label }}
                  <span class="text-danger" *ngIf="field.required">*</span>
                </label>
                <input 
                  [type]="field.type" 
                  class="form-control"
                  [class.is-invalid]="hasFieldError(field.name)"
                  [id]="field.name"
                  [formControlName]="field.name"
                  [placeholder]="field.placeholder || 'Enter ' + field.label.toLowerCase()">
                <div class="invalid-feedback" *ngIf="hasFieldError(field.name)">
                  {{ getFieldError(field.name) }}
                </div>
              </div>

              <!-- Textarea -->
              <div class="mb-3" *ngIf="field.type === 'textarea'">
                <label [for]="field.name" class="form-label fw-semibold text-white-dark">
                  {{ field.label }}
                  <span class="text-danger" *ngIf="field.required">*</span>
                </label>
                <textarea 
                  class="form-control"
                  [class.is-invalid]="hasFieldError(field.name)"
                  [id]="field.name"
                  [formControlName]="field.name"
                  [rows]="field.rows || 3"
                  [placeholder]="field.placeholder || 'Enter ' + field.label.toLowerCase()">
                </textarea>
                <div class="invalid-feedback" *ngIf="hasFieldError(field.name)">
                  {{ getFieldError(field.name) }}
                </div>
              </div>

              <!-- Select Dropdown -->
              <div class="mb-3" *ngIf="field.type === 'select'">
                <label [for]="field.name" class="form-label fw-semibold text-white-dark">
                  {{ field.label }}
                  <span class="text-danger" *ngIf="field.required">*</span>
                </label>
                <select 
                  class="form-select"
                  [class.is-invalid]="hasFieldError(field.name)"
                  [id]="field.name"
                  [formControlName]="field.name">
                  <option value="">Select {{ field.label.toLowerCase() }}</option>
                  <option *ngFor="let option of field.options" [value]="option">
                    {{ option }}
                  </option>
                </select>
                <div class="invalid-feedback" *ngIf="hasFieldError(field.name)">
                  {{ getFieldError(field.name) }}
                </div>
              </div>

              <!-- Radio Buttons -->
              <div class="mb-3" *ngIf="field.type === 'radio'">
                <label class="form-label fw-semibold text-white-dark">
                  {{ field.label }}
                  <span class="text-danger" *ngIf="field.required">*</span>
                </label>
                <div class="mt-2" [class.is-invalid]="hasFieldError(field.name)">
                  <div class="form-check" *ngFor="let option of field.options">
                    <input 
                      class="form-check-input" 
                      type="radio" 
                      [id]="field.name + '_' + option.value"
                      [formControlName]="field.name"
                      [value]="option.value">
                    <label class="form-check-label" [for]="field.name + '_' + option.value">
                      {{ option.label }}
                    </label>
                  </div>
                </div>
                <div class="text-danger fs-12 mt-1" *ngIf="hasFieldError(field.name)">
                  {{ getFieldError(field.name) }}
                </div>
              </div>
            </div>
          </div>


          <!-- Navigation Buttons -->
          <div class="row mt-5">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <!-- Previous Button -->
                <button 
                  type="button" 
                  class="btn btn-soft-secondary btn-animation"
                  [disabled]="currentStep === 1"
                  (click)="previousStep()"
                  *ngIf="currentStep > 1">
                  <i class="ri-arrow-left-line me-1"></i>Previous
                </button>
                
                <!-- Back to Forms Link (only on first step) -->
                <a routerLink="/public/intake-forms" 
                   class="btn btn-soft-secondary btn-animation waves-effect waves-light"
                   *ngIf="currentStep === 1">
                  <i class="ri-arrow-left-line me-1"></i>Back to Forms
                </a>

                <!-- Next/Submit Button -->
                <button 
                  type="submit" 
                  class="btn btn-primary btn-animation waves-effect waves-light btn-lg"
                  [disabled]="(currentStep === totalSteps && (!submissionForm.valid || isSubmitting))">
                  
                  <!-- Next Step Button -->
                  <span *ngIf="currentStep < totalSteps">
                    <i class="ri-arrow-right-line me-1"></i>{{ getCallToActionText() }}
                  </span>
                  
                  <!-- Final Submit Button -->
                  <span *ngIf="currentStep === totalSteps && !isSubmitting">
                    <i class="ri-send-plane-line me-1"></i>{{ getCallToActionText() }}
                  </span>
                  
                  <!-- Loading State -->
                  <span *ngIf="currentStep === totalSteps && isSubmitting">
                    <i class="ri-loader-line animate-spin me-1"></i>Submitting Your Request...
                  </span>
                </button>
              </div>
              
              <!-- Progress Text & Motivation -->
              <div class="text-center mt-3">
                <div class="mb-2" *ngIf="currentStep < totalSteps">
                  <small class="text-muted">
                    <i class="ri-time-line me-1"></i>This should take about {{ currentStep === 1 ? '2' : currentStep === 2 ? '3' : '2' }} minutes
                  </small>
                </div>
                
                <!-- Motivational Message -->
                <div class="alert alert-success bg-success-subtle border-success py-2 mb-3" 
                     *ngIf="getFormCompletionPercentage() > 20">
                  <small class="text-success fw-semibold">{{ getMotivationalMessage() }}</small>
                </div>

                <!-- Time-based Urgency -->
                <div class="alert alert-info bg-info-subtle border-info py-2 mb-0">
                  <small class="text-info">{{ getTimeBasedUrgency() }}</small>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Professional Trust Section -->
    <div class="row mt-5">
      <!-- Attorney Credentials -->
      <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm bg-light-subtle h-100">
          <div class="card-body text-center p-4">
            <div class="avatar-md mx-auto mb-3">
              <div class="avatar-title rounded-circle bg-primary text-white">
                <i class="ri-award-line fs-20"></i>
              </div>
            </div>
            <h6 class="fw-bold mb-2">Experienced Attorneys</h6>
            <p class="text-muted mb-0 fs-13">Our team has over 50+ years combined experience in {{ intakeForm.practiceArea }}</p>
          </div>
        </div>
      </div>

      <!-- Success Rate -->
      <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm bg-light-subtle h-100">
          <div class="card-body text-center p-4">
            <div class="avatar-md mx-auto mb-3">
              <div class="avatar-title rounded-circle bg-success text-white">
                <i class="ri-trophy-line fs-20"></i>
              </div>
            </div>
            <h6 class="fw-bold mb-2">95% Success Rate</h6>
            <p class="text-muted mb-0 fs-13">We have successfully resolved thousands of cases similar to yours</p>
          </div>
        </div>
      </div>

      <!-- No Fee Guarantee -->
      <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm bg-light-subtle h-100">
          <div class="card-body text-center p-4">
            <div class="avatar-md mx-auto mb-3">
              <div class="avatar-title rounded-circle bg-info text-white">
                <i class="ri-shield-check-line fs-20"></i>
              </div>
            </div>
            <h6 class="fw-bold mb-2">No Win, No Fee</h6>
            <p class="text-muted mb-0 fs-13">You don't pay attorney fees unless we win your case</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact & Support Information -->
    <div class="card shadow-sm mt-4">
      <div class="card-body p-4">
        <div class="row align-items-center">
          <div class="col-lg-8">
            <div class="row">
              <div class="col-md-6 mb-3 mb-md-0">
                <div class="d-flex align-items-center">
                  <div class="avatar-xs me-3">
                    <div class="avatar-title rounded-circle bg-success-subtle text-success">
                      <i class="ri-phone-line fs-14"></i>
                    </div>
                  </div>
                  <div>
                    <h6 class="mb-0">24/7 Support</h6>
                    <p class="text-muted mb-0 fs-13">
                      <a href="tel:+15551234567" class="text-decoration-none">(555) 123-4567</a>
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-center">
                  <div class="avatar-xs me-3">
                    <div class="avatar-title rounded-circle bg-info-subtle text-info">
                      <i class="ri-time-line fs-14"></i>
                    </div>
                  </div>
                  <div>
                    <h6 class="mb-0">Fast Response</h6>
                    <p class="text-muted mb-0 fs-13">We respond within 24 hours guaranteed</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 text-lg-end">
            <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
              <span class="badge bg-primary-subtle text-primary fs-12 px-3 py-2">
                <i class="ri-star-fill me-1"></i>5.0 Rating
              </span>
              <span class="badge bg-success-subtle text-success fs-12 px-3 py-2">
                <i class="ri-user-line me-1"></i>10,000+ Clients
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Final Privacy Notice -->
    <div class="card border-0 bg-primary-subtle mt-4">
      <div class="card-body p-4">
        <div class="row align-items-center">
          <div class="col-lg-1 text-center">
            <i class="ri-shield-check-line text-primary display-6"></i>
          </div>
          <div class="col-lg-11">
            <h6 class="text-primary fw-bold mb-2">Your Information is Protected</h6>
            <p class="text-muted mb-2 fs-14">
              All communications are protected by attorney-client privilege. Your information is encrypted and secure.
              We will never share your details with third parties.
            </p>
            <div class="d-flex flex-wrap gap-3">
              <small class="text-muted">
                <i class="ri-lock-line me-1 text-primary"></i>256-bit SSL Encryption
              </small>
              <small class="text-muted">
                <i class="ri-shield-line me-1 text-primary"></i>HIPAA Compliant
              </small>
              <small class="text-muted">
                <i class="ri-file-shield-line me-1 text-primary"></i>Attorney-Client Privilege
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>