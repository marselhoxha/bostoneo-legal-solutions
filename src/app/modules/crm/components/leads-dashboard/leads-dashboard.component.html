<div class="container-fluid" style="margin-top: 120px;">
  <!-- Header -->
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-flex align-items-center justify-content-between">
        <h4 class="mb-0">Lead Management Dashboard</h4>
        <div class="page-title-right">
          <button type="button" class="btn btn-primary btn-sm" (click)="showPipelineView()">
            <i class="ri-stack-line me-1"></i>Pipeline View
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pipeline Summary Cards -->
  <div class="row" *ngIf="pipelineSummary">
    <div class="col-xl-3 col-md-6" *ngFor="let stage of pipelineStages?.slice(0, 4)">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">{{stage.name}}</p>
              <h4 class="mb-0">{{getLeadCountForStage(stage.name)}}</h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle" [style.background-color]="stage.color + '20'">
                <span class="avatar-title rounded-circle" [style.background-color]="stage.color">
                  <i [class]="stage.icon" class="font-size-16" style="color: white;"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row g-3 align-items-center">
            <div class="col-lg-2 col-md-6">
              <select class="form-select form-select-sm" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
                <option value="">All Status</option>
                <option value="NEW">New</option>
                <option value="CONTACTED">Contacted</option>
                <option value="QUALIFIED">Qualified</option>
                <option value="CONSULTATION_SCHEDULED">Consultation Scheduled</option>
                <option value="PROPOSAL_SENT">Proposal Sent</option>
                <option value="NEGOTIATION">Negotiation</option>
                <option value="CONVERTED">Converted</option>
                <option value="LOST">Lost</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-6">
              <select class="form-select form-select-sm" [(ngModel)]="selectedUrgency" (change)="onFilterChange()">
                <option value="">All Urgency</option>
                <option value="URGENT">Urgent</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-6">
              <select class="form-select form-select-sm" [(ngModel)]="selectedPracticeArea" (change)="onFilterChange()">
                <option value="">All Practice Areas</option>
                <option value="FAMILY_LAW">Family Law</option>
                <option value="PERSONAL_INJURY">Personal Injury</option>
                <option value="CRIMINAL_DEFENSE">Criminal Defense</option>
                <option value="BUSINESS_LAW">Business Law</option>
                <option value="ESTATE_PLANNING">Estate Planning</option>
                <option value="REAL_ESTATE">Real Estate</option>
                <option value="IMMIGRATION">Immigration</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-6">
              <input type="text" class="form-control form-control-sm" placeholder="Assigned To" [(ngModel)]="selectedAssignedTo" (input)="onFilterChange()">
            </div>
            <div class="col-lg-2 col-md-6">
              <button type="button" class="btn btn-light btn-sm w-100" (click)="clearFilters()">
                <i class="ri-refresh-line me-1"></i>Clear
              </button>
            </div>
            <div class="col-lg-2 col-md-6">
              <div class="text-muted small text-end">
                Total: <strong>{{totalItems}}</strong> leads
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leads Table -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive" *ngIf="!loading; else loadingTemplate">
            <table class="table table-nowrap table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="cursor-pointer" (click)="onSort('fullName')">
                    Lead Name
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('status')">
                    Status
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('urgencyLevel')">
                    Urgency
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('practiceArea')">
                    Practice Area
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('leadScore')">
                    Score
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th>Assigned To</th>
                  <th class="cursor-pointer" (click)="onSort('estimatedValue')">
                    Est. Value
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('createdAt')">
                    Created
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let lead of paginatedLeads">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar-xs me-3">
                        <span class="avatar-title rounded-circle bg-soft-primary text-primary">
                          {{lead.firstName?.charAt(0) || 'L'}}{{lead.lastName?.charAt(0) || ''}}
                        </span>
                      </div>
                      <div>
                        <h6 class="mb-0">{{lead.fullName || (lead.firstName + ' ' + lead.lastName)}}</h6>
                        <p class="text-muted mb-0" *ngIf="lead.company">{{lead.company}}</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="badge" [class]="getStatusBadgeClass(lead.status)"
                          [title]="'Valid next steps: ' + getValidNextStatuses(lead.status || 'NEW').join(', ')">
                      {{getStatusDisplayName(lead.status || 'NEW')}}
                      <i class="ri-lock-line ms-1" *ngIf="getValidNextStatuses(lead.status || 'NEW').length === 0" title="Final status"></i>
                    </span>
                  </td>
                  <td>
                    <span class="badge" [class]="getUrgencyBadgeClass(lead.urgencyLevel)" *ngIf="lead.urgencyLevel">
                      {{lead.urgencyLevel}}
                    </span>
                    <span class="text-muted" *ngIf="!lead.urgencyLevel">-</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{lead.practiceArea?.replace('_', ' ') || '-'}}</span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center" *ngIf="lead.leadScore">
                      <div class="flex-shrink-0">
                        <span class="badge bg-success" *ngIf="lead.leadScore >= 80">{{lead.leadScore}}</span>
                        <span class="badge bg-warning" *ngIf="lead.leadScore >= 60 && lead.leadScore < 80">{{lead.leadScore}}</span>
                        <span class="badge bg-danger" *ngIf="lead.leadScore < 60">{{lead.leadScore}}</span>
                      </div>
                    </div>
                    <span class="text-muted" *ngIf="!lead.leadScore">-</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{lead.assignedToName || '-'}}</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{formatCurrency(lead.estimatedValue)}}</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{formatDate(lead.createdAt)}}</span>
                  </td>
                  <td>
                    <div class="dropdown">
                      <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Actions
                      </button>
                      <ul class="dropdown-menu">
                        <!-- Always show View Details -->
                        <li><a class="dropdown-item" href="#" (click)="viewLead(lead); $event.preventDefault()">
                          <i class="ri-eye-line me-2"></i>View Details
                        </a></li>
                        
                        <!-- Edit Lead - only if not converted -->
                        <li *ngIf="canEditLead(lead)"><hr class="dropdown-divider"></li>
                        <li *ngIf="canEditLead(lead)"><a class="dropdown-item" href="#" (click)="editLead(lead); $event.preventDefault()">
                          <i class="ri-edit-2-line me-2"></i>Edit Lead
                        </a></li>
                        
                        <!-- Assignment - only if not in final states -->
                        <li *ngIf="canAssignLead(lead)"><a class="dropdown-item" href="#" (click)="assignLead(lead); $event.preventDefault()">
                          <i class="ri-user-add-line me-2"></i>Assign to Attorney
                        </a></li>
                        
                        <!-- Schedule Consultation - only if valid transition -->
                        <li *ngIf="canScheduleConsultation(lead)"><a class="dropdown-item" href="#" (click)="scheduleCall(lead); $event.preventDefault()">
                          <i class="ri-calendar-2-line me-2"></i>Schedule Consultation
                        </a></li>
                        
                        <!-- Convert - only if valid transition -->
                        <li *ngIf="canConvertLead(lead)"><hr class="dropdown-divider"></li>
                        <li *ngIf="canConvertLead(lead)"><a class="dropdown-item text-success" href="#" (click)="convertLead(lead); $event.preventDefault()">
                          <i class="ri-arrow-right-circle-line me-2"></i>Convert to Client
                        </a></li>
                        
                        <!-- Status information -->
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">
                          Status: {{getStatusDisplayName(lead.status || 'NEW')}}
                        </h6></li>
                        <li *ngIf="getValidNextStatuses(lead.status || 'NEW').length === 0">
                          <span class="dropdown-item-text text-muted small">
                            <i class="ri-lock-line me-1"></i>Lead in final status
                          </span>
                        </li>
                        <li *ngIf="getValidNextStatuses(lead.status || 'NEW').length > 0">
                          <span class="dropdown-item-text text-muted small">
                            <i class="ri-information-line me-1"></i>Next: {{getFormattedNextStatuses(lead.status || 'NEW')}}
                          </span>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Loading Template -->
          <ng-template #loadingTemplate>
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <p class="text-muted mt-2">Loading leads...</p>
            </div>
          </ng-template>

          <!-- Empty State -->
          <div class="text-center py-4" *ngIf="!loading && paginatedLeads.length === 0">
            <i class="ri-user-search-line display-4 text-muted"></i>
            <h5 class="mt-3">No leads found</h5>
            <p class="text-muted">Try adjusting your filters or search criteria.</p>
          </div>

          <!-- Pagination -->
          <div class="row align-items-center mt-3" *ngIf="totalPages > 1">
            <div class="col-md-6">
              <div class="text-muted">
                {{ pageInfo }}
              </div>
            </div>
            <div class="col-md-6">
              <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm justify-content-end mb-0">
                  <li class="page-item" [class.disabled]="!hasPreviousPage">
                    <a class="page-link" href="#" (click)="previousPage(); $event.preventDefault()">
                      Previous
                    </a>
                  </li>
                  <li class="page-item active">
                    <span class="page-link">{{ currentPage + 1 }}</span>
                  </li>
                  <li class="page-item" [class.disabled]="!hasNextPage">
                    <a class="page-link" href="#" (click)="nextPage(); $event.preventDefault()">
                      Next
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lead Details Modal -->
<div class="modal fade" [class.show]="showLeadModal" [style.display]="showLeadModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Lead Details - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeLeadModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Contact Information</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Email:</strong> {{selectedLead.email || '-'}}</div>
                <div class="mb-2"><strong>Phone:</strong> {{selectedLead.phone || '-'}}</div>
                <div class="mb-2"><strong>Company:</strong> {{selectedLead.company || '-'}}</div>
                <div class="mb-0"><strong>Preferred Contact:</strong> {{selectedLead.contactPreference || '-'}}</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Lead Information</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Status:</strong> 
                  <span class="badge ms-2" [class]="getStatusBadgeClass(selectedLead.status)">
                    {{selectedLead.status?.replace('_', ' ')}}
                  </span>
                </div>
                <div class="mb-2"><strong>Urgency:</strong> 
                  <span class="badge ms-2" [class]="getUrgencyBadgeClass(selectedLead.urgencyLevel)" *ngIf="selectedLead.urgencyLevel">
                    {{selectedLead.urgencyLevel}}
                  </span>
                  <span *ngIf="!selectedLead.urgencyLevel">-</span>
                </div>
                <div class="mb-2"><strong>Lead Score:</strong> {{selectedLead.leadScore || '-'}}</div>
                <div class="mb-0"><strong>Source:</strong> {{selectedLead.source || '-'}}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Case Details</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Practice Area:</strong> {{selectedLead.practiceArea?.replace('_', ' ') || '-'}}</div>
                <div class="mb-0"><strong>Estimated Value:</strong> {{formatCurrency(selectedLead.estimatedValue)}}</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Timeline</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Created:</strong> {{formatDateTime(selectedLead.createdAt)}}</div>
                <div class="mb-2"><strong>Last Contact:</strong> {{formatDateTime(selectedLead.lastContactDate)}}</div>
                <div class="mb-2"><strong>Contact Attempts:</strong> {{selectedLead.contactAttempts || 0}}</div>
                <div class="mb-0"><strong>Follow-up Date:</strong> {{formatDate(selectedLead.followUpDate)}}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row" *ngIf="selectedLead.initialInquiry || selectedLead.notes">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label fw-semibold">Notes & Inquiry</label>
              <div class="border rounded p-3">
                <div class="mb-2" *ngIf="selectedLead.initialInquiry">
                  <strong>Initial Inquiry:</strong>
                  <p class="mb-0 mt-1">{{selectedLead.initialInquiry}}</p>
                </div>
                <div *ngIf="selectedLead.notes">
                  <strong>Notes:</strong>
                  <p class="mb-0 mt-1">{{selectedLead.notes}}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="closeLeadModal()">Close</button>
        <button type="button" class="btn btn-primary">Edit Lead</button>
        <button type="button" class="btn btn-success">Convert</button>
      </div>
    </div>
  </div>
</div>

<!-- Pipeline Modal -->
<div class="modal fade" [class.show]="showPipelineModal" [style.display]="showPipelineModal ? 'block' : 'none'" 
     tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Lead Pipeline View</h5>
        <button type="button" class="btn-close" (click)="closePipelineModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-3" *ngFor="let stage of pipelineStages">
            <div class="card mb-3">
              <div class="card-header" [style.background-color]="stage.color + '20'">
                <h6 class="mb-0" [style.color]="stage.color">
                  <i [class]="stage.icon" class="me-2"></i>
                  {{stage.name}}
                  <span class="badge badge-soft-secondary ms-2">{{getLeadCountForStage(stage.name)}}</span>
                </h6>
              </div>
              <div class="card-body p-2" style="min-height: 400px;">
                <div class="mb-2" *ngFor="let lead of getLeadsForStage(stage.name) | slice:0:5">
                  <div class="border rounded p-2">
                    <div class="d-flex align-items-center">
                      <div class="avatar-xs me-2">
                        <span class="avatar-title rounded-circle bg-soft-primary text-primary font-size-12">
                          {{lead.firstName?.charAt(0) || 'L'}}{{lead.lastName?.charAt(0) || ''}}
                        </span>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-1 font-size-12">{{lead.fullName || (lead.firstName + ' ' + lead.lastName)}}</h6>
                        <p class="mb-0 text-muted font-size-11">{{lead.practiceArea?.replace('_', ' ') || '-'}}</p>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                          <span class="badge badge-soft-secondary font-size-10">{{getUrgencyDisplayName(lead.urgencyLevel)}}</span>
                          <span class="text-muted font-size-10">{{formatCurrency(lead.estimatedValue)}}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center text-muted font-size-12" 
                     *ngIf="getLeadCountForStage(stage.name) === 0">
                  No leads in this stage
                </div>
                <div class="text-center mt-2" *ngIf="getLeadCountForStage(stage.name) > 5">
                  <small class="text-muted">+{{getLeadCountForStage(stage.name) - 5}} more leads</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Lead Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead && isEditMode">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Lead - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <form [formGroup]="editLeadForm" (ngSubmit)="saveEditLead()">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" 
                       [class.is-invalid]="editLeadForm.get('firstName')?.invalid && editLeadForm.get('firstName')?.touched"
                       formControlName="firstName">
                <div class="invalid-feedback" *ngIf="editLeadForm.get('firstName')?.invalid && editLeadForm.get('firstName')?.touched">
                  <div *ngIf="editLeadForm.get('firstName')?.errors?.['required']">First name is required</div>
                  <div *ngIf="editLeadForm.get('firstName')?.errors?.['minlength']">First name must be at least 2 characters</div>
                  <div *ngIf="editLeadForm.get('firstName')?.errors?.['maxlength']">First name cannot exceed 50 characters</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" 
                       [class.is-invalid]="editLeadForm.get('lastName')?.invalid && editLeadForm.get('lastName')?.touched"
                       formControlName="lastName">
                <div class="invalid-feedback" *ngIf="editLeadForm.get('lastName')?.invalid && editLeadForm.get('lastName')?.touched">
                  <div *ngIf="editLeadForm.get('lastName')?.errors?.['required']">Last name is required</div>
                  <div *ngIf="editLeadForm.get('lastName')?.errors?.['minlength']">Last name must be at least 2 characters</div>
                  <div *ngIf="editLeadForm.get('lastName')?.errors?.['maxlength']">Last name cannot exceed 50 characters</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <input type="email" class="form-control" 
                       [class.is-invalid]="editLeadForm.get('email')?.invalid && editLeadForm.get('email')?.touched"
                       formControlName="email">
                <div class="invalid-feedback" *ngIf="editLeadForm.get('email')?.invalid && editLeadForm.get('email')?.touched">
                  <div *ngIf="editLeadForm.get('email')?.errors?.['required']">Email is required</div>
                  <div *ngIf="editLeadForm.get('email')?.errors?.['email']">Please enter a valid email address</div>
                  <div *ngIf="editLeadForm.get('email')?.errors?.['maxlength']">Email cannot exceed 100 characters</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" 
                       [class.is-invalid]="editLeadForm.get('phone')?.invalid && editLeadForm.get('phone')?.touched"
                       formControlName="phone">
                <div class="invalid-feedback" *ngIf="editLeadForm.get('phone')?.invalid && editLeadForm.get('phone')?.touched">
                  <div *ngIf="editLeadForm.get('phone')?.errors?.['pattern']">Please enter a valid phone number</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Company</label>
                <input type="text" class="form-control" formControlName="company">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Practice Area <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="practiceArea">
                  <option value="">Select Practice Area</option>
                  <option value="FAMILY_LAW">Family Law</option>
                  <option value="PERSONAL_INJURY">Personal Injury</option>
                  <option value="CRIMINAL_DEFENSE">Criminal Defense</option>
                  <option value="BUSINESS_LAW">Business Law</option>
                  <option value="ESTATE_PLANNING">Estate Planning</option>
                  <option value="REAL_ESTATE">Real Estate</option>
                  <option value="IMMIGRATION">Immigration</option>
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" formControlName="status">
                  <option value="">Select Status</option>
                  <option value="NEW">New</option>
                  <option value="CONTACTED">Contacted</option>
                  <option value="QUALIFIED">Qualified</option>
                  <option value="CONSULTATION_SCHEDULED">Consultation Scheduled</option>
                  <option value="PROPOSAL_SENT">Proposal Sent</option>
                  <option value="NEGOTIATION">Negotiation</option>
                  <option value="CONVERTED">Converted</option>
                  <option value="LOST">Lost</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Urgency</label>
                <select class="form-select" formControlName="urgencyLevel">
                  <option value="">Select Urgency</option>
                  <option value="LOW">Low</option>
                  <option value="MEDIUM">Medium</option>
                  <option value="HIGH">High</option>
                  <option value="URGENT">Urgent</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Estimated Value</label>
                <input type="number" class="form-control" formControlName="estimatedValue" placeholder="0">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Contact Preference</label>
                <select class="form-select" formControlName="contactPreference">
                  <option value="">Select Preference</option>
                  <option value="EMAIL">Email</option>
                  <option value="PHONE">Phone</option>
                  <option value="TEXT">Text</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Additional Fields Row -->
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Lead Source</label>
                <select class="form-select" formControlName="source">
                  <option value="">Select Source</option>
                  <option value="WEBSITE">Website</option>
                  <option value="REFERRAL">Referral</option>
                  <option value="GOOGLE_ADS">Google Ads</option>
                  <option value="SOCIAL_MEDIA">Social Media</option>
                  <option value="EMAIL_CAMPAIGN">Email Campaign</option>
                  <option value="PHONE_INQUIRY">Phone Inquiry</option>
                  <option value="WALK_IN">Walk-in</option>
                  <option value="EVENT">Event/Seminar</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Practice Area</label>
                <input type="text" class="form-control" formControlName="practiceArea" placeholder="e.g., Personal Injury, Family Law">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Lead Score</label>
                <input type="number" class="form-control" formControlName="leadScore" 
                       placeholder="0-100" min="0" max="100">
                <div class="form-text text-muted">Lead quality score (0-100)</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Initial Inquiry</label>
            <textarea class="form-control" rows="3" formControlName="initialInquiry"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" rows="3" formControlName="notes"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" (click)="closeEditModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!editLeadForm.valid">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Assign Lead Modal -->
<div class="modal fade" [class.show]="showAssignModal" [style.display]="showAssignModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assign Lead - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeAssignModal()"></button>
      </div>
      <form [formGroup]="assignForm" (ngSubmit)="submitAssignment()">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Assign To <span class="text-danger">*</span></label>
            <select class="form-select" 
                    [class.is-invalid]="assignForm.get('assignedTo')?.invalid && assignForm.get('assignedTo')?.touched"
                    formControlName="assignedTo">
              <option value="">Select Attorney</option>
              <option *ngFor="let attorney of availableAttorneys" [value]="attorney.id">
                {{attorney.firstName}} {{attorney.lastName}} ({{attorney.email}}) - {{attorney.roleName}}
              </option>
            </select>
            <div class="invalid-feedback" *ngIf="assignForm.get('assignedTo')?.invalid && assignForm.get('assignedTo')?.touched">
              Please select an attorney to assign the lead to
            </div>
            <div class="form-text text-muted" *ngIf="availableAttorneys.length === 0">
              Loading attorneys... If none appear, please check user management.
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Assignment Notes</label>
            <textarea class="form-control" rows="3" 
                      [class.is-invalid]="assignForm.get('notes')?.invalid && assignForm.get('notes')?.touched"
                      formControlName="notes" 
                      placeholder="Add any specific instructions or context for the assignee..."></textarea>
            <div class="invalid-feedback" *ngIf="assignForm.get('notes')?.invalid && assignForm.get('notes')?.touched">
              <div *ngIf="assignForm.get('notes')?.errors?.['maxlength']">Notes cannot exceed 500 characters</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" (click)="closeAssignModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!assignForm.valid">Assign Lead</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Schedule Call Modal -->
<div class="modal fade" [class.show]="showScheduleModal" [style.display]="showScheduleModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Schedule Consultation - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeScheduleModal()"></button>
      </div>
      <form [formGroup]="scheduleForm" (ngSubmit)="submitSchedule()">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Consultation Date & Time <span class="text-danger">*</span></label>
                <input type="text" 
                       id="consultationDatePicker"
                       class="form-control" 
                       placeholder="Select date and time"
                       [class.is-invalid]="scheduleForm.get('consultationDateTime')?.invalid && scheduleForm.get('consultationDateTime')?.touched"
                       formControlName="consultationDateTime"
                       readonly>
                <div class="invalid-feedback" *ngIf="scheduleForm.get('consultationDateTime')?.invalid && scheduleForm.get('consultationDateTime')?.touched">
                  Please select a consultation date and time
                </div>
                <div class="form-text text-muted">
                  <i class="ri-information-line me-1"></i>
                  Available Monday-Friday, 8:00 AM - 6:00 PM
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Consultation Type <span class="text-danger">*</span></label>
                <select class="form-select" 
                        [class.is-invalid]="scheduleForm.get('consultationType')?.invalid && scheduleForm.get('consultationType')?.touched"
                        formControlName="consultationType">
                  <option value="INITIAL_CONSULTATION">Initial Consultation</option>
                  <option value="FOLLOW_UP">Follow-up Meeting</option>
                  <option value="CASE_REVIEW">Case Review</option>
                  <option value="DOCUMENT_REVIEW">Document Review</option>
                  <option value="SETTLEMENT_DISCUSSION">Settlement Discussion</option>
                </select>
                <div class="invalid-feedback" *ngIf="scheduleForm.get('consultationType')?.invalid && scheduleForm.get('consultationType')?.touched">
                  Please select a consultation type
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" rows="3" 
                      [class.is-invalid]="scheduleForm.get('notes')?.invalid && scheduleForm.get('notes')?.touched"
                      formControlName="notes" 
                      placeholder="Add any specific details about the consultation..."></textarea>
            <div class="invalid-feedback" *ngIf="scheduleForm.get('notes')?.invalid && scheduleForm.get('notes')?.touched">
              <div *ngIf="scheduleForm.get('notes')?.errors?.['maxlength']">Notes cannot exceed 500 characters</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" (click)="closeScheduleModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!scheduleForm.valid">Schedule Consultation</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Convert Lead Modal - Three-Stage Wizard -->
<div class="modal fade" [class.show]="showConvertModal" [style.display]="showConvertModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <!-- Modal Header with Progress Indicator -->
      <div class="modal-header">
        <div class="w-100">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="modal-title mb-0">
              <i class="ri-arrow-right-circle-line me-2"></i>
              Convert Lead - {{selectedLead.fullName}}
            </h5>
            <button type="button" class="btn-close" (click)="closeConvertModal()"></button>
          </div>
          
          <!-- Progress Steps -->
          <div class="conversion-wizard-progress mt-3">
            <div class="row">
              <div class="col-4">
                <div class="step-indicator" [class.active]="conversionStep === 1" [class.completed]="conversionStep > 1">
                  <div class="step-circle">
                    <i class="ri-settings-line" *ngIf="conversionStep <= 1"></i>
                    <i class="ri-check-line" *ngIf="conversionStep > 1"></i>
                  </div>
                  <div class="step-label">Select Type</div>
                </div>
              </div>
              <div class="col-4">
                <div class="step-indicator" [class.active]="conversionStep === 2" [class.completed]="conversionStep > 2">
                  <div class="step-circle">
                    <i class="ri-file-edit-line" *ngIf="conversionStep <= 2"></i>
                    <i class="ri-check-line" *ngIf="conversionStep > 2"></i>
                  </div>
                  <div class="step-label">Enter Information</div>
                </div>
              </div>
              <div class="col-4">
                <div class="step-indicator" [class.active]="conversionStep === 3" [class.completed]="conversionStep > 3">
                  <div class="step-circle">
                    <i class="ri-eye-line" *ngIf="conversionStep <= 3"></i>
                    <i class="ri-check-line" *ngIf="conversionStep > 3"></i>
                  </div>
                  <div class="step-label">Review & Confirm</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <form [formGroup]="convertForm">
        <div class="modal-body" style="min-height: 500px;">
          
          <!-- Step 1: Conversion Type Selection -->
          <div *ngIf="conversionStep === 1">
            <div class="text-center mb-4">
              <h5 class="text-primary">{{getStepTitle()}}</h5>
              <p class="text-muted">{{getStepDescription()}}</p>
            </div>

            <div class="row">
              <div class="col-md-4" *ngFor="let type of conversionTypes">
                <div class="conversion-type-card h-100" 
                     [class.selected]="selectedConversionType === type.value"
                     (click)="onConversionTypeChange(type.value)">
                  <div class="card-icon" [style.color]="type.color">
                    <i [class]="type.icon"></i>
                  </div>
                  <h6>{{type.label}}</h6>
                  <p class="small text-muted">{{type.description}}</p>
                  <div class="selection-indicator" *ngIf="selectedConversionType === type.value">
                    <i class="ri-check-circle-fill"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- Lead Summary for Context -->
            <div class="row mt-4" *ngIf="selectedConversionType">
              <div class="col-12">
                <div class="alert alert-info">
                  <h6><i class="ri-information-line me-2"></i>Lead Summary</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <p class="mb-1"><strong>Name:</strong> {{selectedLead.fullName}}</p>
                      <p class="mb-1"><strong>Email:</strong> {{selectedLead.email || 'N/A'}}</p>
                      <p class="mb-0"><strong>Phone:</strong> {{selectedLead.phone || 'N/A'}}</p>
                    </div>
                    <div class="col-md-6">
                      <p class="mb-1"><strong>Practice Area:</strong> {{selectedLead.practiceArea?.replace('_', ' ') || 'N/A'}}</p>
                      <p class="mb-1"><strong>Status:</strong> {{getStatusDisplayName(selectedLead.status || 'NEW')}}</p>
                      <p class="mb-0"><strong>Est. Value:</strong> {{formatCurrency(selectedLead.estimatedValue)}}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Data Entry -->
          <div *ngIf="conversionStep === 2">
            <div class="text-center mb-4">
              <h5 class="text-primary">{{getStepTitle()}}</h5>
              <p class="text-muted">{{getStepDescription()}}</p>
              <div class="badge bg-info text-white">
                Converting to: {{getSelectedConversionTypeLabel()}}
              </div>
            </div>

            <!-- Validation Errors -->
            <div class="alert alert-danger" *ngIf="validationErrors.length > 0">
              <h6><i class="ri-alert-line me-2"></i>Please fix the following errors:</h6>
              <ul class="mb-0">
                <li *ngFor="let error of validationErrors">{{error}}</li>
              </ul>
            </div>

            <!-- Client Information Section -->
            <div class="row" *ngIf="selectedConversionType === 'CLIENT_ONLY' || selectedConversionType === 'CLIENT_AND_MATTER'">
              <div class="col-12">
                <h6 class="text-info border-bottom pb-2 mb-3">
                  <i class="ri-user-line me-2"></i>Client Information
                </h6>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">First Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" 
                         [class.is-invalid]="convertForm.get('clientFirstName')?.invalid && convertForm.get('clientFirstName')?.touched"
                         formControlName="clientFirstName">
                  <div class="invalid-feedback" *ngIf="convertForm.get('clientFirstName')?.invalid && convertForm.get('clientFirstName')?.touched">
                    First name is required
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Last Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" 
                         [class.is-invalid]="convertForm.get('clientLastName')?.invalid && convertForm.get('clientLastName')?.touched"
                         formControlName="clientLastName">
                  <div class="invalid-feedback" *ngIf="convertForm.get('clientLastName')?.invalid && convertForm.get('clientLastName')?.touched">
                    Last name is required
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Email <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" 
                         [class.is-invalid]="convertForm.get('clientEmail')?.invalid && convertForm.get('clientEmail')?.touched"
                         formControlName="clientEmail">
                  <div class="invalid-feedback" *ngIf="convertForm.get('clientEmail')?.invalid && convertForm.get('clientEmail')?.touched">
                    <div *ngIf="convertForm.get('clientEmail')?.errors?.['required']">Email is required</div>
                    <div *ngIf="convertForm.get('clientEmail')?.errors?.['email']">Please enter a valid email</div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Phone <span class="text-danger">*</span></label>
                  <input type="tel" class="form-control" 
                         [class.is-invalid]="convertForm.get('clientPhone')?.invalid && convertForm.get('clientPhone')?.touched"
                         formControlName="clientPhone">
                  <div class="invalid-feedback" *ngIf="convertForm.get('clientPhone')?.invalid && convertForm.get('clientPhone')?.touched">
                    Phone number is required
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Client Type <span class="text-danger">*</span></label>
                  <select class="form-select" 
                          [class.is-invalid]="convertForm.get('clientType')?.invalid && convertForm.get('clientType')?.touched"
                          formControlName="clientType">
                    <option value="">Select client type</option>
                    <option value="INDIVIDUAL">Individual</option>
                    <option value="CORPORATE">Corporate</option>
                    <option value="BUSINESS">Business</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="convertForm.get('clientType')?.invalid && convertForm.get('clientType')?.touched">
                    Client type is required
                  </div>
                </div>
              </div>
              
              <!-- Additional Client Fields for CLIENT_AND_MATTER -->
              <div *ngIf="selectedConversionType === 'CLIENT_AND_MATTER'" class="col-12">
                <h6 class="text-muted mt-3 mb-3">Additional Client Details</h6>
                <div class="row">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label class="form-label">Address</label>
                      <input type="text" class="form-control" formControlName="clientAddress">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">City</label>
                      <input type="text" class="form-control" formControlName="clientCity">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">State</label>
                      <input type="text" class="form-control" formControlName="clientState">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">ZIP Code</label>
                      <input type="text" class="form-control" formControlName="clientZip">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Occupation</label>
                      <input type="text" class="form-control" formControlName="clientOccupation">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Employer</label>
                      <input type="text" class="form-control" formControlName="clientEmployer">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Case/Matter Information Section -->
            <div class="row" *ngIf="selectedConversionType === 'MATTER_ONLY' || selectedConversionType === 'CLIENT_AND_MATTER'">
              <div class="col-12">
                <h6 class="text-warning border-bottom pb-2 mb-3">
                  <i class="ri-briefcase-line me-2"></i>Case/Matter Information
                </h6>
              </div>
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label">Case Title <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" 
                         [class.is-invalid]="convertForm.get('caseTitle')?.invalid && convertForm.get('caseTitle')?.touched"
                         formControlName="caseTitle" 
                         placeholder="Brief title describing the case">
                  <div class="invalid-feedback" *ngIf="convertForm.get('caseTitle')?.invalid && convertForm.get('caseTitle')?.touched">
                    Case title is required
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label">Case Description <span class="text-danger">*</span></label>
                  <textarea class="form-control" rows="4" 
                            [class.is-invalid]="convertForm.get('caseDescription')?.invalid && convertForm.get('caseDescription')?.touched"
                            formControlName="caseDescription" 
                            placeholder="Detailed description of the legal matter"></textarea>
                  <div class="invalid-feedback" *ngIf="convertForm.get('caseDescription')?.invalid && convertForm.get('caseDescription')?.touched">
                    Case description is required
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Practice Area <span class="text-danger">*</span></label>
                    <select class="form-select" 
                            [class.is-invalid]="convertForm.get('practiceArea')?.invalid && convertForm.get('practiceArea')?.touched"
                            formControlName="practiceArea">
                      <option value="">Select Practice Area</option>
                      <option value="FAMILY_LAW">Family Law</option>
                      <option value="PERSONAL_INJURY">Personal Injury</option>
                      <option value="CRIMINAL_DEFENSE">Criminal Defense</option>
                      <option value="BUSINESS_LAW">Business Law</option>
                      <option value="ESTATE_PLANNING">Estate Planning</option>
                      <option value="REAL_ESTATE">Real Estate</option>
                      <option value="IMMIGRATION">Immigration</option>
                      <option value="EMPLOYMENT_LAW">Employment Law</option>
                      <option value="INTELLECTUAL_PROPERTY">Intellectual Property</option>
                      <option value="CORPORATE_LAW">Corporate Law</option>
                      <option value="BANKRUPTCY">Bankruptcy</option>
                      <option value="OTHER">Other</option>
                    </select>
                    <div class="invalid-feedback" *ngIf="convertForm.get('practiceArea')?.invalid && convertForm.get('practiceArea')?.touched">
                      Practice area is required
                    </div>
                  </div>
                </div>
              </div>

              <!-- Additional Case Fields for CLIENT_AND_MATTER -->
              <div *ngIf="selectedConversionType === 'CLIENT_AND_MATTER'" class="col-12">
                <h6 class="text-muted mt-3 mb-3">Additional Case Details</h6>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Jurisdiction</label>
                      <input type="text" class="form-control" formControlName="jurisdiction" placeholder="Court jurisdiction">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">County Name</label>
                      <input type="text" class="form-control" formControlName="countyName">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Opposing Party</label>
                      <input type="text" class="form-control" formControlName="opposingParty">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Opposing Counsel</label>
                      <input type="text" class="form-control" formControlName="opposingCounsel">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Retainer Amount</label>
                      <input type="number" class="form-control" formControlName="retainerAmount" placeholder="0">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Hourly Rate</label>
                      <input type="number" class="form-control" formControlName="hourlyRate" placeholder="0">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Urgency</label>
                      <select class="form-select" formControlName="urgencyLevel">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                        <option value="URGENT">Urgent</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- General Notes -->
            <div class="row">
              <div class="col-12">
                <h6 class="text-secondary border-bottom pb-2 mb-3">
                  <i class="ri-file-text-line me-2"></i>Additional Information
                </h6>
                <div class="mb-3">
                  <label class="form-label">Conversion Notes</label>
                  <textarea class="form-control" rows="3" formControlName="conversionNotes" 
                            placeholder="Any additional notes about this conversion..."></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3: Review & Confirmation -->
          <div *ngIf="conversionStep === 3">
            <div class="text-center mb-4">
              <h5 class="text-primary">{{getStepTitle()}}</h5>
              <p class="text-muted">{{getStepDescription()}}</p>
              <div class="badge bg-success text-white">
                Ready to convert to: {{getSelectedConversionTypeLabel()}}
              </div>
            </div>

            <!-- Conflict Check Results -->
            <div class="alert" 
                 [class.alert-success]="conflictCheckResult && !conflictCheckResult.hasConflicts && !conflictCheckResult.checkFailed"
                 [class.alert-warning]="conflictCheckResult && (conflictCheckResult.hasConflicts || conflictCheckResult.checkFailed)">
              <h6>
                <i class="ri-shield-check-line me-2" *ngIf="conflictCheckResult && !conflictCheckResult.hasConflicts && !conflictCheckResult.checkFailed"></i>
                <i class="ri-alert-line me-2" *ngIf="conflictCheckResult && (conflictCheckResult.hasConflicts || conflictCheckResult.checkFailed)"></i>
                Conflict Check Results
              </h6>
              <p class="mb-0" *ngIf="conflictCheckResult && !conflictCheckResult.hasConflicts && !conflictCheckResult.checkFailed">
                No conflicts detected. Safe to proceed with conversion.
              </p>
              <p class="mb-0" *ngIf="conflictCheckResult && conflictCheckResult.hasConflicts && !conflictCheckResult.checkFailed">
                {{conflictCheckResult.conflicts?.length || 0}} conflict(s) detected. Conversion may proceed with administrator approval or caution.
              </p>
              <p class="mb-0" *ngIf="conflictCheckResult && conflictCheckResult.hasConflicts && conflictCheckResult.proceedDespiteConflicts">
                <i class="ri-alert-line me-1 text-warning"></i>
                {{conflictCheckResult.conflicts?.length || 0}} conflict(s) detected - proceeding with administrator override.
              </p>
              <p class="mb-0" *ngIf="conflictCheckResult && conflictCheckResult.checkFailed">
                <i class="ri-information-line me-1"></i>{{conflictCheckResult.warning}}
              </p>
              <div *ngIf="conflictCheckResult && conflictCheckResult.hasConflicts && conflictCheckResult.conflicts && conflictCheckResult.conflicts.length > 0" class="mt-2">
                <strong>Conflict Details:</strong>
                <ul class="mt-1 mb-0">
                  <li *ngFor="let conflict of conflictCheckResult.conflicts" class="small text-danger">
                    <strong>{{formatConflictTypeForDisplay(conflict.type)}}:</strong> {{formatConflictDescription(conflict.description)}}
                  </li>
                </ul>
              </div>
            </div>

            <!-- Review Summary -->
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Conversion Review</h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6 class="text-primary">Lead Information</h6>
                        <p><strong>Name:</strong> {{selectedLead.fullName}}</p>
                        <p><strong>Email:</strong> {{selectedLead.email || 'N/A'}}</p>
                        <p><strong>Phone:</strong> {{selectedLead.phone || 'N/A'}}</p>
                        <p><strong>Current Status:</strong> {{getStatusDisplayName(selectedLead.status || 'NEW')}}</p>
                        <p><strong>Practice Area:</strong> {{selectedLead.practiceArea?.replace('_', ' ') || 'N/A'}}</p>
                      </div>
                      <div class="col-md-6">
                        <h6 class="text-primary">Conversion Details</h6>
                        <p><strong>Type:</strong> {{getSelectedConversionTypeLabel()}}</p>
                        <p><strong>Will Create:</strong> 
                          <span *ngIf="selectedConversionType === 'CLIENT_ONLY'">Client Record</span>
                          <span *ngIf="selectedConversionType === 'MATTER_ONLY'">Case/Matter Record</span>
                          <span *ngIf="selectedConversionType === 'CLIENT_AND_MATTER'">Client & Case Records</span>
                        </p>
                        <p><strong>New Lead Status:</strong> CONVERTED</p>
                      </div>
                    </div>
                    
                    <!-- Client Information Review -->
                    <div *ngIf="selectedConversionType === 'CLIENT_ONLY' || selectedConversionType === 'CLIENT_AND_MATTER'" class="mt-4">
                      <h6 class="text-info border-bottom pb-2 mb-3">Client Information to be Created</h6>
                      <div class="row">
                        <div class="col-md-6">
                          <p><strong>Name:</strong> {{convertForm.get('clientFirstName')?.value}} {{convertForm.get('clientLastName')?.value}}</p>
                          <p><strong>Email:</strong> {{convertForm.get('clientEmail')?.value}}</p>
                          <p><strong>Phone:</strong> {{convertForm.get('clientPhone')?.value || 'N/A'}}</p>
                        </div>
                        <div class="col-md-6">
                          <p *ngIf="convertForm.get('clientAddress')?.value"><strong>Address:</strong> {{convertForm.get('clientAddress')?.value}}</p>
                          <p *ngIf="convertForm.get('clientOccupation')?.value"><strong>Occupation:</strong> {{convertForm.get('clientOccupation')?.value}}</p>
                          <p *ngIf="convertForm.get('clientEmployer')?.value"><strong>Employer:</strong> {{convertForm.get('clientEmployer')?.value}}</p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Case Information Review -->
                    <div *ngIf="selectedConversionType === 'MATTER_ONLY' || selectedConversionType === 'CLIENT_AND_MATTER'" class="mt-4">
                      <h6 class="text-warning border-bottom pb-2 mb-3">Case Information to be Created</h6>
                      <div class="row">
                        <div class="col-md-6">
                          <p><strong>Title:</strong> {{convertForm.get('caseTitle')?.value}}</p>
                          <p><strong>Practice Area:</strong> {{convertForm.get('practiceArea')?.value?.replace('_', ' ') || 'N/A'}}</p>
                        </div>
                        <div class="col-md-6">
                          <p *ngIf="convertForm.get('retainerAmount')?.value"><strong>Retainer:</strong> ${{convertForm.get('retainerAmount')?.value}}</p>
                          <p *ngIf="convertForm.get('urgencyLevel')?.value"><strong>Urgency:</strong> {{convertForm.get('urgencyLevel')?.value}}</p>
                          <p *ngIf="convertForm.get('jurisdiction')?.value"><strong>Jurisdiction:</strong> {{convertForm.get('jurisdiction')?.value}}</p>
                        </div>
                      </div>
                      <div *ngIf="convertForm.get('caseDescription')?.value" class="mt-2">
                        <p><strong>Description:</strong></p>
                        <div class="bg-light p-2 rounded small">{{convertForm.get('caseDescription')?.value}}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Footer with Navigation -->
        <div class="modal-footer">
          <div class="w-100 d-flex justify-content-between align-items-center">
            <div>
              <button type="button" class="btn btn-outline-secondary" (click)="closeConvertModal()">
                <i class="ri-close-line me-1"></i>Cancel
              </button>
            </div>
            
            <div class="step-info text-muted small">
              Step {{conversionStep}} of {{maxSteps}}
            </div>
            
            <div>
              <button type="button" class="btn btn-outline-primary me-2" 
                      *ngIf="canGoToPreviousStep()" 
                      (click)="previousStep()">
                <i class="ri-arrow-left-line me-1"></i>Previous
              </button>
              
              <button type="button" class="btn btn-primary" 
                      *ngIf="conversionStep < 3 && canGoToNextStep()" 
                      (click)="nextStep()">
                Next<i class="ri-arrow-right-line ms-1"></i>
              </button>
              
              <button type="button" class="btn btn-success" 
                      *ngIf="conversionStep === 3" 
                      (click)="submitConversion()"
                      [disabled]="conversionInProgress">
                <span *ngIf="!conversionInProgress">
                  <i class="ri-check-line me-1"></i>Convert Lead
                </span>
                <span *ngIf="conversionInProgress">
                  <i class="spinner-border spinner-border-sm me-1"></i>Converting...
                </span>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showLeadModal || showPipelineModal || showEditModal || showAssignModal || showScheduleModal || showConvertModal"></div>

<!-- Custom Styles -->
<style>
  /* Conversion Wizard Progress Styling */
  .conversion-wizard-progress {
    margin-top: 15px;
    padding: 15px 0;
    border-top: 1px solid #e9ecef;
  }
  
  .step-indicator {
    text-align: center;
    position: relative;
  }
  
  .step-indicator::before {
    content: '';
    position: absolute;
    top: 25px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: #dee2e6;
    z-index: 1;
  }
  
  .step-indicator:first-child::before {
    left: 100%;
    width: 50%;
  }
  
  .step-indicator:last-child::before {
    width: 50%;
  }
  
  .step-indicator.completed::before {
    background: #28a745;
  }
  
  .step-indicator.active::before {
    background: #007bff;
  }
  
  .step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    position: relative;
    z-index: 2;
    font-size: 18px;
    color: #6c757d;
  }
  
  .step-indicator.active .step-circle {
    background: #007bff;
    border-color: #007bff;
    color: white;
  }
  
  .step-indicator.completed .step-circle {
    background: #28a745;
    border-color: #28a745;
    color: white;
  }
  
  .step-label {
    font-size: 12px;
    font-weight: 500;
    color: #6c757d;
  }
  
  .step-indicator.active .step-label {
    color: #007bff;
    font-weight: 600;
  }
  
  .step-indicator.completed .step-label {
    color: #28a745;
    font-weight: 600;
  }
  
  /* Conversion Type Cards */
  .conversion-type-card {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    margin-bottom: 20px;
    background: #fff;
  }
  
  .conversion-type-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
    transform: translateY(-2px);
  }
  
  .conversion-type-card.selected {
    border-color: #28a745;
    background: #f8fff9;
    box-shadow: 0 4px 20px rgba(40, 167, 69, 0.15);
  }
  
  .conversion-type-card .card-icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.7;
  }
  
  .conversion-type-card.selected .card-icon {
    opacity: 1;
  }
  
  .conversion-type-card h6 {
    margin-bottom: 10px;
    font-weight: 600;
    color: #495057;
  }
  
  .conversion-type-card.selected h6 {
    color: #28a745;
  }
  
  .conversion-type-card .selection-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    color: #28a745;
    font-size: 24px;
  }
  
  /* Conversion Progress Styling */
  .conversion-progress {
    text-align: left;
    margin: 20px 0;
  }
  
  .conversion-progress .step {
    padding: 8px 16px;
    margin: 5px 0;
    border-radius: 5px;
    background: #f8f9fa;
    color: #6c757d;
    border-left: 4px solid #dee2e6;
  }
  
  .conversion-progress .step.active {
    background: #fff3cd;
    color: #856404;
    border-left-color: #ffc107;
  }
  
  .conversion-progress .step.completed {
    background: #d1edff;
    color: #155724;
    border-left-color: #28a745;
  }
  
  /* Conflict Check Progress */
  .conflict-check-progress {
    text-align: center;
    padding: 20px;
  }
  
  .conflict-check-progress .progress {
    height: 8px;
    border-radius: 10px;
  }
  
  .conflict-check-progress .progress-bar {
    border-radius: 10px;
  }
  
  /* Flatpickr Customization */
  .crm-datepicker {
    z-index: 9999 !important;
  }
  
  .crm-datepicker .flatpickr-day.selected {
    background: #007bff;
    border-color: #007bff;
  }
  
  .crm-datepicker .flatpickr-day:hover {
    background: #e9ecef;
  }
  
  /* Conversion Confirmation Popup */
  .conversion-confirmation-popup {
    font-size: 14px;
  }
  
  .conversion-confirmation-popup .swal2-html-container {
    text-align: left;
  }
  
  /* Form Validation Enhancements */
  .form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }
  
  .form-select.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }
  
  .invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
  }
  
  /* Modal Enhancements */
  .modal-header {
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
  }
  
  /* Step Navigation */
  .step-info {
    font-weight: 500;
  }
  
  /* Badge Enhancements */
  .badge {
    font-size: 12px;
    padding: 8px 12px;
  }
  
  /* Alert Enhancements */
  .alert h6 {
    margin-bottom: 8px;
    font-weight: 600;
  }
  
  .alert p:last-child {
    margin-bottom: 0;
  }
  
  .modal-footer {
    border-top: 1px solid #dee2e6;
    background: #f8f9fa;
  }
  
  /* Priority Badge Pulse Animation */
  .priority-urgent-pulse {
    animation: pulse-urgent 2s infinite;
  }
  
  @keyframes pulse-urgent {
    0% {
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
  }
  
  /* Dropdown Enhancement */
  .dropdown-menu {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  
  .dropdown-item:hover {
    background-color: #f8f9fa;
  }
</style>