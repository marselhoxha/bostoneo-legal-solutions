<div class="container-fluid" style="margin-top: 120px;">
  <!-- Header -->
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-flex align-items-center justify-content-between">
        <h4 class="mb-0">Lead Management Dashboard</h4>
        <div class="page-title-right">
          <button type="button" class="btn btn-primary btn-sm" (click)="showPipelineView()">
            <i class="ri-stack-line me-1"></i>Pipeline View
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pipeline Summary Cards -->
  <div class="row" *ngIf="pipelineSummary">
    <div class="col-xl-3 col-md-6" *ngFor="let stage of pipelineStages?.slice(0, 4)">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">{{stage.name}}</p>
              <h4 class="mb-0">{{getLeadCountForStage(stage.name)}}</h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle" [style.background-color]="stage.color + '20'">
                <span class="avatar-title rounded-circle" [style.background-color]="stage.color">
                  <i [class]="stage.icon" class="font-size-16" style="color: white;"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row g-3 align-items-center">
            <div class="col-lg-2 col-md-6">
              <select class="form-select form-select-sm" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
                <option value="">All Status</option>
                <option value="NEW">New</option>
                <option value="CONTACTED">Contacted</option>
                <option value="QUALIFIED">Qualified</option>
                <option value="CONSULTATION_SCHEDULED">Consultation</option>
                <option value="PROPOSAL_SENT">Proposal Sent</option>
                <option value="NEGOTIATING">Negotiating</option>
                <option value="CONVERTED">Converted</option>
                <option value="LOST">Lost</option>
                <option value="UNRESPONSIVE">Unresponsive</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-6">
              <select class="form-select form-select-sm" [(ngModel)]="selectedPriority" (change)="onFilterChange()">
                <option value="">All Priority</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-6">
              <select class="form-select form-select-sm" [(ngModel)]="selectedPracticeArea" (change)="onFilterChange()">
                <option value="">All Practice Areas</option>
                <option value="FAMILY_LAW">Family Law</option>
                <option value="PERSONAL_INJURY">Personal Injury</option>
                <option value="CRIMINAL_DEFENSE">Criminal Defense</option>
                <option value="BUSINESS_LAW">Business Law</option>
                <option value="ESTATE_PLANNING">Estate Planning</option>
                <option value="REAL_ESTATE">Real Estate</option>
                <option value="IMMIGRATION">Immigration</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-6">
              <input type="text" class="form-control form-control-sm" placeholder="Assigned To" [(ngModel)]="selectedAssignedTo" (input)="onFilterChange()">
            </div>
            <div class="col-lg-2 col-md-6">
              <button type="button" class="btn btn-light btn-sm w-100" (click)="clearFilters()">
                <i class="ri-refresh-line me-1"></i>Clear
              </button>
            </div>
            <div class="col-lg-2 col-md-6">
              <div class="text-muted small text-end">
                Total: <strong>{{totalItems}}</strong> leads
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leads Table -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive" *ngIf="!loading; else loadingTemplate">
            <table class="table table-nowrap table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="cursor-pointer" (click)="onSort('fullName')">
                    Lead Name
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('status')">
                    Status
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('priority')">
                    Priority
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('practiceArea')">
                    Practice Area
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('leadScore')">
                    Score
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th>Assigned To</th>
                  <th class="cursor-pointer" (click)="onSort('estimatedValue')">
                    Est. Value
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('createdAt')">
                    Created
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let lead of paginatedLeads">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar-xs me-3">
                        <span class="avatar-title rounded-circle bg-soft-primary text-primary">
                          {{lead.firstName?.charAt(0) || 'L'}}{{lead.lastName?.charAt(0) || ''}}
                        </span>
                      </div>
                      <div>
                        <h6 class="mb-0">{{lead.fullName || (lead.firstName + ' ' + lead.lastName)}}</h6>
                        <p class="text-muted mb-0" *ngIf="lead.company">{{lead.company}}</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="badge" [class]="getStatusBadgeClass(lead.status)">
                      {{lead.status?.replace('_', ' ')}}
                    </span>
                  </td>
                  <td>
                    <span class="badge" [class]="getPriorityBadgeClass(lead.priority)" *ngIf="lead.priority">
                      {{lead.priority}}
                    </span>
                    <span class="text-muted" *ngIf="!lead.priority">-</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{lead.practiceArea?.replace('_', ' ') || '-'}}</span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center" *ngIf="lead.leadScore">
                      <div class="flex-shrink-0">
                        <span class="badge bg-success" *ngIf="lead.leadScore >= 80">{{lead.leadScore}}</span>
                        <span class="badge bg-warning" *ngIf="lead.leadScore >= 60 && lead.leadScore < 80">{{lead.leadScore}}</span>
                        <span class="badge bg-danger" *ngIf="lead.leadScore < 60">{{lead.leadScore}}</span>
                      </div>
                    </div>
                    <span class="text-muted" *ngIf="!lead.leadScore">-</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{lead.assignedToName || '-'}}</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{formatCurrency(lead.estimatedValue)}}</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{formatDate(lead.createdAt)}}</span>
                  </td>
                  <td>
                    <div class="dropdown">
                      <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Actions
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" (click)="viewLead(lead); $event.preventDefault()">
                          <i class="ri-eye-line me-2"></i>View Details
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" (click)="editLead(lead); $event.preventDefault()">
                          <i class="ri-edit-2-line me-2"></i>Edit Lead
                        </a></li>
                        <li><a class="dropdown-item" href="#" (click)="assignLead(lead); $event.preventDefault()">
                          <i class="ri-user-add-line me-2"></i>Assign
                        </a></li>
                        <li><a class="dropdown-item" href="#" (click)="scheduleCall(lead); $event.preventDefault()">
                          <i class="ri-calendar-2-line me-2"></i>Schedule Call
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-success" href="#" (click)="convertLead(lead); $event.preventDefault()">
                          <i class="ri-arrow-right-circle-line me-2"></i>Convert
                        </a></li>
                      </ul>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Loading Template -->
          <ng-template #loadingTemplate>
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <p class="text-muted mt-2">Loading leads...</p>
            </div>
          </ng-template>

          <!-- Empty State -->
          <div class="text-center py-4" *ngIf="!loading && paginatedLeads.length === 0">
            <i class="ri-user-search-line display-4 text-muted"></i>
            <h5 class="mt-3">No leads found</h5>
            <p class="text-muted">Try adjusting your filters or search criteria.</p>
          </div>

          <!-- Pagination -->
          <div class="row align-items-center mt-3" *ngIf="totalPages > 1">
            <div class="col-md-6">
              <div class="text-muted">
                {{ pageInfo }}
              </div>
            </div>
            <div class="col-md-6">
              <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm justify-content-end mb-0">
                  <li class="page-item" [class.disabled]="!hasPreviousPage">
                    <a class="page-link" href="#" (click)="previousPage(); $event.preventDefault()">
                      Previous
                    </a>
                  </li>
                  <li class="page-item active">
                    <span class="page-link">{{ currentPage + 1 }}</span>
                  </li>
                  <li class="page-item" [class.disabled]="!hasNextPage">
                    <a class="page-link" href="#" (click)="nextPage(); $event.preventDefault()">
                      Next
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lead Details Modal -->
<div class="modal fade" [class.show]="showLeadModal" [style.display]="showLeadModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Lead Details - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeLeadModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Contact Information</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Email:</strong> {{selectedLead.email || '-'}}</div>
                <div class="mb-2"><strong>Phone:</strong> {{selectedLead.phone || '-'}}</div>
                <div class="mb-2"><strong>Company:</strong> {{selectedLead.company || '-'}}</div>
                <div class="mb-0"><strong>Preferred Contact:</strong> {{selectedLead.contactPreference || '-'}}</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Lead Information</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Status:</strong> 
                  <span class="badge ms-2" [class]="getStatusBadgeClass(selectedLead.status)">
                    {{selectedLead.status?.replace('_', ' ')}}
                  </span>
                </div>
                <div class="mb-2"><strong>Priority:</strong> 
                  <span class="badge ms-2" [class]="getPriorityBadgeClass(selectedLead.priority)" *ngIf="selectedLead.priority">
                    {{selectedLead.priority}}
                  </span>
                  <span *ngIf="!selectedLead.priority">-</span>
                </div>
                <div class="mb-2"><strong>Lead Score:</strong> {{selectedLead.leadScore || '-'}}</div>
                <div class="mb-0"><strong>Source:</strong> {{selectedLead.source || '-'}}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Case Details</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Practice Area:</strong> {{selectedLead.practiceArea?.replace('_', ' ') || '-'}}</div>
                <div class="mb-2"><strong>Case Type:</strong> {{selectedLead.caseType || '-'}}</div>
                <div class="mb-0"><strong>Estimated Value:</strong> {{formatCurrency(selectedLead.estimatedValue)}}</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Timeline</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Created:</strong> {{formatDateTime(selectedLead.createdAt)}}</div>
                <div class="mb-2"><strong>Last Contact:</strong> {{formatDateTime(selectedLead.lastContactDate)}}</div>
                <div class="mb-2"><strong>Contact Attempts:</strong> {{selectedLead.contactAttempts || 0}}</div>
                <div class="mb-0"><strong>Follow-up Date:</strong> {{formatDate(selectedLead.followUpDate)}}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row" *ngIf="selectedLead.initialInquiry || selectedLead.notes">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label fw-semibold">Notes & Inquiry</label>
              <div class="border rounded p-3">
                <div class="mb-2" *ngIf="selectedLead.initialInquiry">
                  <strong>Initial Inquiry:</strong>
                  <p class="mb-0 mt-1">{{selectedLead.initialInquiry}}</p>
                </div>
                <div *ngIf="selectedLead.notes">
                  <strong>Notes:</strong>
                  <p class="mb-0 mt-1">{{selectedLead.notes}}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="closeLeadModal()">Close</button>
        <button type="button" class="btn btn-primary">Edit Lead</button>
        <button type="button" class="btn btn-success">Convert</button>
      </div>
    </div>
  </div>
</div>

<!-- Pipeline Modal -->
<div class="modal fade" [class.show]="showPipelineModal" [style.display]="showPipelineModal ? 'block' : 'none'" 
     tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Lead Pipeline View</h5>
        <button type="button" class="btn-close" (click)="closePipelineModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-3" *ngFor="let stage of pipelineStages">
            <div class="card mb-3">
              <div class="card-header" [style.background-color]="stage.color + '20'">
                <h6 class="mb-0" [style.color]="stage.color">
                  <i [class]="stage.icon" class="me-2"></i>
                  {{stage.name}}
                  <span class="badge badge-soft-secondary ms-2">{{getLeadCountForStage(stage.name)}}</span>
                </h6>
              </div>
              <div class="card-body p-2" style="min-height: 400px;">
                <div class="mb-2" *ngFor="let lead of filteredLeads | slice:0:5">
                  <div class="border rounded p-2" *ngIf="lead.status === stage.name.toUpperCase().replace(' ', '_')">
                    <div class="d-flex align-items-center">
                      <div class="avatar-xs me-2">
                        <span class="avatar-title rounded-circle bg-soft-primary text-primary font-size-12">
                          {{lead.firstName?.charAt(0) || 'L'}}{{lead.lastName?.charAt(0) || ''}}
                        </span>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-1 font-size-12">{{lead.fullName}}</h6>
                        <p class="mb-0 text-muted font-size-11">{{lead.practiceArea?.replace('_', ' ')}}</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center text-muted font-size-12" 
                     *ngIf="getLeadCountForStage(stage.name) === 0">
                  No leads in this stage
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showLeadModal || showPipelineModal"></div>