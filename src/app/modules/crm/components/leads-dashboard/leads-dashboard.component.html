<div class="container-fluid" style="margin-top: 120px;">
  <!-- Header -->
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-flex align-items-center justify-content-between">
        <h4 class="mb-0">Lead Management Dashboard</h4>
        <div class="page-title-right">
          <button type="button" class="btn btn-primary btn-sm" (click)="showPipelineView()">
            <i class="ri-stack-line me-1"></i>Pipeline View
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pipeline Summary Cards -->
  <div class="row" *ngIf="pipelineSummary">
    <div class="col-xl-3 col-md-6" *ngFor="let stage of pipelineStages?.slice(0, 4)">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">{{stage.name}}</p>
              <h4 class="mb-0">{{getLeadCountForStage(stage.name)}}</h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle" [style.background-color]="stage.color + '20'">
                <span class="avatar-title rounded-circle" [style.background-color]="stage.color">
                  <i [class]="stage.icon" class="font-size-16" style="color: white;"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row g-3 align-items-center">
            <div class="col-lg-2 col-md-6">
              <select class="form-select form-select-sm" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
                <option value="">All Status</option>
                <option value="NEW">New</option>
                <option value="CONTACTED">Contacted</option>
                <option value="QUALIFIED">Qualified</option>
                <option value="CONSULTATION_SCHEDULED">Consultation Scheduled</option>
                <option value="PROPOSAL_SENT">Proposal Sent</option>
                <option value="NEGOTIATION">Negotiation</option>
                <option value="CONVERTED">Converted</option>
                <option value="LOST">Lost</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-6">
              <select class="form-select form-select-sm" [(ngModel)]="selectedPriority" (change)="onFilterChange()">
                <option value="">All Priority</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-6">
              <select class="form-select form-select-sm" [(ngModel)]="selectedPracticeArea" (change)="onFilterChange()">
                <option value="">All Practice Areas</option>
                <option value="FAMILY_LAW">Family Law</option>
                <option value="PERSONAL_INJURY">Personal Injury</option>
                <option value="CRIMINAL_DEFENSE">Criminal Defense</option>
                <option value="BUSINESS_LAW">Business Law</option>
                <option value="ESTATE_PLANNING">Estate Planning</option>
                <option value="REAL_ESTATE">Real Estate</option>
                <option value="IMMIGRATION">Immigration</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-6">
              <input type="text" class="form-control form-control-sm" placeholder="Assigned To" [(ngModel)]="selectedAssignedTo" (input)="onFilterChange()">
            </div>
            <div class="col-lg-2 col-md-6">
              <button type="button" class="btn btn-light btn-sm w-100" (click)="clearFilters()">
                <i class="ri-refresh-line me-1"></i>Clear
              </button>
            </div>
            <div class="col-lg-2 col-md-6">
              <div class="text-muted small text-end">
                Total: <strong>{{totalItems}}</strong> leads
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leads Table -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive" *ngIf="!loading; else loadingTemplate">
            <table class="table table-nowrap table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="cursor-pointer" (click)="onSort('fullName')">
                    Lead Name
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('status')">
                    Status
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('priority')">
                    Priority
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('practiceArea')">
                    Practice Area
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('leadScore')">
                    Score
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th>Assigned To</th>
                  <th class="cursor-pointer" (click)="onSort('estimatedValue')">
                    Est. Value
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th class="cursor-pointer" (click)="onSort('createdAt')">
                    Created
                    <i class="ri-arrow-up-down-line ms-1"></i>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let lead of paginatedLeads">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar-xs me-3">
                        <span class="avatar-title rounded-circle bg-soft-primary text-primary">
                          {{lead.firstName?.charAt(0) || 'L'}}{{lead.lastName?.charAt(0) || ''}}
                        </span>
                      </div>
                      <div>
                        <h6 class="mb-0">{{lead.fullName || (lead.firstName + ' ' + lead.lastName)}}</h6>
                        <p class="text-muted mb-0" *ngIf="lead.company">{{lead.company}}</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="badge" [class]="getStatusBadgeClass(lead.status)"
                          [title]="'Valid next steps: ' + getValidNextStatuses(lead.status || 'NEW').join(', ')">
                      {{getStatusDisplayName(lead.status || 'NEW')}}
                      <i class="ri-lock-line ms-1" *ngIf="getValidNextStatuses(lead.status || 'NEW').length === 0" title="Final status"></i>
                    </span>
                  </td>
                  <td>
                    <span class="badge" [class]="getPriorityBadgeClass(lead.priority)" *ngIf="lead.priority">
                      {{lead.priority}}
                    </span>
                    <span class="text-muted" *ngIf="!lead.priority">-</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{lead.practiceArea?.replace('_', ' ') || '-'}}</span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center" *ngIf="lead.leadScore">
                      <div class="flex-shrink-0">
                        <span class="badge bg-success" *ngIf="lead.leadScore >= 80">{{lead.leadScore}}</span>
                        <span class="badge bg-warning" *ngIf="lead.leadScore >= 60 && lead.leadScore < 80">{{lead.leadScore}}</span>
                        <span class="badge bg-danger" *ngIf="lead.leadScore < 60">{{lead.leadScore}}</span>
                      </div>
                    </div>
                    <span class="text-muted" *ngIf="!lead.leadScore">-</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{lead.assignedToName || '-'}}</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{formatCurrency(lead.estimatedValue)}}</span>
                  </td>
                  <td>
                    <span class="text-muted small">{{formatDate(lead.createdAt)}}</span>
                  </td>
                  <td>
                    <div class="dropdown">
                      <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Actions
                      </button>
                      <ul class="dropdown-menu">
                        <!-- Always show View Details -->
                        <li><a class="dropdown-item" href="#" (click)="viewLead(lead); $event.preventDefault()">
                          <i class="ri-eye-line me-2"></i>View Details
                        </a></li>
                        
                        <!-- Edit Lead - only if not converted -->
                        <li *ngIf="canEditLead(lead)"><hr class="dropdown-divider"></li>
                        <li *ngIf="canEditLead(lead)"><a class="dropdown-item" href="#" (click)="editLead(lead); $event.preventDefault()">
                          <i class="ri-edit-2-line me-2"></i>Edit Lead
                        </a></li>
                        
                        <!-- Assignment - only if not in final states -->
                        <li *ngIf="canAssignLead(lead)"><a class="dropdown-item" href="#" (click)="assignLead(lead); $event.preventDefault()">
                          <i class="ri-user-add-line me-2"></i>Assign to Attorney
                        </a></li>
                        
                        <!-- Schedule Consultation - only if valid transition -->
                        <li *ngIf="canScheduleConsultation(lead)"><a class="dropdown-item" href="#" (click)="scheduleCall(lead); $event.preventDefault()">
                          <i class="ri-calendar-2-line me-2"></i>Schedule Consultation
                        </a></li>
                        
                        <!-- Convert - only if valid transition -->
                        <li *ngIf="canConvertLead(lead)"><hr class="dropdown-divider"></li>
                        <li *ngIf="canConvertLead(lead)"><a class="dropdown-item text-success" href="#" (click)="convertLead(lead); $event.preventDefault()">
                          <i class="ri-arrow-right-circle-line me-2"></i>Convert to Client
                        </a></li>
                        
                        <!-- Status information -->
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">
                          Status: {{getStatusDisplayName(lead.status || 'NEW')}}
                        </h6></li>
                        <li *ngIf="getValidNextStatuses(lead.status || 'NEW').length === 0">
                          <span class="dropdown-item-text text-muted small">
                            <i class="ri-lock-line me-1"></i>Lead in final status
                          </span>
                        </li>
                        <li *ngIf="getValidNextStatuses(lead.status || 'NEW').length > 0">
                          <span class="dropdown-item-text text-muted small">
                            <i class="ri-information-line me-1"></i>Next: {{getFormattedNextStatuses(lead.status || 'NEW')}}
                          </span>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Loading Template -->
          <ng-template #loadingTemplate>
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <p class="text-muted mt-2">Loading leads...</p>
            </div>
          </ng-template>

          <!-- Empty State -->
          <div class="text-center py-4" *ngIf="!loading && paginatedLeads.length === 0">
            <i class="ri-user-search-line display-4 text-muted"></i>
            <h5 class="mt-3">No leads found</h5>
            <p class="text-muted">Try adjusting your filters or search criteria.</p>
          </div>

          <!-- Pagination -->
          <div class="row align-items-center mt-3" *ngIf="totalPages > 1">
            <div class="col-md-6">
              <div class="text-muted">
                {{ pageInfo }}
              </div>
            </div>
            <div class="col-md-6">
              <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm justify-content-end mb-0">
                  <li class="page-item" [class.disabled]="!hasPreviousPage">
                    <a class="page-link" href="#" (click)="previousPage(); $event.preventDefault()">
                      Previous
                    </a>
                  </li>
                  <li class="page-item active">
                    <span class="page-link">{{ currentPage + 1 }}</span>
                  </li>
                  <li class="page-item" [class.disabled]="!hasNextPage">
                    <a class="page-link" href="#" (click)="nextPage(); $event.preventDefault()">
                      Next
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lead Details Modal -->
<div class="modal fade" [class.show]="showLeadModal" [style.display]="showLeadModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Lead Details - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeLeadModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Contact Information</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Email:</strong> {{selectedLead.email || '-'}}</div>
                <div class="mb-2"><strong>Phone:</strong> {{selectedLead.phone || '-'}}</div>
                <div class="mb-2"><strong>Company:</strong> {{selectedLead.company || '-'}}</div>
                <div class="mb-0"><strong>Preferred Contact:</strong> {{selectedLead.contactPreference || '-'}}</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Lead Information</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Status:</strong> 
                  <span class="badge ms-2" [class]="getStatusBadgeClass(selectedLead.status)">
                    {{selectedLead.status?.replace('_', ' ')}}
                  </span>
                </div>
                <div class="mb-2"><strong>Priority:</strong> 
                  <span class="badge ms-2" [class]="getPriorityBadgeClass(selectedLead.priority)" *ngIf="selectedLead.priority">
                    {{selectedLead.priority}}
                  </span>
                  <span *ngIf="!selectedLead.priority">-</span>
                </div>
                <div class="mb-2"><strong>Lead Score:</strong> {{selectedLead.leadScore || '-'}}</div>
                <div class="mb-0"><strong>Source:</strong> {{selectedLead.source || '-'}}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Case Details</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Practice Area:</strong> {{selectedLead.practiceArea?.replace('_', ' ') || '-'}}</div>
                <div class="mb-2"><strong>Case Type:</strong> {{selectedLead.caseType || '-'}}</div>
                <div class="mb-0"><strong>Estimated Value:</strong> {{formatCurrency(selectedLead.estimatedValue)}}</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Timeline</label>
              <div class="border rounded p-3">
                <div class="mb-2"><strong>Created:</strong> {{formatDateTime(selectedLead.createdAt)}}</div>
                <div class="mb-2"><strong>Last Contact:</strong> {{formatDateTime(selectedLead.lastContactDate)}}</div>
                <div class="mb-2"><strong>Contact Attempts:</strong> {{selectedLead.contactAttempts || 0}}</div>
                <div class="mb-0"><strong>Follow-up Date:</strong> {{formatDate(selectedLead.followUpDate)}}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row" *ngIf="selectedLead.initialInquiry || selectedLead.notes">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label fw-semibold">Notes & Inquiry</label>
              <div class="border rounded p-3">
                <div class="mb-2" *ngIf="selectedLead.initialInquiry">
                  <strong>Initial Inquiry:</strong>
                  <p class="mb-0 mt-1">{{selectedLead.initialInquiry}}</p>
                </div>
                <div *ngIf="selectedLead.notes">
                  <strong>Notes:</strong>
                  <p class="mb-0 mt-1">{{selectedLead.notes}}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="closeLeadModal()">Close</button>
        <button type="button" class="btn btn-primary">Edit Lead</button>
        <button type="button" class="btn btn-success">Convert</button>
      </div>
    </div>
  </div>
</div>

<!-- Pipeline Modal -->
<div class="modal fade" [class.show]="showPipelineModal" [style.display]="showPipelineModal ? 'block' : 'none'" 
     tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Lead Pipeline View</h5>
        <button type="button" class="btn-close" (click)="closePipelineModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-3" *ngFor="let stage of pipelineStages">
            <div class="card mb-3">
              <div class="card-header" [style.background-color]="stage.color + '20'">
                <h6 class="mb-0" [style.color]="stage.color">
                  <i [class]="stage.icon" class="me-2"></i>
                  {{stage.name}}
                  <span class="badge badge-soft-secondary ms-2">{{getLeadCountForStage(stage.name)}}</span>
                </h6>
              </div>
              <div class="card-body p-2" style="min-height: 400px;">
                <div class="mb-2" *ngFor="let lead of getLeadsForStage(stage.name) | slice:0:5">
                  <div class="border rounded p-2">
                    <div class="d-flex align-items-center">
                      <div class="avatar-xs me-2">
                        <span class="avatar-title rounded-circle bg-soft-primary text-primary font-size-12">
                          {{lead.firstName?.charAt(0) || 'L'}}{{lead.lastName?.charAt(0) || ''}}
                        </span>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-1 font-size-12">{{lead.fullName || (lead.firstName + ' ' + lead.lastName)}}</h6>
                        <p class="mb-0 text-muted font-size-11">{{lead.practiceArea?.replace('_', ' ') || '-'}}</p>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                          <span class="badge badge-soft-secondary font-size-10">{{getPriorityDisplayName(lead.priority)}}</span>
                          <span class="text-muted font-size-10">{{formatCurrency(lead.estimatedValue)}}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center text-muted font-size-12" 
                     *ngIf="getLeadCountForStage(stage.name) === 0">
                  No leads in this stage
                </div>
                <div class="text-center mt-2" *ngIf="getLeadCountForStage(stage.name) > 5">
                  <small class="text-muted">+{{getLeadCountForStage(stage.name) - 5}} more leads</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Lead Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead && isEditMode">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Lead - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <form [formGroup]="editLeadForm" (ngSubmit)="saveEditLead()">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" 
                       [class.is-invalid]="editLeadForm.get('firstName')?.invalid && editLeadForm.get('firstName')?.touched"
                       formControlName="firstName">
                <div class="invalid-feedback" *ngIf="editLeadForm.get('firstName')?.invalid && editLeadForm.get('firstName')?.touched">
                  <div *ngIf="editLeadForm.get('firstName')?.errors?.['required']">First name is required</div>
                  <div *ngIf="editLeadForm.get('firstName')?.errors?.['minlength']">First name must be at least 2 characters</div>
                  <div *ngIf="editLeadForm.get('firstName')?.errors?.['maxlength']">First name cannot exceed 50 characters</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" 
                       [class.is-invalid]="editLeadForm.get('lastName')?.invalid && editLeadForm.get('lastName')?.touched"
                       formControlName="lastName">
                <div class="invalid-feedback" *ngIf="editLeadForm.get('lastName')?.invalid && editLeadForm.get('lastName')?.touched">
                  <div *ngIf="editLeadForm.get('lastName')?.errors?.['required']">Last name is required</div>
                  <div *ngIf="editLeadForm.get('lastName')?.errors?.['minlength']">Last name must be at least 2 characters</div>
                  <div *ngIf="editLeadForm.get('lastName')?.errors?.['maxlength']">Last name cannot exceed 50 characters</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <input type="email" class="form-control" 
                       [class.is-invalid]="editLeadForm.get('email')?.invalid && editLeadForm.get('email')?.touched"
                       formControlName="email">
                <div class="invalid-feedback" *ngIf="editLeadForm.get('email')?.invalid && editLeadForm.get('email')?.touched">
                  <div *ngIf="editLeadForm.get('email')?.errors?.['required']">Email is required</div>
                  <div *ngIf="editLeadForm.get('email')?.errors?.['email']">Please enter a valid email address</div>
                  <div *ngIf="editLeadForm.get('email')?.errors?.['maxlength']">Email cannot exceed 100 characters</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" 
                       [class.is-invalid]="editLeadForm.get('phone')?.invalid && editLeadForm.get('phone')?.touched"
                       formControlName="phone">
                <div class="invalid-feedback" *ngIf="editLeadForm.get('phone')?.invalid && editLeadForm.get('phone')?.touched">
                  <div *ngIf="editLeadForm.get('phone')?.errors?.['pattern']">Please enter a valid phone number</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Company</label>
                <input type="text" class="form-control" formControlName="company">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Practice Area <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="practiceArea">
                  <option value="">Select Practice Area</option>
                  <option value="FAMILY_LAW">Family Law</option>
                  <option value="PERSONAL_INJURY">Personal Injury</option>
                  <option value="CRIMINAL_DEFENSE">Criminal Defense</option>
                  <option value="BUSINESS_LAW">Business Law</option>
                  <option value="ESTATE_PLANNING">Estate Planning</option>
                  <option value="REAL_ESTATE">Real Estate</option>
                  <option value="IMMIGRATION">Immigration</option>
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" formControlName="status">
                  <option value="">Select Status</option>
                  <option value="NEW">New</option>
                  <option value="CONTACTED">Contacted</option>
                  <option value="QUALIFIED">Qualified</option>
                  <option value="CONSULTATION_SCHEDULED">Consultation Scheduled</option>
                  <option value="PROPOSAL_SENT">Proposal Sent</option>
                  <option value="NEGOTIATION">Negotiation</option>
                  <option value="CONVERTED">Converted</option>
                  <option value="LOST">Lost</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Priority</label>
                <select class="form-select" formControlName="priority">
                  <option value="">Select Priority</option>
                  <option value="LOW">Low</option>
                  <option value="MEDIUM">Medium</option>
                  <option value="HIGH">High</option>
                  <option value="URGENT">Urgent</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Estimated Value</label>
                <input type="number" class="form-control" formControlName="estimatedValue" placeholder="0">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Contact Preference</label>
                <select class="form-select" formControlName="contactPreference">
                  <option value="">Select Preference</option>
                  <option value="EMAIL">Email</option>
                  <option value="PHONE">Phone</option>
                  <option value="TEXT">Text</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Additional Fields Row -->
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Lead Source</label>
                <select class="form-select" formControlName="source">
                  <option value="">Select Source</option>
                  <option value="WEBSITE">Website</option>
                  <option value="REFERRAL">Referral</option>
                  <option value="GOOGLE_ADS">Google Ads</option>
                  <option value="SOCIAL_MEDIA">Social Media</option>
                  <option value="EMAIL_CAMPAIGN">Email Campaign</option>
                  <option value="PHONE_INQUIRY">Phone Inquiry</option>
                  <option value="WALK_IN">Walk-in</option>
                  <option value="EVENT">Event/Seminar</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Case Type</label>
                <input type="text" class="form-control" formControlName="caseType" placeholder="e.g., Personal Injury, Family Law">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Lead Score</label>
                <input type="number" class="form-control" formControlName="leadScore" 
                       placeholder="0-100" min="0" max="100">
                <div class="form-text text-muted">Lead quality score (0-100)</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Initial Inquiry</label>
            <textarea class="form-control" rows="3" formControlName="initialInquiry"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" rows="3" formControlName="notes"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" (click)="closeEditModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!editLeadForm.valid">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Assign Lead Modal -->
<div class="modal fade" [class.show]="showAssignModal" [style.display]="showAssignModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assign Lead - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeAssignModal()"></button>
      </div>
      <form [formGroup]="assignForm" (ngSubmit)="submitAssignment()">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Assign To <span class="text-danger">*</span></label>
            <select class="form-select" 
                    [class.is-invalid]="assignForm.get('assignedTo')?.invalid && assignForm.get('assignedTo')?.touched"
                    formControlName="assignedTo">
              <option value="">Select Attorney</option>
              <option *ngFor="let attorney of availableAttorneys" [value]="attorney.id">
                {{attorney.firstName}} {{attorney.lastName}} ({{attorney.email}}) - {{attorney.roleName}}
              </option>
            </select>
            <div class="invalid-feedback" *ngIf="assignForm.get('assignedTo')?.invalid && assignForm.get('assignedTo')?.touched">
              Please select an attorney to assign the lead to
            </div>
            <div class="form-text text-muted" *ngIf="availableAttorneys.length === 0">
              Loading attorneys... If none appear, please check user management.
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Assignment Notes</label>
            <textarea class="form-control" rows="3" 
                      [class.is-invalid]="assignForm.get('notes')?.invalid && assignForm.get('notes')?.touched"
                      formControlName="notes" 
                      placeholder="Add any specific instructions or context for the assignee..."></textarea>
            <div class="invalid-feedback" *ngIf="assignForm.get('notes')?.invalid && assignForm.get('notes')?.touched">
              <div *ngIf="assignForm.get('notes')?.errors?.['maxlength']">Notes cannot exceed 500 characters</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" (click)="closeAssignModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!assignForm.valid">Assign Lead</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Schedule Call Modal -->
<div class="modal fade" [class.show]="showScheduleModal" [style.display]="showScheduleModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Schedule Consultation - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeScheduleModal()"></button>
      </div>
      <form [formGroup]="scheduleForm" (ngSubmit)="submitSchedule()">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Consultation Date & Time <span class="text-danger">*</span></label>
                <input type="text" 
                       id="consultationDatePicker"
                       class="form-control" 
                       placeholder="Select date and time"
                       [class.is-invalid]="scheduleForm.get('consultationDateTime')?.invalid && scheduleForm.get('consultationDateTime')?.touched"
                       formControlName="consultationDateTime"
                       readonly>
                <div class="invalid-feedback" *ngIf="scheduleForm.get('consultationDateTime')?.invalid && scheduleForm.get('consultationDateTime')?.touched">
                  Please select a consultation date and time
                </div>
                <div class="form-text text-muted">
                  <i class="ri-information-line me-1"></i>
                  Available Monday-Friday, 8:00 AM - 6:00 PM
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Consultation Type <span class="text-danger">*</span></label>
                <select class="form-select" 
                        [class.is-invalid]="scheduleForm.get('consultationType')?.invalid && scheduleForm.get('consultationType')?.touched"
                        formControlName="consultationType">
                  <option value="INITIAL_CONSULTATION">Initial Consultation</option>
                  <option value="FOLLOW_UP">Follow-up Meeting</option>
                  <option value="CASE_REVIEW">Case Review</option>
                  <option value="DOCUMENT_REVIEW">Document Review</option>
                  <option value="SETTLEMENT_DISCUSSION">Settlement Discussion</option>
                </select>
                <div class="invalid-feedback" *ngIf="scheduleForm.get('consultationType')?.invalid && scheduleForm.get('consultationType')?.touched">
                  Please select a consultation type
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" rows="3" 
                      [class.is-invalid]="scheduleForm.get('notes')?.invalid && scheduleForm.get('notes')?.touched"
                      formControlName="notes" 
                      placeholder="Add any specific details about the consultation..."></textarea>
            <div class="invalid-feedback" *ngIf="scheduleForm.get('notes')?.invalid && scheduleForm.get('notes')?.touched">
              <div *ngIf="scheduleForm.get('notes')?.errors?.['maxlength']">Notes cannot exceed 500 characters</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" (click)="closeScheduleModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!scheduleForm.valid">Schedule Consultation</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Convert Lead Modal -->
<div class="modal fade" [class.show]="showConvertModal" [style.display]="showConvertModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedLead">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Convert Lead - {{selectedLead.fullName}}</h5>
        <button type="button" class="btn-close" (click)="closeConvertModal()"></button>
      </div>
      <form [formGroup]="convertForm" (ngSubmit)="submitConversion()">
        <div class="modal-body">
          <div class="row mb-4">
            <div class="col-12">
              <label class="form-label">Conversion Type <span class="text-danger">*</span></label>
              <div class="row">
                <div class="col-md-4" *ngFor="let type of conversionTypes">
                  <div class="card h-100" [class.border-primary]="selectedConversionType === type.value">
                    <div class="card-body">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" 
                               [value]="type.value" 
                               formControlName="conversionType"
                               (change)="onConversionTypeChange(type.value)">
                        <label class="form-check-label">
                          <strong>{{type.label}}</strong>
                        </label>
                      </div>
                      <p class="small text-muted mb-0 mt-1">{{type.description}}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Client Information Section -->
          <div class="row" *ngIf="selectedConversionType === 'CLIENT_ONLY' || selectedConversionType === 'CLIENT_AND_MATTER'">
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3">Client Information</h6>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="clientFirstName">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="clientLastName">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <input type="email" class="form-control" formControlName="clientEmail">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" formControlName="clientPhone">
              </div>
            </div>
          </div>

          <!-- Case/Matter Information Section -->
          <div class="row" *ngIf="selectedConversionType === 'MATTER_ONLY' || selectedConversionType === 'CLIENT_AND_MATTER'">
            <div class="col-12">
              <h6 class="text-primary border-bottom pb-2 mb-3">Case/Matter Information</h6>
            </div>
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label">Case Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="caseTitle" 
                       placeholder="Brief title describing the case">
              </div>
            </div>
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label">Case Description <span class="text-danger">*</span></label>
                <textarea class="form-control" rows="4" formControlName="caseDescription" 
                          placeholder="Detailed description of the legal matter"></textarea>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Retainer Amount</label>
                <input type="number" class="form-control" formControlName="retainerAmount" placeholder="0">
              </div>
            </div>
          </div>

          <!-- General Notes -->
          <div class="row">
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label">Conversion Notes</label>
                <textarea class="form-control" rows="3" formControlName="notes" 
                          placeholder="Any additional notes about this conversion..."></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" (click)="closeConvertModal()">Cancel</button>
          <button type="submit" class="btn btn-success" [disabled]="!convertForm.valid || !selectedConversionType">
            Convert Lead
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showLeadModal || showPipelineModal || showEditModal || showAssignModal || showScheduleModal || showConvertModal"></div>

<!-- Custom Styles -->
<style>
  /* Conversion Progress Styling */
  .conversion-progress {
    text-align: left;
    margin: 20px 0;
  }
  
  .conversion-progress .step {
    padding: 8px 16px;
    margin: 5px 0;
    border-radius: 5px;
    background: #f8f9fa;
    color: #6c757d;
    border-left: 4px solid #dee2e6;
  }
  
  .conversion-progress .step.active {
    background: #fff3cd;
    color: #856404;
    border-left-color: #ffc107;
  }
  
  .conversion-progress .step.completed {
    background: #d1edff;
    color: #155724;
    border-left-color: #28a745;
  }
  
  /* Flatpickr Customization */
  .crm-datepicker {
    z-index: 9999 !important;
  }
  
  .crm-datepicker .flatpickr-day.selected {
    background: #007bff;
    border-color: #007bff;
  }
  
  .crm-datepicker .flatpickr-day:hover {
    background: #e9ecef;
  }
  
  /* Conversion Confirmation Popup */
  .conversion-confirmation-popup {
    font-size: 14px;
  }
  
  .conversion-confirmation-popup .swal2-html-container {
    text-align: left;
  }
  
  /* Form Validation Enhancements */
  .form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }
  
  .form-select.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }
  
  .invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
  }
  
  /* Modal Enhancements */
  .modal-header {
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
  }
  
  .modal-footer {
    border-top: 1px solid #dee2e6;
    background: #f8f9fa;
  }
  
  /* Priority Badge Pulse Animation */
  .priority-urgent-pulse {
    animation: pulse-urgent 2s infinite;
  }
  
  @keyframes pulse-urgent {
    0% {
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
  }
  
  /* Dropdown Enhancement */
  .dropdown-menu {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  
  .dropdown-item:hover {
    background-color: #f8f9fa;
  }
</style>