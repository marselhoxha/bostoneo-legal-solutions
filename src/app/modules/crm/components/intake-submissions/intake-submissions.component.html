
<!-- Page Header -->
<div class="row" style="margin-top: 120px;">
  <div class="col-12">
    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
      <div>
        <h4 class="mb-sm-0">
          <i class="ri-gavel-line me-2 text-primary"></i>
          Attorney Review Dashboard
        </h4>
        <p class="text-muted mb-0">Review and manage client intake submissions</p>
      </div>
      
      <div class="page-title-right">
        <ol class="breadcrumb m-0">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item"><a href="/crm/dashboard">CRM</a></li>
          <li class="breadcrumb-item active">Intake Submissions</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="row" *ngIf="isLoading">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading submissions...</span>
        </div>
        <p class="mt-3 text-muted">Loading intake submissions...</p>
      </div>
    </div>
  </div>
</div>

<!-- Error State -->
<div class="row" *ngIf="error && !isLoading">
  <div class="col-12">
    <div class="alert alert-danger" role="alert">
      <i class="ri-error-warning-line me-2"></i>
      {{ error }}
      <button class="btn btn-sm btn-outline-danger ms-3" (click)="loadSubmissions()">
        <i class="ri-refresh-line me-1"></i>Try Again
      </button>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="row attorney-dashboard" *ngIf="!isLoading && !error">
  <!-- Summary Cards -->
  <div class="col-xl-3 col-md-6">
    <div class="card shadow-sm border-warning" [class.priority-critical]="getPendingCount() > 5">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="avatar-sm rounded-circle bg-warning bg-opacity-10 p-2">
              <div class="avatar-title text-warning rounded-circle bg-transparent">
                <i class="ri-alarm-warning-line fs-2"></i>
              </div>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <h5 class="mb-1 fw-bold">{{ getPendingCount() }}</h5>
            <p class="text-muted mb-0 fs-13">
              <strong>Requires Review</strong>
              <span *ngIf="getPendingCount() > 3" class="text-warning ms-1">
                <i class="ri-alert-line"></i> Priority
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6">
    <div class="card shadow-sm border-success">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="avatar-sm rounded-circle bg-success bg-opacity-10 p-2">
              <div class="avatar-title text-success rounded-circle bg-transparent">
                <i class="ri-user-add-line fs-2"></i>
              </div>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <h5 class="mb-1 fw-bold text-success">{{ getConvertedCount() }}</h5>
            <p class="text-muted mb-0 fs-13">
              <strong>New Clients</strong><br>
              <span class="text-success">{{ getConversionRate() }}% conversion</span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6">
    <div class="card shadow-sm border-info">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="avatar-sm rounded-circle bg-info bg-opacity-10 p-2">
              <div class="avatar-title text-info rounded-circle bg-transparent">
                <i class="ri-shield-check-line fs-2"></i>
              </div>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <h5 class="mb-1 fw-bold">{{ getReviewedCount() }}</h5>
            <p class="text-muted mb-0 fs-13">
              <strong>Reviewed Cases</strong><br>
              <span class="text-info">Ready for decision</span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6">
    <div class="card shadow-sm border-secondary">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="avatar-sm rounded-circle bg-secondary bg-opacity-10 p-2">
              <div class="avatar-title text-secondary rounded-circle bg-transparent">
                <i class="ri-bar-chart-2-line fs-2"></i>
              </div>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <h5 class="mb-1 fw-bold">{{ getHighUrgencyCount() }}</h5>
            <p class="text-muted mb-0 fs-13">
              <strong>High Urgency</strong><br>
              <span class="text-danger">Urgent attention needed</span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters and Search -->
<div class="row" *ngIf="!isLoading && !error">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-light-subtle border-bottom-dashed">
        <h5 class="card-title mb-0">
          <i class="ri-filter-3-line me-2 text-primary"></i>
          Filters
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <!-- Search -->
          <div class="col-md-4">
            <label class="form-label">Search</label>
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Search submissions..." 
                     [(ngModel)]="searchTerm" (input)="onSearch()">
              <button class="btn btn-outline-secondary" type="button" (click)="onSearch()">
                <i class="ri-search-line"></i>
              </button>
            </div>
          </div>

          <!-- Status Filter -->
          <div class="col-md-2">
            <label class="form-label">Status</label>
            <select class="form-select" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
              <option *ngFor="let status of statusOptions" [value]="status.value">
                {{ status.label }}
              </option>
            </select>
          </div>

          <!-- Practice Area Filter -->
          <div class="col-md-2">
            <label class="form-label">Practice Area</label>
            <select class="form-select" [(ngModel)]="selectedPracticeArea" (change)="onFilterChange()">
              <option *ngFor="let area of practiceAreaOptions" [value]="area.value">
                {{ area.label }}
              </option>
            </select>
          </div>

          <!-- Urgency Filter -->
          <div class="col-md-2">
            <label class="form-label">Urgency</label>
            <select class="form-select" [(ngModel)]="selectedUrgency" (change)="onFilterChange()">
              <option *ngFor="let urgency of urgencyOptions" [value]="urgency.value">
                {{ urgency.label }}
              </option>
            </select>
          </div>

          <!-- Clear Filters -->
          <div class="col-md-1">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-outline-secondary d-block w-100" (click)="clearFilters()">
              <i class="ri-close-line"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Submissions Table -->
<div class="row" *ngIf="!isLoading && !error">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-light-subtle border-bottom-dashed">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="card-title mb-0">
            <i class="ri-file-list-3-line me-2 text-primary"></i>
            Submissions ({{ totalElements }})
          </h5>
          
          <!-- Bulk Actions -->
          <div class="d-flex gap-2" *ngIf="selectedSubmissions.size > 0">
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" 
                      data-bs-toggle="dropdown">
                <i class="ri-more-2-fill me-1"></i>
                Bulk Actions ({{ selectedSubmissions.size }})
              </button>
              <ul class="dropdown-menu">
                <!-- Convert to Leads - Only show if eligible submissions exist -->
                <li *ngIf="canBulkApprove()">
                  <a class="dropdown-item text-success" href="#" (click)="onBulkAction('approve'); $event.preventDefault()">
                    <i class="ri-user-add-line me-2"></i>Convert to Leads 
                    <span class="badge bg-success ms-1">{{getBulkEligibleCount('approve')}}</span>
                  </a>
                </li>
                
                <!-- Reject Selected - Only show if eligible submissions exist -->
                <li *ngIf="canBulkReject()">
                  <a class="dropdown-item text-danger" href="#" (click)="onBulkAction('reject'); $event.preventDefault()">
                    <i class="ri-close-line me-2"></i>Reject Selected
                    <span class="badge bg-danger ms-1">{{getBulkEligibleCount('reject')}}</span>
                  </a>
                </li>
                
                <!-- Divider - Only show if there are actions above and below -->
                <li *ngIf="(canBulkApprove() || canBulkReject()) && canBulkMarkAsSpam()">
                  <hr class="dropdown-divider">
                </li>
                
                <!-- Mark as Spam - Only show if eligible submissions exist -->
                <li *ngIf="canBulkMarkAsSpam()">
                  <a class="dropdown-item text-warning" href="#" (click)="onBulkAction('spam'); $event.preventDefault()">
                    <i class="ri-spam-line me-2"></i>Mark as Spam
                    <span class="badge bg-warning ms-1">{{getBulkEligibleCount('spam')}}</span>
                  </a>
                </li>
                
                <!-- No actions available message -->
                <li *ngIf="!canBulkApprove() && !canBulkReject() && !canBulkMarkAsSpam()">
                  <div class="dropdown-item-text text-muted">
                    <i class="ri-information-line me-2"></i>
                    <small>No actions available for selected items</small>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-nowrap mb-0">
            <thead class="table-light">
              <tr>
                <th>
                  <input type="checkbox" class="form-check-input" 
                         [checked]="selectAll" (change)="toggleSelectAll()">
                </th>
                <th><i class="ri-user-line me-1"></i>Potential Client</th>
                <th><i class="ri-briefcase-line me-1"></i>Legal Matter</th>
                <th><i class="ri-flag-line me-1"></i>Review Status</th>
                <th><i class="ri-alert-line me-1"></i>Urgency</th>
                <th><i class="ri-star-line me-1"></i>Quality Score</th>
                <th><i class="ri-calendar-line me-1"></i>Date Received</th>
                <th><i class="ri-gavel-line me-1"></i>Attorney</th>
                <th><i class="ri-settings-line me-1"></i>Review Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let submission of paginatedSubmissions"
                  [class.high-priority-row]="submission.urgency === 'HIGH' || submission.urgency === 'URGENT'">
                <td>
                  <input type="checkbox" class="form-check-input" 
                         [checked]="selectedSubmissions.has(submission.id)"
                         (change)="toggleSelection(submission.id)">
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar-xs me-3">
                      <div class="avatar-title rounded-circle bg-primary-subtle text-primary">
                        {{ submission.firstName.charAt(0) }}{{ submission.lastName.charAt(0) }}
                      </div>
                    </div>
                    <div>
                      <h6 class="mb-0">{{ submission.firstName }} {{ submission.lastName }}</h6>
                      <small class="text-muted">{{ submission.email }}</small>
                      <br><small class="text-muted">{{ submission.phone }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="badge bg-secondary-subtle text-secondary">
                    {{ submission.practiceArea }}
                  </span>
                </td>
                <td>
                  <span [class]="getStatusBadgeClass(submission.status)">
                    {{ submission.status.replace('_', ' ') }}
                  </span>
                </td>
                <td>
                  <span [class]="getUrgencyBadgeClass(submission.urgency || '')" *ngIf="submission.urgency">
                    <i class="ri-alert-line me-1" *ngIf="submission.urgency === 'URGENT'"></i>
                    {{ submission.urgency }}
                  </span>
                  <span class="text-muted" *ngIf="!submission.urgency">-</span>
                </td>
                <td>
                  <span [class]="getLeadScoreClass(submission.leadScore)">
                    <i class="ri-star-fill me-1" *ngIf="submission.leadScore >= 80"></i>
                    <i class="ri-star-half-fill me-1" *ngIf="submission.leadScore >= 60 && submission.leadScore < 80"></i>
                    <i class="ri-star-line me-1" *ngIf="submission.leadScore < 60"></i>
                    {{ submission.leadScore }}%
                  </span>
                </td>
                <td>
                  <small>{{ formatDateTime(submission.submittedAt) }}</small>
                </td>
                <td>
                  <span *ngIf="submission.assignedToName; else unassigned">
                    <i class="ri-user-line me-1"></i>{{ submission.assignedToName }}
                  </span>
                  <ng-template #unassigned>
                    <span class="text-muted">Unassigned</span>
                  </ng-template>
                </td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" 
                            data-bs-toggle="dropdown">
                      Actions
                    </button>
                    <ul class="dropdown-menu">
                      <!-- View Details - Always available -->
                      <li><a class="dropdown-item" href="#" (click)="viewSubmissionDetails(submission.id); $event.preventDefault()">
                        <i class="ri-eye-line me-2"></i>View Details
                      </a></li>
                      
                      <!-- Review - Only for PENDING submissions -->
                      <li *ngIf="canReview(submission)">
                        <a class="dropdown-item" href="#" (click)="onSubmissionAction(submission.id, 'review'); $event.preventDefault()">
                          <i class="ri-check-line me-2"></i>Review
                        </a>
                      </li>
                      
                      <!-- Convert to Lead - Only for PENDING or REVIEWED submissions -->
                      <li *ngIf="canConvertToLead(submission)">
                        <a class="dropdown-item text-success" href="#" (click)="convertToLead(submission.id); $event.preventDefault()">
                          <i class="ri-user-add-line me-2"></i>Convert to Lead
                        </a>
                      </li>
                      
                      <!-- Divider - Only show if there are action items below -->
                      <li *ngIf="canReject(submission) || canMarkAsSpam(submission)">
                        <hr class="dropdown-divider">
                      </li>
                      
                      <!-- Mark as Spam - Not available for SPAM or CONVERTED_TO_LEAD -->
                      <li *ngIf="canMarkAsSpam(submission)">
                        <a class="dropdown-item text-warning" href="#" (click)="onSubmissionAction(submission.id, 'spam'); $event.preventDefault()">
                          <i class="ri-spam-line me-2"></i>Mark as Spam
                        </a>
                      </li>
                      
                      <!-- Reject - Only for PENDING or REVIEWED submissions -->
                      <li *ngIf="canReject(submission)">
                        <a class="dropdown-item text-danger" href="#" (click)="onSubmissionAction(submission.id, 'reject'); $event.preventDefault()">
                          <i class="ri-close-line me-2"></i>Reject
                        </a>
                      </li>
                      
                      <!-- Final status message - Show for final statuses -->
                      <li *ngIf="isSubmissionFinal(submission)">
                        <div class="dropdown-item-text text-muted">
                          <i class="ri-lock-line me-2"></i>
                          <small>{{ submission.status === 'SPAM' ? 'Marked as spam' : 
                                   submission.status === 'REJECTED' ? 'Rejected' : 
                                   'Converted to lead' }}</small>
                        </div>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls -->
        <div class="px-4 py-3 border-top" *ngIf="filteredSubmissions.length > pageSize">
          <div class="row align-items-center">
            <div class="col-sm-6">
              <div class="text-muted">
                Showing <strong>{{ pageInfo }}</strong> entries
              </div>
            </div>
            <div class="col-sm-6">
              <div class="d-flex justify-content-sm-end">
                <nav>
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" [class.disabled]="!hasPreviousPage">
                      <button class="page-link" (click)="previousPage()" [disabled]="!hasPreviousPage">
                        <i class="ri-arrow-left-line"></i> Previous
                      </button>
                    </li>
                    <li class="page-item active">
                      <span class="page-link">{{ currentPage + 1 }}</span>
                    </li>
                    <li class="page-item" [class.disabled]="!hasNextPage">
                      <button class="page-link" (click)="nextPage()" [disabled]="!hasNextPage">
                        Next <i class="ri-arrow-right-line"></i>
                      </button>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Empty State -->
<div class="row" *ngIf="!isLoading && !error && filteredSubmissions.length === 0">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <div class="avatar-lg mx-auto mb-4">
          <div class="avatar-title rounded-circle bg-light text-muted">
            <i class="ri-file-list-3-line display-6"></i>
          </div>
        </div>
        <h5 class="mb-3">No Submissions Found</h5>
        <p class="text-muted mb-0">No intake submissions match your current filters.</p>
        <button class="btn btn-outline-primary mt-3" (click)="clearFilters()">
          Clear Filters
        </button>
      </div>
    </div>
  </div>
</div>