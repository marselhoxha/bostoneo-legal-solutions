<!-- Header with Search & Filters -->
<div class="d-flex flex-wrap gap-2 mb-3" *ngIf="!compact">
  <div class="flex-grow-1">
    <div class="search-box">
      <input type="text" class="form-control" placeholder="Search signatures..."
             [(ngModel)]="searchQuery" (ngModelChange)="onSearch()">
      <i class="ri-search-line search-icon"></i>
    </div>
  </div>
  <div>
    <select class="form-select" [(ngModel)]="statusFilter" (ngModelChange)="onStatusFilterChange()">
      <option *ngFor="let opt of statusOptions" [ngValue]="opt.value">{{ opt.label }}</option>
    </select>
  </div>
  <button class="btn btn-primary" (click)="createRequest.emit()" *ngIf="showActions">
    <i class="ri-add-line me-1"></i> New Request
  </button>
</div>

<!-- Loading -->
<div class="text-center py-4" *ngIf="loading">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- Error -->
<div class="alert alert-danger" *ngIf="error">
  <i class="ri-error-warning-line me-2"></i>
  {{ error }}
  <button class="btn btn-sm btn-danger ms-2" (click)="loadRequests()">Retry</button>
</div>

<!-- Empty State -->
<div class="text-center py-5" *ngIf="!loading && !error && filteredRequests.length === 0">
  <div class="avatar-lg mx-auto mb-3">
    <div class="avatar-title bg-light text-secondary rounded-circle fs-24">
      <i class="ri-file-list-3-line"></i>
    </div>
  </div>
  <h5 class="text-muted">No Signature Requests</h5>
  <p class="text-muted" *ngIf="searchQuery || statusFilter !== 'ALL'">
    Try adjusting your filters
  </p>
  <button class="btn btn-primary" (click)="createRequest.emit()" *ngIf="showActions">
    <i class="ri-add-line me-1"></i> Create First Request
  </button>
</div>

<!-- List -->
<div class="table-responsive" *ngIf="!loading && filteredRequests.length > 0">
  <table class="table table-hover align-middle mb-0" [class.table-sm]="compact">
    <thead class="table-light">
      <tr>
        <th>Document</th>
        <th>Signer</th>
        <th>Status</th>
        <th *ngIf="!compact">Sent</th>
        <th *ngIf="!compact">Expires</th>
        <th *ngIf="showActions" class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let request of filteredRequests"
          class="cursor-pointer"
          (click)="selectRequest(request)">
        <!-- Document -->
        <td>
          <div class="d-flex align-items-center">
            <div class="avatar-sm flex-shrink-0 me-2">
              <span class="avatar-title bg-primary-subtle text-primary rounded">
                <i class="ri-file-text-line"></i>
              </span>
            </div>
            <div>
              <h6 class="mb-0 text-truncate" style="max-width: 200px;" [title]="request.title">
                {{ request.title }}
              </h6>
              <small class="text-muted" *ngIf="request.caseName">{{ request.caseName }}</small>
            </div>
          </div>
        </td>

        <!-- Signer -->
        <td>
          <div>
            <span class="fw-medium">{{ request.signerName }}</span>
            <br>
            <small class="text-muted">{{ request.signerEmail }}</small>
          </div>
        </td>

        <!-- Status -->
        <td>
          <app-signature-status-badge
            [status]="request.status"
            [daysUntilExpiry]="request.daysUntilExpiry">
          </app-signature-status-badge>
          <div *ngIf="request.daysUntilExpiry !== undefined && request.daysUntilExpiry <= 3 && request.daysUntilExpiry >= 0"
               class="mt-1">
            <small class="text-danger">
              <i class="ri-alarm-warning-line me-1"></i>
              {{ request.daysUntilExpiry === 0 ? 'Expires today' :
                 request.daysUntilExpiry === 1 ? 'Expires tomorrow' :
                 'Expires in ' + request.daysUntilExpiry + ' days' }}
            </small>
          </div>
        </td>

        <!-- Sent Date -->
        <td *ngIf="!compact">
          <span *ngIf="request.sentAt">{{ formatDate(request.sentAt) }}</span>
          <span *ngIf="!request.sentAt" class="text-muted">-</span>
        </td>

        <!-- Expires -->
        <td *ngIf="!compact">
          <span *ngIf="request.expiresAt">{{ formatDate(request.expiresAt) }}</span>
          <span *ngIf="!request.expiresAt" class="text-muted">-</span>
        </td>

        <!-- Actions -->
        <td *ngIf="showActions" class="text-end">
          <div class="dropdown" (click)="$event.stopPropagation()">
            <button class="btn btn-sm btn-soft-secondary dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown">
              <i class="ri-more-2-fill"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" (click)="selectRequest(request)">
                  <i class="ri-eye-line me-2"></i> View Details
                </a>
              </li>
              <li *ngIf="canRemind(request)">
                <a class="dropdown-item" (click)="sendReminder(request, $event)">
                  <i class="ri-notification-3-line me-2"></i> Send Reminder
                </a>
              </li>
              <li>
                <a class="dropdown-item" (click)="refreshStatus(request, $event)">
                  <i class="ri-refresh-line me-2"></i> Refresh Status
                </a>
              </li>
              <li *ngIf="canDownload(request)">
                <a class="dropdown-item" (click)="downloadDocument(request, $event)">
                  <i class="ri-download-line me-2"></i> Download
                </a>
              </li>
              <li>
                <a class="dropdown-item" (click)="openAuditLog(request, $event)">
                  <i class="ri-history-line me-2"></i> Audit Log
                </a>
              </li>
              <li *ngIf="canVoid(request)">
                <hr class="dropdown-divider">
              </li>
              <li *ngIf="canVoid(request)">
                <a class="dropdown-item text-danger" (click)="voidRequest(request, $event)">
                  <i class="ri-close-circle-line me-2"></i> Void Request
                </a>
              </li>
            </ul>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-between align-items-center mt-3"
     *ngIf="!compact && !loading && totalPages > 1">
  <div class="text-muted">
    Showing {{ (currentPage * pageSize) + 1 }} - {{ Math.min((currentPage + 1) * pageSize, totalElements) }}
    of {{ totalElements }}
  </div>
  <nav>
    <ul class="pagination pagination-sm mb-0">
      <li class="page-item" [class.disabled]="currentPage === 0">
        <a class="page-link" (click)="onPageChange(currentPage - 1)">Previous</a>
      </li>
      <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
          [class.active]="i === currentPage">
        <a class="page-link" (click)="onPageChange(i)">{{ i + 1 }}</a>
      </li>
      <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
        <a class="page-link" (click)="onPageChange(currentPage + 1)">Next</a>
      </li>
    </ul>
  </nav>
</div>
