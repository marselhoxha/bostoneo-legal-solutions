package com.bostoneo.bostoneosolutions.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.LinkedHashMap;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * Post-processor that injects URLs for known legal citations.
 * Guarantees 100% URL coverage regardless of AI laziness.
 *
 * Purpose: Even if Claude ignores our URL requirements, we forcibly inject them.
 * Result: Court-ready responses with clickable source links.
 */
@Service
@Slf4j
public class CitationUrlInjector {

    // LinkedHashMap to preserve insertion order (match longer patterns first)
    private static final Map<Pattern, String> CITATION_URL_MAP = new LinkedHashMap<>();

    static {
        // Massachusetts Constitution
        CITATION_URL_MAP.put(
            Pattern.compile("\\bArticle 14\\b(?! - Source:)(?!\\]\\(http)"),
            "[Article 14](https://malegislature.gov/Laws/Constitution#partTheFirst)"
        );

        // Massachusetts General Laws - Chapter 90 (most common in OUI cases)
        CITATION_URL_MAP.put(
            Pattern.compile("\\bM\\.G\\.L\\.\\s*c\\.\\s*90,?\\s*ยง\\s*24D\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "[M.G.L. c. 90 ยง 24D](https://malegislature.gov/Laws/GeneralLaws/PartI/TitleXIV/Chapter90/Section24D)"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bM\\.G\\.L\\.\\s*c\\.\\s*90,?\\s*ยง\\s*24K\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "[M.G.L. c. 90 ยง 24K](https://malegislature.gov/Laws/GeneralLaws/PartI/TitleXIV/Chapter90/Section24K)"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bM\\.G\\.L\\.\\s*c\\.\\s*90,?\\s*ยง\\s*24\\(1\\)\\([ef]\\)\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "[M.G.L. c. 90 ยง 24(1)(e)-(f)](https://malegislature.gov/Laws/GeneralLaws/PartI/TitleXIV/Chapter90/Section24)"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bM\\.G\\.L\\.\\s*c\\.\\s*90,?\\s*ยง\\s*24\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "[M.G.L. c. 90 ยง 24](https://malegislature.gov/Laws/GeneralLaws/PartI/TitleXIV/Chapter90/Section24)"
        );

        // CMR Regulations
        CITATION_URL_MAP.put(
            Pattern.compile("\\b501\\s*CMR\\s*2\\.00\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "[501 CMR 2.00](https://www.mass.gov/regulations/501-CMR-2-breath-testing)"
        );

        // Massachusetts Rules of Criminal Procedure
        CITATION_URL_MAP.put(
            Pattern.compile("\\bMass\\.?\\s*R\\.?\\s*Crim\\.?\\s*P\\.?\\s*14\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Mass. R. Crim. P. 14 - Source: https://www.mass.gov/supreme-judicial-court-rules/rules-of-criminal-procedure"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bMass\\.?\\s*R\\.?\\s*Crim\\.?\\s*P\\.?(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Mass. R. Crim. P. - Source: https://www.mass.gov/supreme-judicial-court-rules/rules-of-criminal-procedure"
        );

        // Massachusetts Rules of Civil Procedure
        CITATION_URL_MAP.put(
            Pattern.compile("\\bMass\\.?\\s*R\\.?\\s*Civ\\.?\\s*P\\.?(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Mass. R. Civ. P. - Source: https://www.mass.gov/supreme-judicial-court-rules/rules-of-civil-procedure"
        );

        // Key OUI Cases
        CITATION_URL_MAP.put(
            Pattern.compile("\\bCommonwealth\\s+v\\.?\\s+Anderson,?\\s*406\\s+Mass\\.?\\s+343\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Commonwealth v. Anderson, 406 Mass. 343 (1989) - Source: https://www.courtlistener.com/opinion/2107224/commonwealth-v-anderson/"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bCommonwealth\\s+v\\.?\\s+Anderson\\b(?! - Source:)(?!\\]\\(http)(?!,?\\s*406)", Pattern.CASE_INSENSITIVE),
            "Commonwealth v. Anderson - Source: https://www.courtlistener.com/opinion/2107224/commonwealth-v-anderson/"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bCommonwealth\\s+v\\.?\\s+Colturi\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Commonwealth v. Colturi, 448 Mass. 809 (2007) - Source: https://www.courtlistener.com/opinion/2750858/"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bCommonwealth\\s+v\\.?\\s+Houghton\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Commonwealth v. Houghton, 422 Mass. 480 (1996) - Source: https://www.courtlistener.com/opinion/2750106/"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bCommonwealth\\s+v\\.?\\s+Sands\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Commonwealth v. Sands, 424 Mass. 184 (1997) - Source: https://www.courtlistener.com/opinion/2750163/"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bCommonwealth\\s+v\\.?\\s+Gerhardt\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Commonwealth v. Gerhardt, 477 Mass. 775 (2017) - Source: https://www.courtlistener.com/opinion/4429621/"
        );

        // Federal Cases
        CITATION_URL_MAP.put(
            Pattern.compile("\\bMichigan\\s+Dept\\.?\\s+(?:of\\s+)?State\\s+Police\\s+v\\.?\\s+Sitz\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Michigan Dept. of State Police v. Sitz, 496 U.S. 444 (1990) - Source: https://supreme.justia.com/cases/federal/us/496/444/"
        );

        // General URLs
        CITATION_URL_MAP.put(
            Pattern.compile("\\bMassachusetts\\s+Declaration\\s+of\\s+Rights\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Massachusetts Declaration of Rights - Source: https://malegislature.gov/Laws/Constitution#partTheFirst"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\bMassachusetts\\s+General\\s+Laws\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Massachusetts General Laws - Source: https://malegislature.gov/Laws/GeneralLaws"
        );

        // ===== FEDERAL TAX LAW =====

        // IRC sections with subsections: IRC ยง 170(h) or 26 U.S.C. ยง 170(h)
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(?:IRC|26\\s*U\\.S\\.C\\.)\\s*ยง\\s*(\\d+)\\(([a-z])\\)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "IRC ยง $1($2) - Source: https://www.law.cornell.edu/uscode/text/26/$1#$2"
        );

        // IRC sections: IRC ยง 170 or 26 U.S.C. ยง 170
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(?:IRC|26\\s*U\\.S\\.C\\.)\\s*ยง\\s*(\\d+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "IRC ยง $1 - Source: https://www.law.cornell.edu/uscode/text/26/$1"
        );

        // Treasury Regulations: Treas. Reg. ยง 1.170A-14 or 26 CFR ยง 1.170A-14
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(?:Treas\\.\\s*Reg\\.|26\\s*CFR)\\s*ยง\\s*([\\d.A-Z-]+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Treas. Reg. ยง $1 - Source: https://www.ecfr.gov/current/title-26/section-$1"
        );

        // Tax Court Memo citations: Name v. Comm'r, T.C. Memo 2018-159
        CITATION_URL_MAP.put(
            Pattern.compile("\\b([A-Z][a-zA-Z\\s&.]+)\\s+v\\.\\s+Comm'r,\\s*T\\.C\\.\\s*Memo\\.?\\s*(\\d{4})-(\\d+)(?! - Source:)(?!\\]\\(http)"),
            "$1 v. Comm'r, T.C. Memo $2-$3 - Source: https://www.courtlistener.com/?q=$1+v+Commissioner+T.C.+Memo+$2-$3"
        );

        // Tax Court regular citations: Name v. Comm'r, 151 T.C. 247
        CITATION_URL_MAP.put(
            Pattern.compile("\\b([A-Z][a-zA-Z\\s&.]+)\\s+v\\.\\s+Comm'r,\\s*(\\d+)\\s*T\\.C\\.\\s*(\\d+)(?! - Source:)(?!\\]\\(http)"),
            "$1 v. Comm'r, $2 T.C. $3 - Source: https://www.courtlistener.com/?q=$1+v+Commissioner+$2+T.C.+$3"
        );

        // ===== FEDERAL EMPLOYMENT LAW =====

        // Title VII
        CITATION_URL_MAP.put(
            Pattern.compile("\\bTitle VII\\b(?! - Source:)(?!\\]\\(http)"),
            "Title VII - Source: https://www.law.cornell.edu/uscode/text/42/chapter-21/subchapter-VI"
        );

        // 42 U.S.C. ยง 2000e (Title VII codification)
        CITATION_URL_MAP.put(
            Pattern.compile("\\b42\\s*U\\.S\\.C\\.\\s*ยง\\s*2000e(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "42 U.S.C. ยง 2000e - Source: https://www.law.cornell.edu/uscode/text/42/2000e"
        );

        // ADA
        CITATION_URL_MAP.put(
            Pattern.compile("\\bAmericans with Disabilities Act\\b(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Americans with Disabilities Act - Source: https://www.law.cornell.edu/uscode/text/42/chapter-126"
        );

        // 29 U.S.C. (ADEA, FMLA, etc.)
        CITATION_URL_MAP.put(
            Pattern.compile("\\b29\\s*U\\.S\\.C\\.\\s*ยง\\s*(\\d+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "29 U.S.C. ยง $1 - Source: https://www.law.cornell.edu/uscode/text/29/$1"
        );

        // ADEA specifically
        CITATION_URL_MAP.put(
            Pattern.compile("\\bADEA\\b(?! - Source:)(?!\\]\\(http)"),
            "ADEA - Source: https://www.law.cornell.edu/uscode/text/29/chapter-14"
        );

        // FMLA specifically
        CITATION_URL_MAP.put(
            Pattern.compile("\\bFMLA\\b(?! - Source:)(?!\\]\\(http)"),
            "FMLA - Source: https://www.law.cornell.edu/uscode/text/29/chapter-28"
        );

        // ===== FEDERAL INTELLECTUAL PROPERTY LAW =====

        // Patent statute: 35 U.S.C. ยง 271
        CITATION_URL_MAP.put(
            Pattern.compile("\\b35\\s*U\\.S\\.C\\.\\s*ยง\\s*(\\d+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "35 U.S.C. ยง $1 - Source: https://www.law.cornell.edu/uscode/text/35/$1"
        );

        // Lanham Act: 15 U.S.C. ยง 1125(a)
        CITATION_URL_MAP.put(
            Pattern.compile("\\bLanham Act\\s*ยง\\s*43\\(a\\)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Lanham Act ยง 43(a) - Source: https://www.law.cornell.edu/uscode/text/15/1125"
        );

        CITATION_URL_MAP.put(
            Pattern.compile("\\b15\\s*U\\.S\\.C\\.\\s*ยง\\s*1125(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "15 U.S.C. ยง 1125 - Source: https://www.law.cornell.edu/uscode/text/15/1125"
        );

        // Copyright: 17 U.S.C.
        CITATION_URL_MAP.put(
            Pattern.compile("\\b17\\s*U\\.S\\.C\\.\\s*ยง\\s*(\\d+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "17 U.S.C. ยง $1 - Source: https://www.law.cornell.edu/uscode/text/17/$1"
        );

        // ===== FEDERAL CASE LAW =====

        // Supreme Court: Name v. Name, 496 U.S. 444
        CITATION_URL_MAP.put(
            Pattern.compile("\\b([A-Z][a-zA-Z\\s&.]+)\\s+v\\.\\s+([A-Z][a-zA-Z\\s&.]+),\\s*(\\d+)\\s*U\\.S\\.\\s*(\\d+)(?! - Source:)(?!\\]\\(http)"),
            "$1 v. $2, $3 U.S. $4 - Source: https://supreme.justia.com/cases/federal/us/$3/$4/"
        );

        // Federal Circuit F.3d: Name v. Name, 123 F.3d 456
        CITATION_URL_MAP.put(
            Pattern.compile("\\b([A-Z][a-zA-Z\\s&.]+)\\s+v\\.\\s+([A-Z][a-zA-Z\\s&.]+),\\s*(\\d+)\\s*F\\.3d\\s*(\\d+)(?! - Source:)(?!\\]\\(http)"),
            "$1 v. $2, $3 F.3d $4 - Source: https://www.courtlistener.com/?q=$1+v+$2+$3+F.3d+$4"
        );

        // Federal Circuit F.2d: Name v. Name, 123 F.2d 456
        CITATION_URL_MAP.put(
            Pattern.compile("\\b([A-Z][a-zA-Z\\s&.]+)\\s+v\\.\\s+([A-Z][a-zA-Z\\s&.]+),\\s*(\\d+)\\s*F\\.2d\\s*(\\d+)(?! - Source:)(?!\\]\\(http)"),
            "$1 v. $2, $3 F.2d $4 - Source: https://www.courtlistener.com/?q=$1+v+$2+$3+F.2d+$4"
        );

        // ===== IMMIGRATION LAW =====

        // INA sections (Immigration and Nationality Act = 8 U.S.C.)
        // INA ยง 208 = 8 U.S.C. ยง 1158, INA ยง 240A = 8 U.S.C. ยง 1229b, etc.
        // Pattern: INA ยง 208(a)(1)
        CITATION_URL_MAP.put(
            Pattern.compile("\\bINA\\s*ยง\\s*(\\d+[A-Z]?)(?:\\(([a-z])\\))?(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "INA ยง $1 - Source: https://www.law.cornell.edu/uscode/text/8/chapter-12"
        );

        // Specific 8 U.S.C. immigration sections (Title 8 = Immigration)
        // 8 U.S.C. ยง 1158 (asylum), ยง 1229b (cancellation), ยง 1101 (definitions)
        CITATION_URL_MAP.put(
            Pattern.compile("\\b8\\s*U\\.S\\.C\\.\\s*ยง\\s*(\\d+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "8 U.S.C. ยง $1 - Source: https://www.law.cornell.edu/uscode/text/8/$1"
        );

        // 8 CFR immigration regulations (more specific than general CFR catchall)
        // 8 CFR ยง 1003.1 (BIA), ยง 1003.2 (Remand), ยง 1003.3 (Appeal), ยง 208 (Asylum procedures)
        CITATION_URL_MAP.put(
            Pattern.compile("\\b8\\s*CFR\\s*ยง\\s*([\\d.]+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "8 CFR ยง $1 - Source: https://www.ecfr.gov/current/title-8/section-$1"
        );

        // BIA precedent decisions: Matter of X-Y-Z-, 24 I&N Dec. 493 (BIA 2008)
        CITATION_URL_MAP.put(
            Pattern.compile("\\bMatter of\\s+([A-Z](?:-[A-Z])*-),\\s*(\\d+)\\s*I&N\\s*Dec\\.\\s*(\\d+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "Matter of $1, $2 I&N Dec. $3 - Source: https://www.justice.gov/eoir/board-immigration-appeals-precedent-decisions"
        );

        // BIA precedent decisions without citation: Matter of X-Y-Z-
        CITATION_URL_MAP.put(
            Pattern.compile("\\bMatter of\\s+([A-Z](?:-[A-Z])*-)(?! - Source:)(?!\\]\\(http)(?!,\\s*\\d+)", Pattern.CASE_INSENSITIVE),
            "Matter of $1 - Source: https://www.justice.gov/eoir/board-immigration-appeals-precedent-decisions"
        );

        // ===== FEDERAL ENVIRONMENTAL LAW (CERCLA) =====

        // CERCLA (Comprehensive Environmental Response, Compensation, and Liability Act)
        // 42 U.S.C. ยงยง 9601-9675

        // CERCLA ยง 107 (liability) = 42 U.S.C. ยง 9607
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(?:CERCLA\\s*ยง\\s*107|42\\s*U\\.S\\.C\\.\\s*ยง\\s*9607)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "42 U.S.C. ยง 9607 (CERCLA ยง 107) - Source: https://www.law.cornell.edu/uscode/text/42/9607"
        );

        // CERCLA ยง 101 (definitions) = 42 U.S.C. ยง 9601
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(?:CERCLA\\s*ยง\\s*101|42\\s*U\\.S\\.C\\.\\s*ยง\\s*9601)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "42 U.S.C. ยง 9601 (CERCLA ยง 101) - Source: https://www.law.cornell.edu/uscode/text/42/9601"
        );

        // CERCLA ยง 113 (contribution) = 42 U.S.C. ยง 9613
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(?:CERCLA\\s*ยง\\s*113|42\\s*U\\.S\\.C\\.\\s*ยง\\s*9613)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "42 U.S.C. ยง 9613 (CERCLA ยง 113) - Source: https://www.law.cornell.edu/uscode/text/42/9613"
        );

        // CERCLA ยง 122 (settlements) = 42 U.S.C. ยง 9622
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(?:CERCLA\\s*ยง\\s*122|42\\s*U\\.S\\.C\\.\\s*ยง\\s*9622)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "42 U.S.C. ยง 9622 (CERCLA ยง 122) - Source: https://www.law.cornell.edu/uscode/text/42/9622"
        );

        // National Contingency Plan (NCP): 40 CFR Part 300
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(?:NCP|National Contingency Plan|40\\s*C\\.F\\.R\\.\\s*(?:Part\\s*)?300)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "40 CFR Part 300 (NCP) - Source: https://www.ecfr.gov/current/title-40/chapter-I/subchapter-J/part-300"
        );

        // Specific 42 U.S.C. ยงยง 9600-9675 (CERCLA range)
        CITATION_URL_MAP.put(
            Pattern.compile("\\b42\\s*U\\.S\\.C\\.\\s*ยง\\s*(96\\d{2})(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "42 U.S.C. ยง $1 - Source: https://www.law.cornell.edu/uscode/text/42/$1"
        );

        // ===== OTHER FEDERAL STATUTES =====

        // General U.S.C. catchall (for statutes not covered above)
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(\\d+)\\s*U\\.S\\.C\\.\\s*ยง\\s*([\\d]+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "$1 U.S.C. ยง $2 - Source: https://www.law.cornell.edu/uscode/text/$1/$2"
        );

        // General CFR catchall (for regulations not covered above)
        CITATION_URL_MAP.put(
            Pattern.compile("\\b(\\d+)\\s*CFR\\s*ยง\\s*([\\d.]+)(?! - Source:)(?!\\]\\(http)", Pattern.CASE_INSENSITIVE),
            "$1 CFR ยง $2 - Source: https://www.ecfr.gov/current/title-$1/section-$2"
        );
    }

    /**
     * Main injection method - scans response and adds URLs for known citations
     */
    public String inject(String response) {
        if (response == null || response.isBlank()) {
            return response;
        }

        log.info("๐ CitationUrlInjector: Processing response ({} chars)", response.length());

        String processed = response;
        int injectCount = 0;

        for (Map.Entry<Pattern, String> entry : CITATION_URL_MAP.entrySet()) {
            Pattern pattern = entry.getKey();
            String replacement = entry.getValue();

            Matcher matcher = pattern.matcher(processed);
            if (matcher.find()) {
                processed = matcher.replaceAll(replacement);
                injectCount++;
            }
        }

        if (injectCount > 0) {
            log.info("โ Injected {} URLs into response", injectCount);
        } else {
            log.info("โน๏ธ No URL injections needed (all citations already had URLs or none found)");
        }

        return processed;
    }

    /**
     * Validates response has sufficient URL coverage
     * Returns percentage of known citations that have URLs
     */
    public ValidationResult validate(String response) {
        if (response == null || response.isBlank()) {
            return new ValidationResult(0, 0, 0.0);
        }

        int citationsFound = 0;
        int citationsWithUrls = 0;

        for (Pattern pattern : CITATION_URL_MAP.keySet()) {
            // Remove the negative lookbehind to find ALL occurrences
            String patternStr = pattern.pattern()
                .replace("(?! - Source:)", "")
                .replace("(?!\\]\\(http)", "");

            Pattern findPattern = Pattern.compile(patternStr, pattern.flags());
            Matcher matcher = findPattern.matcher(response);

            while (matcher.find()) {
                citationsFound++;

                // Check if this specific occurrence has a URL
                String citationText = matcher.group();
                int citationEnd = matcher.end();

                // Check next 200 chars for URL pattern
                String following = response.substring(
                    citationEnd,
                    Math.min(citationEnd + 200, response.length())
                );

                if (following.matches("^\\s*-\\s*Source:\\s*http.*") ||
                    following.matches("^\\]\\(http.*")) {
                    citationsWithUrls++;
                }
            }
        }

        double coverage = citationsFound > 0 ? (double) citationsWithUrls / citationsFound * 100 : 100.0;

        return new ValidationResult(citationsFound, citationsWithUrls, coverage);
    }

    /**
     * Result of validation check
     */
    public static class ValidationResult {
        public final int totalCitations;
        public final int citationsWithUrls;
        public final double coveragePercentage;

        public ValidationResult(int total, int withUrls, double coverage) {
            this.totalCitations = total;
            this.citationsWithUrls = withUrls;
            this.coveragePercentage = coverage;
        }

        public boolean isAcceptable() {
            return coveragePercentage >= 90.0; // 90%+ coverage is acceptable
        }

        @Override
        public String toString() {
            return String.format("Citations: %d, With URLs: %d, Coverage: %.1f%%",
                totalCitations, citationsWithUrls, coveragePercentage);
        }
    }
}
